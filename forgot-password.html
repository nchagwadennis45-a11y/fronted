<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Recovery - ConnectSphere</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="responsive.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .primary-gradient {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        }
        .text-glow {
            text-shadow: 0 0 8px rgba(59, 130, 246, 0.6);
        }
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 12px;
            color: white;
            opacity: 0;
            transform: translateY(100%);
            transition: all 0.3s ease-out;
            z-index: 1000;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast.success { background-color: #10b981; }
        .toast.error { background-color: #ef4444; }
        .toast.info { background-color: #3b82f6; }

        .recovery-option-card {
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .recovery-option-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            border-color: #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div class="w-full max-w-lg mx-auto p-6 md:p-10 glass-card rounded-2xl shadow-2xl">
        <div class="flex items-center space-x-3 mb-8">
            <i class="fas fa-lock text-3xl text-blue-400 text-glow"></i>
            <h1 class="text-3xl font-bold text-gray-100">Account Recovery</h1>
        </div>

        <!-- Step 1: Email/Identifier Input -->
        <div id="step-1-email" class="">
            <p class="text-gray-300 mb-6">
                Please enter your registered email or phone number to find your account.
            </p>
            <form id="emailForm" onsubmit="handlePasswordReset(event)">
                <div class="mb-6">
                    <label for="identifier" class="block text-sm font-medium text-gray-300 mb-2">Email / Phone Number</label>
                    <input type="text" id="identifier" name="identifier" required placeholder="name@example.com or +1234567890"
                           class="w-full p-3 rounded-xl bg-gray-700 bg-opacity-50 border border-gray-600 focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                </div>
                <button type="submit" id="submitBtn"
                        class="w-full primary-gradient text-white py-3 rounded-xl font-semibold shadow-lg hover:shadow-blue-500/50 transition duration-300 transform hover:scale-[1.01] flex items-center justify-center">
                    <i class="fas fa-search mr-2"></i> Find Account
                </button>
            </form>
        </div>

        <!-- Step 2: Method Selection (Hidden initially) -->
        <div id="step-2-methods" class="hidden">
            <h2 class="text-2xl font-semibold mb-4 text-gray-100">Choose Recovery Method</h2>
            <p class="text-gray-300 mb-6">
                Select how you'd like to receive your password reset instructions.
            </p>
            <div class="space-y-4">
                
                <!-- Option 1: Email Link (Firebase Default) -->
                <div onclick="selectRecoveryMethod('email')" class="recovery-option-card glass-card p-4 rounded-xl flex items-center space-x-4">
                    <i class="fas fa-envelope text-2xl text-green-400"></i>
                    <div>
                        <h3 class="font-bold text-lg">Email Link</h3>
                        <p class="text-sm text-gray-400">Send a password reset link to your registered email.</p>
                    </div>
                </div>

                <!-- Option 2: Phone Number (Code) -->
                <div onclick="selectRecoveryMethod('phone')" class="recovery-option-card glass-card p-4 rounded-xl flex items-center space-x-4">
                    <i class="fas fa-mobile-alt text-2xl text-yellow-400"></i>
                    <div>
                        <h3 class="font-bold text-lg">Phone Number (SMS Code)</h3>
                        <p class="text-sm text-gray-400">Receive a one-time code via SMS to reset your password.</p>
                    </div>
                </div>

                <!-- Option 3: Voice Call -->
                <div onclick="selectRecoveryMethod('voice')" class="recovery-option-card glass-card p-4 rounded-xl flex items-center space-x-4">
                    <i class="fas fa-phone-volume text-2xl text-red-400"></i>
                    <div>
                        <h3 class="font-bold text-lg">Voice Call</h3>
                        <p class="text-sm text-gray-400">Receive an automated voice call with a verification code.</p>
                    </div>
                </div>

                <!-- Option 4: Secret Text (Security Question) -->
                <div onclick="selectRecoveryMethod('secret')" class="recovery-option-card glass-card p-4 rounded-xl flex items-center space-x-4">
                    <i class="fas fa-user-secret text-2xl text-purple-400"></i>
                    <div>
                        <h3 class="font-bold text-lg">Secret Text / Security Question</h3>
                        <p class="text-sm text-gray-400">Answer your security question for direct reset access.</p>
                    </div>
                </div>
            </div>
            
            <button onclick="goBackToLogin()"
                    class="w-full mt-6 text-gray-400 py-3 rounded-xl font-semibold hover:text-gray-100 transition duration-200">
                <i class="fas fa-arrow-left mr-2"></i> Back to Login
            </button>
        </div>
        
        <!-- Step 3: Specific Recovery Form (Secret Text example) -->
        <div id="step-3-secret-reset" class="hidden">
            <h2 class="text-2xl font-semibold mb-4 text-gray-100">Secret Text Recovery</h2>
            <p class="text-gray-300 mb-6">
                To confirm your identity, please answer your secret question.
            </p>
            <form id="secretForm" onsubmit="executeRecovery(event, 'secret')">
                <div class="mb-4">
                    <label for="securityQuestion" class="block text-sm font-medium text-gray-300 mb-2">Security Question</label>
                    <p id="securityQuestion" class="p-3 rounded-xl bg-gray-700 bg-opacity-50 border border-gray-600">
                        What was the name of your first pet? (Simulated)
                    </p>
                </div>
                <div class="mb-6">
                    <label for="securityAnswer" class="block text-sm font-medium text-gray-300 mb-2">Your Answer</label>
                    <input type="text" id="securityAnswer" name="securityAnswer" required
                           class="w-full p-3 rounded-xl bg-gray-700 bg-opacity-50 border border-gray-600 focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                </div>
                
                <button type="submit" id="secretSubmitBtn"
                        class="w-full primary-gradient text-white py-3 rounded-xl font-semibold shadow-lg hover:shadow-blue-500/50 transition duration-300 transform hover:scale-[1.01] flex items-center justify-center">
                    <i class="fas fa-check-circle mr-2"></i> Verify & Reset
                </button>
            </form>
            <button onclick="changeMethod()"
                    class="w-full mt-4 text-gray-400 py-3 rounded-xl font-semibold hover:text-gray-100 transition duration-200">
                Change Recovery Method
            </button>
        </div>
    </div>

    <!-- Loading Modal -->
    <div id="loadingModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
        <div class="flex flex-col items-center p-8 rounded-xl glass-card">
            <i class="fas fa-spinner fa-spin text-4xl text-blue-400 mb-4"></i>
            <p class="text-lg font-medium text-gray-100" id="loadingText">Processing...</p>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed bottom-0 right-0 p-4 space-y-2 z-50"></div>

    <script>
        // --- Firebase Setup ---
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        let app, auth;

        if (Object.keys(firebaseConfig).length > 0) {
            app = firebase.initializeApp(firebaseConfig);
            auth = app.auth();
        } else {
            // Mock auth for running outside of canvas environment
            auth = {
                sendPasswordResetEmail: async (email) => {
                    console.log(`MOCK: Sending password reset to ${email}`);
                    return new Promise(resolve => setTimeout(resolve, 1000));
                },
            };
            console.warn("Firebase not initialized. Using mock authentication functions.");
        }

        // --- State and UI Management ---
        let currentStep = 1;
        let userIdentifier = '';
        let lastSelectedMethod = '';

        const uiElements = {
            step1: document.getElementById('step-1-email'),
            step2: document.getElementById('step-2-methods'),
            step3Secret: document.getElementById('step-3-secret-reset'),
            loadingModal: document.getElementById('loadingModal'),
            loadingText: document.getElementById('loadingText'),
            submitBtn: document.getElementById('submitBtn')
        };
        
        // Helper to show/hide steps
        function setStep(step) {
            uiElements.step1.classList.add('hidden');
            uiElements.step2.classList.add('hidden');
            uiElements.step3Secret.classList.add('hidden');
            
            if (step === 1) {
                uiElements.step1.classList.remove('hidden');
                currentStep = 1;
            } else if (step === 2) {
                uiElements.step2.classList.remove('hidden');
                currentStep = 2;
            } else if (step === 3) {
                uiElements.step3Secret.classList.remove('hidden');
                currentStep = 3;
            }
        }

        function showLoading(text = 'Processing...') {
            uiElements.loadingText.textContent = text;
            uiElements.loadingModal.classList.remove('hidden');
        }

        function hideLoading() {
            uiElements.loadingModal.classList.add('hidden');
        }

        // --- Core Functions ---

        // Step 1 Submission: Find Account (Simulated)
        async function handlePasswordReset(event) {
            event.preventDefault();
            const identifierInput = document.getElementById('identifier');
            userIdentifier = identifierInput.value.trim();

            if (!userIdentifier) {
                showToast('Please enter your email or phone number.', 'error');
                return;
            }

            // Simulate account finding process
            showLoading('Locating account...');
            await new Promise(resolve => setTimeout(resolve, 1500)); 
            
            // In a real app, you would check if the identifier exists and what recovery methods are available
            // For this demo, we assume the account is found and proceed to method selection
            hideLoading();
            setStep(2);
        }

        // Step 2 Selection: Choose Method
        function selectRecoveryMethod(method) {
            lastSelectedMethod = method;
            if (method === 'email') {
                executeRecovery(null, 'email');
            } else if (method === 'phone' || method === 'voice') {
                // Phone/Voice method only requires showing a toast about the simulation
                executeRecovery(null, method);
            } else if (method === 'secret') {
                // Navigate to the specific secret question form
                setStep(3);
            }
        }

        // Step 3 Execution: Perform Recovery Action
        async function executeRecovery(event, method) {
            if (event) event.preventDefault();

            showLoading(`Initiating ${method} recovery...`);
            
            if (method === 'email') {
                if (!userIdentifier.includes('@')) {
                    hideLoading();
                    showToast('The identifier entered is not a valid email address.', 'error');
                    return;
                }
                
                try {
                    // Firebase Email Reset
                    await auth.sendPasswordResetEmail(userIdentifier);
                    hideLoading();
                    showToast('Recovery email sent successfully! Please check your inbox (and spam folder) for the link.', 'success');
                    goBackToLogin(); // Go back to login after successful action
                } catch (error) {
                    hideLoading();
                    const errorMessage = getFriendlyErrorMessage(error.code);
                    showToast(`Email reset failed: ${errorMessage}`, 'error');
                    console.error("Firebase reset error:", error);
                }
            } else if (method === 'phone' || method === 'voice') {
                // Simulated Phone/Voice Call Recovery
                await new Promise(resolve => setTimeout(resolve, 2000));
                hideLoading();
                const action = method === 'phone' ? 'SMS code' : 'voice call';
                showToast(`A simulated ${action} has been initiated for ${userIdentifier}. Please check your phone for a code to complete the process.`, 'info');
                goBackToLogin();
            } else if (method === 'secret') {
                // Simulated Secret Text (Security Question) Answer
                const answer = document.getElementById('securityAnswer').value.trim();
                if (answer.toLowerCase() === 'sparky') { // Mock correct answer
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    hideLoading();
                    showToast('Security question verified! You can now set a new password (Simulated). Redirecting to login.', 'success');
                    goBackToLogin();
                } else {
                    hideLoading();
                    showToast('Incorrect answer. Please try again or select another method.', 'error');
                }
            }
        }

        // --- Navigation and Utility ---

        function changeMethod() {
            // Allows the user to go back from a specific form (like secret text) to the method selection step
            document.getElementById('securityAnswer').value = ''; // Clear input
            setStep(2);
        }

        function goBackToLogin() {
            window.location.href = 'login.html';
        }

        function getFriendlyErrorMessage(errorCode) {
            switch (errorCode) {
                case 'auth/user-not-found':
                    return 'No user found with that email address.';
                case 'auth/invalid-email':
                    return 'The email address is not valid.';
                case 'auth/too-many-requests':
                    return 'Access to this account has been temporarily disabled due to many failed login attempts. Please try again later.';
                default:
                    return 'An unknown error occurred. Please try again.';
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} mr-2"></i>
                    ${message}
                </div>
            `;
            
            document.getElementById('toastContainer').appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 5000); // Increased duration to 5 seconds for important messages
        }

        // Close modals when clicking outside
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('fixed') && event.target.id !== 'loadingModal') {
                event.target.classList.add('hidden');
            }
        });
        
        // Initial setup
        setStep(1);
    </script>
</body>
</html>