<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="manifest" href="../manifest.json">
    <meta name="theme-color" content="#4F46E5">
    <link rel="icon" href="../icons/moodchat-192.png">
    <link rel="icon" href="../icons/moodchat-512.png">
    <meta name="theme-color" content="#000000">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Business Hub | MoodChat Tools</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js for statistics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* All your existing CSS remains exactly the same */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary-color: #0084ff;
            --secondary-color: #f0f2f5;
            --danger-color: #ff3b30;
            --success-color: #34c759;
            --warning-color: #ff9500;
            --info-color: #5ac8fa;
            --premium-color: #ffd700;
            --business-color: #9b59b6;
            --text-primary: #050505;
            --text-secondary: #65676b;
            --bg-color: #ffffff;
            --border-color: #dddfe2;
            --tools-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --business-gradient: linear-gradient(135deg, #9b59b6 0%, #3498db 100%);
            --ai-gradient: linear-gradient(135deg, #00c6ff 0%, #0072ff 100%);
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.2);
            --offline-overlay: rgba(255, 255, 255, 0.95);
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }
        
        .app-container {
            display: flex;
            height: 100vh;
            position: relative;
        }
        
        /* Offline Overlay */
        .offline-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--offline-overlay);
            z-index: 9999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }
        
        .offline-overlay.active {
            display: flex;
        }
        
        .offline-icon {
            font-size: 64px;
            color: var(--text-secondary);
            margin-bottom: 20px;
            opacity: 0.7;
        }
        
        .offline-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 10px;
        }
        
        .offline-message {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 30px;
            max-width: 400px;
            line-height: 1.5;
        }
        
        .offline-submessage {
            font-size: 14px;
            color: var(--text-secondary);
            opacity: 0.8;
            max-width: 400px;
            margin-top: 20px;
            padding: 15px;
            background-color: var(--secondary-color);
            border-radius: 12px;
            border-left: 4px solid var(--warning-color);
        }
        
        .offline-dismiss-btn {
            margin-top: 30px;
            padding: 12px 30px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .offline-dismiss-btn:hover {
            background-color: #0073e6;
            transform: translateY(-2px);
        }
        
        .offline-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--warning-color);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow);
            animation: slideInRight 0.3s ease;
            display: none;
        }
        
        .offline-indicator.active {
            display: flex;
        }
        
        /* Sidebar Styles */
        .sidebar {
            width: 320px;
            background-color: var(--bg-color);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
            position: relative;
        }
        
        @media (min-width: 769px) {
            .sidebar {
                display: flex;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                position: absolute !important;
                left: -320px;
                transition: left 0.3s;
                z-index: 1000;
            }
            
            .sidebar.active {
                left: 0;
            }
            
            .main-content {
                width: 100% !important;
            }
        }
        
        .sidebar-header {
            padding: 20px;
            background: var(--business-gradient);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .sidebar-header h2 {
            font-size: 24px;
            font-weight: 600;
        }
        
        .mobile-menu-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: none;
        }
        
        @media (max-width: 768px) {
            .mobile-menu-toggle {
                display: block;
            }
        }
        
        /* Transaction History */
        .transaction-history {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .transaction-history-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .transaction-history-header h3 {
            font-size: 16px;
            font-weight: 600;
        }
        
        .transactions-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }
        
        .transaction-item {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: background 0.2s;
        }
        
        .transaction-item:hover {
            background-color: var(--secondary-color);
        }
        
        .transaction-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: var(--primary-color);
        }
        
        .transaction-details {
            flex: 1;
        }
        
        .transaction-title {
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .transaction-meta {
            font-size: 13px;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
        }
        
        .transaction-amount {
            font-weight: 600;
        }
        
        .transaction-amount.income {
            color: var(--success-color);
        }
        
        .transaction-amount.expense {
            color: var(--danger-color);
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background-color: var(--bg-color);
        }
        
        .main-header {
            padding: 20px;
            background: var(--tools-gradient);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 600;
        }
        
        .user-details h3 {
            font-size: 18px;
            margin-bottom: 4px;
        }
        
        .user-plan {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .credits-display {
            background-color: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            padding: 20px;
            background-color: var(--secondary-color);
        }
        
        .stat-card {
            background-color: var(--bg-color);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card.premium {
            border: 2px solid var(--premium-color);
        }
        
        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .stat-title {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .stat-trend {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .stat-trend.positive {
            color: var(--success-color);
        }
        
        .stat-trend.negative {
            color: var(--danger-color);
        }
        
        .productivity-ring {
            position: relative;
            width: 80px;
            height: 80px;
            margin: 20px auto;
        }
        
        .productivity-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 20px;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        /* Tool Categories */
        .tool-categories {
            display: flex;
            gap: 10px;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
            scrollbar-width: none;
        }
        
        .tool-categories::-webkit-scrollbar {
            display: none;
        }
        
        .category-btn {
            padding: 10px 20px;
            background-color: var(--secondary-color);
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
            white-space: nowrap;
            transition: all 0.2s;
        }
        
        .category-btn.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .category-btn:hover:not(.active) {
            background-color: #e4e6e9;
        }
        
        /* REMOVED Search Bar Styles */
        
        /* Tools Grid - FIXED SCROLL */
        .tools-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .tools-grid {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            height: 100%;
        }
        
        @media (max-width: 768px) {
            .tools-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .tool-card {
            background-color: var(--bg-color);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
            border: 2px solid transparent;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            min-height: 280px;
            display: flex;
            flex-direction: column;
        }
        
        .tool-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }
        
        .tool-card.locked {
            opacity: 0.7;
            border-color: var(--border-color);
        }
        
        .tool-card.premium {
            border-color: var(--premium-color);
        }
        
        .tool-card.business {
            border-color: var(--business-color);
        }
        
        .tool-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .tool-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: var(--ai-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            margin-bottom: 15px;
        }
        
        .tool-category-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .ai-badge {
            background-color: rgba(0, 198, 255, 0.1);
            color: #0072ff;
        }
        
        .business-badge {
            background-color: rgba(155, 89, 182, 0.1);
            color: var(--business-color);
        }
        
        .productivity-badge {
            background-color: rgba(52, 199, 89, 0.1);
            color: var(--success-color);
        }
        
        .tool-lock {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: var(--danger-color);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        .tool-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .tool-description {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 15px;
            flex: 1;
        }
        
        .tool-pricing {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .tool-price {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .tool-credits {
            font-size: 13px;
            color: var(--warning-color);
            background-color: rgba(255, 149, 0, 0.1);
            padding: 4px 8px;
            border-radius: 10px;
        }
        
        .tool-plan-required {
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 15px;
        }
        
        .most-used-badge {
            position: absolute;
            top: -10px;
            right: 20px;
            background-color: var(--danger-color);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .tool-actions {
            display: flex;
            gap: 10px;
            margin-top: auto;
        }
        
        .tool-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }
        
        .tool-btn.primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .tool-btn.primary:hover {
            background-color: #0073e6;
        }
        
        .tool-btn.secondary {
            background-color: var(--secondary-color);
            color: var(--text-primary);
        }
        
        .tool-btn.secondary:hover {
            background-color: #e4e6e9;
        }
        
        .tool-btn.success {
            background-color: var(--success-color);
            color: white;
        }
        
        .tool-btn.success:hover {
            background-color: #2dbb4f;
        }
        
        .tool-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Tool Modal - UPDATED FOR FULL IFRAME */
        .tool-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .tool-modal.active {
            display: flex;
        }
        
        .tool-modal-container {
            width: 95%;
            height: 90vh;
            background-color: var(--bg-color);
            border-radius: 20px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-lg);
            position: relative;
        }
        
        .tool-modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--ai-gradient);
            color: white;
            flex-shrink: 0;
        }
        
        .tool-modal-header h3 {
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .tool-modal-content {
            flex: 1;
            overflow-y: auto;
            padding: 25px;
        }
        
        .tool-iframe-container {
            width: 100%;
            height: calc(100vh - 180px);
            border: none;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 0;
            flex: 1;
        }
        
        .tool-iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 12px;
        }
        
        /* Payment Modal - MINIMIZED */
        .payment-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1001;
            align-items: center;
            justify-content: center;
        }
        
        .payment-modal.active {
            display: flex;
        }
        
        .payment-modal-container {
            width: 90%;
            max-width: 450px; /* Reduced from 500px */
            max-height: 85vh; /* Reduced height */
            background-color: var(--bg-color);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        
        .payment-modal-header {
            padding: 15px 20px; /* Reduced padding */
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--success-color);
            color: white;
            flex-shrink: 0;
        }
        
        .payment-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        
        .payment-tab {
            flex: 1;
            padding: 12px; /* Reduced padding */
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
            font-size: 14px; /* Smaller font */
        }
        
        .payment-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        
        .payment-form {
            padding: 20px; /* Reduced padding */
            overflow-y: auto;
            flex: 1;
        }
        
        .payment-methods {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px; /* Reduced gap */
            margin-bottom: 15px;
        }
        
        .payment-method {
            padding: 12px; /* Reduced padding */
            border: 2px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            font-size: 14px;
        }
        
        .payment-method.selected {
            border-color: var(--primary-color);
            background-color: rgba(0, 132, 255, 0.05);
        }
        
        .payment-method-icon {
            font-size: 20px; /* Reduced size */
            margin-bottom: 8px;
            color: var(--primary-color);
        }
        
        .form-group {
            margin-bottom: 15px; /* Reduced margin */
        }
        
        .form-label {
            display: block;
            margin-bottom: 6px; /* Reduced margin */
            font-weight: 500;
            font-size: 14px;
        }
        
        .form-input {
            width: 100%;
            padding: 10px 12px; /* Reduced padding */
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px; /* Reduced gap */
        }
        
        .secure-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px; /* Smaller font */
            color: var(--success-color);
            margin-top: 10px;
        }
        
        /* Credit Packages */
        .credit-packages {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px; /* Reduced gap */
            margin-bottom: 15px;
        }
        
        .credit-package {
            padding: 15px; /* Reduced padding */
            border: 2px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .credit-package.selected {
            border-color: var(--primary-color);
            background-color: rgba(0, 132, 255, 0.05);
        }
        
        .credit-package.popular {
            border-color: var(--premium-color);
        }
        
        .popular-badge {
            position: absolute;
            top: -8px;
            right: 8px;
            background-color: var(--premium-color);
            color: #333;
            padding: 3px 6px;
            border-radius: 8px;
            font-size: 10px; /* Smaller font */
            font-weight: 600;
        }
        
        .package-amount {
            font-size: 20px; /* Reduced size */
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .package-price {
            font-size: 16px; /* Reduced size */
            font-weight: 600;
            color: var(--success-color);
        }
        
        .package-value {
            font-size: 12px; /* Smaller font */
            color: var(--text-secondary);
        }
        
        /* Subscription Plans - COMPACT */
        .subscription-plans {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px; /* Reduced gap */
            margin-bottom: 15px;
        }
        
        @media (max-width: 1024px) {
            .subscription-plans {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 480px) {
            .subscription-plans {
                grid-template-columns: 1fr;
            }
        }
        
        .subscription-plan {
            padding: 15px; /* Reduced padding */
            border: 2px solid var(--border-color);
            border-radius: 12px;
            text-align: center;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .subscription-plan.selected {
            border-color: var(--primary-color);
            transform: scale(1.02); /* Reduced scale */
            box-shadow: var(--shadow);
        }
        
        .subscription-plan.popular {
            border-color: var(--premium-color);
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1) 0%, rgba(255, 215, 0, 0.05) 100%);
        }
        
        .plan-name {
            font-size: 16px; /* Reduced size */
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .plan-price {
            font-size: 24px; /* Reduced size */
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .plan-period {
            font-size: 12px; /* Smaller font */
            color: var(--text-secondary);
            margin-bottom: 15px;
        }
        
        .plan-features {
            text-align: left;
            margin-bottom: 15px;
        }
        
        .plan-feature {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 6px;
            font-size: 12px; /* Smaller font */
        }
        
        .plan-feature i {
            color: var(--success-color);
            font-size: 10px; /* Smaller icon */
        }
        
        /* Marketplace Items */
        .marketplace-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); /* Smaller min width */
            gap: 12px; /* Reduced gap */
        }
        
        .marketplace-item {
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.2s;
        }
        
        .marketplace-item:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
        }
        
        .marketplace-image {
            height: 100px; /* Reduced height */
            background-color: var(--secondary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px; /* Reduced size */
            color: var(--text-secondary);
        }
        
        .marketplace-content {
            padding: 12px; /* Reduced padding */
        }
        
        .marketplace-title {
            font-weight: 600;
            margin-bottom: 6px;
            font-size: 14px;
        }
        
        .marketplace-description {
            font-size: 12px; /* Smaller font */
            color: var(--text-secondary);
            margin-bottom: 8px;
            line-height: 1.4;
        }
        
        .marketplace-price {
            font-weight: 600;
            color: var(--success-color);
            font-size: 14px;
        }
        
        /* Affiliate Dashboard */
        .affiliate-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* Changed to 2 columns */
            gap: 12px; /* Reduced gap */
            margin-bottom: 15px;
        }
        
        .affiliate-stat {
            text-align: center;
            padding: 15px; /* Reduced padding */
            background-color: var(--secondary-color);
            border-radius: 12px;
        }
        
        .affiliate-stat-value {
            font-size: 20px; /* Reduced size */
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .affiliate-stat-label {
            font-size: 12px; /* Smaller font */
            color: var(--text-secondary);
        }
        
        .affiliate-link-container {
            background-color: var(--secondary-color);
            padding: 12px; /* Reduced padding */
            border-radius: 12px;
            margin-bottom: 15px;
        }
        
        .affiliate-link {
            display: flex;
            gap: 8px;
        }
        
        .affiliate-link-input {
            flex: 1;
            padding: 8px; /* Reduced padding */
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--bg-color);
            font-size: 12px; /* Smaller font */
        }
        
        /* Consultation Cards */
        .consultation-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); /* Smaller min width */
            gap: 15px; /* Reduced gap */
        }
        
        .consultation-card {
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 15px; /* Reduced padding */
            transition: all 0.2s;
        }
        
        .consultation-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
        }
        
        .consultation-title {
            font-size: 16px; /* Reduced size */
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .consultation-price {
            font-size: 20px; /* Reduced size */
            font-weight: 700;
            color: var(--success-color);
            margin-bottom: 12px;
        }
        
        /* Ad Space */
        .ad-space {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px; /* Reduced padding */
            border-radius: 12px;
            margin: 15px 0; /* Reduced margin */
            text-align: center;
        }
        
        .ad-space h4 {
            font-size: 16px; /* Reduced size */
            margin-bottom: 8px;
        }
        
        .ad-space p {
            opacity: 0.9;
            margin-bottom: 12px;
            font-size: 14px;
        }
        
        .roi-badge {
            display: inline-block;
            background-color: rgba(255, 255, 255, 0.2);
            padding: 4px 8px; /* Reduced padding */
            border-radius: 20px;
            font-size: 11px; /* Smaller font */
            margin-bottom: 12px;
        }
        
        /* Why MoodChat - MOVED TO BOTTOM */
        .why-moodchat {
            background-color: var(--secondary-color);
            padding: 25px 20px;
            border-radius: 12px;
            margin: 20px;
            text-align: center;
            border-top: 3px solid var(--primary-color);
        }
        
        .why-moodchat h3 {
            font-size: 22px;
            margin-bottom: 15px;
            color: var(--primary-color);
        }
        
        .why-moodchat p {
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto 20px;
            line-height: 1.6;
            font-size: 15px;
        }
        
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .feature-card {
            background-color: var(--bg-color);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            box-shadow: var(--shadow);
        }
        
        .feature-icon {
            font-size: 28px;
            color: var(--primary-color);
            margin-bottom: 12px;
        }
        
        /* CTA Card */
        .cta-card {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            margin: 20px;
        }
        
        .cta-card h3 {
            font-size: 22px;
            margin-bottom: 10px;
        }
        
        .cta-card p {
            opacity: 0.9;
            margin-bottom: 20px;
            font-size: 15px;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--success-color);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
        }
        
        .notification.active {
            transform: translateY(0);
            opacity: 1;
        }
        
        .notification.error {
            background-color: var(--danger-color);
        }
        
        .notification.warning {
            background-color: var(--warning-color);
        }
        
        .notification.info {
            background-color: var(--info-color);
        }
        
        /* Local Storage Indicator */
        .local-storage-indicator {
            position: fixed;
            bottom: 70px;
            right: 20px;
            background-color: var(--info-color);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow);
            animation: slideInRight 0.3s ease;
            display: none;
        }
        
        .local-storage-indicator.active {
            display: flex;
        }
        
        /* Cache Indicator */
        .cache-indicator {
            padding: 10px 20px;
            background-color: var(--secondary-color);
            border-radius: 8px;
            margin: 10px 20px;
            font-size: 13px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
            animation: fadeIn 0.3s ease;
        }
        
        /* Loading States */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--secondary-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease;
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                width: 300px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .affiliate-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .header-actions {
                flex-direction: column;
                align-items: flex-end;
            }
            
            .credit-packages {
                grid-template-columns: 1fr;
            }
            
            .payment-methods {
                grid-template-columns: 1fr;
            }
            
            .affiliate-stats {
                grid-template-columns: 1fr;
            }
            
            .mobile-overlay {
                display: block;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
                opacity: 0;
                visibility: hidden;
                transition: all 0.3s;
            }
            
            .mobile-overlay.active {
                opacity: 1;
                visibility: visible;
            }
        }
        
        @media (max-width: 480px) {
            .sidebar {
                width: 280px;
            }
            
            .tool-categories {
                padding: 12px 15px;
            }
            
            .category-btn {
                padding: 8px 15px;
                font-size: 14px;
            }
            
            .tool-modal-container,
            .payment-modal-container {
                width: 95%;
                max-height: 95vh;
            }
            
            .why-moodchat,
            .cta-card {
                margin: 15px;
                padding: 20px;
            }
        }
        
        /* Tool-specific styles */
        .ai-tool .tool-icon {
            background: var(--ai-gradient);
        }
        
        .business-tool .tool-icon {
            background: var(--business-gradient);
        }
        
        .productivity-tool .tool-icon {
            background: linear-gradient(135deg, #34c759 0%, #2dbb4f 100%);
        }
        
        .marketplace-tool .tool-icon {
            background: linear-gradient(135deg, #ff9500 0%, #ff5e3a 100%);
        }
        
        .premium-tool .tool-icon {
            background: linear-gradient(135deg, #ffd700 0%, #ff9500 100%);
        }
    </style>
</head>
<body>
    <!-- Offline Overlay -->
    <div class="offline-overlay" id="offlineOverlay">
        <div class="offline-icon">
            <i class="fas fa-wifi-slash"></i>
        </div>
        <div class="offline-title">You're Offline</div>
        <div class="offline-message">Some tools require internet connection to work properly.</div>
        <div class="offline-submessage">
            <i class="fas fa-info-circle"></i> You can still access cached tools and use basic features. Premium tools and real-time data will sync when you're back online.
        </div>
        <button class="offline-dismiss-btn" id="dismissOfflineBtn">
            <i class="fas fa-eye"></i> View Cached Tools
        </button>
    </div>
    
    <!-- Offline Indicator -->
    <div class="offline-indicator" id="offlineIndicator">
        <i class="fas fa-wifi-slash"></i>
        <span>Offline</span>
    </div>
    
    <!-- Local Storage Indicator -->
    <div class="local-storage-indicator" id="localStorageIndicator">
        <i class="fas fa-database"></i>
        <span>Loaded from Local Storage</span>
    </div>
    
    <!-- Mobile Menu Overlay -->
    <div class="mobile-overlay" id="mobileOverlay"></div>
    
    <div class="app-container">
        <!-- Sidebar with Transaction History -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>Transactions</h2>
                <button class="mobile-menu-toggle" id="closeSidebar">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="transaction-history">
                <div class="transaction-history-header">
                    <h3>Recent Activity</h3>
                    <button class="category-btn" id="refreshTransactions">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                
                <div class="transactions-list" id="transactionsList">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                    </div>
                </div>
            </div>
            
            <!-- Advertising Space -->
            <div class="ad-space" style="margin: 15px; background: linear-gradient(135deg, #9b59b6 0%, #3498db 100%);">
                <h4>Premium Ad Space</h4>
                <div class="roi-badge">2.8% average CTR</div>
                <p>Reach 50,000+ business users</p>
                <button class="tool-btn primary" style="width: 100%; padding: 8px;">
                    <i class="fas fa-bullhorn"></i> Book Now
                </button>
            </div>
            
            <!-- Affiliate Program -->
            <div style="padding: 15px; border-top: 1px solid var(--border-color);">
                <h3 style="font-size: 16px; margin-bottom: 8px;">Affiliate Program</h3>
                <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">Earn 30% commission on referrals</p>
                <button class="tool-btn success" style="width: 100%; padding: 8px;" id="viewAffiliateBtn">
                    <i class="fas fa-chart-line"></i> View Dashboard
                </button>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Main Header -->
            <div class="main-header">
                <button class="mobile-menu-toggle" id="openSidebar">
                    <i class="fas fa-bars"></i>
                </button>
                
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">
                        ME
                    </div>
                    <div class="user-details">
                        <h3 id="userName">Loading...</h3>
                        <div class="user-plan">
                            <span id="userPlan">Loading...</span>
                            â€¢ 
                            <span id="userCredits">Loading credits</span>
                        </div>
                    </div>
                </div>
                
                <div class="header-actions">
                    <div class="credits-display">
                        <i class="fas fa-coins"></i>
                        <span id="currentCredits">0</span>
                        <button class="category-btn" style="background: rgba(255,255,255,0.3); color: white; padding: 4px 12px;" id="buyCreditsBtn">
                            <i class="fas fa-plus"></i> Buy
                        </button>
                    </div>
                    
                    <button class="category-btn" style="background: rgba(255,255,255,0.3); color: white;" id="upgradePlanBtn">
                        <i class="fas fa-crown"></i> Upgrade
                    </button>
                </div>
            </div>
            
            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Monthly Revenue</div>
                        <div class="stat-trend positive">
                            <i class="fas fa-arrow-up"></i>
                            +12.5%
                        </div>
                    </div>
                    <div class="stat-value" id="monthlyRevenue">$0</div>
                    <div style="font-size: 14px; color: var(--text-secondary);">Target: $3,000</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Available Credits</div>
                        <div class="stat-trend negative">
                            <i class="fas fa-arrow-down"></i>
                            -8.2%
                        </div>
                    </div>
                    <div class="stat-value" id="availableCredits">0</div>
                    <div style="font-size: 14px; color: var(--text-secondary);">
                        <button class="category-btn" style="padding: 5px 10px; font-size: 13px;" id="addCreditsBtn">
                            <i class="fas fa-plus"></i> Add Credits
                        </button>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Productivity Score</div>
                        <div class="stat-trend positive">
                            <i class="fas fa-arrow-up"></i>
                            +5.3%
                        </div>
                    </div>
                    <div class="productivity-ring">
                        <canvas id="productivityChart" width="80" height="80"></canvas>
                        <div class="productivity-value" id="productivityScore">0%</div>
                    </div>
                </div>
                
                <div class="stat-card premium">
                    <div class="stat-header">
                        <div class="stat-title">AI Tools Usage</div>
                        <div class="stat-trend positive">
                            <i class="fas fa-arrow-up"></i>
                            +24.7%
                        </div>
                    </div>
                    <div class="stat-value" id="aiUsage">0</div>
                    <div style="font-size: 14px; color: var(--text-secondary);">This month</div>
                    <div class="most-used-badge" style="position: absolute; top: 10px; right: 10px;">
                        <i class="fas fa-fire"></i> Most Used
                    </div>
                </div>
            </div>
            
            <!-- Tool Categories -->
            <div class="tool-categories">
                <button class="category-btn active" data-category="all">All Tools</button>
                <button class="category-btn" data-category="ai">AI Tools</button>
                <button class="category-btn" data-category="business">Business Tools</button>
                <button class="category-btn" data-category="productivity">Productivity</button>
                <button class="category-btn" data-category="marketplace">Marketplace</button>
                <button class="category-btn" data-category="premium">Premium</button>
            </div>
            
            <!-- Cache Indicator -->
            <div class="cache-indicator" id="cacheIndicator" style="display: none;">
                <i class="fas fa-database"></i>
                <span>Showing cached tools data. Some features may be limited.</span>
            </div>
            
            <!-- Tools Grid Container -->
            <div class="tools-container">
                <div class="tools-grid" id="toolsGrid">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tool Modal -->
    <div class="tool-modal" id="toolModal">
        <div class="tool-modal-container">
            <div class="tool-modal-header">
                <h3 id="toolModalTitle">
                    <i class="fas fa-robot"></i>
                    <span>AI Content Generator</span>
                </h3>
                <button class="add-friend-btn" id="closeToolModal" style="background: rgba(255,255,255,0.2);">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="tool-modal-content" id="toolModalContent">
                <!-- Tool details will be loaded here -->
            </div>
            
            <div style="padding: 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-between; flex-shrink: 0;">
                <button class="tool-btn secondary" id="cancelToolBtn">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="tool-btn primary" id="openToolBtn">
                    <i class="fas fa-external-link-alt"></i> Open Tool
                </button>
            </div>
        </div>
    </div>
    
    <!-- Payment Modal -->
    <div class="payment-modal" id="paymentModal">
        <div class="payment-modal-container">
            <div class="payment-modal-header">
                <h3 id="paymentModalTitle">Buy Credits</h3>
                <button class="add-friend-btn" id="closePaymentModal" style="background: rgba(255,255,255,0.2);">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="payment-tabs" id="paymentTabs">
                <button class="payment-tab active" data-tab="credits">Buy Credits</button>
                <button class="payment-tab" data-tab="subscription">Upgrade Plan</button>
                <button class="payment-tab" data-tab="affiliate">Affiliate</button>
                <button class="payment-tab" data-tab="consultation">Consultation</button>
            </div>
            
            <div class="payment-form" id="paymentForm">
                <!-- Payment forms will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification">
        <i class="fas fa-check-circle"></i>
        <span id="notificationText">Operation completed successfully</span>
    </div>

    <!-- Why MoodChat Section - MOVED OUTSIDE MAIN CONTENT TO BOTTOM -->
    <div class="why-moodchat" id="whyMoodchatSection">
        <h3>Why MoodChat?</h3>
        <p>Africa's first all-in-one chat + business platform built for African payments & connectivity. Offline-first, fast, and secure.</p>
        
        <div class="features-grid">
            <div class="feature-card">
                <div class="feature-icon">
                    <i class="fas fa-bolt"></i>
                </div>
                <h4>Offline-First</h4>
                <p>Works without internet, syncs when back online</p>
            </div>
            
            <div class="feature-card">
                <div class="feature-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <h4>Secure</h4>
                <p>Bank-level encryption for all transactions</p>
            </div>
            
            <div class="feature-card">
                <div class="feature-icon">
                    <i class="fas fa-hand-holding-usd"></i>
                </div>
                <h4>African Payments</h4>
                <p>Built for local payment methods</p>
            </div>
            
            <div class="feature-card">
                <div class="feature-icon">
                    <i class="fas fa-robot"></i>
                </div>
                <h4>AI-Powered</h4>
                <p>Smart tools that grow with your business</p>
            </div>
        </div>
    </div>
    
    <!-- CTA Card - MOVED TO BOTTOM -->
    <div class="cta-card" id="ctaSection">
        <h3>Start Earning With MoodChat</h3>
        <p>Join thousands of entrepreneurs growing their business with our platform. No coding required.</p>
        <div class="tool-actions" style="justify-content: center;">
            <button class="tool-btn success" style="padding: 12px 30px;">
                <i class="fas fa-rocket"></i> Get Started Free
            </button>
            <button class="tool-btn primary" style="padding: 12px 30px;">
                <i class="fas fa-play-circle"></i> Watch Demo
            </button>
        </div>
    </div>

    <script>
        // =============================================
        // COMPLETE BUSINESS HUB & TOOLS SYSTEM
        // =============================================

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDHHyGgsSV18BcXrGgzi4C8frzDAE1C1zo",
            authDomain: "uniconnect-ee95c.firebaseapp.com",
            projectId: "uniconnect-ee95c",
            storageBucket: "uniconnect-ee95c.firebasestorage.app",
            messagingSenderId: "1003264444309",
            appId: "1:1003264444309:web:9f0307516e44d21e97d89c"
        };
        
        // Initialize Firebase with error handling
        let firebaseInitialized = false;
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            firebaseInitialized = true;
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.log('Firebase initialization error (continuing offline):', error.message);
            // Continue without Firebase - offline mode
        }
        
        const db = firebaseInitialized ? firebase.firestore() : null;
        const auth = firebaseInitialized ? firebase.auth() : null;
        const storage = firebaseInitialized ? firebase.storage() : null;
        
        // Global variables
        let currentUser = null;
        let userData = null;
        let allTools = [];
        let filteredTools = [];
        let transactions = [];
        let currentTool = null;
        let currentCategory = 'all';
        let currentSearchTerm = '';
        let isOnline = navigator.onLine;
        let productivityChart = null;
        let offlineCheckInterval = null;
        let isLoadedFromLocalStorage = false;
        let currentPlan = 'free';
        let currentCredits = 0;
        let monthlyRevenue = 0;
        let aiUsage = 0;
        let productivityScore = 0;
        
        // Tool categories
        const toolCategories = {
            'ai': {
                name: 'AI Tools',
                icon: 'fas fa-robot',
                color: 'ai'
            },
            'business': {
                name: 'Business Tools',
                icon: 'fas fa-briefcase',
                color: 'business'
            },
            'productivity': {
                name: 'Productivity',
                icon: 'fas fa-chart-line',
                color: 'productivity'
            },
            'marketplace': {
                name: 'Marketplace',
                icon: 'fas fa-store',
                color: 'marketplace'
            },
            'premium': {
                name: 'Premium',
                icon: 'fas fa-crown',
                color: 'premium'
            }
        };
        
        // Subscription plans
        const subscriptionPlans = {
            'free': {
                name: 'Free',
                price: 0,
                credits: 5,
                features: [
                    'Basic AI tools',
                    '5 credits/month',
                    'Community support',
                    'Limited exports'
                ],
                color: 'var(--secondary-color)'
            },
            'basic': {
                name: 'Basic',
                price: 19,
                credits: 100,
                features: [
                    'All AI tools',
                    '100 credits/month',
                    'Email support',
                    'CSV exports',
                    'Basic analytics'
                ],
                color: 'var(--primary-color)'
            },
            'pro': {
                name: 'Pro',
                price: 49,
                credits: 500,
                features: [
                    'All AI & Business tools',
                    '500 credits/month',
                    'Priority support',
                    'Excel/PDF exports',
                    'Advanced analytics',
                    'Marketplace access'
                ],
                color: 'var(--premium-color)',
                popular: true
            },
            'business': {
                name: 'Business',
                price: 99,
                credits: 1000,
                features: [
                    'All tools + Premium',
                    '1000 credits/month',
                    '24/7 phone support',
                    'Unlimited exports',
                    'Custom integrations',
                    'Dedicated account manager',
                    'White-label options'
                ],
                color: 'var(--business-color)'
            }
        };
        
        // Credit packages
        const creditPackages = [
            { id: '100', amount: 100, price: 4.99, value: 'Standard', popular: false },
            { id: '500', amount: 500, price: 19.99, value: 'Most Popular', popular: true },
            { id: '1000', amount: 1000, price: 34.99, value: 'Best Value', popular: false },
            { id: '5000', amount: 5000, price: 149.99, value: 'Enterprise', popular: false }
        ];
        
        // Tool URL mapping - Updated with real tool paths
        const toolUrlMap = {
            'ai-content': '../tools/content-generator.html',
            'ai-image': '../tools/image-generator.html',
            'seo-analyzer': '../tools/seo-analyzer.html',
            'chatbot-builder': '../tools/chatbot-builder.html',
            'bulk-email': '../tools/email-sender.html',
            'predictive-analytics': '../tools/analytics.html',
            'invoice-generator': '../tools/invoice-generator.html',
            'payment-gateway': '../tools/payment-gateway.html',
            'crm-advanced': '../tools/crm.html',
            'data-export': '../tools/data-export.html',
            'social-scheduler': '../tools/social-scheduler.html',
            'analytics-dashboard': '../tools/analytics-dashboard.html',
            'ai-templates': '../tools/templates-marketplace.html',
            'analytics-addon': '../tools/advanced-analytics.html',
            'integration-plugin': '../tools/integrations.html',
            'video-editor': '../tools/video-editor.html'
        };
        
        // Marketplace items
        const marketplaceItems = [
            { id: 'sales-funnel', name: 'Sales Funnel Template', description: 'Complete sales funnel for e-commerce', price: '$49', category: 'template' },
            { id: 'email-campaign', name: 'Email Campaign Bundle', description: '10 ready-to-use email sequences', price: '$29', category: 'template' },
            { id: 'social-calendar', name: 'Social Media Calendar', description: '3-month content calendar', price: '$19', category: 'productivity' },
            { id: 'analytics-dash', name: 'Analytics Dashboard', description: 'Real-time business metrics', price: '$99', category: 'analytics' },
            { id: 'shopify-plugin', name: 'Shopify Integration', description: 'Connect with Shopify store', price: '$79', category: 'integration' },
            { id: 'zapier-connector', name: 'Zapier Connector', description: '500+ app integrations', price: '$59', category: 'integration' }
        ];
        
        // Consultation services
        const consultationServices = [
            { id: 'strategy', name: 'Strategy Session', duration: '1 hour', price: '$99', description: 'Business growth strategy consultation' },
            { id: 'ai-implementation', name: 'AI Implementation', duration: '2 hours', price: '$149', description: 'AI tools setup and training' },
            { id: 'marketing-audit', name: 'Marketing Audit', duration: '3 hours', price: '$249', description: 'Complete marketing strategy review' }
        ];
        
        // Pre-loaded tools data - EXPANDED with more tools
        const preloadedTools = [
            {
                id: 'ai-content',
                name: 'AI Content Generator',
                description: 'Generate marketing copy, blog posts, and social media content with advanced AI.',
                category: 'ai',
                icon: 'fas fa-feather-alt',
                price: 'Included',
                credits: 10,
                planRequired: 'basic',
                features: ['Blog posts', 'Social media', 'Ad copy', 'Product descriptions'],
                mostUsed: true,
                locked: false
            },
            {
                id: 'ai-image',
                name: 'AI Image Generator',
                description: 'Create stunning images from text descriptions for marketing and design.',
                category: 'ai',
                icon: 'fas fa-image',
                price: 'Included',
                credits: 20,
                planRequired: 'basic',
                features: ['Marketing images', 'Social media graphics', 'Product mockups', 'Art generation'],
                mostUsed: true,
                locked: false
            },
            {
                id: 'seo-analyzer',
                name: 'SEO Analyzer',
                description: 'Analyze website SEO performance and get optimization recommendations.',
                category: 'ai',
                icon: 'fas fa-search',
                price: 'Included',
                credits: 15,
                planRequired: 'pro',
                features: ['Keyword analysis', 'Backlink checker', 'Rank tracking', 'Optimization tips'],
                mostUsed: false,
                locked: false
            },
            {
                id: 'chatbot-builder',
                name: 'Chatbot Builder',
                description: 'Create AI-powered chatbots for customer service and lead generation.',
                category: 'ai',
                icon: 'fas fa-comments',
                price: 'Included',
                credits: 25,
                planRequired: 'business',
                features: ['No-code builder', 'Multi-language', 'Analytics', 'Integration'],
                mostUsed: false,
                locked: true
            },
            {
                id: 'bulk-email',
                name: 'Bulk Email Sender',
                description: 'Send email campaigns to up to 10,000 recipients with advanced analytics.',
                category: 'business',
                icon: 'fas fa-envelope',
                price: 'Included',
                credits: 50,
                planRequired: 'pro',
                features: ['10,000 recipients', 'A/B testing', 'Analytics', 'Automation'],
                mostUsed: false,
                locked: false
            },
            {
                id: 'predictive-analytics',
                name: 'Predictive Analytics',
                description: 'AI-powered sales forecasts and business trend predictions.',
                category: 'business',
                icon: 'fas fa-chart-bar',
                price: 'Included',
                credits: 100,
                planRequired: 'pro',
                features: ['Sales forecasts', 'Trend analysis', 'Risk assessment', 'Custom reports'],
                mostUsed: false,
                locked: false
            },
            {
                id: 'invoice-generator',
                name: 'Invoice Generator',
                description: 'Create professional invoices with automatic calculations and tracking.',
                category: 'business',
                icon: 'fas fa-file-invoice',
                price: 'Included',
                credits: 5,
                planRequired: 'basic',
                features: ['Custom templates', 'Auto-calculations', 'Payment tracking', 'Multi-currency'],
                mostUsed: false,
                locked: false
            },
            {
                id: 'payment-gateway',
                name: 'Payment Gateway',
                description: 'Accept online payments with multiple payment methods integration.',
                category: 'business',
                icon: 'fas fa-credit-card',
                price: 'Included',
                credits: 30,
                planRequired: 'business',
                features: ['Multiple methods', 'Secure processing', 'Real-time reports', 'Fraud detection'],
                mostUsed: false,
                locked: true
            },
            {
                id: 'crm-advanced',
                name: 'Advanced CRM',
                description: 'Customer relationship management with lead scoring and automation.',
                category: 'business',
                icon: 'fas fa-users',
                price: 'Included',
                credits: 150,
                planRequired: 'business',
                features: ['Lead scoring', 'Automation', 'Pipeline management', 'Team collaboration'],
                mostUsed: false,
                locked: true
            },
            {
                id: 'data-export',
                name: 'Data Export Tool',
                description: 'Export business data in CSV, Excel, and PDF formats with custom templates.',
                category: 'productivity',
                icon: 'fas fa-file-export',
                price: 'Included',
                credits: 30,
                planRequired: 'basic',
                features: ['Multiple formats', 'Custom templates', 'Scheduled exports', 'API access'],
                mostUsed: false,
                locked: false
            },
            {
                id: 'social-scheduler',
                name: 'Social Media Scheduler',
                description: 'Schedule posts across all social media platforms with analytics.',
                category: 'productivity',
                icon: 'fas fa-calendar',
                price: 'Included',
                credits: 20,
                planRequired: 'basic',
                features: ['Multi-platform', 'Bulk scheduling', 'Analytics', 'Content calendar'],
                mostUsed: false,
                locked: false
            },
            {
                id: 'analytics-dashboard',
                name: 'Analytics Dashboard',
                description: 'Real-time business analytics with customizable dashboards.',
                category: 'productivity',
                icon: 'fas fa-tachometer-alt',
                price: 'Included',
                credits: 40,
                planRequired: 'pro',
                features: ['Real-time data', 'Custom widgets', 'Export reports', 'Team sharing'],
                mostUsed: false,
                locked: false
            },
            {
                id: 'ai-templates',
                name: 'AI Templates Marketplace',
                description: 'Access ready-to-use templates for various business needs.',
                category: 'marketplace',
                icon: 'fas fa-clipboard-list',
                price: 'Free',
                credits: 0,
                planRequired: 'pro',
                features: ['100+ templates', 'Customizable', 'Community ratings', 'Regular updates'],
                mostUsed: false,
                locked: false
            },
            {
                id: 'analytics-addon',
                name: 'Advanced Analytics Add-on',
                description: 'Premium analytics with custom dashboards and real-time reporting.',
                category: 'premium',
                icon: 'fas fa-chart-pie',
                price: '$19.99/month',
                credits: 200,
                planRequired: 'business',
                features: ['Custom dashboards', 'Real-time data', 'Predictive insights', 'White-label'],
                mostUsed: false,
                locked: true
            },
            {
                id: 'integration-plugin',
                name: 'Integration Plugin',
                description: 'Connect with Shopify, Zapier, QuickBooks and other platforms.',
                category: 'premium',
                icon: 'fas fa-plug',
                price: '$24.99/month',
                credits: 250,
                planRequired: 'business',
                features: ['Multiple platforms', 'Real-time sync', 'Custom workflows', 'API builder'],
                mostUsed: false,
                locked: true
            },
            {
                id: 'video-editor',
                name: 'Video Editor Pro',
                description: 'Professional video editing with AI-powered enhancements.',
                category: 'premium',
                icon: 'fas fa-video',
                price: '$29.99/month',
                credits: 300,
                planRequired: 'business',
                features: ['AI enhancements', '4K support', 'Template library', 'Cloud storage'],
                mostUsed: false,
                locked: true
            }
        ];
        
        // DOM Elements
        const toolModal = document.getElementById('toolModal');
        const paymentModal = document.getElementById('paymentModal');
        const notification = document.getElementById('notification');
        const offlineOverlay = document.getElementById('offlineOverlay');
        const offlineIndicator = document.getElementById('offlineIndicator');
        const localStorageIndicator = document.getElementById('localStorageIndicator');
        const cacheIndicator = document.getElementById('cacheIndicator');
        const sidebar = document.getElementById('sidebar');
        const mobileOverlay = document.getElementById('mobileOverlay');
        const toolsGrid = document.getElementById('toolsGrid');
        const transactionsList = document.getElementById('transactionsList');
        const whyMoodchatSection = document.getElementById('whyMoodchatSection');
        const ctaSection = document.getElementById('ctaSection');
        
        // Storage Keys
        const STORAGE_KEYS = {
            // Local Storage
            LOCAL_USER: 'moodchat_current_user',
            LOCAL_TOOLS: 'moodchat_tools',
            LOCAL_TRANSACTIONS: 'moodchat_transactions',
            LOCAL_USER_DATA: 'moodchat_user_data',
            LOCAL_CREDITS: 'moodchat_user_credits',
            LOCAL_PLAN: 'moodchat_user_plan',
            LOCAL_LAST_SYNC: 'moodchat_tools_last_sync',
            LOCAL_OFFLINE_DISMISSED: 'moodchat_offline_overlay_dismissed',
            
            // Session Storage (for compatibility with index.html login)
            SESSION_USER: 'session_current_user',
            SESSION_TOKEN: 'session_auth_token',
            SESSION_USER_DATA: 'session_user_data'
        };
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });
        
        async function initializeApp() {
            // Initialize offline detection
            initializeOfflineDetection();
            
            // Check user authentication from multiple sources
            await checkUserAuthentication();
            
            // Load user data
            await loadUserData();
            
            // Load tools from cache
            await loadToolsFromCache();
            
            // Load transactions from cache
            await loadTransactionsFromCache();
            
            // Initialize productivity chart
            initializeProductivityChart();
            
            // Setup event listeners
            setupEventListeners();
            
            // Update UI
            updateUserDisplay();
            updateStatsDisplay();
            renderTools();
            renderTransactions();
            
            // Show notification
            showNotification('Business Hub ready. ' + (isOnline ? 'Online mode.' : 'Offline mode - using cached data.'), 'success');
            
            console.log('Business Hub initialized successfully');
        }
        
        async function checkUserAuthentication() {
            try {
                // Check multiple authentication sources in order of priority
                
                // 1. Check Firebase authentication (if initialized)
                if (firebaseInitialized && auth) {
                    await checkFirebaseAuth();
                }
                
                // 2. Check session storage (from index.html login)
                await checkSessionStorage();
                
                // 3. Check local storage
                await checkLocalStorage();
                
                // 4. Only create demo user if NO authentication source found
                if (!currentUser) {
                    console.log('No user found in any authentication source');
                    
                    // Check if we should create demo user (only if absolutely necessary)
                    const shouldCreateDemo = await shouldCreateDemoUser();
                    if (shouldCreateDemo) {
                        createDemoUser();
                    } else {
                        // Redirect to login
                        redirectToLogin();
                        return false;
                    }
                }
                
                return true;
                
            } catch (error) {
                console.error('Authentication error:', error);
                
                // Fallback to local storage
                const localUser = localStorage.getItem(STORAGE_KEYS.LOCAL_USER);
                if (localUser) {
                    currentUser = JSON.parse(localUser);
                    return true;
                }
                
                // Last resort: create demo user
                createDemoUser();
                return false;
            }
        }
        
        async function checkFirebaseAuth() {
            if (!firebaseInitialized || !auth) return;
            
            try {
                // Check Firebase auth state
                return new Promise((resolve) => {
                    auth.onAuthStateChanged(async (firebaseUser) => {
                        if (firebaseUser) {
                            currentUser = {
                                uid: firebaseUser.uid,
                                displayName: firebaseUser.displayName || 'User',
                                email: firebaseUser.email,
                                photoURL: firebaseUser.photoURL,
                                source: 'firebase'
                            };
                            
                            // Fetch user data from Firestore
                            await fetchUserDataFromFirestore();
                            
                            // Save to local storage for offline access
                            saveUserToLocalStorage();
                            
                            console.log('Firebase user authenticated:', currentUser.displayName);
                            resolve(true);
                        } else {
                            resolve(false);
                        }
                    });
                });
            } catch (error) {
                console.error('Firebase auth check error:', error);
                return false;
            }
        }
        
        async function checkSessionStorage() {
            try {
                const sessionUser = sessionStorage.getItem(STORAGE_KEYS.SESSION_USER);
                const sessionToken = sessionStorage.getItem(STORAGE_KEYS.SESSION_TOKEN);
                
                if (sessionUser && sessionToken) {
                    currentUser = JSON.parse(sessionUser);
                    currentUser.source = 'session';
                    
                    // Load session user data
                    const sessionData = sessionStorage.getItem(STORAGE_KEYS.SESSION_USER_DATA);
                    if (sessionData) {
                        userData = JSON.parse(sessionData);
                        currentPlan = userData.plan || 'free';
                        currentCredits = userData.credits || 0;
                        monthlyRevenue = userData.monthlyRevenue || 0;
                        aiUsage = userData.aiUsage || 0;
                        productivityScore = userData.productivityScore || 50;
                    }
                    
                    // Sync to local storage for persistence
                    saveUserToLocalStorage();
                    
                    console.log('Session user authenticated:', currentUser.displayName);
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Session storage check error:', error);
                return false;
            }
        }
        
        async function checkLocalStorage() {
            try {
                const localUser = localStorage.getItem(STORAGE_KEYS.LOCAL_USER);
                
                if (localUser) {
                    currentUser = JSON.parse(localUser);
                    currentUser.source = 'local';
                    
                    // Load local user data
                    await loadUserFromLocalStorage();
                    
                    console.log('Local storage user loaded:', currentUser.displayName);
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Local storage check error:', error);
                return false;
            }
        }
        
        async function shouldCreateDemoUser() {
            // Only create demo user if:
            // 1. We're in offline mode AND
            // 2. No user exists in any storage AND
            // 3. User is accessing tools page directly (not redirected from login)
            
            const urlParams = new URLSearchParams(window.location.search);
            const fromLogin = urlParams.get('fromLogin') === 'true';
            
            if (fromLogin) {
                return false; // User came from login, shouldn't create demo
            }
            
            if (!isOnline) {
                // Check all storage sources
                const hasSessionUser = sessionStorage.getItem(STORAGE_KEYS.SESSION_USER);
                const hasLocalUser = localStorage.getItem(STORAGE_KEYS.LOCAL_USER);
                
                if (!hasSessionUser && !hasLocalUser) {
                    return true; // Offline and no user found
                }
            }
            
            return false;
        }
        
        function redirectToLogin() {
            console.log('Redirecting to login page...');
            // In a real app, redirect to login
            // window.location.href = '../index.html?redirect=' + encodeURIComponent(window.location.pathname);
            
            // For now, create demo user to prevent redirect loop
            createDemoUser();
        }
        
        async function fetchUserDataFromFirestore() {
            if (!firebaseInitialized || !db || !currentUser) return;
            
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (userDoc.exists) {
                    userData = userDoc.data();
                    currentPlan = userData.plan || 'free';
                    currentCredits = userData.credits || 0;
                    monthlyRevenue = userData.monthlyRevenue || 0;
                    aiUsage = userData.aiUsage || 0;
                    productivityScore = userData.productivityScore || 50;
                    
                    // Save to local storage
                    saveUserDataToLocalStorage();
                    
                    console.log('User data loaded from Firestore');
                }
            } catch (error) {
                console.error('Error fetching user data from Firestore:', error);
                // Fallback to local storage
                await loadUserFromLocalStorage();
            }
        }
        
        function createDemoUser() {
            console.log('Creating demo user for offline access');
            
            currentUser = {
                uid: 'demo_user_' + Date.now(),
                displayName: 'Demo User',
                email: 'demo@moodchat.com',
                photoURL: '',
                source: 'demo'
            };
            
            userData = {
                plan: 'free',
                credits: 5,
                monthlyRevenue: 0,
                aiUsage: 0,
                productivityScore: 50
            };
            
            currentPlan = 'free';
            currentCredits = 5;
            monthlyRevenue = 0;
            aiUsage = 0;
            productivityScore = 50;
            
            // Save to storage
            saveUserToLocalStorage();
            saveUserDataToLocalStorage();
            
            console.log('Demo user created for offline access');
        }
        
        async function loadUserData() {
            try {
                // Try to load from local storage first
                await loadUserFromLocalStorage();
                
                // If no user data, check session storage
                if (!currentUser) {
                    await checkSessionStorage();
                }
                
                // Set user avatar initials
                const userAvatar = document.getElementById('userAvatar');
                if (userAvatar && currentUser) {
                    const initials = currentUser.displayName 
                        ? currentUser.displayName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2)
                        : 'DU';
                    userAvatar.textContent = initials;
                }
                
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }
        
        async function loadUserFromLocalStorage() {
            try {
                const cachedUser = localStorage.getItem(STORAGE_KEYS.LOCAL_USER);
                if (cachedUser) {
                    currentUser = JSON.parse(cachedUser);
                }
                
                // Load user data
                const cachedData = localStorage.getItem(STORAGE_KEYS.LOCAL_USER_DATA);
                if (cachedData) {
                    userData = JSON.parse(cachedData);
                    currentPlan = userData.plan || 'free';
                    currentCredits = userData.credits || 0;
                    monthlyRevenue = userData.monthlyRevenue || 0;
                    aiUsage = userData.aiUsage || 0;
                    productivityScore = userData.productivityScore || 50;
                }
                
                // Load credits and plan
                const savedCredits = localStorage.getItem(STORAGE_KEYS.LOCAL_CREDITS);
                if (savedCredits) {
                    currentCredits = parseInt(savedCredits);
                }
                
                const savedPlan = localStorage.getItem(STORAGE_KEYS.LOCAL_PLAN);
                if (savedPlan) {
                    currentPlan = savedPlan;
                }
                
            } catch (error) {
                console.error('Error loading user from local storage:', error);
            }
        }
        
        async function loadToolsFromCache() {
            try {
                const cachedTools = localStorage.getItem(STORAGE_KEYS.LOCAL_TOOLS);
                if (cachedTools) {
                    allTools = JSON.parse(cachedTools);
                    isLoadedFromLocalStorage = true;
                    console.log('Loaded tools from cache:', allTools.length);
                } else {
                    // Use preloaded tools if no cache
                    allTools = preloadedTools;
                    saveToolsToLocalStorage();
                }
                
                // Apply current plan to determine locked status
                updateToolLockStatus();
                
            } catch (error) {
                console.error('Error loading tools from cache:', error);
                allTools = preloadedTools;
            }
        }
        
        async function loadTransactionsFromCache() {
            try {
                const cachedTransactions = localStorage.getItem(STORAGE_KEYS.LOCAL_TRANSACTIONS);
                if (cachedTransactions) {
                    transactions = JSON.parse(cachedTransactions);
                    console.log('Loaded transactions from cache:', transactions.length);
                } else {
                    // Generate sample transactions
                    generateSampleTransactions();
                }
                
            } catch (error) {
                console.error('Error loading transactions from cache:', error);
                generateSampleTransactions();
            }
        }
        
        function generateSampleTransactions() {
            transactions = [
                { id: '1', type: 'credit_purchase', title: 'Credit Purchase', amount: '$19.99', date: new Date().toISOString().split('T')[0], status: 'completed' },
                { id: '2', type: 'tool_usage', title: 'AI Content Generator', amount: '-10 credits', date: new Date(Date.now() - 86400000).toISOString().split('T')[0], status: 'completed' },
                { id: '3', type: 'affiliate_earning', title: 'Affiliate Commission', amount: '$24.50', date: new Date(Date.now() - 172800000).toISOString().split('T')[0], status: 'completed' },
                { id: '4', type: 'subscription', title: 'Pro Plan Renewal', amount: '$49.00', date: new Date(Date.now() - 259200000).toISOString().split('T')[0], status: 'completed' }
            ];
            
            saveTransactionsToLocalStorage();
        }
        
        function saveUserToLocalStorage() {
            try {
                if (currentUser) {
                    localStorage.setItem(STORAGE_KEYS.LOCAL_USER, JSON.stringify(currentUser));
                }
            } catch (error) {
                console.error('Error saving user to local storage:', error);
            }
        }
        
        function saveUserDataToLocalStorage() {
            try {
                localStorage.setItem(STORAGE_KEYS.LOCAL_CREDITS, currentCredits.toString());
                localStorage.setItem(STORAGE_KEYS.LOCAL_PLAN, currentPlan);
                
                if (!userData) {
                    userData = {
                        plan: currentPlan,
                        credits: currentCredits,
                        monthlyRevenue: monthlyRevenue,
                        aiUsage: aiUsage,
                        productivityScore: productivityScore
                    };
                } else {
                    userData.plan = currentPlan;
                    userData.credits = currentCredits;
                    userData.monthlyRevenue = monthlyRevenue;
                    userData.aiUsage = aiUsage;
                    userData.productivityScore = productivityScore;
                }
                
                localStorage.setItem(STORAGE_KEYS.LOCAL_USER_DATA, JSON.stringify(userData));
                
            } catch (error) {
                console.error('Error saving user data to local storage:', error);
            }
        }
        
        function saveToolsToLocalStorage() {
            try {
                localStorage.setItem(STORAGE_KEYS.LOCAL_TOOLS, JSON.stringify(allTools));
            } catch (error) {
                console.error('Error saving tools to local storage:', error);
            }
        }
        
        function saveTransactionsToLocalStorage() {
            try {
                localStorage.setItem(STORAGE_KEYS.LOCAL_TRANSACTIONS, JSON.stringify(transactions));
            } catch (error) {
                console.error('Error saving transactions to local storage:', error);
            }
        }
        
        function initializeOfflineDetection() {
            updateOnlineStatus();
            
            window.addEventListener('online', handleOnline);
            window.addEventListener('offline', handleOffline);
            
            offlineCheckInterval = setInterval(checkConnectivity, 30000);
            
            updateUIForConnectivity();
        }
        
        function updateOnlineStatus() {
            isOnline = navigator.onLine;
            console.log('Network status:', isOnline ? 'Online' : 'Offline');
        }
        
        function handleOnline() {
            console.log('App is now online');
            isOnline = true;
            
            updateUIForConnectivity();
            
            // Hide offline indicators
            offlineIndicator.classList.remove('active');
            localStorageIndicator.classList.remove('active');
            cacheIndicator.style.display = 'none';
            offlineOverlay.classList.remove('active');
            
            // Enable online features
            enableOnlineFeatures();
            
            // Sync with server
            trySyncWithServer();
            
            showNotification('You are back online. Syncing data...', 'success');
        }
        
        function handleOffline() {
            console.log('App is now offline');
            isOnline = false;
            
            // Show offline indicators
            offlineIndicator.classList.add('active');
            cacheIndicator.style.display = 'flex';
            
            // Update UI for offline mode
            updateUIForOfflineMode();
            
            // Check offline overlay
            checkOfflineOverlay();
            
            // Show local storage indicator if loaded from cache
            if (isLoadedFromLocalStorage) {
                localStorageIndicator.classList.add('active');
                setTimeout(() => {
                    localStorageIndicator.classList.remove('active');
                }, 5000);
            }
            
            showNotification('You are offline. Using cached data.', 'warning');
        }
        
        function checkOfflineOverlay() {
            const overlayDismissed = localStorage.getItem(STORAGE_KEYS.LOCAL_OFFLINE_DISMISSED);
            
            if (overlayDismissed === 'true') {
                offlineOverlay.classList.remove('active');
            } else {
                offlineOverlay.classList.add('active');
            }
        }
        
        function dismissOfflineOverlay() {
            offlineOverlay.classList.remove('active');
            localStorage.setItem(STORAGE_KEYS.LOCAL_OFFLINE_DISMISSED, 'true');
            cacheIndicator.style.display = 'flex';
        }
        
        function checkConnectivity() {
            fetch('https://www.google.com/favicon.ico', { 
                mode: 'no-cors',
                cache: 'no-cache'
            })
            .then(() => {
                if (!isOnline) handleOnline();
            })
            .catch(() => {
                if (isOnline) handleOffline();
            });
        }
        
        function updateUIForConnectivity() {
            if (!isOnline) {
                updateUIForOfflineMode();
            } else {
                updateUIForOnlineMode();
            }
        }
        
        function updateUIForOfflineMode() {
            offlineIndicator.classList.add('active');
            cacheIndicator.style.display = 'flex';
            
            // Update tool buttons for offline mode
            document.querySelectorAll('.tool-btn').forEach(btn => {
                if (btn.classList.contains('primary') && !btn.id.includes('open')) {
                    btn.disabled = true;
                    btn.title = 'Requires internet connection';
                }
            });
        }
        
        function updateUIForOnlineMode() {
            offlineIndicator.classList.remove('active');
            localStorageIndicator.classList.remove('active');
            cacheIndicator.style.display = 'none';
            offlineOverlay.classList.remove('active');
            
            // Enable tool buttons
            document.querySelectorAll('.tool-btn').forEach(btn => {
                if (btn.disabled && btn.title === 'Requires internet connection') {
                    btn.disabled = false;
                    btn.title = '';
                }
            });
        }
        
        function enableOnlineFeatures() {
            // Update tool lock status based on plan
            updateToolLockStatus();
            
            // Refresh data if needed
            if (firebaseInitialized) {
                // In a real app, you would fetch from Firebase here
                console.log('Online features enabled');
            }
        }
        
        async function trySyncWithServer() {
            if (!isOnline || !firebaseInitialized) return;
            
            try {
                console.log('Syncing with server...');
                
                // Simulate server sync
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Update last sync timestamp
                localStorage.setItem(STORAGE_KEYS.LOCAL_LAST_SYNC, Date.now().toString());
                
                console.log('Sync completed');
                
            } catch (error) {
                console.error('Error syncing with server:', error);
            }
        }
        
        function initializeProductivityChart() {
            const ctx = document.getElementById('productivityChart').getContext('2d');
            
            productivityChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [productivityScore, 100 - productivityScore],
                        backgroundColor: [
                            'rgba(52, 199, 89, 0.8)',
                            'rgba(221, 223, 226, 0.3)'
                        ],
                        borderWidth: 0,
                        borderRadius: 10
                    }]
                },
                options: {
                    cutout: '70%',
                    responsive: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: false
                        }
                    }
                }
            });
        }
        
        function updateUserDisplay() {
            document.getElementById('userName').textContent = currentUser?.displayName || 'User';
            document.getElementById('userPlan').textContent = subscriptionPlans[currentPlan].name + ' Plan';
            document.getElementById('userCredits').textContent = currentCredits + ' credits';
            document.getElementById('currentCredits').textContent = currentCredits;
        }
        
        function updateStatsDisplay() {
            document.getElementById('monthlyRevenue').textContent = '$' + monthlyRevenue.toLocaleString();
            document.getElementById('availableCredits').textContent = currentCredits.toLocaleString();
            document.getElementById('aiUsage').textContent = aiUsage.toLocaleString();
            document.getElementById('productivityScore').textContent = productivityScore + '%';
            
            // Update productivity chart
            if (productivityChart) {
                productivityChart.data.datasets[0].data = [productivityScore, 100 - productivityScore];
                productivityChart.update();
            }
        }
        
        function renderTools() {
            toolsGrid.innerHTML = '';
            
            // Filter tools based on category
            filteredTools = allTools.filter(tool => {
                // Category filter
                if (currentCategory !== 'all' && tool.category !== currentCategory) {
                    return false;
                }
                
                return true;
            });
            
            if (filteredTools.length === 0) {
                toolsGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                        <i class="fas fa-tools" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                        <p>No tools found in this category</p>
                        <p class="subtext">Try selecting a different category</p>
                    </div>
                `;
                return;
            }
            
            filteredTools.forEach(tool => {
                const toolCard = document.createElement('div');
                toolCard.className = `tool-card ${tool.category}-tool ${tool.locked ? 'locked' : ''} ${tool.planRequired === 'business' ? 'business' : ''}`;
                
                const categoryInfo = toolCategories[tool.category];
                const planInfo = subscriptionPlans[tool.planRequired];
                
                toolCard.innerHTML = `
                    ${tool.mostUsed ? '<div class="most-used-badge"><i class="fas fa-fire"></i> Most Used</div>' : ''}
                    ${tool.locked ? '<div class="tool-lock"><i class="fas fa-lock"></i></div>' : ''}
                    
                    <div class="tool-icon">
                        <i class="${tool.icon}"></i>
                    </div>
                    
                    <div class="tool-card-header">
                        <div class="tool-category-badge ${categoryInfo.color}-badge">
                            <i class="${categoryInfo.icon}"></i>
                            ${categoryInfo.name}
                        </div>
                        ${tool.planRequired !== 'free' ? `
                        <div class="tool-plan-required">
                            <i class="fas fa-crown" style="color: ${planInfo.color}"></i>
                            ${planInfo.name} Plan
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="tool-title">${tool.name}</div>
                    <div class="tool-description">${tool.description}</div>
                    
                    <div class="tool-pricing">
                        <div class="tool-price">${tool.price}</div>
                        ${tool.credits > 0 ? `<div class="tool-credits">${tool.credits} credits</div>` : ''}
                    </div>
                    
                    <div class="tool-actions">
                        <button class="tool-btn secondary" data-action="details" ${!isOnline ? 'disabled' : ''}>
                            <i class="fas fa-info-circle"></i> Details
                        </button>
                        <button class="tool-btn primary" data-action="open" ${tool.locked || !isOnline ? 'disabled' : ''}>
                            <i class="fas fa-play"></i> Open
                        </button>
                    </div>
                `;
                
                // Add event listeners
                const detailsBtn = toolCard.querySelector('[data-action="details"]');
                const openBtn = toolCard.querySelector('[data-action="open"]');
                
                detailsBtn.addEventListener('click', () => {
                    showToolDetails(tool);
                });
                
                openBtn.addEventListener('click', () => {
                    if (tool.locked) {
                        showUpgradeModal(tool);
                    } else {
                        openTool(tool);
                    }
                });
                
                // Add tool data attribute
                toolCard.dataset.toolId = tool.id;
                
                toolsGrid.appendChild(toolCard);
            });
        }
        
        function renderTransactions() {
            transactionsList.innerHTML = '';
            
            if (transactions.length === 0) {
                transactionsList.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                        <i class="fas fa-receipt" style="font-size: 24px; margin-bottom: 15px;"></i>
                        <p>No transactions yet</p>
                    </div>
                `;
                return;
            }
            
            transactions.slice(0, 10).forEach(transaction => {
                const transactionItem = document.createElement('div');
                transactionItem.className = 'transaction-item';
                
                let icon = 'fas fa-exchange-alt';
                let iconColor = 'var(--info-color)';
                
                switch(transaction.type) {
                    case 'credit_purchase':
                        icon = 'fas fa-coins';
                        iconColor = 'var(--warning-color)';
                        break;
                    case 'tool_usage':
                        icon = 'fas fa-toolbox';
                        iconColor = 'var(--primary-color)';
                        break;
                    case 'affiliate_earning':
                        icon = 'fas fa-hand-holding-usd';
                        iconColor = 'var(--success-color)';
                        break;
                    case 'subscription':
                        icon = 'fas fa-crown';
                        iconColor = 'var(--premium-color)';
                        break;
                    case 'marketplace':
                        icon = 'fas fa-store';
                        iconColor = 'var(--business-color)';
                        break;
                    case 'consultation':
                        icon = 'fas fa-user-tie';
                        iconColor = 'var(--info-color)';
                        break;
                }
                
                transactionItem.innerHTML = `
                    <div class="transaction-icon" style="background-color: ${iconColor}20; color: ${iconColor};">
                        <i class="${icon}"></i>
                    </div>
                    <div class="transaction-details">
                        <div class="transaction-title">${transaction.title}</div>
                        <div class="transaction-meta">
                            <span>${formatDate(transaction.date)}</span>
                            <span class="transaction-amount ${transaction.amount.startsWith('$') ? 'income' : 'expense'}">${transaction.amount}</span>
                        </div>
                    </div>
                `;
                
                transactionsList.appendChild(transactionItem);
            });
        }
        
        function showToolDetails(tool) {
            currentTool = tool;
            
            const categoryInfo = toolCategories[tool.category];
            const planInfo = subscriptionPlans[tool.planRequired];
            
            document.getElementById('toolModalTitle').innerHTML = `
                <i class="${tool.icon}"></i>
                <span>${tool.name}</span>
            `;
            
            const isLocked = tool.locked;
            const canOpen = !isLocked && currentCredits >= tool.credits;
            
            document.getElementById('toolModalContent').innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div class="tool-category-badge ${categoryInfo.color}-badge" style="display: inline-block;">
                        <i class="${categoryInfo.icon}"></i>
                        ${categoryInfo.name}
                    </div>
                    
                    ${tool.planRequired !== 'free' ? `
                    <div class="tool-plan-required" style="display: inline-block; margin-left: 10px;">
                        <i class="fas fa-crown" style="color: ${planInfo.color}"></i>
                        ${planInfo.name} Plan Required
                    </div>
                    ` : ''}
                </div>
                
                <p style="margin-bottom: 20px; color: var(--text-secondary); line-height: 1.6;">${tool.description}</p>
                
                <div class="tool-features">
                    <h4 style="margin-bottom: 15px;">Features</h4>
                    ${tool.features.map(feature => `
                        <div class="feature-item">
                            <i class="fas fa-check-circle" style="color: var(--success-color);"></i>
                            <span>${feature}</span>
                        </div>
                    `).join('')}
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0; padding: 15px; background-color: var(--secondary-color); border-radius: 12px;">
                    <div>
                        <div style="font-size: 24px; font-weight: 700;">${tool.price}</div>
                        ${tool.credits > 0 ? `<div style="font-size: 14px; color: var(--text-secondary);">${tool.credits} credits per use</div>` : ''}
                    </div>
                    
                    <div>
                        <div style="font-size: 16px; font-weight: 600;">Your Credits: ${currentCredits}</div>
                        ${tool.credits > 0 ? `
                        <div style="font-size: 14px; color: ${currentCredits >= tool.credits ? 'var(--success-color)' : 'var(--danger-color)'}">
                            ${currentCredits >= tool.credits ? 'âœ“ Sufficient credits' : 'âœ— Insufficient credits'}
                        </div>
                        ` : ''}
                    </div>
                </div>
                
                ${isLocked ? `
                <div style="padding: 15px; background-color: rgba(255, 59, 48, 0.1); border-radius: 12px; border-left: 4px solid var(--danger-color); margin: 20px 0;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-lock" style="color: var(--danger-color);"></i>
                        <div>
                            <div style="font-weight: 600; color: var(--danger-color);">Tool Locked</div>
                            <div style="font-size: 14px; color: var(--text-secondary);">
                                Upgrade to ${planInfo.name} Plan to access this tool
                            </div>
                        </div>
                    </div>
                </div>
                ` : ''}
                
                ${!isLocked && tool.credits > 0 && currentCredits < tool.credits ? `
                <div style="padding: 15px; background-color: rgba(255, 149, 0, 0.1); border-radius: 12px; border-left: 4px solid var(--warning-color); margin: 20px 0;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-exclamation-triangle" style="color: var(--warning-color);"></i>
                        <div>
                            <div style="font-weight: 600; color: var(--warning-color);">Insufficient Credits</div>
                            <div style="font-size: 14px; color: var(--text-secondary);">
                                You need ${tool.credits - currentCredits} more credits to use this tool
                            </div>
                        </div>
                    </div>
                </div>
                ` : ''}
            `;
            
            // Update open button text based on availability
            const openBtn = document.getElementById('openToolBtn');
            if (isLocked) {
                openBtn.innerHTML = '<i class="fas fa-crown"></i> Upgrade to Unlock';
                openBtn.classList.remove('primary');
                openBtn.classList.add('success');
            } else if (!canOpen) {
                openBtn.innerHTML = '<i class="fas fa-coins"></i> Buy Credits';
                openBtn.classList.remove('primary');
                openBtn.classList.add('warning');
            } else {
                openBtn.innerHTML = '<i class="fas fa-external-link-alt"></i> Open Tool';
                openBtn.classList.remove('success', 'warning');
                openBtn.classList.add('primary');
            }
            
            toolModal.classList.add('active');
        }
        
        function openTool(tool) {
            if (tool.locked) {
                showUpgradeModal(tool);
                return;
            }
            
            // Check credits
            if (tool.credits > 0 && currentCredits < tool.credits) {
                showNotification(`Insufficient credits. You need ${tool.credits} credits to use this tool.`, 'error');
                showPaymentModal('credits');
                return;
            }
            
            // Deduct credits
            if (tool.credits > 0) {
                currentCredits -= tool.credits;
                updateCreditsDisplay();
                
                // Add transaction
                transactions.unshift({
                    id: 't' + Date.now(),
                    type: 'tool_usage',
                    title: tool.name,
                    amount: `-${tool.credits} credits`,
                    date: new Date().toISOString().split('T')[0],
                    status: 'completed'
                });
                
                saveTransactionsToLocalStorage();
                saveUserDataToLocalStorage();
                
                // Update productivity score
                productivityScore = Math.min(100, productivityScore + 1);
                updateStatsDisplay();
                
                showNotification(`Tool opened. ${tool.credits} credits deducted.`, 'success');
            }
            
            // Record AI usage
            if (tool.category === 'ai') {
                aiUsage++;
                updateStatsDisplay();
            }
            
            // Get tool URL - check if it exists
            const toolUrl = getToolUrl(tool.id);
            
            document.getElementById('toolModalContent').innerHTML = `
                <div class="tool-iframe-container">
                    <iframe src="${toolUrl}" class="tool-iframe" frameborder="0" allow="fullscreen"></iframe>
                </div>
            `;
            
            // Update button to close instead of open
            const openBtn = document.getElementById('openToolBtn');
            openBtn.innerHTML = '<i class="fas fa-times"></i> Close Tool';
            openBtn.onclick = () => {
                toolModal.classList.remove('active');
                showToolDetails(tool); // Reset to details view
            };
            
            // Update modal header
            document.getElementById('toolModalTitle').innerHTML = `
                <i class="${tool.icon}"></i>
                <span>${tool.name} - Running</span>
            `;
            
            renderTransactions();
        }
        
        function getToolUrl(toolId) {
            // Check if tool exists in mapping
            if (toolUrlMap[toolId]) {
                return toolUrlMap[toolId];
            }
            
            // Fallback to placeholder
            return `../tools/placeholder.html?tool=${toolId}`;
        }
        
        function showUpgradeModal(tool) {
            showPaymentModal('subscription');
        }
        
        function showPaymentModal(tab = 'credits') {
            paymentModal.classList.add('active');
            
            // Set active tab
            document.querySelectorAll('.payment-tab').forEach(t => {
                t.classList.remove('active');
                if (t.dataset.tab === tab) {
                    t.classList.add('active');
                }
            });
            
            loadPaymentTab(tab);
        }
        
        function loadPaymentTab(tab) {
            const paymentForm = document.getElementById('paymentForm');
            
            switch(tab) {
                case 'credits':
                    paymentForm.innerHTML = `
                        <h4 style="margin-bottom: 15px; text-align: center; font-size: 18px;">Buy Credits</h4>
                        
                        <div class="credit-packages">
                            ${creditPackages.map(pkg => `
                                <div class="credit-package ${pkg.popular ? 'popular' : ''}" data-package="${pkg.id}">
                                    ${pkg.popular ? '<div class="popular-badge">Most Popular</div>' : ''}
                                    <div class="package-amount">${pkg.amount} credits</div>
                                    <div class="package-price">$${pkg.price}</div>
                                    <div class="package-value">${pkg.value}</div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Payment Method</label>
                            <div class="payment-methods">
                                <div class="payment-method selected" data-method="card">
                                    <div class="payment-method-icon">
                                        <i class="far fa-credit-card"></i>
                                    </div>
                                    <div>Credit Card</div>
                                </div>
                                <div class="payment-method" data-method="paypal">
                                    <div class="payment-method-icon">
                                        <i class="fab fa-paypal"></i>
                                    </div>
                                    <div>PayPal</div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="cardPaymentForm" style="display: block;">
                            <div class="form-group">
                                <label class="form-label">Card Number</label>
                                <input type="text" class="form-input" placeholder="1234 5678 9012 3456" maxlength="19">
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Expiry Date</label>
                                    <input type="text" class="form-input" placeholder="MM/YY">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">CVV</label>
                                    <input type="text" class="form-input" placeholder="123" maxlength="4">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Cardholder Name</label>
                                <input type="text" class="form-input" placeholder="${currentUser?.displayName || 'Your Name'}">
                            </div>
                        </div>
                        
                        <div id="paypalPaymentForm" style="display: none;">
                            <div style="text-align: center; padding: 15px;">
                                <i class="fab fa-paypal" style="font-size: 40px; color: #003087; margin-bottom: 12px;"></i>
                                <p style="font-size: 14px;">You will be redirected to PayPal to complete your payment</p>
                            </div>
                        </div>
                        
                        <div class="secure-badge">
                            <i class="fas fa-shield-alt"></i>
                            <span>Secured by Stripe â€¢ All transactions are secure</span>
                        </div>
                        
                        <div style="margin-top: 20px; display: flex; justify-content: space-between;">
                            <button class="tool-btn secondary" id="cancelPaymentBtn" style="padding: 8px 15px;">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                            <button class="tool-btn success" id="confirmPaymentBtn" style="padding: 8px 15px;">
                                <i class="fas fa-lock"></i> Pay Now
                            </button>
                        </div>
                    `;
                    
                    // Add event listeners for credit packages
                    document.querySelectorAll('.credit-package').forEach(pkg => {
                        pkg.addEventListener('click', function() {
                            document.querySelectorAll('.credit-package').forEach(p => {
                                p.classList.remove('selected');
                            });
                            this.classList.add('selected');
                        });
                    });
                    
                    // Add event listeners for payment methods
                    document.querySelectorAll('.payment-method').forEach(method => {
                        method.addEventListener('click', function() {
                            document.querySelectorAll('.payment-method').forEach(m => {
                                m.classList.remove('selected');
                            });
                            this.classList.add('selected');
                            
                            const methodType = this.dataset.method;
                            document.getElementById('cardPaymentForm').style.display = methodType === 'card' ? 'block' : 'none';
                            document.getElementById('paypalPaymentForm').style.display = methodType === 'paypal' ? 'block' : 'none';
                        });
                    });
                    
                    // Set first package as selected
                    document.querySelector('.credit-package').classList.add('selected');
                    break;
                    
                case 'subscription':
                    paymentForm.innerHTML = `
                        <h4 style="margin-bottom: 15px; text-align: center; font-size: 18px;">Upgrade Your Plan</h4>
                        
                        <div class="subscription-plans">
                            ${Object.entries(subscriptionPlans).map(([key, plan]) => `
                                <div class="subscription-plan ${plan.popular ? 'popular' : ''} ${key === currentPlan ? 'selected' : ''}" data-plan="${key}">
                                    <div class="plan-name">${plan.name}</div>
                                    <div class="plan-price">$${plan.price}<span style="font-size: 14px;">/${plan.price === 0 ? 'forever' : 'month'}</span></div>
                                    <div class="plan-period">${plan.credits} credits/month</div>
                                    
                                    <div class="plan-features">
                                        ${plan.features.map(feature => `
                                            <div class="plan-feature">
                                                <i class="fas fa-check"></i>
                                                <span>${feature}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                    
                                    ${key === currentPlan ? `
                                    <button class="tool-btn secondary" style="width: 100%; padding: 8px;" disabled>
                                        <i class="fas fa-check"></i> Current Plan
                                    </button>
                                    ` : `
                                    <button class="tool-btn ${plan.popular ? 'success' : 'primary'}" style="width: 100%; padding: 8px;" data-upgrade="${key}">
                                        <i class="fas fa-arrow-up"></i> ${plan.price === 0 ? 'Downgrade' : 'Upgrade'}
                                    </button>
                                    `}
                                </div>
                            `).join('')}
                        </div>
                        
                        <div style="margin-top: 20px; text-align: center;">
                            <button class="tool-btn secondary" id="cancelPaymentBtn" style="padding: 8px 15px;">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    `;
                    
                    // Add event listeners for subscription plans
                    document.querySelectorAll('.subscription-plan').forEach(plan => {
                        const upgradeBtn = plan.querySelector('[data-upgrade]');
                        if (upgradeBtn) {
                            upgradeBtn.addEventListener('click', function() {
                                const planKey = this.dataset.upgrade;
                                upgradePlan(planKey);
                            });
                        }
                    });
                    break;
                    
                case 'affiliate':
                    paymentForm.innerHTML = `
                        <h4 style="margin-bottom: 15px; text-align: center; font-size: 18px;">Affiliate Program</h4>
                        
                        <div class="affiliate-stats">
                            <div class="affiliate-stat">
                                <div class="affiliate-stat-value">$245.50</div>
                                <div class="affiliate-stat-label">Total Earnings</div>
                            </div>
                            <div class="affiliate-stat">
                                <div class="affiliate-stat-value">12</div>
                                <div class="affiliate-stat-label">Referrals</div>
                            </div>
                            <div class="affiliate-stat">
                                <div class="affiliate-stat-value">30%</div>
                                <div class="affiliate-stat-label">Commission</div>
                            </div>
                            <div class="affiliate-stat">
                                <div class="affiliate-stat-value">$89.50</div>
                                <div class="affiliate-stat-label">Pending</div>
                            </div>
                        </div>
                        
                        <div class="affiliate-link-container">
                            <h5 style="margin-bottom: 8px; font-size: 14px;">Your Referral Link</h5>
                            <div class="affiliate-link">
                                <input type="text" class="affiliate-link-input" value="https://moodchat.com/ref/${currentUser?.uid || 'demo123'}" readonly>
                                <button class="tool-btn primary" id="copyAffiliateLink" style="padding: 8px 12px;">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <h5 style="margin-bottom: 8px; font-size: 14px;">Payout Request</h5>
                            <div class="form-group">
                                <label class="form-label">Amount (Min: $50)</label>
                                <input type="number" class="form-input" id="payoutAmount" value="50" min="50" max="245.50" step="0.01">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Payment Method</label>
                                <select class="form-input">
                                    <option>Bank Transfer</option>
                                    <option>PayPal</option>
                                    <option>Mobile Money</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px; display: flex; justify-content: space-between;">
                            <button class="tool-btn secondary" id="cancelPaymentBtn" style="padding: 8px 15px;">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                            <button class="tool-btn success" id="requestPayoutBtn" style="padding: 8px 15px;">
                                <i class="fas fa-money-check-alt"></i> Request Payout
                            </button>
                        </div>
                    `;
                    
                    // Add event listeners for affiliate tab
                    document.getElementById('copyAffiliateLink').addEventListener('click', function() {
                        const linkInput = document.querySelector('.affiliate-link-input');
                        linkInput.select();
                        document.execCommand('copy');
                        showNotification('Referral link copied to clipboard', 'success');
                    });
                    
                    document.getElementById('requestPayoutBtn').addEventListener('click', function() {
                        const amount = document.getElementById('payoutAmount').value;
                        showNotification(`Payout request for $${amount} submitted`, 'success');
                        paymentModal.classList.remove('active');
                    });
                    break;
                    
                case 'consultation':
                    paymentForm.innerHTML = `
                        <h4 style="margin-bottom: 15px; text-align: center; font-size: 18px;">Book Expert Consultation</h4>
                        
                        <div class="consultation-cards">
                            ${consultationServices.map(service => `
                                <div class="consultation-card" data-service="${service.id}">
                                    <div class="consultation-title">${service.name}</div>
                                    <div class="consultation-price">${service.price}</div>
                                    <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">
                                        <i class="fas fa-clock"></i> ${service.duration}
                                    </div>
                                    <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 15px;">${service.description}</p>
                                    <button class="tool-btn primary" style="width: 100%; padding: 8px;" data-book="${service.id}">
                                        <i class="fas fa-calendar-check"></i> Book Now
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div style="margin-top: 20px; text-align: center;">
                            <button class="tool-btn secondary" id="cancelPaymentBtn" style="padding: 8px 15px;">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    `;
                    
                    // Add event listeners for consultation booking
                    document.querySelectorAll('[data-book]').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const serviceId = this.dataset.book;
                            const service = consultationServices.find(s => s.id === serviceId);
                            bookConsultation(service);
                        });
                    });
                    break;
            }
            
            // Add cancel button event listener
            const cancelBtn = document.getElementById('cancelPaymentBtn');
            if (cancelBtn) {
                cancelBtn.addEventListener('click', () => {
                    paymentModal.classList.remove('active');
                });
            }
            
            // Add confirm payment button event listener (for credits tab)
            const confirmBtn = document.getElementById('confirmPaymentBtn');
            if (confirmBtn) {
                confirmBtn.addEventListener('click', processPayment);
            }
        }
        
        function processPayment() {
            const selectedPackage = document.querySelector('.credit-package.selected');
            if (!selectedPackage) {
                showNotification('Please select a credit package', 'error');
                return;
            }
            
            const packageId = selectedPackage.dataset.package;
            const selectedPackageData = creditPackages.find(p => p.id === packageId);
            
            // Simulate payment processing
            showNotification('Processing payment...', 'info');
            
            setTimeout(() => {
                // Add credits
                currentCredits += selectedPackageData.amount;
                updateCreditsDisplay();
                
                // Add transaction
                transactions.unshift({
                    id: 'p' + Date.now(),
                    type: 'credit_purchase',
                    title: 'Credit Purchase',
                    amount: `$${selectedPackageData.price}`,
                    date: new Date().toISOString().split('T')[0],
                    status: 'completed'
                });
                
                // Update monthly revenue
                monthlyRevenue += selectedPackageData.price;
                updateStatsDisplay();
                
                saveUserDataToLocalStorage();
                saveTransactionsToLocalStorage();
                renderTransactions();
                
                paymentModal.classList.remove('active');
                showNotification(`Payment successful! ${selectedPackageData.amount} credits added to your account.`, 'success');
            }, 1500);
        }
        
        function upgradePlan(planKey) {
            const plan = subscriptionPlans[planKey];
            
            if (planKey === currentPlan) {
                showNotification(`You are already on the ${plan.name} plan`, 'info');
                return;
            }
            
            if (plan.price > 0) {
                // Show payment modal for paid upgrades
                showNotification(`Upgrading to ${plan.name} plan for $${plan.price}/month`, 'info');
                
                // In a real app, you would process payment here
                setTimeout(() => {
                    completePlanUpgrade(planKey);
                }, 1000);
            } else {
                // Free plan (downgrade)
                if (confirm(`Are you sure you want to downgrade to the ${plan.name} plan? Some tools may become unavailable.`)) {
                    completePlanUpgrade(planKey);
                }
            }
        }
        
        function completePlanUpgrade(planKey) {
            currentPlan = planKey;
            updateUserDisplay();
            updateToolLockStatus();
            saveUserDataToLocalStorage();
            
            // Add transaction for paid plans
            const plan = subscriptionPlans[planKey];
            if (plan.price > 0) {
                transactions.unshift({
                    id: 's' + Date.now(),
                    type: 'subscription',
                    title: `${plan.name} Plan`,
                    amount: `$${plan.price}`,
                    date: new Date().toISOString().split('T')[0],
                    status: 'completed'
                });
                saveTransactionsToLocalStorage();
                renderTransactions();
            }
            
            showNotification(`Plan upgraded to ${plan.name} successfully!`, 'success');
            paymentModal.classList.remove('active');
            
            // Re-render tools to update lock status
            renderTools();
        }
        
        function bookConsultation(service) {
            // Add transaction
            transactions.unshift({
                id: 'c' + Date.now(),
                type: 'consultation',
                title: service.name,
                amount: service.price,
                date: new Date().toISOString().split('T')[0],
                status: 'scheduled'
            });
            
            saveTransactionsToLocalStorage();
            renderTransactions();
            
            paymentModal.classList.remove('active');
            showNotification(`${service.name} booked successfully! Our team will contact you to schedule the session.`, 'success');
        }
        
        function updateToolLockStatus() {
            allTools.forEach(tool => {
                const planOrder = ['free', 'basic', 'pro', 'business'];
                const userPlanIndex = planOrder.indexOf(currentPlan);
                const requiredPlanIndex = planOrder.indexOf(tool.planRequired);
                
                tool.locked = requiredPlanIndex > userPlanIndex;
            });
        }
        
        function updateCreditsDisplay() {
            document.getElementById('currentCredits').textContent = currentCredits;
            document.getElementById('userCredits').textContent = currentCredits + ' credits';
            document.getElementById('availableCredits').textContent = currentCredits.toLocaleString();
            
            saveUserDataToLocalStorage();
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric'
            });
        }
        
        function showNotification(message, type = 'success') {
            const notificationText = document.getElementById('notificationText');
            if (!notificationText) return;
            
            notificationText.textContent = message;
            
            notification.className = 'notification';
            notification.classList.add(type);
            
            notification.classList.add('active');
            
            setTimeout(() => {
                notification.classList.remove('active');
            }, 3000);
        }
        
        function setupEventListeners() {
            // Dismiss offline overlay
            document.getElementById('dismissOfflineBtn').addEventListener('click', dismissOfflineOverlay);
            
            // Mobile menu toggle
            document.getElementById('openSidebar').addEventListener('click', () => {
                sidebar.classList.add('active');
                mobileOverlay.classList.add('active');
            });
            
            document.getElementById('closeSidebar').addEventListener('click', () => {
                sidebar.classList.remove('active');
                mobileOverlay.classList.remove('active');
            });
            
            mobileOverlay.addEventListener('click', () => {
                sidebar.classList.remove('active');
                mobileOverlay.classList.remove('active');
            });
            
            // Refresh transactions
            document.getElementById('refreshTransactions').addEventListener('click', () => {
                renderTransactions();
                showNotification('Transactions refreshed', 'success');
            });
            
            // Tool category buttons
            document.querySelectorAll('.category-btn[data-category]').forEach(btn => {
                btn.addEventListener('click', function() {
                    const category = this.dataset.category;
                    
                    // Update active button
                    document.querySelectorAll('.category-btn[data-category]').forEach(b => {
                        b.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // Update current category
                    currentCategory = category;
                    
                    // Re-render tools
                    renderTools();
                });
            });
            
            // Buy credits button
            document.getElementById('buyCreditsBtn').addEventListener('click', () => {
                showPaymentModal('credits');
            });
            
            document.getElementById('addCreditsBtn').addEventListener('click', () => {
                showPaymentModal('credits');
            });
            
            // Upgrade plan button
            document.getElementById('upgradePlanBtn').addEventListener('click', () => {
                showPaymentModal('subscription');
            });
            
            // View affiliate dashboard
            document.getElementById('viewAffiliateBtn').addEventListener('click', () => {
                showPaymentModal('affiliate');
            });
            
            // Tool modal buttons
            document.getElementById('closeToolModal').addEventListener('click', () => {
                toolModal.classList.remove('active');
            });
            
            document.getElementById('cancelToolBtn').addEventListener('click', () => {
                toolModal.classList.remove('active');
            });
            
            document.getElementById('openToolBtn').addEventListener('click', () => {
                if (currentTool) {
                    if (currentTool.locked) {
                        showUpgradeModal(currentTool);
                    } else if (currentTool.credits > 0 && currentCredits < currentTool.credits) {
                        showPaymentModal('credits');
                    } else {
                        openTool(currentTool);
                    }
                }
            });
            
            // Payment modal tabs
            document.querySelectorAll('.payment-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    
                    document.querySelectorAll('.payment-tab').forEach(t => {
                        t.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    loadPaymentTab(tabName);
                });
            });
            
            // Close payment modal
            document.getElementById('closePaymentModal').addEventListener('click', () => {
                paymentModal.classList.remove('active');
            });
            
            // Window resize
            window.addEventListener('resize', () => {
                if (window.innerWidth > 768) {
                    sidebar.classList.remove('active');
                    mobileOverlay.classList.remove('active');
                }
            });
            
            // Before unload
            window.addEventListener('beforeunload', () => {
                if (offlineCheckInterval) {
                    clearInterval(offlineCheckInterval);
                }
                
                saveToolsToLocalStorage();
                saveTransactionsToLocalStorage();
                saveUserDataToLocalStorage();
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // Close modals with Escape
                if (e.key === 'Escape') {
                    if (toolModal.classList.contains('active')) {
                        toolModal.classList.remove('active');
                    }
                    if (paymentModal.classList.contains('active')) {
                        paymentModal.classList.remove('active');
                    }
                    if (sidebar.classList.contains('active')) {
                        sidebar.classList.remove('active');
                        mobileOverlay.classList.remove('active');
                    }
                }
            });
        }
        
        console.log('Business Hub & Tools system initialized successfully');
    </script>
</body>
</html>