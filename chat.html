<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kynecta - Real-time Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    
    <style>
        /* All your existing CSS styles remain exactly the same */
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .primary-gradient {
            background: linear-gradient(135deg, #3B82F6 0%, #8B5CF6 100%);
        }
        .message-sent {
            background: linear-gradient(135deg, #3B82F6 0%, #8B5CF6 100%);
            color: white;
            margin-left: auto;
            border-radius: 20px 20px 5px 20px;
        }
        .message-received {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 20px 20px 20px 5px;
            backdrop-filter: blur(10px);
        }

        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            z-index: 1000;
            transition: all 0.3s ease-in-out;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .connection-status.connected {
            background: rgba(34, 197, 94, 0.8);
            color: white;
        }
        .connection-status.connecting {
            background: rgba(245, 158, 11, 0.8);
            color: white;
        }
        .connection-status.disconnected {
            background: rgba(239, 68, 68, 0.8);
            color: white;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-container {
            background: rgba(30, 30, 60, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .emoji-picker, .sticker-picker, .gif-picker {
            position: absolute;
            bottom: 70px;
            right: 10px;
            background: rgba(30, 30, 60, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 10px;
            padding: 15px;
            width: 300px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
        }
        .emoji-grid, .sticker-grid {
            display: grid;
            gap: 5px;
        }
        .emoji-grid {
            grid-template-columns: repeat(8, 1fr);
        }
        .sticker-grid {
            grid-template-columns: repeat(4, 1fr);
        }
        .gif-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px;
        }
        .emoji, .sticker {
            padding: 5px;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        .emoji:hover, .sticker:hover {
            background: rgba(59, 130, 246, 0.3);
            transform: scale(1.1);
        }
        .sticker {
            font-size: 2rem;
        }
        .gif-item {
            border-radius: 5px;
            cursor: pointer;
            overflow: hidden;
            transition: all 0.2s;
        }
        .gif-item:hover {
            transform: scale(1.05);
        }
        
        .upload-progress {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
        }
        .upload-progress-bar {
            height: 100%;
            background: #3B82F6;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .chat-item {
            padding: 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .chat-item:hover {
            background: rgba(59, 130, 246, 0.2);
        }
        .chat-item.active {
            background: rgba(59, 130, 246, 0.3);
        }
        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3B82F6, #8B5CF6);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            flex-shrink: 0;
        }
        .chat-item-info {
            flex: 1;
            min-width: 0;
        }
        .chat-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        .chat-item-name {
            font-weight: 600;
            color: white;
            font-size: 0.9rem;
        }
        .chat-item-time {
            font-size: 0.75rem;
            color: #8B5CF6;
        }
        .chat-item-preview {
            font-size: 0.8rem;
            color: #94A3B8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 4px;
        }
        .chat-item-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-badge {
            background: #EF4444;
            color: white;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 0.75rem;
        }
        .chat-type-indicator {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 8px;
            background: rgba(139, 92, 246, 0.3);
            color: #8B5CF6;
        }
        .type-personal { background: rgba(34, 197, 94, 0.3); color: #22C55E; }
        .type-group { background: rgba(249, 115, 22, 0.3); color: #F97316; }

        .message {
            margin-bottom: 16px;
            display: flex;
            animation: messageSlideIn 0.3s ease-out;
        }
        @keyframes messageSlideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message.sent {
            justify-content: flex-end;
        }
        .message.received {
            justify-content: flex-start;
        }
        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            transition: all 0.3s;
            position: relative;
        }
        .message-bubble:hover {
            transform: scale(1.02);
        }
        .message-sender {
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 4px;
            color: #E2E8F0;
        }
        .message-content {
            word-wrap: break-word;
        }
        .message-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 4px;
            font-size: 0.75rem;
            opacity: 0.8;
        }
        .message-time {
            color: inherit;
        }
        .message-status {
            margin-left: 8px;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            padding: 8px 16px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 18px;
            width: fit-content;
            margin: 5px 0;
            font-size: 0.8rem;
            color: #94A3B8;
        }
        .typing-dots {
            display: flex;
            margin-left: 8px;
        }
        .typing-dot {
            width: 6px;
            height: 6px;
            background: #94A3B8;
            border-radius: 50%;
            margin: 0 2px;
            animation: typingPulse 1.4s infinite ease-in-out;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typingPulse {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }
        
        .sync-indicator {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: linear-gradient(135deg, #10B981, #059669);
            border: 2px solid #1E293B;
            animation: syncPulse 2s infinite;
        }
        @keyframes syncPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.3); opacity: 0.7; }
        }
        
        .ai-suggestion {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 12px;
            padding: 10px 15px;
            margin: 8px 0;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        .ai-suggestion:hover {
            background: rgba(139, 92, 246, 0.2);
            transform: translateY(-2px);
        }
        
        .cosmic-background {
            background: 
                radial-gradient(circle at 20% 80%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(16, 185, 129, 0.05) 0%, transparent 50%),
                linear-gradient(135deg, #0F172A 0%, #1E293B 50%, #334155 100%);
        }
        
        .video-call-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 2000;
            display: none;
        }
        .local-video {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 200px;
            height: 150px;
            border: 2px solid #3B82F6;
            border-radius: 10px;
        }
        .remote-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .call-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
        }
        .call-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        .call-end {
            background: #EF4444;
            color: white;
        }
        .call-mute {
            background: #6B7280;
            color: white;
        }
        .call-video {
            background: #3B82F6;
            color: white;
        }
        
        .suggestion-bubble {
            position: relative;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            transition: all 0.3s;
        }
        .suggestion-bubble:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .memory-lane {
            background: rgba(30, 30, 60, 0.7);
            border-radius: 15px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #8B5CF6;
        }

        /* Message Reactions */
        .message-reactions {
            display: flex;
            gap: 5px;
            margin-top: 5px;
            flex-wrap: wrap;
        }
        .reaction {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 2px 6px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            gap: 2px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .reaction:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .reaction-count {
            font-size: 0.6rem;
        }

        /* Media Messages */
        .media-message {
            max-width: 300px;
            border-radius: 12px;
            overflow: hidden;
            margin: 5px 0;
        }
        .media-message img, .media-message video {
            width: 100%;
            height: auto;
            display: block;
        }
        .audio-message {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            margin: 5px 0;
        }
        .audio-controls {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .audio-progress {
            flex: 1;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            overflow: hidden;
        }
        .audio-progress-bar {
            height: 100%;
            background: #3B82F6;
            width: 0%;
            transition: width 0.1s;
        }

        /* Mood-based backgrounds */
        .mood-happy {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(251, 191, 36, 0.1));
        }
        .mood-calm {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
        }
        .mood-energetic {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(249, 115, 22, 0.1));
        }
        .mood-focused {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1));
        }

        /* Friend Activity Tracker */
        .activity-tracker {
            background: rgba(30, 30, 60, 0.8);
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
        }
        .activity-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s;
        }
        .activity-item:hover {
            background: rgba(59, 130, 246, 0.2);
        }

        /* Encryption Indicator */
        .encryption-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.7rem;
            color: #10B981;
        }

        /* Quick Actions Toolbar */
        .quick-actions {
            display: flex;
            gap: 5px;
            padding: 5px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            margin-bottom: 10px;
        }

        /* Message Menu */
        .message-menu {
            position: absolute;
            top: 0;
            right: -80px;
            background: rgba(30, 30, 60, 0.95);
            border-radius: 8px;
            padding: 5px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 10;
        }
        .message:hover .message-menu {
            display: block;
        }
        .menu-item {
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.8rem;
        }
        .menu-item:hover {
            background: rgba(59, 130, 246, 0.3);
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(30, 30, 60, 0.95);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            z-index: 10000;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(59, 130, 246, 0.3);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        /* Video Recording */
        .video-recording {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 15px;
            z-index: 2000;
            display: none;
        }

        /* Screen Sharing */
        .screen-sharing {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 300px;
            height: 200px;
            border: 2px solid #3B82F6;
            border-radius: 10px;
            z-index: 1500;
            display: none;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0F172A 0%, #1E293B 50%, #334155 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        @media (max-width: 768px) {
            .message-bubble {
                max-width: 85%;
            }
            .modal-container {
                width: 95%;
                padding: 15px;
            }
            .emoji-picker, .sticker-picker, .gif-picker {
                width: 90vw;
                right: 5vw;
            }
            .media-message {
                max-width: 250px;
            }
            .message-menu {
                right: 0;
                top: -40px;
            }
            .screen-sharing {
                width: 200px;
                height: 150px;
            }
        }
    </style>
</head>
<body class="h-full cosmic-background text-white overflow-x-hidden">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="text-center">
            <div class="w-20 h-20 cyber-gradient rounded-2xl flex items-center justify-center mx-auto mb-6 quantum-glow">
                <i class="fas fa-comments text-white text-2xl"></i>
            </div>
            <h2 class="text-2xl font-bold text-blue-300 mb-2">Kynecta Chat</h2>
            <p class="text-blue-400 mb-4">Loading your conversations...</p>
            <div class="flex justify-center">
                <div class="loading-spinner"></div>
            </div>
        </div>
    </div>

    <!-- Connection Status -->
    <div class="connection-status connecting" id="connectionStatus">
        <i class="fas fa-circle-notch fa-spin"></i>
        <span>Connecting to Firebase...</span>
    </div>

    <!-- Mobile Navigation -->
    <div class="md:hidden glass-effect border-b border-blue-800/50 p-3">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <button id="mobileMenuBtn" class="text-blue-300">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                <h1 class="text-lg font-bold text-blue-300">Kynecta</h1>
            </div>
            
            <div class="flex items-center space-x-3">
                <button id="mobileSearchBtn" class="text-blue-300">
                    <i class="fas fa-search"></i>
                </button>
                <button id="mobileProfileBtn" class="text-blue-300">
                    <i class="fas fa-user"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Mobile Search Bar -->
    <div id="mobileSearch" class="md:hidden glass-effect border-b border-blue-800/50 p-3 hidden">
        <div class="relative">
            <input type="text" placeholder="Search connections..." class="w-full bg-gray-800/50 border border-blue-700/50 rounded-lg py-2 px-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            <i class="fas fa-search absolute right-3 top-2.5 text-blue-400"></i>
        </div>
    </div>

    <!-- Main Chat App -->
    <div id="chat-app" class="h-full flex flex-col hidden">
        <!-- Desktop Header -->
        <div class="hidden md:flex glass-effect border-b border-blue-800/50 p-3">
            <div class="container mx-auto px-4 flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <h1 class="text-xl font-bold text-blue-300">Kynecta Chat</h1>
                    <div class="p-2 rounded-lg bg-blue-800/30">
                        <span class="text-xs text-blue-300">Active</span>
                    </div>
                    <div class="encryption-indicator">
                        <i class="fas fa-lock"></i>
                        <span>End-to-End Encrypted</span>
                    </div>
                </div>
                
                <div class="flex items-center space-x-3">
                    <button id="ai-mode" class="text-green-300 hover:text-green-200 text-sm transition-colors" title="AI Mode">
                        <i class="fas fa-robot"></i>
                    </button>
                    <button id="logout-btn" class="text-red-300 hover:text-red-200 text-sm transition-colors">
                        <i class="fas fa-sign-out-alt"></i> <span class="hidden md:inline">Sign Out</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="flex flex-1 overflow-hidden" id="mainContainer">
            <!-- Sidebar -->
            <div id="sidebar" class="w-full md:w-80 bg-gray-900/80 border-r border-blue-800/50 flex flex-col absolute md:relative z-10 transform -translate-x-full md:translate-x-0 transition-transform duration-300">
                <div class="p-4 border-b border-blue-800/50">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold text-blue-300">Connections</h2>
                        <button class="text-blue-400 hover:text-blue-300 transition-colors" id="createGroupBtn" title="Create Group">
                            <i class="fas fa-users"></i>
                        </button>
                    </div>
                    
                    <!-- Search - Desktop -->
                    <div class="hidden md:block relative mb-4">
                        <input type="text" id="chatSearch" placeholder="Search connections..." class="w-full bg-gray-800/50 border border-blue-700/50 rounded-lg py-2 px-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <i class="fas fa-search absolute right-3 top-2.5 text-blue-400"></i>
                    </div>

                    <!-- AI Assistant -->
                    <div class="ai-suggestion mb-4" id="aiAssistant">
                        <div class="text-xs text-purple-400 mb-1">Kynecta AI</div>
                        <div class="text-sm">Ready to help optimize your connections</div>
                    </div>

                    <!-- Friend Activity Tracker -->
                    <div class="activity-tracker mb-4">
                        <h3 class="text-sm font-semibold text-blue-300 mb-2">Friend Activity</h3>
                        <div id="friendsActivity" class="space-y-2">
                            <!-- Activity will be populated dynamically -->
                        </div>
                    </div>

                    <!-- Friends List -->
                    <div class="mb-4">
                        <h3 class="text-sm font-semibold text-blue-300 mb-2">Online Now</h3>
                        <div id="friendsList" class="max-h-40 overflow-y-auto space-y-2">
                            <!-- Friends will be populated dynamically -->
                        </div>
                    </div>
                </div>

                <!-- Chat List -->
                <div class="flex-1 overflow-y-auto p-2" id="chatList">
                    <div class="no-chats text-center py-10 text-blue-300" id="noChatsMessage">
                        <i class="fas fa-comments text-4xl mb-3"></i>
                        <p>No conversations yet</p>
                        <p class="text-sm mt-1">Start a conversation to begin</p>
                    </div>
                </div>
                
                <!-- User Profile -->
                <div class="p-4 border-t border-blue-800/50">
                    <div class="flex items-center space-x-3">
                        <div class="relative">
                            <img src="" alt="Profile" class="profile-pic" id="userProfilePic">
                            <div class="sync-indicator"></div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="font-medium text-sm truncate" id="userDisplayName">Loading...</p>
                            <div class="flex items-center text-xs text-blue-300">
                                <span id="userStatus">Online</span>
                                <span class="mx-1">•</span>
                                <span id="userMood">Happy</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Chat Area -->
            <div class="flex-1 flex flex-col w-full">
                <!-- Chat Header -->
                <div class="glass-effect border-b border-blue-800/50 p-3 md:p-4" id="chatHeader">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <button id="backToChats" class="md:hidden text-blue-300">
                                <i class="fas fa-arrow-left"></i>
                            </button>
                            <div class="relative">
                                <img src="" alt="Chat Avatar" class="profile-pic" id="chatHeaderAvatar">
                                <div class="sync-indicator" id="chatStatusIndicator"></div>
                            </div>
                            <div>
                                <h3 class="font-bold text-base md:text-lg" id="chatHeaderName">Select a chat</h3>
                                <p class="text-xs text-blue-300" id="chatHeaderStatus">Choose a conversation</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2 md:space-x-4" id="chatActions">
                            <button class="text-blue-400 hover:text-blue-300 transition-colors p-2" id="videoCallBtn" title="Video Call">
                                <i class="fas fa-video"></i>
                            </button>
                            <button class="text-blue-400 hover:text-blue-300 transition-colors p-2" id="voiceCallBtn" title="Voice Call">
                                <i class="fas fa-phone"></i>
                            </button>
                            <button class="text-blue-400 hover:text-blue-300 transition-colors p-2" id="aiEnhanceBtn" title="AI Enhance">
                                <i class="fas fa-magic"></i>
                            </button>
                            <button class="text-blue-400 hover:text-blue-300 transition-colors p-2" id="screenShareBtn" title="Share Screen">
                                <i class="fas fa-desktop"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Messages Area -->
                <div class="flex-1 overflow-y-auto p-3 md:p-4" id="messagesContainer">
                    <div class="text-center text-blue-300 py-10" id="noMessagesMessage">
                        <i class="fas fa-comments text-4xl mb-3"></i>
                        <p>No messages yet</p>
                        <p class="text-sm mt-1">Select a chat to start messaging</p>
                    </div>

                    <!-- AI Suggestions -->
                    <div class="suggestion-bubble hidden" id="suggestionBubble">
                        <div class="text-xs text-blue-400 mb-1">AI Suggestion</div>
                        <div class="text-sm">Try asking about their interests for better engagement</div>
                    </div>

                    <div class="memory-lane hidden" id="memoryLane">
                        <div class="text-blue-400 font-medium mb-2">Memory Lane</div>
                        <div class="text-sm">Your conversation highlights will appear here</div>
                    </div>
                </div>

                <!-- Typing Indicator -->
                <div class="hidden px-4" id="typingIndicator">
                    <div class="typing-indicator">
                        <span id="typingUsers"></span>
                        <div class="typing-dots">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                </div>

                <!-- AI Suggestions -->
                <div class="hidden px-4" id="aiSuggestions">
                    <div class="ai-suggestion">
                        <div class="text-xs text-purple-400 mb-1">Conversation Helper</div>
                        <div class="text-sm">Try asking about their recent activities</div>
                    </div>
                </div>

                <!-- Message Input -->
                <div class="glass-effect border-t border-blue-800/50 p-3 md:p-4">
                    <!-- Quick Actions Toolbar -->
                    <div class="quick-actions mb-3">
                        <button class="text-blue-400 hover:text-blue-300 transition-colors p-2 rounded-full hover:bg-blue-800/50" id="emojiBtn" title="Emoji">
                            <i class="fas fa-smile"></i>
                        </button>
                        <button class="text-blue-400 hover:text-blue-300 transition-colors p-2 rounded-full hover:bg-blue-800/50" id="attachmentBtn" title="Attach File">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <button class="text-blue-400 hover:text-blue-300 transition-colors p-2 rounded-full hover:bg-blue-800/50" id="voiceNoteBtn" title="Voice Note">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <button class="text-blue-400 hover:text-blue-300 transition-colors p-2 rounded-full hover:bg-blue-800/50" id="gifBtn" title="GIF">
                            <i class="fas fa-film"></i>
                        </button>
                        <button class="text-blue-400 hover:text-blue-300 transition-colors p-2 rounded-full hover:bg-blue-800/50" id="stickerBtn" title="Stickers">
                            <i class="fas fa-sticky-note"></i>
                        </button>
                        <button class="text-blue-400 hover:text-blue-300 transition-colors p-2 rounded-full hover:bg-blue-800/50" id="videoRecordBtn" title="Record Video">
                            <i class="fas fa-video"></i>
                        </button>
                        <button class="text-blue-400 hover:text-blue-300 transition-colors p-2 rounded-full hover:bg-blue-800/50" id="locationBtn" title="Share Location">
                            <i class="fas fa-map-marker-alt"></i>
                        </button>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <div class="flex-1 relative">
                            <input type="text" id="messageInput" placeholder="Select a chat to start messaging..." class="w-full bg-gray-800/50 border border-blue-700/50 rounded-full py-2 md:py-3 px-4 text-sm md:text-base focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                            
                            <!-- Emoji Picker -->
                            <div class="emoji-picker hidden" id="emojiPicker">
                                <div class="emoji-grid" id="emojiGrid"></div>
                            </div>
                            
                            <!-- Sticker Picker -->
                            <div class="sticker-picker hidden" id="stickerPicker">
                                <div class="sticker-grid" id="stickerGrid"></div>
                            </div>
                            
                            <!-- GIF Picker -->
                            <div class="gif-picker hidden" id="gifPicker">
                                <div class="gif-grid" id="gifGrid"></div>
                            </div>
                        </div>
                        
                        <button class="primary-gradient hover:opacity-90 text-white p-2 md:p-3 rounded-full transition-colors" id="sendBtn" disabled>
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    
                    <!-- Upload Progress -->
                    <div class="upload-progress hidden mt-2" id="uploadProgress">
                        <div class="upload-progress-bar" id="uploadProgressBar"></div>
                    </div>

                    <!-- Voice Recording UI -->
                    <div class="hidden mt-2" id="voiceRecording">
                        <div class="flex items-center justify-between bg-red-500/20 p-3 rounded-lg">
                            <div class="flex items-center space-x-2">
                                <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
                                <span class="text-sm">Recording...</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span id="recordingTime">0:00</span>
                                <button class="text-red-500" id="stopRecording">
                                    <i class="fas fa-stop"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Video Recording UI -->
                    <div class="video-recording hidden" id="videoRecording">
                        <div class="text-center">
                            <video id="videoPreview" width="320" height="240" autoplay muted class="rounded-lg mb-4"></video>
                            <div class="flex justify-center space-x-4">
                                <button class="bg-red-500 text-white px-4 py-2 rounded-lg" id="stopVideoRecording">
                                    <i class="fas fa-stop mr-2"></i>Stop
                                </button>
                                <button class="bg-gray-500 text-white px-4 py-2 rounded-lg" id="cancelVideoRecording">
                                    <i class="fas fa-times mr-2"></i>Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Video Call Container -->
    <div class="video-call-container" id="videoCallContainer">
        <video class="remote-video" id="remoteVideo" autoplay></video>
        <video class="local-video" id="localVideo" autoplay muted></video>
        <div class="call-controls">
            <button class="call-btn call-mute" id="muteBtn">
                <i class="fas fa-microphone"></i>
            </button>
            <button class="call-btn call-video" id="videoToggleBtn">
                <i class="fas fa-video"></i>
            </button>
            <button class="call-btn" id="screenShareBtnCall" style="background: #8B5CF6; color: white;">
                <i class="fas fa-desktop"></i>
            </button>
            <button class="call-btn call-end" id="endCallBtn">
                <i class="fas fa-phone"></i>
            </button>
        </div>
    </div>

    <!-- Screen Sharing Preview -->
    <div class="screen-sharing hidden" id="screenSharing">
        <video id="screenShareVideo" autoplay muted class="w-full h-full rounded-lg"></video>
    </div>

    <!-- Modals -->
    <div class="modal" id="createGroupModal">
        <div class="modal-container">
            <h3 class="text-xl font-bold mb-4">Create Group</h3>
            <input type="text" id="groupName" placeholder="Group name" class="w-full bg-gray-800 border border-blue-700 rounded-lg py-2 px-3 mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <div class="mb-4">
                <p class="mb-2 text-blue-300">Select members:</p>
                <div id="groupFriendsList" class="max-h-40 overflow-y-auto space-y-2">
                    <!-- Friends will be populated here -->
                </div>
            </div>
            <div class="flex justify-end space-x-2">
                <button class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors" id="cancelCreateGroup">Cancel</button>
                <button class="px-4 py-2 primary-gradient hover:opacity-90 rounded-lg transition-colors" id="confirmCreateGroup">Create Group</button>
            </div>
        </div>
    </div>

    <!-- Location Sharing Modal -->
    <div class="modal" id="locationModal">
        <div class="modal-container">
            <h3 class="text-xl font-bold mb-4">Share Location</h3>
            <div id="locationMap" class="w-full h-64 bg-gray-700 rounded-lg mb-4 flex items-center justify-center">
                <p class="text-gray-400">Loading map...</p>
            </div>
            <div class="flex justify-end space-x-2">
                <button class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors" id="cancelLocation">Cancel</button>
                <button class="px-4 py-2 primary-gradient hover:opacity-90 rounded-lg transition-colors" id="shareLocation">Share Location</button>
            </div>
        </div>
    </div>

    <!-- Firebase Configuration -->
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDHHyGgsSV18BcXrGgzi4C8frzDAE1C1zo",
            authDomain: "uniconnect-ee95c.firebaseapp.com",
            projectId: "uniconnect-ee95c",
            storageBucket: "uniconnect-ee95c.firebasestorage.app",
            messagingSenderId: "1003264444309",
            appId: "1:1003264444309:web:9f0307516e44d21e97d89c"
        };

        // Initialize Firebase
        let firebaseInitialized = false;
        let auth, db, storage;

        try {
            // Check if Firebase is already initialized
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            } else {
                firebase.app(); // if already initialized, use that one
            }
            
            auth = firebase.auth();
            db = firebase.firestore();
            storage = firebase.storage();
            firebaseInitialized = true;
            console.log("✅ Firebase initialized successfully");
            
            // Enable offline persistence with better error handling
            db.enablePersistence({ synchronizeTabs: true })
                .then(() => {
                    console.log("✅ Offline persistence enabled");
                })
                .catch((err) => {
                    console.warn("⚠️ Offline persistence not supported:", err);
                });
                
        } catch (error) {
            console.error("❌ Firebase initialization error:", error);
            firebaseInitialized = false;
        }

        // Global variables
        let currentUser = null;
        let currentChatId = null;
        let typingTimeout = null;
        let messagesListener = null;
        let chatsListener = null;
        let typingListener = null;
        let friendsListener = null;
        let activityListener = null;
        let localStream = null;
        let remoteStream = null;
        let screenStream = null;
        let peerConnection = null;
        let isAiMode = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let videoChunks = [];
        let recordingTimer = null;
        let recordingStartTime = null;
        let currentAudio = null;
        let videoRecorder = null;
        let isRecordingVideo = false;
        let isScreenSharing = false;
    </script>

    <!-- Application Logic -->
    <script>
        // DOM Elements
        const loadingScreen = document.getElementById('loadingScreen');
        const chatApp = document.getElementById('chat-app');
        const connectionStatus = document.getElementById('connectionStatus');
        const chatList = document.getElementById('chatList');
        const noChatsMessage = document.getElementById('noChatsMessage');
        const friendsList = document.getElementById('friendsList');
        const friendsActivity = document.getElementById('friendsActivity');
        const messagesContainer = document.getElementById('messagesContainer');
        const noMessagesMessage = document.getElementById('noMessagesMessage');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const chatHeaderName = document.getElementById('chatHeaderName');
        const chatHeaderStatus = document.getElementById('chatHeaderStatus');
        const chatHeaderAvatar = document.getElementById('chatHeaderAvatar');
        const chatStatusIndicator = document.getElementById('chatStatusIndicator');
        const userProfilePic = document.getElementById('userProfilePic');
        const userDisplayName = document.getElementById('userDisplayName');
        const userStatus = document.getElementById('userStatus');
        const userMood = document.getElementById('userMood');
        const logoutBtn = document.getElementById('logoutBtn');
        const emojiBtn = document.getElementById('emojiBtn');
        const emojiPicker = document.getElementById('emojiPicker');
        const emojiGrid = document.getElementById('emojiGrid');
        const stickerBtn = document.getElementById('stickerBtn');
        const stickerPicker = document.getElementById('stickerPicker');
        const stickerGrid = document.getElementById('stickerGrid');
        const gifBtn = document.getElementById('gifBtn');
        const gifPicker = document.getElementById('gifPicker');
        const gifGrid = document.getElementById('gifGrid');
        const attachmentBtn = document.getElementById('attachmentBtn');
        const voiceNoteBtn = document.getElementById('voiceNoteBtn');
        const videoRecordBtn = document.getElementById('videoRecordBtn');
        const locationBtn = document.getElementById('locationBtn');
        const uploadProgress = document.getElementById('uploadProgress');
        const uploadProgressBar = document.getElementById('uploadProgressBar');
        const voiceRecording = document.getElementById('voiceRecording');
        const videoRecording = document.getElementById('videoRecording');
        const videoPreview = document.getElementById('videoPreview');
        const stopVideoRecording = document.getElementById('stopVideoRecording');
        const cancelVideoRecording = document.getElementById('cancelVideoRecording');
        const recordingTime = document.getElementById('recordingTime');
        const stopRecording = document.getElementById('stopRecording');
        const typingIndicator = document.getElementById('typingIndicator');
        const typingUsers = document.getElementById('typingUsers');
        const videoCallBtn = document.getElementById('videoCallBtn');
        const voiceCallBtn = document.getElementById('voiceCallBtn');
        const aiEnhanceBtn = document.getElementById('aiEnhanceBtn');
        const screenShareBtn = document.getElementById('screenShareBtn');
        const screenShareBtnCall = document.getElementById('screenShareBtnCall');
        const videoCallContainer = document.getElementById('videoCallContainer');
        const screenSharing = document.getElementById('screenSharing');
        const screenShareVideo = document.getElementById('screenShareVideo');
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const muteBtn = document.getElementById('muteBtn');
        const videoToggleBtn = document.getElementById('videoToggleBtn');
        const endCallBtn = document.getElementById('endCallBtn');
        const createGroupBtn = document.getElementById('createGroupBtn');
        const createGroupModal = document.getElementById('createGroupModal');
        const cancelCreateGroup = document.getElementById('cancelCreateGroup');
        const confirmCreateGroup = document.getElementById('confirmCreateGroup');
        const groupName = document.getElementById('groupName');
        const groupFriendsList = document.getElementById('groupFriendsList');
        const locationModal = document.getElementById('locationModal');
        const cancelLocation = document.getElementById('cancelLocation');
        const shareLocation = document.getElementById('shareLocation');
        const locationMap = document.getElementById('locationMap');
        const suggestionBubble = document.getElementById('suggestionBubble');
        const memoryLane = document.getElementById('memoryLane');
        const aiAssistant = document.getElementById('aiAssistant');
        const aiSuggestions = document.getElementById('aiSuggestions');
        const aiMode = document.getElementById('ai-mode');
        const mainContainer = document.getElementById('mainContainer');
        const chatSearch = document.getElementById('chatSearch');
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const mobileSearchBtn = document.getElementById('mobileSearchBtn');
        const mobileProfileBtn = document.getElementById('mobileProfileBtn');
        const mobileSearch = document.getElementById('mobileSearch');
        const sidebar = document.getElementById('sidebar');
        const backToChats = document.getElementById('backToChats');

        // WebRTC Configuration (simplified for demo)
        const rtcConfiguration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' }
            ]
        };

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Initializing Kynecta Chat...");
            
            if (!firebaseInitialized) {
                console.error("Firebase not initialized properly");
                updateConnectionStatus('disconnected', 'Firebase connection failed');
                showNotification('Firebase connection failed. Please refresh the page.', 'error');
                return;
            }
            
            // Check authentication state using onAuthStateChanged
            auth.onAuthStateChanged(user => {
                console.log("Auth state changed:", user);
                if (user) {
                    // User is signed in
                    currentUser = user;
                    console.log("✅ User authenticated:", user.uid);
                    
                    // Hide loading screen and show chat app
                    loadingScreen.classList.add('hidden');
                    chatApp.classList.remove('hidden');
                    
                    // Initialize user and features
                    initializeUser();
                    updateConnectionStatus('connected', 'Connected to Firebase');
                    
                    // Set up event listeners after a short delay to ensure DOM is ready
                    setTimeout(() => {
                        setupEventListeners();
                        initializeEmojiPicker();
                        initializeStickerPicker();
                        initializeGifPicker();
                    }, 100);
                    
                } else {
                    // User is not signed in - redirect to login page
                    console.log("❌ User not authenticated, redirecting to login...");
                    redirectToLogin();
                }
            });
        });

        function redirectToLogin() {
            // Redirect to your login page
            window.location.href = 'index.html'; // Change this to your actual login page URL
        }

        function initializeUser() {
            console.log("Initializing user:", currentUser.uid);
            loadUserProfile();
            setupPresence();
            loadFriends();
            loadFriendActivity();
            loadChats();
        }

        function setupPresence() {
            if (!currentUser || !firebaseInitialized) return;

            try {
                // Set user as online in Firestore
                const userStatusRef = db.collection('users').doc(currentUser.uid);
                userStatusRef.set({
                    uid: currentUser.uid,
                    displayName: currentUser.displayName || 'Anonymous User',
                    email: currentUser.email,
                    photoURL: currentUser.photoURL || '',
                    status: 'online',
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
                    mood: 'happy',
                    lastActive: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true }).catch(error => {
                    console.error("Error setting user status:", error);
                });

                // Update active status every 30 seconds
                setInterval(() => {
                    if (currentUser) {
                        userStatusRef.update({
                            lastActive: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                }, 30000);
            } catch (error) {
                console.error("Error in setupPresence:", error);
            }
        }

        // ========== FEATURE IMPLEMENTATIONS ==========

        function setupEventListeners() {
            console.log("Setting up event listeners...");
            
            // Message input and sending
            messageInput.addEventListener('input', handleMessageInput);
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            sendBtn.addEventListener('click', sendMessage);
            
            // Feature buttons
            emojiBtn.addEventListener('click', toggleEmojiPicker);
            stickerBtn.addEventListener('click', toggleStickerPicker);
            gifBtn.addEventListener('click', toggleGifPicker);
            attachmentBtn.addEventListener('click', handleAttachment);
            voiceNoteBtn.addEventListener('click', startVoiceRecording);
            videoRecordBtn.addEventListener('click', startVideoRecording);
            locationBtn.addEventListener('click', showLocationModal);
            
            // Call buttons
            videoCallBtn.addEventListener('click', startVideoCall);
            voiceCallBtn.addEventListener('click', startVoiceCall);
            screenShareBtn.addEventListener('click', toggleScreenShare);
            
            // Call control buttons
            muteBtn.addEventListener('click', toggleMute);
            videoToggleBtn.addEventListener('click', toggleVideo);
            endCallBtn.addEventListener('click', endCall);
            screenShareBtnCall.addEventListener('click', toggleScreenShare);
            
            // Group creation
            createGroupBtn.addEventListener('click', showCreateGroupModal);
            cancelCreateGroup.addEventListener('click', hideCreateGroupModal);
            confirmCreateGroup.addEventListener('click', createGroup);
            
            // Location sharing
            cancelLocation.addEventListener('click', hideLocationModal);
            shareLocation.addEventListener('click', shareCurrentLocation);
            
            // AI features
            aiEnhanceBtn.addEventListener('click', toggleAIEnhance);
            aiMode.addEventListener('click', toggleAIMode);
            aiAssistant.addEventListener('click', interactWithAI);
            
            // Logout
            logoutBtn.addEventListener('click', handleLogout);
            
            // Mobile navigation
            mobileMenuBtn.addEventListener('click', toggleMobileSidebar);
            mobileSearchBtn.addEventListener('click', toggleMobileSearch);
            backToChats.addEventListener('click', showChatList);
            
            // Video recording controls
            stopVideoRecording.addEventListener('click', stopVideoRecordingFunc);
            cancelVideoRecording.addEventListener('click', cancelVideoRecordingFunc);
            stopRecording.addEventListener('click', stopVoiceRecording);
            
            // Close pickers when clicking outside
            document.addEventListener('click', function(e) {
                if (!emojiPicker.contains(e.target) && e.target !== emojiBtn) {
                    emojiPicker.classList.add('hidden');
                }
                if (!stickerPicker.contains(e.target) && e.target !== stickerBtn) {
                    stickerPicker.classList.add('hidden');
                }
                if (!gifPicker.contains(e.target) && e.target !== gifBtn) {
                    gifPicker.classList.add('hidden');
                }
            });
            
            console.log("✅ Event listeners set up successfully");
        }

        function handleMessageInput() {
            if (messageInput.value.trim() !== '') {
                sendBtn.disabled = false;
            } else {
                sendBtn.disabled = true;
            }
            
            // Handle typing indicator
            if (currentChatId) {
                // Send typing status to Firebase
                db.collection('chats').doc(currentChatId).collection('typing').doc(currentUser.uid).set({
                    uid: currentUser.uid,
                    displayName: currentUser.displayName,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Clear previous timeout
                if (typingTimeout) clearTimeout(typingTimeout);
                
                // Set timeout to remove typing status
                typingTimeout = setTimeout(() => {
                    db.collection('chats').doc(currentChatId).collection('typing').doc(currentUser.uid).delete();
                }, 2000);
            }
        }

        function sendMessage() {
            if (!currentChatId || !messageInput.value.trim()) return;
            
            const messageText = messageInput.value.trim();
            const messageData = {
                text: messageText,
                senderId: currentUser.uid,
                senderName: currentUser.displayName || 'Anonymous',
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                type: 'text'
            };
            
            // Add message to Firestore
            db.collection('chats').doc(currentChatId).collection('messages').add(messageData)
                .then(() => {
                    // Clear input and disable send button
                    messageInput.value = '';
                    sendBtn.disabled = true;
                    
                    // Update last message in chat
                    db.collection('chats').doc(currentChatId).update({
                        lastMessage: messageText,
                        lastMessageTime: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Remove typing status
                    if (typingTimeout) {
                        clearTimeout(typingTimeout);
                        db.collection('chats').doc(currentChatId).collection('typing').doc(currentUser.uid).delete();
                    }
                })
                .catch(error => {
                    console.error("Error sending message:", error);
                    showNotification('Failed to send message');
                });
        }

        function toggleEmojiPicker() {
            const isVisible = !emojiPicker.classList.contains('hidden');
            
            // Hide other pickers
            stickerPicker.classList.add('hidden');
            gifPicker.classList.add('hidden');
            
            // Toggle emoji picker
            if (isVisible) {
                emojiPicker.classList.add('hidden');
            } else {
                emojiPicker.classList.remove('hidden');
            }
        }

        function toggleStickerPicker() {
            const isVisible = !stickerPicker.classList.contains('hidden');
            
            // Hide other pickers
            emojiPicker.classList.add('hidden');
            gifPicker.classList.add('hidden');
            
            // Toggle sticker picker
            if (isVisible) {
                stickerPicker.classList.add('hidden');
            } else {
                stickerPicker.classList.remove('hidden');
            }
        }

        function toggleGifPicker() {
            const isVisible = !gifPicker.classList.contains('hidden');
            
            // Hide other pickers
            emojiPicker.classList.add('hidden');
            stickerPicker.classList.add('hidden');
            
            // Toggle GIF picker
            if (isVisible) {
                gifPicker.classList.add('hidden');
            } else {
                gifPicker.classList.remove('hidden');
            }
        }

        function initializeEmojiPicker() {
            // Common emojis for the picker
            const emojis = ['😀', '😂', '🥰', '😎', '🤔', '😍', '🙂', '😊', '🤩', '😜', 
                           '👍', '❤️', '🔥', '🎉', '💯', '✨', '🙏', '😢', '😡', '🤯'];
            
            emojiGrid.innerHTML = '';
            emojis.forEach(emoji => {
                const emojiElement = document.createElement('div');
                emojiElement.className = 'emoji';
                emojiElement.textContent = emoji;
                emojiElement.addEventListener('click', () => {
                    messageInput.value += emoji;
                    messageInput.focus();
                    emojiPicker.classList.add('hidden');
                });
                emojiGrid.appendChild(emojiElement);
            });
        }

        function initializeStickerPicker() {
            // Simple sticker implementation using emojis
            const stickers = ['😺', '🐶', '🐼', '🦊', '🐨', '🐯', '🦁', '🐮',
                             '🌞', '🌙', '⭐', '🌈', '🔥', '💧', '🌺', '🍕'];
            
            stickerGrid.innerHTML = '';
            stickers.forEach(sticker => {
                const stickerElement = document.createElement('div');
                stickerElement.className = 'sticker';
                stickerElement.textContent = sticker;
                stickerElement.addEventListener('click', () => {
                    // For demo, we'll send the sticker as text
                    // In a real app, you'd send a reference to the actual sticker image
                    sendSticker(sticker);
                    stickerPicker.classList.add('hidden');
                });
                stickerGrid.appendChild(stickerElement);
            });
        }

        function sendSticker(sticker) {
            if (!currentChatId) return;
            
            const messageData = {
                type: 'sticker',
                sticker: sticker,
                senderId: currentUser.uid,
                senderName: currentUser.displayName || 'Anonymous',
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            db.collection('chats').doc(currentChatId).collection('messages').add(messageData)
                .then(() => {
                    // Update last message in chat
                    db.collection('chats').doc(currentChatId).update({
                        lastMessage: 'Sent a sticker',
                        lastMessageTime: firebase.firestore.FieldValue.serverTimestamp()
                    });
                })
                .catch(error => {
                    console.error("Error sending sticker:", error);
                    showNotification('Failed to send sticker');
                });
        }

        function initializeGifPicker() {
            // For demo, we'll use a few placeholder GIFs
            // In a real app, you'd integrate with a GIF API like Giphy or Tenor
            const gifs = [
                { url: 'https://media.giphy.com/media/3o7aCTPPm4OHfRLSH6/giphy.gif', alt: 'Celebration' },
                { url: 'https://media.giphy.com/media/l0MYt5jPR6QX5pnqM/giphy.gif', alt: 'Hello' },
                { url: 'https://media.giphy.com/media/26AHONQ79FdWZhAI0/giphy.gif', alt: 'Laughing' },
                { url: 'https://media.giphy.com/media/l4HnKwiJJaJQB04Zq/giphy.gif', alt: 'Thumbs up' }
            ];
            
            gifGrid.innerHTML = '';
            gifs.forEach(gif => {
                const gifElement = document.createElement('div');
                gifElement.className = 'gif-item';
                
                const img = document.createElement('img');
                img.src = gif.url;
                img.alt = gif.alt;
                img.className = 'w-full h-auto';
                
                gifElement.appendChild(img);
                gifElement.addEventListener('click', () => {
                    sendGif(gif.url);
                    gifPicker.classList.add('hidden');
                });
                
                gifGrid.appendChild(gifElement);
            });
        }

        function sendGif(gifUrl) {
            if (!currentChatId) return;
            
            const messageData = {
                type: 'gif',
                gifUrl: gifUrl,
                senderId: currentUser.uid,
                senderName: currentUser.displayName || 'Anonymous',
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            db.collection('chats').doc(currentChatId).collection('messages').add(messageData)
                .then(() => {
                    // Update last message in chat
                    db.collection('chats').doc(currentChatId).update({
                        lastMessage: 'Sent a GIF',
                        lastMessageTime: firebase.firestore.FieldValue.serverTimestamp()
                    });
                })
                .catch(error => {
                    console.error("Error sending GIF:", error);
                    showNotification('Failed to send GIF');
                });
        }

        function handleAttachment() {
            // Create a file input element
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*,video/*,audio/*,.pdf,.doc,.docx,.txt';
            fileInput.style.display = 'none';
            
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    uploadFile(file);
                }
                
                // Remove the input element
                document.body.removeChild(fileInput);
            });
            
            // Add to DOM and trigger click
            document.body.appendChild(fileInput);
            fileInput.click();
        }

        function uploadFile(file) {
            if (!currentChatId) return;
            
            // Show upload progress
            uploadProgress.classList.remove('hidden');
            uploadProgressBar.style.width = '0%';
            
            // Create a reference to the file in Firebase Storage
            const fileRef = storage.ref().child(`chats/${currentChatId}/${Date.now()}_${file.name}`);
            
            // Upload the file
            const uploadTask = fileRef.put(file);
            
            uploadTask.on('state_changed',
                (snapshot) => {
                    // Update progress bar
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    uploadProgressBar.style.width = progress + '%';
                },
                (error) => {
                    console.error("Upload error:", error);
                    showNotification('Failed to upload file');
                    uploadProgress.classList.add('hidden');
                },
                () => {
                    // Upload completed successfully
                    uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                        // Determine file type
                        let fileType = 'file';
                        if (file.type.startsWith('image/')) fileType = 'image';
                        else if (file.type.startsWith('video/')) fileType = 'video';
                        else if (file.type.startsWith('audio/')) fileType = 'audio';
                        
                        // Create message with file
                        const messageData = {
                            type: fileType,
                            fileUrl: downloadURL,
                            fileName: file.name,
                            fileSize: file.size,
                            senderId: currentUser.uid,
                            senderName: currentUser.displayName || 'Anonymous',
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        
                        // Add message to Firestore
                        return db.collection('chats').doc(currentChatId).collection('messages').add(messageData);
                    }).then(() => {
                        // Update last message in chat
                        db.collection('chats').doc(currentChatId).update({
                            lastMessage: 'Sent a file',
                            lastMessageTime: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        // Hide upload progress
                        uploadProgress.classList.add('hidden');
                        showNotification('File uploaded successfully');
                    }).catch(error => {
                        console.error("Error adding file message:", error);
                        showNotification('Failed to send file');
                        uploadProgress.classList.add('hidden');
                    });
                }
            );
        }

        function startVoiceRecording() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showNotification('Voice recording not supported in this browser');
                return;
            }
            
            // Request microphone permission
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    // Show recording UI
                    voiceRecording.classList.remove('hidden');
                    
                    // Initialize MediaRecorder
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    
                    // Set up event handlers
                    mediaRecorder.ondataavailable = (event) => {
                        audioChunks.push(event.data);
                    };
                    
                    mediaRecorder.onstop = () => {
                        // Create audio blob
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        
                        // Upload audio file
                        uploadAudioFile(audioBlob);
                        
                        // Stop all tracks
                        stream.getTracks().forEach(track => track.stop());
                        
                        // Hide recording UI
                        voiceRecording.classList.add('hidden');
                        
                        // Clear recording timer
                        if (recordingTimer) {
                            clearInterval(recordingTimer);
                            recordingTimer = null;
                        }
                    };
                    
                    // Start recording
                    mediaRecorder.start();
                    
                    // Start recording timer
                    recordingStartTime = Date.now();
                    recordingTimer = setInterval(updateRecordingTime, 1000);
                })
                .catch(error => {
                    console.error("Error accessing microphone:", error);
                    showNotification('Microphone access denied');
                });
        }

        function stopVoiceRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
        }

        function updateRecordingTime() {
            if (!recordingStartTime) return;
            
            const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            
            recordingTime.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function uploadAudioFile(audioBlob) {
            if (!currentChatId) return;
            
            // Create a file from the blob
            const audioFile = new File([audioBlob], `voice_message_${Date.now()}.webm`, {
                type: 'audio/webm'
            });
            
            // Show upload progress
            uploadProgress.classList.remove('hidden');
            uploadProgressBar.style.width = '0%';
            
            // Create a reference to the file in Firebase Storage
            const fileRef = storage.ref().child(`chats/${currentChatId}/${audioFile.name}`);
            
            // Upload the file
            const uploadTask = fileRef.put(audioFile);
            
            uploadTask.on('state_changed',
                (snapshot) => {
                    // Update progress bar
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    uploadProgressBar.style.width = progress + '%';
                },
                (error) => {
                    console.error("Upload error:", error);
                    showNotification('Failed to upload voice message');
                    uploadProgress.classList.add('hidden');
                },
                () => {
                    // Upload completed successfully
                    uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                        // Create message with audio
                        const messageData = {
                            type: 'audio',
                            fileUrl: downloadURL,
                            fileName: audioFile.name,
                            fileSize: audioFile.size,
                            senderId: currentUser.uid,
                            senderName: currentUser.displayName || 'Anonymous',
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        
                        // Add message to Firestore
                        return db.collection('chats').doc(currentChatId).collection('messages').add(messageData);
                    }).then(() => {
                        // Update last message in chat
                        db.collection('chats').doc(currentChatId).update({
                            lastMessage: 'Sent a voice message',
                            lastMessageTime: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        // Hide upload progress
                        uploadProgress.classList.add('hidden');
                        showNotification('Voice message sent');
                    }).catch(error => {
                        console.error("Error adding audio message:", error);
                        showNotification('Failed to send voice message');
                        uploadProgress.classList.add('hidden');
                    });
                }
            );
        }

        function startVideoRecording() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showNotification('Video recording not supported in this browser');
                return;
            }
            
            // Request camera permission
            navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                .then(stream => {
                    // Show video recording UI
                    videoRecording.classList.remove('hidden');
                    
                    // Set up video preview
                    videoPreview.srcObject = stream;
                    
                    // Initialize MediaRecorder
                    videoRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
                    videoChunks = [];
                    
                    // Set up event handlers
                    videoRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            videoChunks.push(event.data);
                        }
                    };
                    
                    videoRecorder.onstop = () => {
                        // Create video blob
                        const videoBlob = new Blob(videoChunks, { type: 'video/webm' });
                        
                        // Upload video file
                        uploadVideoFile(videoBlob);
                        
                        // Stop all tracks
                        stream.getTracks().forEach(track => track.stop());
                        
                        // Hide recording UI
                        videoRecording.classList.add('hidden');
                        isRecordingVideo = false;
                    };
                    
                    // Start recording
                    videoRecorder.start();
                    isRecordingVideo = true;
                })
                .catch(error => {
                    console.error("Error accessing camera:", error);
                    showNotification('Camera access denied');
                });
        }

        function stopVideoRecordingFunc() {
            if (videoRecorder && isRecordingVideo) {
                videoRecorder.stop();
            }
        }

        function cancelVideoRecordingFunc() {
            if (videoRecorder && isRecordingVideo) {
                videoRecorder.stop();
                videoRecording.classList.add('hidden');
                isRecordingVideo = false;
                
                // Stop all tracks in the stream
                if (videoPreview.srcObject) {
                    videoPreview.srcObject.getTracks().forEach(track => track.stop());
                }
            }
        }

        function uploadVideoFile(videoBlob) {
            if (!currentChatId) return;
            
            // Create a file from the blob
            const videoFile = new File([videoBlob], `video_message_${Date.now()}.webm`, {
                type: 'video/webm'
            });
            
            // Show upload progress
            uploadProgress.classList.remove('hidden');
            uploadProgressBar.style.width = '0%';
            
            // Create a reference to the file in Firebase Storage
            const fileRef = storage.ref().child(`chats/${currentChatId}/${videoFile.name}`);
            
            // Upload the file
            const uploadTask = fileRef.put(videoFile);
            
            uploadTask.on('state_changed',
                (snapshot) => {
                    // Update progress bar
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    uploadProgressBar.style.width = progress + '%';
                },
                (error) => {
                    console.error("Upload error:", error);
                    showNotification('Failed to upload video message');
                    uploadProgress.classList.add('hidden');
                },
                () => {
                    // Upload completed successfully
                    uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                        // Create message with video
                        const messageData = {
                            type: 'video',
                            fileUrl: downloadURL,
                            fileName: videoFile.name,
                            fileSize: videoFile.size,
                            senderId: currentUser.uid,
                            senderName: currentUser.displayName || 'Anonymous',
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        
                        // Add message to Firestore
                        return db.collection('chats').doc(currentChatId).collection('messages').add(messageData);
                    }).then(() => {
                        // Update last message in chat
                        db.collection('chats').doc(currentChatId).update({
                            lastMessage: 'Sent a video message',
                            lastMessageTime: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        // Hide upload progress
                        uploadProgress.classList.add('hidden');
                        showNotification('Video message sent');
                    }).catch(error => {
                        console.error("Error adding video message:", error);
                        showNotification('Failed to send video message');
                        uploadProgress.classList.add('hidden');
                    });
                }
            );
        }

        function startVideoCall() {
            if (!currentChatId) {
                showNotification('Please select a chat first');
                return;
            }
            
            // Request camera and microphone permissions
            navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                .then(stream => {
                    localStream = stream;
                    
                    // Show video call UI
                    videoCallContainer.style.display = 'block';
                    
                    // Set local video stream
                    localVideo.srcObject = stream;
                    
                    // Initialize WebRTC (simplified for demo)
                    initializeWebRTC();
                    
                    // Send call notification to the other user
                    sendCallNotification('video');
                    
                    showNotification('Starting video call...');
                })
                .catch(error => {
                    console.error("Error accessing camera/microphone:", error);
                    showNotification('Camera/microphone access denied');
                });
        }

        function startVoiceCall() {
            if (!currentChatId) {
                showNotification('Please select a chat first');
                return;
            }
            
            // Request microphone permission
            navigator.mediaDevices.getUserMedia({ audio: true, video: false })
                .then(stream => {
                    localStream = stream;
                    
                    // Show video call UI (for voice call too, but without video)
                    videoCallContainer.style.display = 'block';
                    localVideo.style.display = 'none';
                    
                    // Initialize WebRTC (simplified for demo)
                    initializeWebRTC();
                    
                    // Send call notification to the other user
                    sendCallNotification('voice');
                    
                    showNotification('Starting voice call...');
                })
                .catch(error => {
                    console.error("Error accessing microphone:", error);
                    showNotification('Microphone access denied');
                });
        }

        function initializeWebRTC() {
            // Simplified WebRTC implementation for demo
            // In a real app, you'd use a signaling server and proper WebRTC setup
            
            peerConnection = new RTCPeerConnection(rtcConfiguration);
            
            // Add local stream to connection
            if (localStream) {
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
            }
            
            // Handle incoming stream
            peerConnection.ontrack = (event) => {
                remoteVideo.srcObject = event.streams[0];
                remoteStream = event.streams[0];
            };
            
            // For demo purposes, we'll simulate a connection
            // In a real app, you'd exchange SDP offers/answers and ICE candidates
            setTimeout(() => {
                showNotification('Call connected (demo mode)');
            }, 2000);
        }

        function toggleScreenShare() {
            if (!isScreenSharing) {
                // Start screen sharing
                if (navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia) {
                    navigator.mediaDevices.getDisplayMedia({ video: true })
                        .then(stream => {
                            screenStream = stream;
                            isScreenSharing = true;
                            
                            // Show screen sharing preview
                            screenSharing.classList.remove('hidden');
                            screenShareVideo.srcObject = stream;
                            
                            // Replace video track in peer connection
                            if (peerConnection) {
                                const videoTrack = stream.getVideoTracks()[0];
                                const sender = peerConnection.getSenders().find(s => 
                                    s.track && s.track.kind === 'video'
                                );
                                
                                if (sender) {
                                    sender.replaceTrack(videoTrack);
                                }
                            }
                            
                            showNotification('Screen sharing started');
                        })
                        .catch(error => {
                            console.error("Error sharing screen:", error);
                            showNotification('Screen sharing failed');
                        });
                } else {
                    showNotification('Screen sharing not supported in this browser');
                }
            } else {
                // Stop screen sharing
                if (screenStream) {
                    screenStream.getTracks().forEach(track => track.stop());
                    screenStream = null;
                }
                
                isScreenSharing = false;
                screenSharing.classList.add('hidden');
                
                // Switch back to camera
                if (localStream) {
                    const videoTrack = localStream.getVideoTracks()[0];
                    if (videoTrack && peerConnection) {
                        const sender = peerConnection.getSenders().find(s => 
                            s.track && s.track.kind === 'video'
                        );
                        
                        if (sender) {
                            sender.replaceTrack(videoTrack);
                        }
                    }
                }
                
                showNotification('Screen sharing stopped');
            }
        }

        function toggleMute() {
            if (localStream) {
                const audioTracks = localStream.getAudioTracks();
                if (audioTracks.length > 0) {
                    const isMuted = !audioTracks[0].enabled;
                    audioTracks[0].enabled = isMuted;
                    
                    // Update button appearance
                    if (isMuted) {
                        muteBtn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
                        muteBtn.style.background = '#EF4444';
                    } else {
                        muteBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                        muteBtn.style.background = '#6B7280';
                    }
                    
                    showNotification(isMuted ? 'Microphone muted' : 'Microphone unmuted');
                }
            }
        }

        function toggleVideo() {
            if (localStream) {
                const videoTracks = localStream.getVideoTracks();
                if (videoTracks.length > 0) {
                    const isVideoOn = !videoTracks[0].enabled;
                    videoTracks[0].enabled = isVideoOn;
                    
                    // Update button appearance
                    if (isVideoOn) {
                        videoToggleBtn.innerHTML = '<i class="fas fa-video"></i>';
                        videoToggleBtn.style.background = '#3B82F6';
                        localVideo.style.display = 'block';
                    } else {
                        videoToggleBtn.innerHTML = '<i class="fas fa-video-slash"></i>';
                        videoToggleBtn.style.background = '#6B7280';
                        localVideo.style.display = 'none';
                    }
                    
                    showNotification(isVideoOn ? 'Video turned on' : 'Video turned off');
                }
            }
        }

        function endCall() {
            // Stop all streams
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            if (remoteStream) {
                remoteStream.getTracks().forEach(track => track.stop());
                remoteStream = null;
            }
            
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
                screenStream = null;
                isScreenSharing = false;
                screenSharing.classList.add('hidden');
            }
            
            // Close peer connection
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            // Hide call UI
            videoCallContainer.style.display = 'none';
            localVideo.style.display = 'block'; // Reset for next call
            
            // Reset call control buttons
            muteBtn.innerHTML = '<i class="fas fa-microphone"></i>';
            muteBtn.style.background = '#6B7280';
            videoToggleBtn.innerHTML = '<i class="fas fa-video"></i>';
            videoToggleBtn.style.background = '#3B82F6';
            
            showNotification('Call ended');
        }

        function sendCallNotification(callType) {
            if (!currentChatId) return;
            
            // Create a call notification in Firestore
            const callData = {
                type: callType,
                callerId: currentUser.uid,
                callerName: currentUser.displayName || 'Anonymous',
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'ringing'
            };
            
            db.collection('chats').doc(currentChatId).collection('calls').add(callData)
                .catch(error => {
                    console.error("Error sending call notification:", error);
                });
        }

        function showLocationModal() {
            locationModal.style.display = 'flex';
            
            // For demo, we'll just show a placeholder
            // In a real app, you'd integrate with a maps API
            locationMap.innerHTML = '<p class="text-gray-400">Map would appear here with your location</p>';
        }

        function hideLocationModal() {
            locationModal.style.display = 'none';
        }

        function shareCurrentLocation() {
            if (!navigator.geolocation) {
                showNotification('Geolocation is not supported by this browser');
                return;
            }
            
            showNotification('Getting your location...');
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    
                    // Create location message
                    const messageData = {
                        type: 'location',
                        latitude: latitude,
                        longitude: longitude,
                        senderId: currentUser.uid,
                        senderName: currentUser.displayName || 'Anonymous',
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    // Add message to Firestore
                    db.collection('chats').doc(currentChatId).collection('messages').add(messageData)
                        .then(() => {
                            // Update last message in chat
                            db.collection('chats').doc(currentChatId).update({
                                lastMessage: 'Shared location',
                                lastMessageTime: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            
                            hideLocationModal();
                            showNotification('Location shared successfully');
                        })
                        .catch(error => {
                            console.error("Error sharing location:", error);
                            showNotification('Failed to share location');
                        });
                },
                (error) => {
                    console.error("Error getting location:", error);
                    showNotification('Unable to get your location');
                }
            );
        }

        function showCreateGroupModal() {
            createGroupModal.style.display = 'flex';
            
            // Load friends for group creation
            loadFriendsForGroup();
        }

        function hideCreateGroupModal() {
            createGroupModal.style.display = 'none';
            groupName.value = '';
        }

        function loadFriendsForGroup() {
            // For demo, we'll create some placeholder friends
            // In a real app, you'd load actual friends from Firestore
            const friends = [
                { id: 'friend1', name: 'Alex Johnson', selected: false },
                { id: 'friend2', name: 'Sam Smith', selected: false },
                { id: 'friend3', name: 'Taylor Swift', selected: false },
                { id: 'friend4', name: 'Jordan Lee', selected: false }
            ];
            
            groupFriendsList.innerHTML = '';
            friends.forEach(friend => {
                const friendElement = document.createElement('div');
                friendElement.className = 'flex items-center p-2 rounded hover:bg-gray-700';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `friend-${friend.id}`;
                checkbox.className = 'mr-2';
                checkbox.checked = friend.selected;
                checkbox.addEventListener('change', () => {
                    friend.selected = checkbox.checked;
                });
                
                const label = document.createElement('label');
                label.htmlFor = `friend-${friend.id}`;
                label.textContent = friend.name;
                label.className = 'flex-1 cursor-pointer';
                
                friendElement.appendChild(checkbox);
                friendElement.appendChild(label);
                groupFriendsList.appendChild(friendElement);
            });
        }

        function createGroup() {
            const name = groupName.value.trim();
            if (!name) {
                showNotification('Please enter a group name');
                return;
            }
            
            // Get selected members
            const selectedFriends = Array.from(groupFriendsList.querySelectorAll('input:checked'))
                .map(checkbox => checkbox.id.replace('friend-', ''));
            
            if (selectedFriends.length === 0) {
                showNotification('Please select at least one member');
                return;
            }
            
            // Create group chat in Firestore
            const groupData = {
                name: name,
                type: 'group',
                members: [currentUser.uid, ...selectedFriends],
                createdBy: currentUser.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                lastMessage: 'Group created',
                lastMessageTime: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            db.collection('chats').add(groupData)
                .then((docRef) => {
                    hideCreateGroupModal();
                    showNotification('Group created successfully');
                    
                    // Load the new group chat
                    loadChats();
                })
                .catch(error => {
                    console.error("Error creating group:", error);
                    showNotification('Failed to create group');
                });
        }

        function toggleAIEnhance() {
            // Toggle AI enhancement for the current chat
            isAiMode = !isAiMode;
            
            if (isAiMode) {
                aiEnhanceBtn.style.color = '#10B981'; // Green color when active
                aiSuggestions.classList.remove('hidden');
                showNotification('AI enhancement activated');
            } else {
                aiEnhanceBtn.style.color = ''; // Reset to default
                aiSuggestions.classList.add('hidden');
                showNotification('AI enhancement deactivated');
            }
        }

        function toggleAIMode() {
            // Toggle global AI mode
            // This would affect the entire app, not just the current chat
            showNotification('AI mode toggled (demo)');
        }

        function interactWithAI() {
            // Show AI interaction modal or perform AI action
            showNotification('AI assistant activated (demo)');
        }

        function toggleMobileSidebar() {
            sidebar.classList.toggle('-translate-x-full');
        }

        function toggleMobileSearch() {
            mobileSearch.classList.toggle('hidden');
        }

        function showChatList() {
            // For mobile: show chat list and hide chat area
            sidebar.classList.remove('-translate-x-full');
        }

        // ========== UTILITY FUNCTIONS ==========

        function showNotification(message) {
            // Remove existing notifications
            document.querySelectorAll('.notification').forEach(notification => {
                notification.remove();
            });
            
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }

        function updateConnectionStatus(status, message) {
            if (connectionStatus) {
                connectionStatus.className = 'connection-status ' + status;
                switch(status) {
                    case 'connected':
                        connectionStatus.innerHTML = '<i class="fas fa-check-circle"></i><span>' + message + '</span>';
                        break;
                    case 'connecting':
                        connectionStatus.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i><span>' + message + '</span>';
                        break;
                    case 'disconnected':
                        connectionStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>' + message + '</span>';
                        break;
                }
            }
        }

        function generateId() {
            return 'id_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
        }

        function handleLogout() {
            if (!firebaseInitialized) {
                showNotification('Firebase not initialized. Please refresh the page.', 'error');
                return;
            }
            
            auth.signOut()
                .then(() => {
                    showNotification('Signed out successfully');
                    // Redirect will happen automatically via onAuthStateChanged
                })
                .catch(error => {
                    console.error('Logout error:', error);
                    showNotification('Error signing out');
                });
        }

        // ========== PLACEHOLDER FUNCTIONS ==========
        // These would be implemented in a real app

        function loadUserProfile() {
            // Placeholder - would load user profile from Firestore
            userDisplayName.textContent = currentUser.displayName || 'User';
            userProfilePic.src = currentUser.photoURL || '';
        }

        function loadFriends() {
            // Placeholder - would load friends from Firestore
            friendsList.innerHTML = '<p class="text-gray-400 text-sm">Friends list would appear here</p>';
        }

        function loadFriendActivity() {
            // Placeholder - would load friend activity from Firestore
            friendsActivity.innerHTML = '<p class="text-gray-400 text-sm">Friend activity would appear here</p>';
        }

        function loadChats() {
            // Placeholder - would load chats from Firestore
            noChatsMessage.classList.remove('hidden');
        }
    </script>
</body>
</html>