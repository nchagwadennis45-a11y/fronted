<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kynecta - Next-Gen Quantum Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="responsive.css">
    <!-- Firebase SDK 9.22.1 -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    
    <style>
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .primary-gradient {
            background: linear-gradient(135deg, #3B82F6 0%, #8B5CF6 100%);
        }
        .message-sent {
            background: linear-gradient(135deg, #3B82F6 0%, #8B5CF6 100%);
            color: white;
            margin-left: auto;
            border-radius: 20px 20px 5px 20px;
        }
        .message-received {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 20px 20px 20px 5px;
            backdrop-filter: blur(10px);
        }

        /* Quantum Features */
        .quantum-entanglement {
            position: relative;
            overflow: hidden;
        }
        .quantum-entanglement::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(59,130,246,0.2) 0%, transparent 70%);
            animation: quantumPulse 3s infinite alternate;
            z-index: -1;
        }
        @keyframes quantumPulse {
            0% { transform: scale(1); opacity: 0.3; }
            100% { transform: scale(1.2); opacity: 0.7; }
        }

        .connection-sync {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.7rem;
            color: #8B5CF6;
            margin-top: 5px;
        }
        .connection-sync.active {
            color: #22C55E;
        }
        .connection-sync-bar {
            width: 60px;
            height: 4px;
            background: rgba(139, 92, 246, 0.3);
            border-radius: 2px;
            overflow: hidden;
        }
        .connection-sync-progress {
            height: 100%;
            background: #8B5CF6;
            border-radius: 2px;
            transition: width 0.5s ease;
        }

        .suggestion-bubble {
            position: relative;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            transition: all 0.3s;
        }
        .suggestion-bubble:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .memory-lane {
            background: rgba(30, 30, 60, 0.7);
            border-radius: 15px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #8B5CF6;
        }

        .quantum-state-message {
            position: relative;
            background: linear-gradient(135deg, rgba(59,130,246,0.2), rgba(139,92,246,0.2));
            border: 1px solid rgba(59,130,246,0.3);
            border-radius: 15px;
            padding: 15px;
            margin: 10px 0;
            overflow: hidden;
        }

        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            z-index: 1000;
            transition: all 0.3s ease-in-out;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .connection-status.connected {
            background: rgba(34, 197, 94, 0.8);
            color: white;
        }
        .connection-status.connecting {
            background: rgba(245, 158, 11, 0.8);
            color: white;
        }
        .connection-status.disconnected {
            background: rgba(239, 68, 68, 0.8);
            color: white;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-container {
            background: rgba(30, 30, 60, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .dropdown-menu {
            position: absolute;
            top: 60px;
            right: 20px;
            background: rgba(30, 30, 60, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 10px;
            padding: 10px;
            min-width: 200px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        .dropdown-item {
            padding: 12px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .dropdown-item:hover {
            background: rgba(59, 130, 246, 0.2);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(34, 197, 94, 0.9);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            z-index: 1001;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        .emoji-picker {
            position: absolute;
            bottom: 70px;
            right: 10px;
            background: rgba(30, 30, 60, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 10px;
            padding: 15px;
            width: 300px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
        }
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 5px;
        }
        .emoji {
            padding: 5px;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        .emoji:hover {
            background: rgba(59, 130, 246, 0.3);
            transform: scale(1.1);
        }
        
        .upload-progress {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
        }
        .upload-progress-bar {
            height: 100%;
            background: #3B82F6;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .media-preview {
            max-height: 200px;
            object-fit: cover;
            border-radius: 12px;
            margin-top: 10px;
        }

        .chat-item {
            padding: 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .chat-item:hover {
            background: rgba(59, 130, 246, 0.2);
        }
        .chat-item.active {
            background: rgba(59, 130, 246, 0.3);
        }
        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3B82F6, #8B5CF6);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            flex-shrink: 0;
        }
        .chat-item-info {
            flex: 1;
            min-width: 0;
        }
        .chat-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        .chat-item-name {
            font-weight: 600;
            color: white;
            font-size: 0.9rem;
        }
        .chat-item-time {
            font-size: 0.75rem;
            color: #8B5CF6;
        }
        .chat-item-preview {
            font-size: 0.8rem;
            color: #94A3B8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 4px;
        }
        .chat-item-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-badge {
            background: #EF4444;
            color: white;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 0.75rem;
        }
        .chat-type-indicator {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 8px;
            background: rgba(139, 92, 246, 0.3);
            color: #8B5CF6;
        }
        .type-personal { background: rgba(34, 197, 94, 0.3); color: #22C55E; }
        .type-group { background: rgba(249, 115, 22, 0.3); color: #F97316; }

        .message {
            margin-bottom: 16px;
            display: flex;
            animation: messageSlideIn 0.3s ease-out;
        }
        @keyframes messageSlideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message.sent {
            justify-content: flex-end;
        }
        .message.received {
            justify-content: flex-start;
        }
        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            transition: all 0.3s;
            position: relative;
        }
        .message-bubble:hover {
            transform: scale(1.02);
        }
        .message-sender {
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 4px;
            color: #E2E8F0;
        }
        .message-content {
            word-wrap: break-word;
        }
        .message-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 4px;
            font-size: 0.75rem;
            opacity: 0.8;
        }
        .message-time {
            color: inherit;
        }
        .message-status {
            margin-left: 8px;
        }

        .no-chats {
            text-align: center;
            padding: 3rem;
            color: #7f8c8d;
        }

        .hidden {
            display: none !important;
        }

        .bubble-blue { background: linear-gradient(135deg, #3B82F6 0%, #8B5CF6 100%) !important; }
        .bubble-green { background: linear-gradient(135deg, #10B981 0%, #059669 100%) !important; }
        .bubble-purple { background: linear-gradient(135deg, #8B5CF6 0%, #A855F7 100%) !important; }
        
        .reply-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 8px;
            margin-bottom: 8px;
            border-left: 3px solid #3B82F6;
        }
        .reply-sender {
            font-size: 0.7rem;
            font-weight: bold;
            color: #3B82F6;
        }
        .reply-content {
            font-size: 0.8rem;
            color: #E2E8F0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .pinned-message {
            border: 2px solid #F59E0B;
            background: rgba(245, 158, 11, 0.1);
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            padding: 8px 16px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 18px;
            width: fit-content;
            margin: 5px 0;
            font-size: 0.8rem;
            color: #94A3B8;
        }
        .typing-dots {
            display: flex;
            margin-left: 8px;
        }
        .typing-dot {
            width: 6px;
            height: 6px;
            background: #94A3B8;
            border-radius: 50%;
            margin: 0 2px;
            animation: typingPulse 1.4s infinite ease-in-out;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typingPulse {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        .sticker-picker {
            position: absolute;
            bottom: 70px;
            right: 10px;
            background: rgba(30, 30, 60, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 10px;
            padding: 15px;
            width: 300px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
        }
        .sticker-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
        }
        .sticker {
            padding: 5px;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            font-size: 2rem;
        }
        .sticker:hover {
            background: rgba(59, 130, 246, 0.3);
            transform: scale(1.1);
        }
        
        .gif-picker {
            position: absolute;
            bottom: 70px;
            right: 10px;
            background: rgba(30, 30, 60, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 10px;
            padding: 15px;
            width: 300px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
        }
        .gif-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px;
        }
        .gif-item {
            border-radius: 5px;
            cursor: pointer;
            overflow: hidden;
            transition: all 0.2s;
        }
        .gif-item:hover {
            transform: scale(1.05);
        }
        .gif-item img {
            width: 100%;
            height: auto;
            border-radius: 5px;
        }
        
        .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }
        
        /* Kynecta Unique Features */
        .sync-indicator {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: linear-gradient(135deg, #10B981, #059669);
            border: 2px solid #1E293B;
            animation: syncPulse 2s infinite;
        }
        @keyframes syncPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.3); opacity: 0.7; }
        }
        
        .hologram-effect {
            position: relative;
            overflow: hidden;
        }
        .hologram-effect::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(59, 130, 246, 0.1), transparent);
            transform: rotate(45deg);
            animation: hologramScan 3s linear infinite;
            z-index: 1;
        }
        @keyframes hologramScan {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }
        
        .ai-suggestion {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 12px;
            padding: 10px 15px;
            margin: 8px 0;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        .ai-suggestion:hover {
            background: rgba(139, 92, 246, 0.2);
            transform: translateY(-2px);
        }
        .ai-suggestion::before {
            content: 'AI';
            position: absolute;
            top: -8px;
            left: 10px;
            background: #8B5CF6;
            color: white;
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 8px;
        }
        
        .mood-adaptive {
            transition: all 0.5s ease;
        }
        .mood-happy { background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(251, 191, 36, 0.2)); }
        .mood-calm { background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(139, 92, 246, 0.2)); }
        .mood-energetic { background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(249, 115, 22, 0.2)); }
        
        .cosmic-background {
            background: 
                radial-gradient(circle at 20% 80%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(16, 185, 129, 0.05) 0%, transparent 50%),
                linear-gradient(135deg, #0F172A 0%, #1E293B 50%, #334155 100%);
        }
        
        .quantum-tunnel {
            position: relative;
            overflow: hidden;
        }
        .quantum-tunnel::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.4), transparent);
            animation: quantumTunnel 3s infinite;
        }
        @keyframes quantumTunnel {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        @media (max-width: 768px) {
            .flex {
                flex-direction: column;
            }
            .w-80 {
                width: 100%;
            }
            .message-bubble {
                max-width: 85%;
            }
            .modal-container {
                width: 95%;
                padding: 15px;
            }
        }

        /* Video Call Styles */
        .video-call-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 2000;
            display: none;
        }
        .local-video {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 200px;
            height: 150px;
            border: 2px solid #3B82F6;
            border-radius: 10px;
        }
        .remote-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .call-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
        }
        .call-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        .call-end {
            background: #EF4444;
            color: white;
        }
        .call-mute {
            background: #6B7280;
            color: white;
        }
        .call-video {
            background: #3B82F6;
            color: white;
        }
        
        /* AR Mode */
        .ar-mode {
            transform: perspective(1000px) rotateX(5deg);
            transition: transform 0.5s ease;
        }
        
        .network-activity {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }
        .network-node {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #3B82F6;
            border-radius: 50%;
            animation: networkConnect 3s infinite linear;
        }
        @keyframes networkConnect {
            0%, 100% { opacity: 0; transform: scale(0); }
            50% { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="h-full cosmic-background text-white">
    <!-- Connection Status -->
    <div class="connection-status connecting" id="connectionStatus">
        <i class="fas fa-circle-notch fa-spin"></i>
        <span>Connecting to Kynecta...</span>
    </div>

    <!-- Authentication Required Screen -->
    <div id="auth-required" class="h-full flex items-center justify-center">
        <div class="text-center max-w-md p-8 glass-effect rounded-2xl border border-blue-800/50">
            <div class="text-8xl mb-6 opacity-50 hologram-effect rounded-full w-32 h-32 mx-auto flex items-center justify-center">
                <i class="fas fa-user-lock"></i>
            </div>
            <h2 class="text-3xl font-bold text-blue-300 mb-4">Authentication Required</h2>
            <p class="text-blue-400 mb-8 text-lg">Sign in to access Kynecta</p>
            <div class="space-y-4">
                <button onclick="redirectToLogin()" class="primary-gradient text-white px-8 py-4 rounded-2xl font-semibold hover:opacity-90 transition-all duration-300 transform hover:scale-105 shadow-lg w-full quantum-tunnel">
                    <i class="fas fa-sign-in-alt mr-2"></i>Sign In
                </button>
            </div>
        </div>
    </div>

    <!-- Main Chat App -->
    <div id="chat-app" class="hidden h-full flex flex-col">
        <!-- Header -->
        <div class="glass-effect border-b border-blue-800/50 p-3">
            <div class="flex items-center justify-between max-w-6xl mx-auto">
                <div class="flex items-center space-x-4">
                    <h1 class="text-xl font-bold text-blue-300">Kynecta Quantum Chat</h1>
                    <div class="quantum-entanglement p-2 rounded-lg">
                        <span class="text-xs text-blue-300">Quantum Sync: Active</span>
                    </div>
                </div>
                
                <div class="flex items-center space-x-3">
                    <button id="ar-toggle" class="text-purple-300 hover:text-purple-200 text-sm transition-colors" title="AR Mode">
                        <i class="fas fa-vr-cardboard"></i>
                    </button>
                    <button id="ai-mode" class="text-green-300 hover:text-green-200 text-sm transition-colors" title="AI Mode">
                        <i class="fas fa-robot"></i>
                    </button>
                    <button id="logout-btn" class="text-red-300 hover:text-red-200 text-sm transition-colors">
                        <i class="fas fa-sign-out-alt"></i> Sign Out
                    </button>
                </div>
            </div>
        </div>

        <div class="flex flex-1 overflow-hidden" id="mainContainer">
            <!-- Sidebar -->
            <div class="w-80 bg-gray-900/80 border-r border-blue-800/50 flex flex-col">
                <div class="p-4 border-b border-blue-800/50">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold text-blue-300">Connections</h2>
                        <button class="text-blue-400 hover:text-blue-300 transition-colors" id="createGroupBtn" title="Create Group">
                            <i class="fas fa-users"></i>
                        </button>
                    </div>
                    
                    <!-- Search -->
                    <div class="relative mb-4">
                        <input type="text" id="chatSearch" placeholder="Search connections..." class="w-full bg-gray-800/50 border border-blue-700/50 rounded-lg py-2 px-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <i class="fas fa-search absolute right-3 top-2.5 text-blue-400"></i>
                    </div>

                    <!-- AI Assistant -->
                    <div class="ai-suggestion mb-4" id="aiAssistant">
                        <div class="text-xs text-purple-400 mb-1">Kynecta AI</div>
                        <div class="text-sm">Ready to help optimize your connections</div>
                    </div>

                    <!-- Friends List -->
                    <div class="mb-4">
                        <h3 class="text-sm font-semibold text-blue-300 mb-2">Online Now</h3>
                        <div id="friendsList" class="max-h-40 overflow-y-auto space-y-2">
                            <!-- Friends will be populated dynamically -->
                        </div>
                    </div>
                </div>

                <!-- Chat List -->
                <div class="flex-1 overflow-y-auto p-2" id="chatList">
                    <div class="no-chats" id="noChatsMessage">
                        <i class="fas fa-comments text-4xl mb-3 text-blue-400"></i>
                        <p class="text-blue-300">No conversations yet</p>
                        <p class="text-sm text-blue-400 mt-1">Start a conversation to begin</p>
                    </div>
                </div>
                
                <!-- User Profile -->
                <div class="p-4 border-t border-blue-800/50">
                    <div class="flex items-center space-x-3">
                        <div class="relative">
                            <img src="" alt="Profile" class="profile-pic" id="userProfilePic">
                            <div class="sync-indicator"></div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="font-medium text-sm truncate" id="userDisplayName">Loading...</p>
                            <div class="connection-sync active">
                                <span class="text-xs">Connection:</span>
                                <div class="connection-sync-bar">
                                    <div class="connection-sync-progress" style="width: 92%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Chat Area -->
            <div class="flex-1 flex flex-col">
                <!-- Chat Header -->
                <div class="glass-effect border-b border-blue-800/50 p-4" id="chatHeader">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="relative">
                                <img src="" alt="Chat Avatar" class="profile-pic" id="chatHeaderAvatar">
                                <div class="sync-indicator"></div>
                            </div>
                            <div>
                                <h3 class="font-bold" id="chatHeaderName">Select a chat</h3>
                                <p class="text-xs text-blue-300" id="chatHeaderStatus">Choose a conversation</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-4" id="chatActions">
                            <button class="text-blue-400 hover:text-blue-300 transition-colors" id="videoCallBtn" title="Video Call">
                                <i class="fas fa-video"></i>
                            </button>
                            <button class="text-blue-400 hover:text-blue-300 transition-colors" id="voiceCallBtn" title="Voice Call">
                                <i class="fas fa-phone"></i>
                            </button>
                            <button class="text-blue-400 hover:text-blue-300 transition-colors" id="quantumMessageBtn" title="Quantum Message">
                                <i class="fas fa-atom"></i>
                            </button>
                            <button class="text-blue-400 hover:text-blue-300 transition-colors" id="aiEnhanceBtn" title="AI Enhance">
                                <i class="fas fa-magic"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Messages Area -->
                <div class="flex-1 overflow-y-auto p-4" id="messagesContainer">
                    <div class="text-center text-blue-300 py-10" id="noMessagesMessage">
                        <i class="fas fa-comments text-4xl mb-3"></i>
                        <p>No messages yet</p>
                        <p class="text-sm mt-1">Select a chat to start messaging</p>
                    </div>

                    <!-- Kynecta Features -->
                    <div class="suggestion-bubble hidden" id="suggestionBubble">
                        <div class="text-xs text-blue-400 mb-1">AI Suggestion</div>
                        <div class="text-sm">Try asking about their interests for better engagement</div>
                    </div>

                    <div class="memory-lane hidden" id="memoryLane">
                        <div class="memory-date">Memory Lane</div>
                        <div class="memory-content">Your conversation highlights will appear here</div>
                    </div>
                </div>

                <!-- Typing Indicator -->
                <div class="hidden" id="typingIndicator">
                    <div class="typing-indicator">
                        <span id="typingUsers"></span>
                        <div class="typing-dots">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                </div>

                <!-- AI Suggestions -->
                <div class="hidden" id="aiSuggestions">
                    <div class="ai-suggestion">
                        <div class="text-xs text-purple-400 mb-1">Conversation Helper</div>
                        <div class="text-sm">Try asking about their recent activities</div>
                    </div>
                </div>

                <!-- Message Input -->
                <div class="glass-effect border-t border-blue-800/50 p-4">
                    <div class="flex items-center space-x-2">
                        <button class="text-blue-400 hover:text-blue-300 transition-colors p-2 rounded-full hover:bg-blue-800/50" id="emojiBtn">
                            <i class="fas fa-smile"></i>
                        </button>
                        <button class="text-blue-400 hover:text-blue-300 transition-colors p-2 rounded-full hover:bg-blue-800/50" id="attachmentBtn">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <button class="text-blue-400 hover:text-blue-300 transition-colors p-2 rounded-full hover:bg-blue-800/50" id="gifBtn">
                            <i class="fas fa-film"></i>
                        </button>
                        <button class="text-blue-400 hover:text-blue-300 transition-colors p-2 rounded-full hover:bg-blue-800/50" id="stickerBtn">
                            <i class="fas fa-sticky-note"></i>
                        </button>
                        
                        <div class="flex-1 relative">
                            <input type="text" id="messageInput" placeholder="Select a chat to start messaging..." class="w-full bg-gray-800/50 border border-blue-700/50 rounded-full py-3 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                            
                            <!-- Emoji Picker -->
                            <div class="emoji-picker hidden" id="emojiPicker">
                                <div class="emoji-grid" id="emojiGrid"></div>
                            </div>
                            
                            <!-- Sticker Picker -->
                            <div class="sticker-picker hidden" id="stickerPicker">
                                <div class="sticker-grid" id="stickerGrid"></div>
                            </div>
                            
                            <!-- GIF Picker -->
                            <div class="gif-picker hidden" id="gifPicker">
                                <div class="gif-grid" id="gifGrid"></div>
                            </div>
                        </div>
                        
                        <button class="primary-gradient hover:opacity-90 text-white p-3 rounded-full transition-colors" id="sendBtn" disabled>
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    
                    <!-- Upload Progress -->
                    <div class="upload-progress hidden" id="uploadProgress">
                        <div class="upload-progress-bar" id="uploadProgressBar"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Video Call Container -->
    <div class="video-call-container" id="videoCallContainer">
        <video class="remote-video" id="remoteVideo" autoplay></video>
        <video class="local-video" id="localVideo" autoplay muted></video>
        <div class="call-controls">
            <button class="call-btn call-mute" id="muteBtn">
                <i class="fas fa-microphone"></i>
            </button>
            <button class="call-btn call-video" id="videoToggleBtn">
                <i class="fas fa-video"></i>
            </button>
            <button class="call-btn call-end" id="endCallBtn">
                <i class="fas fa-phone"></i>
            </button>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal" id="createGroupModal">
        <div class="modal-container">
            <h3 class="text-xl font-bold mb-4">Create Group</h3>
            <input type="text" id="groupName" placeholder="Group name" class="w-full bg-gray-800 border border-blue-700 rounded-lg py-2 px-3 mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <div class="mb-4">
                <p class="mb-2 text-blue-300">Select members:</p>
                <div id="groupFriendsList" class="max-h-40 overflow-y-auto space-y-2">
                    <!-- Friends will be populated here -->
                </div>
            </div>
            <div class="flex justify-end space-x-2">
                <button class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors" id="cancelCreateGroup">Cancel</button>
                <button class="px-4 py-2 primary-gradient hover:opacity-90 rounded-lg transition-colors" id="confirmCreateGroup">Create Group</button>
            </div>
        </div>
    </div>

    <div class="modal" id="quantumMessageModal">
        <div class="modal-container">
            <h3 class="text-xl font-bold mb-4">Create Quantum Message</h3>
            <p class="text-blue-400 mb-4">Quantum messages exist in multiple states until observed by the recipient.</p>
            <textarea id="quantumMessageText" placeholder="Enter your quantum message..." class="w-full bg-gray-800 border border-blue-700 rounded-lg py-2 px-3 mb-4 h-32 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
            <div class="flex items-center space-x-2 mb-4">
                <input type="checkbox" id="superposition" class="rounded text-blue-600">
                <label for="superposition" class="text-sm text-blue-300">Enable quantum superposition</label>
            </div>
            <div class="flex justify-end space-x-2">
                <button class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors" id="cancelQuantumMessage">Cancel</button>
                <button class="px-4 py-2 primary-gradient hover:opacity-90 rounded-lg transition-colors" id="confirmQuantumMessage">Send Quantum</button>
            </div>
        </div>
    </div>

    <!-- Firebase Configuration -->
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDHHyGgsSV18BcXrGgzi4C8frzDAE1C1zo",
            authDomain: "uniconnect-ee95c.firebaseapp.com",
            projectId: "uniconnect-ee95c",
            storageBucket: "uniconnect-ee95c.firebasestorage.app",
            messagingSenderId: "1003264444309",
            appId: "1:1003264444309:web:9f0307516e44d21e97d89c"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Global variables
        let currentUser = null;
        let currentChatId = null;
        let typingTimeout = null;
        let messagesListener = null;
        let chatsListener = null;
        let typingListener = null;
        let localStream = null;
        let remoteStream = null;
        let peerConnection = null;
        let isArMode = false;
        let isAiMode = false;
    </script>

    <!-- Application Logic -->
    <script>
        // DOM Elements
        const authRequired = document.getElementById('auth-required');
        const chatApp = document.getElementById('chat-app');
        const connectionStatus = document.getElementById('connectionStatus');
        const chatList = document.getElementById('chatList');
        const noChatsMessage = document.getElementById('noChatsMessage');
        const friendsList = document.getElementById('friendsList');
        const messagesContainer = document.getElementById('messagesContainer');
        const noMessagesMessage = document.getElementById('noMessagesMessage');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const chatHeaderName = document.getElementById('chatHeaderName');
        const chatHeaderStatus = document.getElementById('chatHeaderStatus');
        const chatHeaderAvatar = document.getElementById('chatHeaderAvatar');
        const userProfilePic = document.getElementById('userProfilePic');
        const userDisplayName = document.getElementById('userDisplayName');
        const logoutBtn = document.getElementById('logoutBtn');
        const emojiBtn = document.getElementById('emojiBtn');
        const emojiPicker = document.getElementById('emojiPicker');
        const emojiGrid = document.getElementById('emojiGrid');
        const stickerBtn = document.getElementById('stickerBtn');
        const stickerPicker = document.getElementById('stickerPicker');
        const stickerGrid = document.getElementById('stickerGrid');
        const gifBtn = document.getElementById('gifBtn');
        const gifPicker = document.getElementById('gifPicker');
        const gifGrid = document.getElementById('gifGrid');
        const attachmentBtn = document.getElementById('attachmentBtn');
        const uploadProgress = document.getElementById('uploadProgress');
        const uploadProgressBar = document.getElementById('uploadProgressBar');
        const typingIndicator = document.getElementById('typingIndicator');
        const typingUsers = document.getElementById('typingUsers');
        const videoCallBtn = document.getElementById('videoCallBtn');
        const voiceCallBtn = document.getElementById('voiceCallBtn');
        const quantumMessageBtn = document.getElementById('quantumMessageBtn');
        const aiEnhanceBtn = document.getElementById('aiEnhanceBtn');
        const videoCallContainer = document.getElementById('videoCallContainer');
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const muteBtn = document.getElementById('muteBtn');
        const videoToggleBtn = document.getElementById('videoToggleBtn');
        const endCallBtn = document.getElementById('endCallBtn');
        const createGroupBtn = document.getElementById('createGroupBtn');
        const createGroupModal = document.getElementById('createGroupModal');
        const cancelCreateGroup = document.getElementById('cancelCreateGroup');
        const confirmCreateGroup = document.getElementById('confirmCreateGroup');
        const groupName = document.getElementById('groupName');
        const groupFriendsList = document.getElementById('groupFriendsList');
        const quantumMessageModal = document.getElementById('quantumMessageModal');
        const cancelQuantumMessage = document.getElementById('cancelQuantumMessage');
        const confirmQuantumMessage = document.getElementById('confirmQuantumMessage');
        const quantumMessageText = document.getElementById('quantumMessageText');
        const suggestionBubble = document.getElementById('suggestionBubble');
        const memoryLane = document.getElementById('memoryLane');
        const aiAssistant = document.getElementById('aiAssistant');
        const aiSuggestions = document.getElementById('aiSuggestions');
        const arToggle = document.getElementById('ar-toggle');
        const aiMode = document.getElementById('ai-mode');
        const mainContainer = document.getElementById('mainContainer');
        const chatSearch = document.getElementById('chatSearch');

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication state
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    authRequired.classList.add('hidden');
                    chatApp.classList.remove('hidden');
                    loadUserProfile();
                    loadFriends();
                    loadChats();
                    updateConnectionStatus('connected');
                    initializeNetworkActivity();
                } else {
                    currentUser = null;
                    authRequired.classList.remove('hidden');
                    chatApp.classList.add('hidden');
                }
            });

            // Set up event listeners
            setupEventListeners();
            initializeEmojiPicker();
            initializeStickerPicker();
            initializeGifPicker();
        });

        function setupEventListeners() {
            // Message sending
            messageInput.addEventListener('input', handleMessageInput);
            messageInput.addEventListener('keypress', e => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            sendBtn.addEventListener('click', sendMessage);

            // Typing indicators
            messageInput.addEventListener('focus', startTyping);
            messageInput.addEventListener('blur', stopTyping);

            // UI interactions
            emojiBtn.addEventListener('click', toggleEmojiPicker);
            stickerBtn.addEventListener('click', toggleStickerPicker);
            gifBtn.addEventListener('click', toggleGifPicker);
            attachmentBtn.addEventListener('click', handleAttachment);
            logoutBtn.addEventListener('click', handleLogout);
            
            // Video call
            videoCallBtn.addEventListener('click', startVideoCall);
            voiceCallBtn.addEventListener('click', startVoiceCall);
            quantumMessageBtn.addEventListener('click', showQuantumMessageModal);
            aiEnhanceBtn.addEventListener('click', toggleAIEnhance);
            endCallBtn.addEventListener('click', endCall);
            muteBtn.addEventListener('click', toggleMute);
            videoToggleBtn.addEventListener('click', toggleVideo);
            
            // Group creation
            createGroupBtn.addEventListener('click', showCreateGroupModal);
            cancelCreateGroup.addEventListener('click', hideCreateGroupModal);
            confirmCreateGroup.addEventListener('click', createGroup);
            
            // Quantum message
            cancelQuantumMessage.addEventListener('click', hideQuantumMessageModal);
            confirmQuantumMessage.addEventListener('click', sendQuantumMessage);
            
            // AI Assistant
            aiAssistant.addEventListener('click', interactWithAI);
            
            // AR/AI modes
            arToggle.addEventListener('click', toggleARMode);
            aiMode.addEventListener('click', toggleAIMode);
            
            // Search
            chatSearch.addEventListener('input', filterChats);
            
            // Close modals when clicking outside
            document.addEventListener('click', e => {
                if (!emojiPicker.contains(e.target) && e.target !== emojiBtn) {
                    emojiPicker.classList.add('hidden');
                }
                if (!stickerPicker.contains(e.target) && e.target !== stickerBtn) {
                    stickerPicker.classList.add('hidden');
                }
                if (!gifPicker.contains(e.target) && e.target !== gifBtn) {
                    gifPicker.classList.add('hidden');
                }
                if (e.target === createGroupModal) {
                    hideCreateGroupModal();
                }
                if (e.target === quantumMessageModal) {
                    hideQuantumMessageModal();
                }
            });
        }

        function updateConnectionStatus(status) {
            connectionStatus.className = 'connection-status ' + status;
            switch(status) {
                case 'connected':
                    connectionStatus.innerHTML = '<i class="fas fa-check-circle"></i><span>Connected to Kynecta</span>';
                    break;
                case 'connecting':
                    connectionStatus.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i><span>Connecting to Kynecta...</span>';
                    break;
                case 'disconnected':
                    connectionStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>Connection Lost</span>';
                    break;
            }
        }

        function loadUserProfile() {
            if (!currentUser) return;
            
            // Set user display name
            userDisplayName.textContent = currentUser.displayName || 'User';
            
            // Set user profile picture
            if (currentUser.photoURL) {
                userProfilePic.src = currentUser.photoURL;
                chatHeaderAvatar.src = currentUser.photoURL;
            } else {
                // Generate a default avatar based on user initials
                const initials = currentUser.displayName ? 
                    currentUser.displayName.split(' ').map(n => n[0]).join('').toUpperCase() : 
                    'U';
                userProfilePic.src = `https://ui-avatars.com/api/?name=${initials}&background=3B82F6&color=fff&size=40`;
                chatHeaderAvatar.src = `https://ui-avatars.com/api/?name=${initials}&background=3B82F6&color=fff&size=40`;
            }
        }

        function loadFriends() {
            // In a real app, this would fetch from Firestore
            // For demo purposes, we'll generate dynamic data
            const friendNames = ['Alex Johnson', 'Sam Wilson', 'Jordan Lee', 'Taylor Swift', 'Morgan Freeman'];
            const statuses = ['Online', 'Away', 'Busy', 'Offline'];
            
            friendsList.innerHTML = '';
            friendNames.forEach((name, index) => {
                const status = statuses[Math.floor(Math.random() * statuses.length)];
                const friendId = 'friend' + (index + 1);
                const avatarUrl = `https://i.pravatar.cc/150?img=${Math.floor(Math.random() * 70) + 1}`;
                
                const friendElement = document.createElement('div');
                friendElement.className = 'flex items-center space-x-3 p-2 rounded-lg hover:bg-blue-800/50 cursor-pointer';
                friendElement.innerHTML = `
                    <div class="relative">
                        <img src="${avatarUrl}" alt="${name}" class="w-8 h-8 rounded-full">
                        <div class="absolute bottom-0 right-0 w-2 h-2 ${status === 'Online' ? 'bg-green-500' : status === 'Away' ? 'bg-yellow-500' : status === 'Busy' ? 'bg-red-500' : 'bg-gray-500'} rounded-full border border-white"></div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium truncate">${name}</p>
                        <p class="text-xs text-blue-300">${status}</p>
                    </div>
                `;
                friendElement.addEventListener('click', () => startChatWithFriend({id: friendId, name: name, avatar: avatarUrl, status: status}));
                friendsList.appendChild(friendElement);
            });
        }

        function loadChats() {
            // In a real app, this would fetch from Firestore
            // For demo purposes, we'll generate dynamic data
            const chatNames = ['Tech Team', 'Family Group', 'Project Discussion', 'Friends Circle'];
            const lastMessages = [
                'Let me know when you are available for a call',
                'Did you see the latest updates?',
                'The meeting has been rescheduled to tomorrow',
                'Thanks for your help with the project!'
            ];
            
            chatList.innerHTML = '';
            
            if (chatNames.length === 0) {
                noChatsMessage.classList.remove('hidden');
                return;
            }
            
            noChatsMessage.classList.add('hidden');
            
            chatNames.forEach((name, index) => {
                const chatId = 'chat' + (index + 1);
                const lastMessage = lastMessages[index];
                const timestamp = new Date(Date.now() - Math.random() * 7 * 24 * 3600000); // Random time in last 7 days
                const unread = Math.random() > 0.7 ? Math.floor(Math.random() * 5) + 1 : 0;
                const type = Math.random() > 0.5 ? 'group' : 'personal';
                const participants = ['user1', 'friend1', 'friend2', 'friend3'].slice(0, Math.floor(Math.random() * 4) + 2);
                
                const chatElement = document.createElement('div');
                chatElement.className = 'chat-item';
                chatElement.dataset.chatId = chatId;
                chatElement.dataset.chatName = name;
                
                const timeString = formatTime(timestamp);
                const avatarUrl = type === 'personal' ? `https://i.pravatar.cc/150?img=${Math.floor(Math.random() * 70) + 1}` : null;
                
                chatElement.innerHTML = `
                    <div class="chat-avatar">
                        ${!avatarUrl ? name.split(' ').map(n => n[0]).join('').toUpperCase() : ''}
                    </div>
                    <div class="chat-item-info">
                        <div class="chat-item-header">
                            <span class="chat-item-name">${name}</span>
                            <span class="chat-item-time">${timeString}</span>
                        </div>
                        <div class="chat-item-preview">${lastMessage}</div>
                        <div class="chat-item-meta">
                            <span class="chat-type-indicator ${type === 'group' ? 'type-group' : 'type-personal'}">${type === 'group' ? 'Group' : 'Direct'}</span>
                            ${unread > 0 ? `<span class="chat-badge">${unread}</span>` : ''}
                        </div>
                    </div>
                `;
                
                if (avatarUrl) {
                    const avatarImg = chatElement.querySelector('.chat-avatar');
                    avatarImg.innerHTML = '';
                    const img = document.createElement('img');
                    img.src = avatarUrl;
                    img.alt = name;
                    img.className = 'profile-pic';
                    avatarImg.appendChild(img);
                }
                
                chatElement.addEventListener('click', () => selectChat({
                    id: chatId,
                    name: name,
                    lastMessage: lastMessage,
                    timestamp: timestamp,
                    unread: unread,
                    type: type,
                    avatar: avatarUrl,
                    participants: participants
                }));
                chatList.appendChild(chatElement);
            });
        }

        function selectChat(chat) {
            // Remove active class from all chats
            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to selected chat
            const selectedChat = document.querySelector(`[data-chat-id="${chat.id}"]`);
            if (selectedChat) {
                selectedChat.classList.add('active');
            }
            
            // Update chat header
            chatHeaderName.textContent = chat.name;
            chatHeaderStatus.textContent = chat.type === 'group' ? `${chat.participants.length} members` : 'Online';
            
            // Set chat avatar
            if (chat.avatar) {
                chatHeaderAvatar.src = chat.avatar;
            } else {
                // Generate a default avatar
                const initials = chat.name.split(' ').map(n => n[0]).join('').toUpperCase();
                chatHeaderAvatar.src = `https://ui-avatars.com/api/?name=${initials}&background=8B5CF6&color=fff&size=40`;
            }
            
            // Enable message input
            messageInput.disabled = false;
            messageInput.placeholder = `Message ${chat.name}...`;
            sendBtn.disabled = false;
            
            // Hide no messages message
            noMessagesMessage.classList.add('hidden');
            
            // Set current chat
            currentChatId = chat.id;
            
            // Load messages for this chat
            loadMessages(chat.id);
            
            // Show features occasionally
            showSpecialFeatures();
            
            // Show AI suggestions
            showAISuggestions();
        }

        function loadMessages(chatId) {
            // Clear existing messages
            messagesContainer.innerHTML = '';
            
            // In a real app, this would fetch from Firestore
            // For demo purposes, we'll generate dynamic messages
            const messageCount = Math.floor(Math.random() * 10) + 5;
            const senders = [currentUser.uid, 'friend1', 'friend2', 'friend3'];
            const senderNames = [currentUser.displayName || 'You', 'Alex Johnson', 'Sam Wilson', 'Jordan Lee'];
            const messageTemplates = [
                "Hey, how are you doing today?",
                "Did you get a chance to look at the document I sent?",
                "Let's schedule a meeting for next week",
                "The project is coming along really well",
                "Thanks for your help with this!",
                "Can you send me those files when you get a chance?",
                "I'll be available for a call in about an hour",
                "Let me know if you need anything else",
                "That sounds like a great idea!",
                "Looking forward to working together on this"
            ];
            
            // Display messages
            for (let i = 0; i < messageCount; i++) {
                const senderIndex = Math.floor(Math.random() * senders.length);
                const messageIndex = Math.floor(Math.random() * messageTemplates.length);
                const timestamp = new Date(Date.now() - Math.random() * 24 * 3600000); // Random time in last 24 hours
                
                const message = {
                    id: 'msg' + i,
                    senderId: senders[senderIndex],
                    senderName: senderNames[senderIndex],
                    content: messageTemplates[messageIndex],
                    timestamp: timestamp,
                    type: 'text'
                };
                
                displayMessage(message);
            }
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function displayMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.senderId === currentUser.uid ? 'sent' : 'received'} mood-adaptive`;
            
            // Add random mood class for visual variety
            const moods = ['mood-happy', 'mood-calm', 'mood-energetic'];
            const randomMood = moods[Math.floor(Math.random() * moods.length)];
            if (message.senderId !== currentUser.uid) {
                messageDiv.classList.add(randomMood);
            }
            
            const timeString = formatTime(message.timestamp);
            
            messageDiv.innerHTML = `
                <div class="message-bubble ${message.senderId === currentUser.uid ? 'message-sent' : 'message-received'}">
                    ${message.senderId !== currentUser.uid ? `<div class="message-sender">${message.senderName}</div>` : ''}
                    <div class="message-content">${message.content}</div>
                    <div class="message-meta">
                        <span class="message-time">${timeString}</span>
                        ${message.senderId === currentUser.uid ? `<span class="message-status"><i class="fas fa-check-double"></i></span>` : ''}
                    </div>
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
        }

        function handleMessageInput() {
            if (messageInput.value.trim() !== '') {
                sendBtn.disabled = false;
            } else {
                sendBtn.disabled = true;
            }
        }

        function sendMessage() {
            const content = messageInput.value.trim();
            if (!content || !currentChatId) return;
            
            // Create message object
            const message = {
                id: generateId(),
                senderId: currentUser.uid,
                senderName: currentUser.displayName || 'You',
                content: content,
                timestamp: new Date(),
                type: 'text'
            };
            
            // Display message immediately (optimistic update)
            displayMessage(message);
            
            // Clear input
            messageInput.value = '';
            sendBtn.disabled = true;
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // In a real app, this would save to Firestore
            console.log('Message sent:', message);
            
            // Show notification
            showNotification('Message sent');
            
            // Simulate AI response occasionally
            if (Math.random() > 0.7) {
                setTimeout(() => {
                    const aiResponse = generateAIResponse(content);
                    const responseMessage = {
                        id: generateId(),
                        senderId: 'ai-assistant',
                        senderName: 'Kynecta AI',
                        content: aiResponse,
                        timestamp: new Date(),
                        type: 'text'
                    };
                    displayMessage(responseMessage);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }, 1000 + Math.random() * 2000);
            }
        }

        function generateAIResponse(userMessage) {
            const responses = [
                "That's an interesting point! Have you considered other perspectives?",
                "I'm here to help if you need any assistance with that.",
                "Great conversation! Would you like me to suggest some related topics?",
                "Based on our chat history, you might find this information useful...",
                "I notice you're discussing this topic in depth. Would you like me to provide additional resources?"
            ];
            return responses[Math.floor(Math.random() * responses.length)];
        }

        function startTyping() {
            if (!currentChatId) return;
            
            // In a real app, this would update a typing indicator in Firestore
            console.log('User started typing');
        }

        function stopTyping() {
            if (!currentChatId) return;
            
            // In a real app, this would clear the typing indicator in Firestore
            console.log('User stopped typing');
        }

        function toggleEmojiPicker() {
            emojiPicker.classList.toggle('hidden');
            stickerPicker.classList.add('hidden');
            gifPicker.classList.add('hidden');
        }

        function toggleStickerPicker() {
            stickerPicker.classList.toggle('hidden');
            emojiPicker.classList.add('hidden');
            gifPicker.classList.add('hidden');
        }

        function toggleGifPicker() {
            gifPicker.classList.toggle('hidden');
            emojiPicker.classList.add('hidden');
            stickerPicker.classList.add('hidden');
        }

        function initializeEmojiPicker() {
            const emojis = ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''];
            
            emojis.forEach(emoji => {
                const emojiElement = document.createElement('div');
                emojiElement.className = 'emoji';
                emojiElement.textContent = emoji;
                emojiElement.addEventListener('click', () => {
                    messageInput.value += emoji;
                    emojiPicker.classList.add('hidden');
                    messageInput.focus();
                });
                emojiGrid.appendChild(emojiElement);
            });
        }

        function initializeStickerPicker() {
            const stickers = ['', '', '', '', '', '', '', '', '', '', '', ''];
            
            stickers.forEach(sticker => {
                const stickerElement = document.createElement('div');
                stickerElement.className = 'sticker';
                stickerElement.textContent = sticker;
                stickerElement.addEventListener('click', () => {
                    // In a real app, this would send a sticker message
                    showNotification('Sticker sent: ' + sticker);
                    stickerPicker.classList.add('hidden');
                });
                stickerGrid.appendChild(stickerElement);
            });
        }

        function initializeGifPicker() {
            // In a real app, this would fetch from a GIF API
            // For demo purposes, we'll use placeholder images
            const gifUrls = [
                'https://media.giphy.com/media/3o7aCTPPm4OHfRLSH6/giphy.gif',
                'https://media.giphy.com/media/l0HlBO7eyRzqkJgMw/giphy.gif',
                'https://media.giphy.com/media/3o72FfM5HJydzafgUE/giphy.gif',
                'https://media.giphy.com/media/xT5LMHxhOfscxPfIfm/giphy.gif'
            ];
            
            gifUrls.forEach(url => {
                const gifElement = document.createElement('div');
                gifElement.className = 'gif-item';
                
                const img = document.createElement('img');
                img.src = url;
                img.alt = 'GIF';
                
                gifElement.appendChild(img);
                gifElement.addEventListener('click', () => {
                    // In a real app, this would send a GIF message
                    showNotification('GIF sent');
                    gifPicker.classList.add('hidden');
                });
                
                gifGrid.appendChild(gifElement);
            });
        }

        function handleAttachment() {
            // Create a file input element
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*, video/*, audio/*, .pdf, .doc, .docx';
            fileInput.style.display = 'none';
            
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    uploadFile(file);
                }
            });
            
            document.body.appendChild(fileInput);
            fileInput.click();
            document.body.removeChild(fileInput);
        }

        function uploadFile(file) {
            if (!currentChatId) return;
            
            // Show upload progress
            uploadProgress.classList.remove('hidden');
            uploadProgressBar.style.width = '0%';
            
            // In a real app, this would upload to Firebase Storage
            // For demo purposes, we'll simulate upload progress
            let progress = 0;
            const interval = setInterval(() => {
                progress += 5;
                uploadProgressBar.style.width = `${progress}%`;
                
                if (progress >= 100) {
                    clearInterval(interval);
                    
                    // Hide progress bar after a delay
                    setTimeout(() => {
                        uploadProgress.classList.add('hidden');
                    }, 1000);
                    
                    // Show notification
                    showNotification(`File "${file.name}" uploaded successfully`);
                    
                    // Create and send a file message
                    const message = {
                        id: generateId(),
                        senderId: currentUser.uid,
                        senderName: currentUser.displayName || 'You',
                        content: `Sent a file: ${file.name}`,
                        timestamp: new Date(),
                        type: 'file',
                        file: {
                            name: file.name,
                            url: URL.createObjectURL(file), // In real app, this would be the Firebase Storage URL
                            type: file.type
                        }
                    };
                    
                    // Display message
                    displayMessage(message);
                    
                    // Scroll to bottom
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            }, 100);
        }

        function startVideoCall() {
            if (!currentChatId) {
                showNotification('Please select a chat first');
                return;
            }
            
            // Show video call container
            videoCallContainer.style.display = 'block';
            
            // In a real app, this would initialize WebRTC
            // For demo purposes, we'll just show the UI
            showNotification('Starting video call...');
            
            // Simulate getting camera access
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                    .then(stream => {
                        localStream = stream;
                        localVideo.srcObject = stream;
                        showNotification('Camera and microphone access granted');
                    })
                    .catch(error => {
                        console.error('Error accessing media devices:', error);
                        showNotification('Could not access camera or microphone');
                    });
            }
        }

        function startVoiceCall() {
            if (!currentChatId) {
                showNotification('Please select a chat first');
                return;
            }
            
            // In a real app, this would initialize a voice call
            showNotification('Starting voice call...');
            
            // Simulate getting microphone access
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(stream => {
                        localStream = stream;
                        showNotification('Microphone access granted');
                    })
                    .catch(error => {
                        console.error('Error accessing microphone:', error);
                        showNotification('Could not access microphone');
                    });
            }
        }

        function endCall() {
            // Hide video call container
            videoCallContainer.style.display = 'none';
            
            // Stop local stream
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            // In a real app, this would end the call and clean up resources
            showNotification('Call ended');
        }

        function toggleMute() {
            if (!localStream) return;
            
            const audioTracks = localStream.getAudioTracks();
            if (audioTracks.length > 0) {
                const enabled = audioTracks[0].enabled;
                audioTracks[0].enabled = !enabled;
                
                const icon = muteBtn.querySelector('i');
                if (enabled) {
                    icon.classList.remove('fa-microphone');
                    icon.classList.add('fa-microphone-slash');
                    showNotification('Microphone muted');
                } else {
                    icon.classList.remove('fa-microphone-slash');
                    icon.classList.add('fa-microphone');
                    showNotification('Microphone unmuted');
                }
            }
        }

        function toggleVideo() {
            if (!localStream) return;
            
            const videoTracks = localStream.getVideoTracks();
            if (videoTracks.length > 0) {
                const enabled = videoTracks[0].enabled;
                videoTracks[0].enabled = !enabled;
                
                const icon = videoToggleBtn.querySelector('i');
                if (enabled) {
                    icon.classList.remove('fa-video');
                    icon.classList.add('fa-video-slash');
                    showNotification('Video turned off');
                } else {
                    icon.classList.remove('fa-video-slash');
                    icon.classList.add('fa-video');
                    showNotification('Video turned on');
                }
            }
        }

        function toggleAIEnhance() {
            aiSuggestions.classList.toggle('hidden');
            if (aiSuggestions.classList.contains('hidden')) {
                showNotification('AI suggestions disabled');
            } else {
                showNotification('AI suggestions enabled');
            }
        }

        function showCreateGroupModal() {
            createGroupModal.style.display = 'flex';
            
            // Populate friends list for group creation
            groupFriendsList.innerHTML = '';
            const friends = friendsList.querySelectorAll('.flex.items-center');
            
            friends.forEach(friend => {
                const friendClone = friend.cloneNode(true);
                friendClone.classList.add('group-friend');
                
                // Add checkbox
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'mr-2 rounded text-blue-600';
                friendClone.insertBefore(checkbox, friendClone.firstChild);
                
                groupFriendsList.appendChild(friendClone);
            });
        }

        function hideCreateGroupModal() {
            createGroupModal.style.display = 'none';
            groupName.value = '';
        }

        function createGroup() {
            const name = groupName.value.trim();
            if (!name) {
                showNotification('Please enter a group name');
                return;
            }
            
            // Get selected friends
            const selectedFriends = groupFriendsList.querySelectorAll('input:checked');
            if (selectedFriends.length === 0) {
                showNotification('Please select at least one friend');
                return;
            }
            
            // In a real app, this would create a group in Firestore
            showNotification(`Group "${name}" created successfully`);
            hideCreateGroupModal();
            
            // Add the new group to the chat list
            const newChat = {
                id: generateId(),
                name: name,
                lastMessage: 'Group created',
                timestamp: new Date(),
                unread: 0,
                type: 'group',
                avatar: null,
                participants: ['user1', ...Array.from(selectedFriends).map(f => f.parentElement.querySelector('p').textContent)]
            };
            
            // Reload chats to include the new group
            loadChats();
        }

        function showQuantumMessageModal() {
            if (!currentChatId) {
                showNotification('Please select a chat first');
                return;
            }
            
            quantumMessageModal.style.display = 'flex';
        }

        function hideQuantumMessageModal() {
            quantumMessageModal.style.display = 'none';
            quantumMessageText.value = '';
        }

        function sendQuantumMessage() {
            const content = quantumMessageText.value.trim();
            if (!content) {
                showNotification('Please enter a quantum message');
                return;
            }
            
            // Create quantum message
            const message = {
                id: generateId(),
                senderId: currentUser.uid,
                senderName: currentUser.displayName || 'You',
                content: content,
                timestamp: new Date(),
                type: 'quantum',
                superposition: document.getElementById('superposition').checked
            };
            
            // Display message
            displayMessage(message);
            
            // Hide modal
            hideQuantumMessageModal();
            
            // Show notification
            showNotification('Quantum message sent!');
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showSpecialFeatures() {
            // Randomly show special features
            if (Math.random() > 0.7) {
                suggestionBubble.classList.remove('hidden');
            } else {
                suggestionBubble.classList.add('hidden');
            }
            
            if (Math.random() > 0.8) {
                memoryLane.classList.remove('hidden');
            } else {
                memoryLane.classList.add('hidden');
            }
        }

        function showAISuggestions() {
            // Randomly show AI suggestions
            if (Math.random() > 0.5) {
                const suggestions = [
                    "Ask about their weekend plans",
                    "Share something interesting you learned recently",
                    "Discuss common interests you both have",
                    "Ask for their opinion on a topic you care about"
                ];
                const suggestion = suggestions[Math.floor(Math.random() * suggestions.length)];
                
                const suggestionElement = aiSuggestions.querySelector('.ai-suggestion .text-sm');
                suggestionElement.textContent = suggestion;
                
                aiSuggestions.classList.remove('hidden');
            } else {
                aiSuggestions.classList.add('hidden');
            }
        }

        function interactWithAI() {
            const responses = [
                "I'm analyzing your conversation patterns to provide better suggestions...",
                "Your communication style is very effective!",
                "I notice you have great engagement with your connections.",
                "Would you like me to help optimize your conversation flow?",
                "Your recent messages show positive interaction patterns."
            ];
            const response = responses[Math.floor(Math.random() * responses.length)];
            
            showNotification('Kynecta AI: ' + response);
        }

        function toggleARMode() {
            isArMode = !isArMode;
            if (isArMode) {
                mainContainer.classList.add('ar-mode');
                arToggle.classList.add('text-purple-500');
                showNotification('AR Mode Activated');
            } else {
                mainContainer.classList.remove('ar-mode');
                arToggle.classList.remove('text-purple-500');
                showNotification('AR Mode Disabled');
            }
        }

        function toggleAIMode() {
            isAiMode = !isAiMode;
            if (isAiMode) {
                document.body.classList.add('ai-mode-active');
                aiMode.classList.add('text-green-500');
                showNotification('AI Mode Activated');
                
                // Add network activity visualization
                initializeNetworkActivity();
            } else {
                document.body.classList.remove('ai-mode-active');
                aiMode.classList.remove('text-green-500');
                showNotification('AI Mode Disabled');
                
                // Remove network activity
                const existingActivity = document.querySelector('.network-activity');
                if (existingActivity) {
                    existingActivity.remove();
                }
            }
        }

        function initializeNetworkActivity() {
            if (!isAiMode) return;
            
            const networkActivity = document.createElement('div');
            networkActivity.className = 'network-activity';
            document.body.appendChild(networkActivity);
            
            // Create network nodes
            for (let i = 0; i < 20; i++) {
                const node = document.createElement('div');
                node.className = 'network-node';
                node.style.left = Math.random() * 100 + 'vw';
                node.style.top = Math.random() * 100 + 'vh';
                node.style.animationDelay = Math.random() * 3 + 's';
                networkActivity.appendChild(node);
            }
        }

        function filterChats() {
            const searchTerm = chatSearch.value.toLowerCase();
            const chatItems = document.querySelectorAll('.chat-item');
            
            chatItems.forEach(item => {
                const chatName = item.querySelector('.chat-item-name').textContent.toLowerCase();
                if (chatName.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function startChatWithFriend(friend) {
            // Check if a chat already exists with this friend
            const existingChat = document.querySelector(`[data-chat-name="${friend.name}"]`);
            
            if (existingChat) {
                // Select the existing chat
                existingChat.click();
            } else {
                // Create a new chat
                const newChat = {
                    id: generateId(),
                    name: friend.name,
                    lastMessage: 'Chat started',
                    timestamp: new Date(),
                    unread: 0,
                    type: 'personal',
                    avatar: friend.avatar,
                    participants: [currentUser.uid, friend.id]
                };
                
                // Add to chat list and select it
                loadChats(); // This would normally add the new chat to Firestore first
                selectChat(newChat);
                
                // Show notification
                showNotification(`Started chat with ${friend.name}`);
            }
        }

        function handleLogout() {
            auth.signOut().then(() => {
                showNotification('Signed out successfully');
            }).catch(error => {
                console.error('Logout error:', error);
                showNotification('Error signing out');
            });
        }

        function redirectToLogin() {
            window.location.href = 'login.html';
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function formatTime(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) {
                return 'Now';
            } else if (diffMins < 60) {
                return `${diffMins}m`;
            } else if (diffHours < 24) {
                return `${diffHours}h`;
            } else if (diffDays < 7) {
                return `${diffDays}d`;
            } else {
                return date.toLocaleDateString();
            }
        }

        function generateId() {
            return 'id_' + Math.random().toString(36).substr(2, 9);
        }
    </script>
</body>
</html>