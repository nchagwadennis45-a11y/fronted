<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Kynecta - Enhanced Social Feed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    
    <style>
        /* CSS Variables for Themes */
        :root {
            --primary-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-primary: #ffffff;
            --text-secondary: #cbd5e1;
            --accent-color: #22d3ee;
            --accent-hover: #06b6d4;
            --card-bg: rgba(30, 41, 59, 0.5);
            --card-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .light-theme {
            --primary-bg: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            --glass-bg: rgba(255, 255, 255, 0.8);
            --glass-border: rgba(209, 213, 219, 0.5);
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --accent-color: #3b82f6;
            --accent-hover: #2563eb;
            --card-bg: rgba(255, 255, 255, 0.9);
            --card-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .dark-theme {
            --primary-bg: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            --glass-bg: rgba(30, 41, 59, 0.5);
            --glass-border: rgba(100, 116, 139, 0.3);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent-color: #22d3ee;
            --accent-hover: #06b6d4;
            --card-bg: rgba(30, 41, 59, 0.5);
            --card-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .cyber-theme {
            --primary-bg: linear-gradient(135deg, #1e3a8a 0%, #7e22ce 100%);
            --glass-bg: rgba(30, 58, 138, 0.3);
            --glass-border: rgba(124, 58, 237, 0.5);
            --text-primary: #f0f9ff;
            --text-secondary: #bae6fd;
            --accent-color: #f59e0b;
            --accent-hover: #d97706;
            --card-bg: rgba(30, 58, 138, 0.3);
            --card-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
        }

        /* Emotion Reactive Backgrounds */
        .emotion-joy { --primary-bg: linear-gradient(135deg, #FFD93D 0%, #FF6B6B 100%) !important; }
        .emotion-love { --primary-bg: linear-gradient(135deg, #FF6B9D 0%, #C44569 100%) !important; }
        .emotion-calm { --primary-bg: linear-gradient(135deg, #6BC5D2 0%, #3B82F6 100%) !important; }
        .emotion-excited { --primary-bg: linear-gradient(135deg, #FF9A3D 0%, #FF6B6B 100%) !important; }
        .emotion-sad { --primary-bg: linear-gradient(135deg, #3a7bd5 0%, #3a6073 100%) !important; }
        .emotion-angry { --primary-bg: linear-gradient(135deg, #c31432 0%, #240b36 100%) !important; }

        /* Enhanced UI Components */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
        }

        .post-card {
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .post-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
        }

        .masonry-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            align-items: start;
        }

        /* Reaction Animations */
        .reaction-animation {
            animation: floatUp 1s ease-out forwards;
        }

        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-50px) scale(1.5); opacity: 0; }
        }

        /* Floating Create Button */
        .floating-create-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--accent-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            z-index: 100;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .floating-create-btn:hover {
            transform: scale(1.1);
            background: var(--accent-hover);
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            z-index: 1000;
            transition: all 0.3s ease-in-out;
            display: flex;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .connection-status.connected {
            background: rgba(34, 197, 94, 0.9);
            color: white;
            border: 1px solid rgba(34, 197, 94, 0.6);
        }
        .connection-status.connecting {
            background: rgba(245, 158, 11, 0.9);
            color: white;
            border: 1px solid rgba(245, 158, 11, 0.6);
        }
        .connection-status.disconnected {
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: 1px solid rgba(239, 68, 68, 0.6);
        }
        .connection-status.hidden {
            opacity: 0;
            transform: translateY(-20px);
            pointer-events: none;
        }

        /* Scrollbar Styling */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: var(--accent-color);
            border-radius: 10px;
        }

        /* Loading Animation */
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid var(--accent-color);
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Reaction Picker */
        .reaction-picker {
            position: absolute;
            bottom: 40px;
            left: 0;
            background: var(--card-bg);
            border-radius: 24px;
            padding: 10px;
            display: flex;
            gap: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            z-index: 10;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .reaction-picker.show {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }

        .reaction-option {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 18px;
        }

        .reaction-option:hover {
            transform: scale(1.2);
        }

        /* Poll Styles */
        .poll-option {
            background: var(--glass-bg);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .poll-option:hover {
            background: rgba(139, 92, 246, 0.2);
        }

        .poll-option.selected {
            background: rgba(34, 211, 238, 0.2);
            border: 1px solid var(--accent-color);
        }

        .poll-bar {
            height: 8px;
            background: var(--accent-color);
            border-radius: 4px;
            margin-top: 5px;
            transition: width 0.5s ease;
        }

        /* Story Styles */
        .story-ring {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            padding: 3px;
            background: linear-gradient(45deg, #ff6b6b, #ffa726, #4ecdc4, #45b7d1);
            cursor: pointer;
        }

        .story-content {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            overflow: hidden;
            background: var(--card-bg);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .story-content img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Comment Thread */
        .comment-thread {
            margin-top: 15px;
            border-left: 2px solid var(--glass-border);
            padding-left: 15px;
        }

        .comment-item {
            margin-bottom: 10px;
            padding: 10px;
            background: var(--glass-bg);
            border-radius: 10px;
        }

        /* Link Preview */
        .link-preview {
            border-radius: 12px;
            overflow: hidden;
            margin-top: 10px;
            background: var(--glass-bg);
        }

        .link-preview img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .link-preview-content {
            padding: 12px;
        }

        /* Filter & Sort Controls */
        .filter-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .filter-btn {
            padding: 8px 16px;
            border-radius: 20px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .filter-btn.active {
            background: var(--accent-color);
            color: white;
        }

        .filter-btn:hover:not(.active) {
            background: rgba(139, 92, 246, 0.2);
        }

        /* Keyboard Shortcuts Help */
        .keyboard-shortcuts {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            z-index: 100;
            max-width: 300px;
            display: none;
        }

        .keyboard-shortcuts.show {
            display: block;
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .shortcut-key {
            background: var(--glass-bg);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-container {
            background: rgba(30, 30, 60, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .hidden {
            display: none !important;
        }

        /* Status Indicator */
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        .status-online {
            background-color: #10B981;
            box-shadow: 0 0 8px #10B981;
        }
        .status-away {
            background-color: #F59E0B;
            box-shadow: 0 0 8px #F59E0B;
        }
        .status-busy {
            background-color: #EF4444;
            box-shadow: 0 0 8px #EF4444;
        }
        .status-offline {
            background-color: #6B7280;
            box-shadow: 0 0 8px #6B7280;
        }

        /* Media Preview */
        .media-preview {
            max-height: 300px;
            object-fit: cover;
            border-radius: 12px;
            margin-top: 10px;
        }

        /* Upload Progress */
        .upload-progress {
            width: 100%;
            height: 6px;
            background: var(--glass-bg);
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
        }
        .upload-progress-bar {
            height: 100%;
            background: var(--accent-color);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Audio Player */
        .audio-player {
            width: 100%;
            margin-top: 10px;
        }
        .audio-player audio {
            width: 100%;
            border-radius: 20px;
        }

        /* Kynecta Unique Features */
        .energy-ring {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: conic-gradient(var(--accent-color) 0%, transparent 0%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .energy-ring-inner {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--card-bg);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .kynecta-badge {
            background: linear-gradient(45deg, #ff6b6b, #ffa726, #4ecdc4, #45b7d1);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
        }
        
        .collaboration-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(34, 211, 238, 0.2);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }
        
        .ai-suggestion {
            background: rgba(139, 92, 246, 0.1);
            border-left: 3px solid var(--accent-color);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
        }

        /* NEW FEATURES STYLES */

        /* Mood-based Filtering */
        .mood-filter-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background: var(--glass-bg);
            border-radius: 12px;
        }

        .mood-option {
            padding: 8px 12px;
            border-radius: 20px;
            background: var(--card-bg);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .mood-option.active {
            background: var(--accent-color);
            color: white;
        }

        /* Interactive Reactions */
        .vibe-reactions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .vibe-reaction {
            padding: 6px 12px;
            border-radius: 20px;
            background: var(--glass-bg);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .vibe-reaction.active {
            background: var(--accent-color);
            color: white;
        }

        .vibe-reaction:hover {
            transform: scale(1.05);
        }

        /* AI Content Suggestions */
        .ai-content-suggestions {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .ai-suggestion-item {
            padding: 10px;
            background: var(--glass-bg);
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .ai-suggestion-item:hover {
            background: rgba(139, 92, 246, 0.2);
        }

        /* Gamified Engagement System */
        .gamification-panel {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .streak-counter {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .streak-days {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent-color);
        }

        .badge-collection {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .badge-item {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--glass-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        /* Enhanced Comment System */
        .nested-comment {
            margin-left: 20px;
            border-left: 2px solid var(--glass-border);
            padding-left: 10px;
        }

        .voice-comment-btn {
            background: var(--accent-color);
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .emoji-picker {
            position: absolute;
            bottom: 40px;
            background: var(--card-bg);
            border-radius: 12px;
            padding: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            z-index: 10;
            display: none;
            grid-template-columns: repeat(6, 1fr);
            gap: 5px;
        }

        .emoji-picker.show {
            display: grid;
        }

        .emoji-option {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .emoji-option:hover {
            background: var(--accent-color);
        }

        /* Daily Vibe Section */
        .daily-vibe-section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .daily-vibe-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--accent-color);
        }

        /* Anti-toxicity Filter */
        .toxicity-warning {
            background: rgba(239, 68, 68, 0.2);
            border-left: 3px solid #EF4444;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        /* Appreciation Button */
        .appreciation-btn {
            background: linear-gradient(45deg, #FFD93D, #FF6B6B);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .appreciation-btn:hover {
            transform: scale(1.05);
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .masonry-grid {
                grid-template-columns: 1fr;
            }
            
            .floating-create-btn {
                bottom: 20px;
                right: 20px;
                width: 50px;
                height: 50px;
            }

            .mood-filter-container {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .vibe-reactions {
                flex-wrap: wrap;
            }
            
            .streak-counter {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .badge-collection {
                justify-content: center;
            }
            
            .emoji-picker {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 480px) {
            .filter-controls {
                justify-content: center;
            }
            
            .emoji-picker {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body class="h-full dark-theme overflow-x-hidden">
    <!-- Connection Status -->
    <div class="connection-status connecting" id="connectionStatus">
        <i class="fas fa-circle-notch fa-spin mr-2"></i>
        <span id="connectionText">Connecting to Kynecta...</span>
    </div>

    <!-- Floating Create Button -->
    <div class="floating-create-btn" id="floatingCreateBtn">
        <i class="fas fa-plus"></i>
    </div>

    <!-- Keyboard Shortcuts Help -->
    <div class="keyboard-shortcuts" id="keyboardShortcuts">
        <h3 class="font-bold text-theme-accent mb-3">Keyboard Shortcuts</h3>
        <div class="shortcut-item">
            <span>Create New Post</span>
            <span class="shortcut-key">N</span>
        </div>
        <div class="shortcut-item">
            <span>Search</span>
            <span class="shortcut-key">/</span>
        </div>
        <div class="shortcut-item">
            <span>Toggle Theme</span>
            <span class="shortcut-key">T</span>
        </div>
        <div class="shortcut-item">
            <span>Show Shortcuts</span>
            <span class="shortcut-key">?</span>
        </div>
    </div>

    <!-- Mobile Navigation Toggle -->
    <div class="lg:hidden fixed top-4 left-4 z-50">
        <button id="mobileNavToggle" class="w-10 h-10 glass rounded-2xl flex items-center justify-center text-theme-secondary hover:text-theme-accent">
            <i class="fas fa-bars"></i>
        </button>
    </div>

    <div class="flex h-full" style="height: 100vh;">
        <!-- Navigation Sidebar -->
        <div id="sidebar" class="w-20 lg:w-64 glass border-r border-purple-800 flex flex-col fixed lg:relative h-full z-40 transform -translate-x-full lg:translate-x-0 transition-transform duration-300">
            <div class="p-4">
                <a href="#" class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-2xl flex items-center justify-center" style="background: var(--accent-color);">
                        <i class="fas fa-network-wired text-white"></i>
                    </div>
                    <span class="hidden lg:block text-xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-400">
                        Kynecta
                    </span>
                </a>
            </div>

            <nav class="flex-1 px-2 lg:px-4 space-y-2">
                <a href="home.html" class="flex items-center space-x-3 p-3 rounded-xl bg-cyan-900/30 text-cyan-400 border border-cyan-500/50">
                    <i class="fas fa-home w-6"></i>
                    <span class="hidden lg:block font-semibold">Social Feed</span>
                </a>
                <a href="chat.html" class="flex items-center space-x-3 p-3 rounded-xl text-theme-secondary hover:bg-purple-900/30 hover:text-theme-accent transition">
                    <i class="fas fa-comment-dots w-6"></i>
                    <span class="hidden lg:block">Quantum Chat</span>
                </a>
                <a href="profile.html" class="flex items-center space-x-3 p-3 rounded-xl text-theme-secondary hover:bg-purple-900/30 hover:text-theme-accent transition">
                    <i class="fas fa-user-astronaut w-6"></i>
                    <span class="hidden lg:block">Profile</span>
                </a>
                <a href="marketplace.html" class="flex items-center space-x-3 p-3 rounded-xl text-theme-secondary hover:bg-purple-900/30 hover:text-theme-accent transition">
                    <i class="fas fa-store w-6"></i>
                    <span class="hidden lg:block">Marketplace</span>
                </a>
                <a href="collections.html" class="flex items-center space-x-3 p-3 rounded-xl text-theme-secondary hover:bg-purple-900/30 hover:text-theme-accent transition">
                    <i class="fas fa-bookmark w-6"></i>
                    <span class="hidden lg:block">Collections</span>
                </a>
                <!-- Kynecta Unique Feature: Collaborative Spaces -->
                <a href="spaces.html" class="flex items-center space-x-3 p-3 rounded-xl text-theme-secondary hover:bg-purple-900/30 hover:text-theme-accent transition">
                    <i class="fas fa-users w-6"></i>
                    <span class="hidden lg:block">Collaborative Spaces</span>
                </a>
            </nav>

            <!-- User Status -->
            <div class="p-4 border-t border-purple-800">
                <div id="userStatusContainer" class="flex items-center space-x-3 p-3 glass rounded-xl cursor-pointer hover:bg-cyan-900/30 transition">
                    <div class="relative">
                        <img id="userAvatar" class="w-8 h-8 rounded-2xl object-cover" src="" alt="User Avatar">
                        <div id="statusIndicator" class="status-indicator status-online absolute -bottom-1 -right-1 border-2 border-gray-900"></div>
                    </div>
                    <div class="hidden lg:block">
                        <p id="userDisplayName" class="text-sm font-semibold text-theme-accent">Loading...</p>
                        <p id="statusText" class="text-xs text-theme-secondary">Online</p>
                    </div>
                </div>
                <!-- Kynecta Unique Feature: User Energy Level -->
                <div class="flex items-center justify-between mt-2 mb-2">
                    <span class="text-xs text-theme-secondary">Connection Energy</span>
                    <div class="energy-ring" id="userEnergyRing">
                        <div class="energy-ring-inner">
                            <span class="text-xs font-bold" id="energyPercentage">0%</span>
                        </div>
                    </div>
                </div>
                <button id="signOutBtn" class="w-full mt-2 py-2 glass border border-purple-700 rounded-2xl text-theme-secondary hover:text-theme-accent transition text-sm hidden">
                    <i class="fas fa-sign-out-alt mr-2"></i>Sign Out
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden w-full lg:w-auto">
            <!-- Header -->
            <header class="glass border-b border-purple-800 px-4 md:px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex-1 max-w-2xl relative">
                        <div class="relative">
                            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-theme-secondary"></i>
                            <input type="text" id="searchInput" placeholder="Search posts, people, or topics..." 
                                   class="w-full pl-10 pr-4 py-3 glass border border-purple-700 rounded-2xl focus:outline-none focus:ring-2 focus:ring-theme-accent focus:border-transparent placeholder-theme-secondary">
                        </div>
                        <div id="searchResults" class="search-results">
                            <!-- Search results will appear here -->
                        </div>
                    </div>
                    <div class="flex items-center space-x-4 ml-4">
                        <button id="themeToggle" class="w-10 h-10 glass rounded-2xl flex items-center justify-center text-theme-secondary hover:text-theme-accent hover:scale-110 transition">
                            <i class="fas fa-palette"></i>
                        </button>
                        <button id="notificationsBtn" class="w-10 h-10 glass rounded-2xl flex items-center justify-center text-theme-secondary hover:text-theme-accent hover:scale-110 transition relative">
                            <i class="fas fa-bell"></i>
                            <span id="notificationCount" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
                        </button>
                    </div>
                </div>
            </header>

            <!-- NEW FEATURE: Daily Vibe Section -->
            <div class="daily-vibe-section glass border-b border-purple-800">
                <div class="daily-vibe-title">Today's Vibe: Gratitude</div>
                <p class="text-theme-secondary mb-3">Share what you're thankful for today</p>
                <button class="appreciation-btn" id="shareGratitudeBtn">
                    <i class="fas fa-heart mr-1"></i> Share Gratitude
                </button>
            </div>

            <!-- Stories Section -->
            <div class="glass border-b border-purple-800 p-4">
                <div class="flex space-x-6 overflow-x-auto scrollbar-hide pb-2" id="storiesContainer">
                    <!-- Stories will be loaded dynamically -->
                </div>
            </div>

            <!-- NEW FEATURE: Mood-based Filtering -->
            <div class="mood-filter-container glass border-b border-purple-800">
                <span class="text-theme-primary font-medium">My Mood:</span>
                <div class="mood-option active" data-mood="all">All</div>
                <div class="mood-option" data-mood="happy">üòä Happy</div>
                <div class="mood-option" data-mood="creative">üé® Creative</div>
                <div class="mood-option" data-mood="motivated">üí™ Motivated</div>
                <div class="mood-option" data-mood="calm">üòå Calm</div>
                <div class="mood-option" data-mood="reflective">ü§î Reflective</div>
            </div>

            <!-- Filter & Sort Controls -->
            <div class="glass border-b border-purple-800 p-4">
                <div class="filter-controls">
                    <button class="filter-btn active" data-filter="all">All Posts</button>
                    <button class="filter-btn" data-filter="top">Top</button>
                    <button class="filter-btn" data-filter="trending">Trending</button>
                    <button class="filter-btn" data-filter="latest">Latest</button>
                    
                    <!-- Emotion Filters -->
                    <div class="relative emotion-filter">
                        <button class="filter-btn" id="emotionFilterBtn">
                            <i class="fas fa-smile mr-1"></i> Mood
                        </button>
                        <div class="emotion-options absolute mt-2 p-3 glass rounded-xl z-10 hidden" id="emotionOptions">
                            <div class="grid grid-cols-3 gap-2">
                                <div class="emotion-option" data-emotion="joy">üòÑ Joy</div>
                                <div class="emotion-option" data-emotion="love">‚ù§Ô∏è Love</div>
                                <div class="emotion-option" data-emotion="calm">üòå Calm</div>
                                <div class="emotion-option" data-emotion="excited">ü§© Excited</div>
                                <div class="emotion-option" data-emotion="sad">üò¢ Sad</div>
                                <div class="emotion-option" data-emotion="angry">üò† Angry</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Interest Filters -->
                    <div class="relative interest-filter">
                        <button class="filter-btn" id="interestFilterBtn">
                            <i class="fas fa-tags mr-1"></i> Interests
                        </button>
                        <div class="interest-options absolute mt-2 p-3 glass rounded-xl z-10 hidden" id="interestOptions">
                            <div class="space-y-2">
                                <div class="interest-option" data-interest="technology">Technology</div>
                                <div class="interest-option" data-interest="sports">Sports</div>
                                <div class="interest-option" data-interest="music">Music</div>
                                <div class="interest-option" data-interest="art">Art</div>
                                <div class="interest-option" data-interest="travel">Travel</div>
                                <div class="interest-option" data-interest="food">Food</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Kynecta Unique Feature: Content Type Filter -->
                    <div class="relative content-type-filter">
                        <button class="filter-btn" id="contentTypeFilterBtn">
                            <i class="fas fa-filter mr-1"></i> Content Type
                        </button>
                        <div class="content-type-options absolute mt-2 p-3 glass rounded-xl z-10 hidden" id="contentTypeOptions">
                            <div class="space-y-2">
                                <div class="content-type-option" data-content-type="text">Text Only</div>
                                <div class="content-type-option" data-content-type="image">With Images</div>
                                <div class="content-type-option" data-content-type="video">With Videos</div>
                                <div class="content-type-option" data-content-type="poll">Polls</div>
                                <div class="content-type-option" data-content-type="collaborative">Collaborative</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Feed -->
            <main class="flex-1 overflow-y-auto bg-gradient-to-b from-purple-900/20 to-gray-900/50 custom-scrollbar">
                <div class="container mx-auto px-4 py-4">
                    <!-- NEW FEATURE: AI Content Suggestions -->
                    <div class="ai-content-suggestions glass mb-6">
                        <h3 class="font-bold text-theme-accent mb-3 flex items-center">
                            <i class="fas fa-robot mr-2"></i> AI Content Ideas
                        </h3>
                        <div id="aiContentSuggestionsList">
                            <div class="ai-suggestion-item">
                                <p>Share a recent accomplishment and what you learned from it</p>
                            </div>
                            <div class="ai-suggestion-item">
                                <p>Ask your network for recommendations on [your interest]</p>
                            </div>
                            <div class="ai-suggestion-item">
                                <p>Post about a book, movie, or podcast that inspired you recently</p>
                            </div>
                        </div>
                        <button id="refreshAISuggestions" class="w-full mt-3 py-2 glass border border-purple-700 rounded-2xl text-theme-secondary hover:text-theme-accent transition">
                            <i class="fas fa-sync-alt mr-2"></i> Get New Ideas
                        </button>
                    </div>

                    <div class="masonry-grid" id="feedContainer">
                        <!-- Posts will be loaded dynamically from Firebase -->
                    </div>
                    
                    <!-- Loading Indicator -->
                    <div id="loadingIndicator" class="loading-spinner hidden"></div>
                    
                    <!-- End of Feed Message -->
                    <div id="endOfFeed" class="text-center py-8 text-theme-secondary hidden">
                        <i class="fas fa-check-circle text-2xl mb-2"></i>
                        <p>You're all caught up!</p>
                    </div>
                </div>
            </main>
        </div>

        <!-- Right Sidebar -->
        <div id="rightSidebar" class="hidden lg:block w-80 glass border-l border-purple-800 overflow-y-auto custom-scrollbar">
            <div class="p-4 md:p-6">
                <!-- User Profile Card -->
                <div class="glass border border-purple-700 rounded-2xl p-4 mb-6">
                    <div class="flex items-center space-x-3 mb-4">
                        <img id="sidebarUserAvatar" class="w-12 h-12 rounded-2xl object-cover" src="" alt="User Avatar">
                        <div>
                            <h3 id="sidebarUserName" class="font-bold text-theme-accent">Loading...</h3>
                            <p id="sidebarUserStatus" class="text-xs text-theme-secondary">Online</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-2 text-center">
                        <div>
                            <p class="font-bold text-theme-accent" id="postCount">0</p>
                            <p class="text-xs text-theme-secondary">Posts</p>
                        </div>
                        <div>
                            <p class="font-bold text-theme-accent" id="followerCount">0</p>
                            <p class="text-xs text-theme-secondary">Followers</p>
                        </div>
                        <div>
                            <p class="font-bold text-theme-accent" id="followingCount">0</p>
                            <p class="text-xs text-theme-secondary">Following</p>
                        </div>
                    </div>
                    <!-- Kynecta Unique Feature: User Badges -->
                    <div class="mt-4 flex flex-wrap gap-2" id="userBadges">
                        <!-- Badges will be loaded dynamically -->
                    </div>
                </div>

                <!-- NEW FEATURE: Gamified Engagement System -->
                <div class="gamification-panel glass border border-purple-700 rounded-2xl p-4 mb-6">
                    <h3 class="font-bold text-theme-accent mb-4 flex items-center">
                        <i class="fas fa-trophy mr-2"></i> Engagement Streak
                    </h3>
                    <div class="streak-counter">
                        <div>
                            <p class="text-sm text-theme-secondary">Current Streak</p>
                            <div class="streak-days">7 days</div>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-theme-secondary">Points</p>
                            <div class="streak-days">245</div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <p class="text-sm text-theme-secondary mb-2">Your Badges</p>
                        <div class="badge-collection">
                            <div class="badge-item" title="Newcomer">ü•ö</div>
                            <div class="badge-item" title="Contributor">üåü</div>
                            <div class="badge-item" title="Social Butterfly">ü¶ã</div>
                            <div class="badge-item" title="Thought Leader">üí°</div>
                        </div>
                    </div>
                    <button id="viewAllBadges" class="w-full py-2 glass border border-purple-700 rounded-2xl text-theme-secondary hover:text-theme-accent transition text-sm">
                        View All Achievements
                    </button>
                </div>

                <!-- Trending Topics -->
                <div class="glass border border-purple-700 rounded-2xl p-4 mb-6">
                    <h3 class="font-bold text-theme-accent mb-4 flex items-center">
                        <i class="fas fa-fire mr-2"></i> Trending Topics
                    </h3>
                    <div id="trendingTopicsContainer" class="space-y-3">
                        <!-- Trending topics will be loaded dynamically -->
                    </div>
                </div>

                <!-- Leaderboard -->
                <div class="glass border border-purple-700 rounded-2xl p-4 mb-6">
                    <h3 class="font-bold text-theme-accent mb-4 flex items-center">
                        <i class="fas fa-trophy mr-2"></i> Top Contributors
                    </h3>
                    <div id="leaderboardContainer" class="space-y-3">
                        <!-- Leaderboard will be loaded dynamically -->
                    </div>
                </div>

                <!-- Suggested Connections -->
                <div class="glass border border-purple-700 rounded-2xl p-4">
                    <h3 class="font-bold text-theme-accent mb-4">Suggested Connections</h3>
                    <div id="suggestedUsersContainer" class="space-y-4">
                        <!-- Suggested users will be loaded dynamically -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Post Modal -->
    <div id="createPostModal" class="modal hidden">
        <div class="modal-container">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-theme-accent">Create Post</h2>
                <button id="closePostModal" class="text-theme-secondary hover:text-theme-accent transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div class="flex items-center space-x-3 mb-4">
                    <img id="currentUserAvatar" class="w-10 h-10 rounded-2xl object-cover" src="" alt="Your Avatar">
                    <div>
                        <p id="currentUserName" class="font-semibold text-theme-primary">Loading...</p>
                        <div class="flex space-x-2 mt-1">
                            <select id="postAudience" class="text-xs bg-transparent border border-purple-700 rounded-lg px-2 py-1">
                                <option value="public">üåç Public</option>
                                <option value="friends">üë• Friends</option>
                                <option value="private">üîí Only Me</option>
                            </select>
                            <select id="postMood" class="text-xs bg-transparent border border-purple-700 rounded-lg px-2 py-1">
                                <option value="">How are you feeling?</option>
                                <option value="joy">üòÑ Joyful</option>
                                <option value="love">‚ù§Ô∏è Loving</option>
                                <option value="calm">üòå Calm</option>
                                <option value="excited">ü§© Excited</option>
                                <option value="sad">üò¢ Sad</option>
                                <option value="angry">üò† Angry</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <textarea id="modalPostInput" placeholder="What's on your mind?" 
                          class="w-full p-4 glass border border-purple-700 rounded-2xl focus:outline-none focus:ring-2 focus:ring-theme-accent focus:border-transparent placeholder-theme-secondary h-32 resize-none"></textarea>
                
                <!-- Kynecta Unique Feature: AI Content Suggestions -->
                <div id="aiSuggestion" class="ai-suggestion hidden">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-semibold text-theme-accent mb-1">AI Suggestion</p>
                            <p id="aiSuggestionText" class="text-sm">Try adding a question to engage your audience!</p>
                        </div>
                        <button id="applySuggestion" class="text-xs bg-theme-accent text-white px-2 py-1 rounded-lg">Apply</button>
                    </div>
                </div>
                
                <!-- NEW FEATURE: Anti-toxicity Filter Warning -->
                <div id="toxicityWarning" class="toxicity-warning hidden">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <span>Our AI detected potentially harmful content. Please review before posting.</span>
                </div>
                
                <!-- Poll Creator -->
                <div id="pollCreator" class="hidden">
                    <div class="mb-3">
                        <input type="text" id="pollQuestion" placeholder="Ask a question..." class="w-full p-2 glass border border-purple-700 rounded-lg">
                    </div>
                    <div id="pollOptions" class="space-y-2">
                        <div class="flex items-center space-x-2">
                            <input type="text" placeholder="Option 1" class="flex-1 p-2 glass border border-purple-700 rounded-lg">
                            <button class="text-red-500 remove-poll-option"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="text" placeholder="Option 2" class="flex-1 p-2 glass border border-purple-700 rounded-lg">
                            <button class="text-red-500 remove-poll-option"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                    <button id="addPollOption" class="mt-2 text-theme-accent text-sm"><i class="fas fa-plus mr-1"></i> Add Option</button>
                    <div class="flex items-center mt-3">
                        <input type="checkbox" id="multiplePollAnswers" class="mr-2">
                        <label for="multiplePollAnswers" class="text-sm">Allow multiple answers</label>
                    </div>
                </div>
                
                <!-- Kynecta Unique Feature: Collaborative Post -->
                <div id="collaborativePost" class="hidden mt-4">
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-sm font-semibold text-theme-accent">Collaborative Post</p>
                        <button id="toggleCollaborative" class="text-xs bg-theme-accent text-white px-2 py-1 rounded-lg">Enable</button>
                    </div>
                    <div id="collaborativeSettings" class="hidden space-y-2">
                        <input type="text" id="collaborativeTitle" placeholder="Collaboration title..." class="w-full p-2 glass border border-purple-700 rounded-lg">
                        <select id="collaborativeType" class="w-full p-2 glass border border-purple-700 rounded-lg">
                            <option value="brainstorming">Brainstorming</option>
                            <option value="decision">Decision Making</option>
                            <option value="project">Project Planning</option>
                        </select>
                        <div class="flex items-center">
                            <input type="checkbox" id="allowEdits" class="mr-2">
                            <label for="allowEdits" class="text-sm">Allow others to edit</label>
                        </div>
                    </div>
                </div>
                
                <!-- Media Preview -->
                <div id="modalMediaPreview" class="hidden">
                    <img id="modalPreviewImage" class="media-preview w-full hidden rounded-xl">
                    <video id="modalPreviewVideo" class="media-preview w-full hidden rounded-xl" controls></video>
                    <audio id="modalPreviewAudio" class="audio-player hidden" controls></audio>
                    <div class="upload-progress hidden" id="uploadProgress">
                        <div class="upload-progress-bar" id="uploadProgressBar"></div>
                    </div>
                </div>
                
                <!-- Link Preview -->
                <div id="linkPreview" class="link-preview hidden">
                    <div class="flex">
                        <div class="link-preview-content flex-1">
                            <h4 id="linkTitle" class="font-semibold text-theme-primary"></h4>
                            <p id="linkDescription" class="text-sm text-theme-secondary mt-1"></p>
                            <p id="linkDomain" class="text-xs text-theme-secondary mt-2"></p>
                        </div>
                        <img id="linkImage" class="w-24 h-24 object-cover rounded-r-lg" src="" alt="Link preview">
                    </div>
                </div>
                
                <div class="flex flex-wrap gap-4 text-theme-secondary justify-center">
                    <button id="modalAddPhoto" class="flex items-center space-x-2 hover:text-theme-accent transition">
                        <i class="fas fa-image"></i>
                        <span>Photo</span>
                    </button>
                    <button id="modalAddVideo" class="flex items-center space-x-2 hover:text-theme-accent transition">
                        <i class="fas fa-video"></i>
                        <span>Video</span>
                    </button>
                    <button id="modalAddAudio" class="flex items-center space-x-2 hover:text-theme-accent transition">
                        <i class="fas fa-music"></i>
                        <span>Audio</span>
                    </button>
                    <button id="modalAddPoll" class="flex items-center space-x-2 hover:text-theme-accent transition">
                        <i class="fas fa-poll"></i>
                        <span>Poll</span>
                    </button>
                    <button id="modalAddLink" class="flex items-center space-x-2 hover:text-theme-accent transition">
                        <i class="fas fa-link"></i>
                        <span>Link</span>
                    </button>
                    <!-- Kynecta Unique Feature: Collaborative Post Button -->
                    <button id="modalAddCollaborative" class="flex items-center space-x-2 hover:text-theme-accent transition">
                        <i class="fas fa-users"></i>
                        <span>Collaborate</span>
                    </button>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4">
                    <button id="cancelPost" class="px-4 py-2 glass border border-purple-700 rounded-2xl text-theme-secondary hover:text-theme-accent transition">
                        Cancel
                    </button>
                    <button id="publishPost" class="px-6 py-2 rounded-2xl font-semibold hover:scale-105 transition" style="background: var(--accent-color); color: white;">
                        Publish
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW FEATURE: Emoji Picker -->
    <div class="emoji-picker" id="emojiPicker">
        <!-- Emojis will be populated dynamically -->
    </div>

    <!-- File Inputs (Hidden) -->
    <input type="file" id="modalPhotoInput" accept="image/*" class="hidden">
    <input type="file" id="modalVideoInput" accept="video/*" class="hidden">
    <input type="file" id="modalAudioInput" accept="audio/*" class="hidden">

    <script>
        // Firebase Configuration for Kynecta - Using the same config as index.html
        const firebaseConfig = {
            apiKey: "AIzaSyDHHyGgsSV18BcXrGgzi4C8frzDAE1C1zo",
            authDomain: "uniconnect-ee95c.firebaseapp.com",
            projectId: "uniconnect-ee95c",
            storageBucket: "uniconnect-ee95c.firebasestorage.app",
            messagingSenderId: "1003264444309",
            appId: "1:1003264444309:web:9f0307516e44d21e97d89c"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // Global Variables
        let currentUser = null;
        let posts = [];
        let lastPost = null;
        let hasMorePosts = true;
        let currentFilter = 'all';
        let currentEmotionFilter = null;
        let currentInterestFilter = null;
        let currentContentTypeFilter = null;
        let selectedReaction = null;
        let currentMoodFilter = 'all'; // NEW: Mood-based filtering

        // DOM Elements
        const connectionStatus = document.getElementById('connectionStatus');
        const connectionText = document.getElementById('connectionText');
        const feedContainer = document.getElementById('feedContainer');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const endOfFeed = document.getElementById('endOfFeed');
        const floatingCreateBtn = document.getElementById('floatingCreateBtn');
        const createPostModal = document.getElementById('createPostModal');
        const closePostModal = document.getElementById('closePostModal');
        const cancelPost = document.getElementById('cancelPost');
        const publishPost = document.getElementById('publishPost');
        const modalPostInput = document.getElementById('modalPostInput');
        const themeToggle = document.getElementById('themeToggle');
        const searchInput = document.getElementById('searchInput');
        const keyboardShortcuts = document.getElementById('keyboardShortcuts');
        const userStatusContainer = document.getElementById('userStatusContainer');
        const userAvatar = document.getElementById('userAvatar');
        const userDisplayName = document.getElementById('userDisplayName');
        const statusText = document.getElementById('statusText');
        const sidebarUserAvatar = document.getElementById('sidebarUserAvatar');
        const sidebarUserName = document.getElementById('sidebarUserName');
        const sidebarUserStatus = document.getElementById('sidebarUserStatus');
        const postCount = document.getElementById('postCount');
        const followerCount = document.getElementById('followerCount');
        const followingCount = document.getElementById('followingCount');
        const emotionFilterBtn = document.getElementById('emotionFilterBtn');
        const emotionOptions = document.getElementById('emotionOptions');
        const interestFilterBtn = document.getElementById('interestFilterBtn');
        const interestOptions = document.getElementById('interestOptions');
        const contentTypeFilterBtn = document.getElementById('contentTypeFilterBtn');
        const contentTypeOptions = document.getElementById('contentTypeOptions');
        const storiesContainer = document.getElementById('storiesContainer');
        const trendingTopicsContainer = document.getElementById('trendingTopicsContainer');
        const leaderboardContainer = document.getElementById('leaderboardContainer');
        const suggestedUsersContainer = document.getElementById('suggestedUsersContainer');
        const currentUserAvatar = document.getElementById('currentUserAvatar');
        const currentUserName = document.getElementById('currentUserName');
        const signOutBtn = document.getElementById('signOutBtn');
        const userEnergyRing = document.getElementById('userEnergyRing');
        const energyPercentage = document.getElementById('energyPercentage');
        const userBadges = document.getElementById('userBadges');
        const aiSuggestion = document.getElementById('aiSuggestion');
        const aiSuggestionText = document.getElementById('aiSuggestionText');
        const applySuggestion = document.getElementById('applySuggestion');
        const collaborativePost = document.getElementById('collaborativePost');
        const toggleCollaborative = document.getElementById('toggleCollaborative');
        const collaborativeSettings = document.getElementById('collaborativeSettings');
        const modalAddCollaborative = document.getElementById('modalAddCollaborative');
        
        // NEW FEATURE: Mood-based Filtering Elements
        const moodOptions = document.querySelectorAll('.mood-option');
        
        // NEW FEATURE: AI Content Suggestions Elements
        const refreshAISuggestions = document.getElementById('refreshAISuggestions');
        const aiContentSuggestionsList = document.getElementById('aiContentSuggestionsList');
        
        // NEW FEATURE: Gamification Elements
        const viewAllBadges = document.getElementById('viewAllBadges');
        
        // NEW FEATURE: Daily Vibe Elements
        const shareGratitudeBtn = document.getElementById('shareGratitudeBtn');
        
        // NEW FEATURE: Emoji Picker
        const emojiPicker = document.getElementById('emojiPicker');
        
        // NEW FEATURE: Anti-toxicity Filter
        const toxicityWarning = document.getElementById('toxicityWarning');

        // Mobile Navigation Elements
        const mobileNavToggle = document.getElementById('mobileNavToggle');
        const sidebar = document.getElementById('sidebar');
        const rightSidebar = document.getElementById('rightSidebar');

        // Initialize the application
        function init() {
            // Set up Firebase authentication state observer
            auth.onAuthStateChanged(user => {
                if (user) {
                    // User is signed in
                    currentUser = user;
                    updateUserUI();
                    loadUserData();
                    loadInitialPosts();
                    loadStories();
                    loadTrendingTopics();
                    loadLeaderboard();
                    loadSuggestedUsers();
                    signOutBtn.classList.remove('hidden');
                    
                    // NEW: Initialize new features
                    initializeNewFeatures();
                } else {
                    // User is signed out - redirect to index page
                    console.log('User not signed in, redirecting to index...');
                    window.location.href = 'index.html';
                }
            });

            // Set up event listeners
            setupEventListeners();
            
            // Set up keyboard shortcuts
            setupKeyboardShortcuts();
            
            // Set up infinite scroll
            setupInfiniteScroll();
            
            // Set up connection monitoring
            setupConnectionMonitoring();
        }

        // NEW: Initialize new features
        function initializeNewFeatures() {
            // Initialize emoji picker
            initializeEmojiPicker();
            
            // Load AI content suggestions
            loadAIContentSuggestions();
            
            // Initialize mood-based filtering
            initializeMoodFiltering();
            
            // Initialize gamification data
            initializeGamificationData();
        }

        // NEW: Initialize emoji picker
        function initializeEmojiPicker() {
            const emojis = ['üòÄ', 'üòÇ', 'ü•∞', 'üòé', 'ü§î', 'üôå', 'üî•', 'üíØ', '‚ú®', 'üåü', 'üíñ', 'üëç', 'üëè', 'üéâ', 'üí°', 'üåà', 'üöÄ', 'üìö', 'üé®', 'üéµ', 'üçï', '‚òï', 'üåç', 'üí™'];
            
            emojiPicker.innerHTML = '';
            emojis.forEach(emoji => {
                const emojiOption = document.createElement('div');
                emojiOption.className = 'emoji-option';
                emojiOption.textContent = emoji;
                emojiOption.addEventListener('click', function() {
                    // TODO: Insert emoji into active comment or post input
                    const activeInput = document.activeElement;
                    if (activeInput && (activeInput.tagName === 'TEXTAREA' || activeInput.tagName === 'INPUT')) {
                        const cursorPosition = activeInput.selectionStart;
                        const textBefore = activeInput.value.substring(0, cursorPosition);
                        const textAfter = activeInput.value.substring(cursorPosition);
                        activeInput.value = textBefore + emoji + textAfter;
                        activeInput.focus();
                        activeInput.setSelectionRange(cursorPosition + emoji.length, cursorPosition + emoji.length);
                    }
                    emojiPicker.classList.remove('show');
                });
                emojiPicker.appendChild(emojiOption);
            });
        }

        // NEW: Load AI content suggestions
        function loadAIContentSuggestions() {
            // TODO: Fetch AI content suggestions from backend
            // For now, using static suggestions
            console.log('Loading AI content suggestions...');
        }

        // NEW: Initialize mood-based filtering
        function initializeMoodFiltering() {
            moodOptions.forEach(option => {
                option.addEventListener('click', function() {
                    moodOptions.forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');
                    currentMoodFilter = this.dataset.mood;
                    reloadPosts();
                });
            });
        }

        // NEW: Initialize gamification data
        function initializeGamificationData() {
            // TODO: Fetch user's gamification data from Firebase
            console.log('Initializing gamification data...');
        }

        // Set up event listeners
        function setupEventListeners() {
            // Theme toggle
            themeToggle.addEventListener('click', toggleTheme);
            
            // Create post modal
            floatingCreateBtn.addEventListener('click', openCreatePostModal);
            closePostModal.addEventListener('click', closeCreatePostModal);
            cancelPost.addEventListener('click', closeCreatePostModal);
            publishPost.addEventListener('click', createPost);
            
            // Filter buttons
            document.querySelectorAll('.filter-btn[data-filter]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn[data-filter]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentFilter = this.dataset.filter;
                    reloadPosts();
                });
            });
            
            // Emotion filter
            emotionFilterBtn.addEventListener('click', toggleEmotionOptions);
            document.querySelectorAll('.emotion-option').forEach(option => {
                option.addEventListener('click', function() {
                    currentEmotionFilter = this.dataset.emotion;
                    emotionFilterBtn.innerHTML = `<i class="fas fa-smile mr-1"></i> ${this.textContent}`;
                    emotionOptions.classList.add('hidden');
                    reloadPosts();
                });
            });
            
            // Interest filter
            interestFilterBtn.addEventListener('click', toggleInterestOptions);
            document.querySelectorAll('.interest-option').forEach(option => {
                option.addEventListener('click', function() {
                    currentInterestFilter = this.dataset.interest;
                    interestFilterBtn.innerHTML = `<i class="fas fa-tags mr-1"></i> ${this.textContent}`;
                    interestOptions.classList.add('hidden');
                    reloadPosts();
                });
            });
            
            // Content type filter
            contentTypeFilterBtn.addEventListener('click', toggleContentTypeOptions);
            document.querySelectorAll('.content-type-option').forEach(option => {
                option.addEventListener('click', function() {
                    currentContentTypeFilter = this.dataset.contentType;
                    contentTypeFilterBtn.innerHTML = `<i class="fas fa-filter mr-1"></i> ${this.textContent}`;
                    contentTypeOptions.classList.add('hidden');
                    reloadPosts();
                });
            });
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', function(event) {
                if (!emotionFilterBtn.contains(event.target) && !emotionOptions.contains(event.target)) {
                    emotionOptions.classList.add('hidden');
                }
                if (!interestFilterBtn.contains(event.target) && !interestOptions.contains(event.target)) {
                    interestOptions.classList.add('hidden');
                }
                if (!contentTypeFilterBtn.contains(event.target) && !contentTypeOptions.contains(event.target)) {
                    contentTypeOptions.classList.add('hidden');
                }
                if (!emojiPicker.contains(event.target)) {
                    emojiPicker.classList.remove('show');
                }
            });
            
            // Search functionality
            searchInput.addEventListener('input', debounce(handleSearch, 300));
            
            // Media upload buttons
            document.getElementById('modalAddPhoto').addEventListener('click', () => document.getElementById('modalPhotoInput').click());
            document.getElementById('modalAddVideo').addEventListener('click', () => document.getElementById('modalVideoInput').click());
            document.getElementById('modalAddAudio').addEventListener('click', () => document.getElementById('modalAudioInput').click());
            document.getElementById('modalAddPoll').addEventListener('click', togglePollCreator);
            document.getElementById('modalAddLink').addEventListener('click', addLinkToPost);
            document.getElementById('modalAddCollaborative').addEventListener('click', toggleCollaborativePost);
            
            // File inputs
            document.getElementById('modalPhotoInput').addEventListener('change', handleMediaUpload);
            document.getElementById('modalVideoInput').addEventListener('change', handleMediaUpload);
            document.getElementById('modalAudioInput').addEventListener('change', handleMediaUpload);
            
            // Add poll option
            document.getElementById('addPollOption').addEventListener('click', addPollOption);
            
            // Remove poll option
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-poll-option') || 
                    e.target.parentElement.classList.contains('remove-poll-option')) {
                    const optionElement = e.target.closest('.flex.items-center');
                    if (document.querySelectorAll('#pollOptions .flex.items-center').length > 2) {
                        optionElement.remove();
                    } else {
                        alert('Poll must have at least 2 options');
                    }
                }
            });
            
            // AI Suggestion
            applySuggestion.addEventListener('click', applyAISuggestion);
            modalPostInput.addEventListener('input', generateAISuggestion);
            
            // Collaborative post
            toggleCollaborative.addEventListener('click', function() {
                collaborativeSettings.classList.toggle('hidden');
                if (collaborativeSettings.classList.contains('hidden')) {
                    this.textContent = 'Enable';
                } else {
                    this.textContent = 'Disable';
                }
            });
            
            // Sign out button
            signOutBtn.addEventListener('click', signOut);
            
            // NEW FEATURE: AI Content Suggestions
            refreshAISuggestions.addEventListener('click', refreshAISuggestionsHandler);
            
            // NEW FEATURE: Daily Vibe
            shareGratitudeBtn.addEventListener('click', shareGratitudeHandler);
            
            // NEW FEATURE: Gamification
            viewAllBadges.addEventListener('click', viewAllBadgesHandler);
            
            // NEW FEATURE: Anti-toxicity filter
            modalPostInput.addEventListener('input', checkToxicity);
            
            // Mobile Navigation
            mobileNavToggle.addEventListener('click', toggleMobileNav);
        }

        // Toggle mobile navigation
        function toggleMobileNav() {
            sidebar.classList.toggle('-translate-x-full');
        }

        // NEW: Refresh AI content suggestions
        function refreshAISuggestionsHandler() {
            // TODO: Fetch new AI content suggestions from backend
            showNotification('Getting fresh content ideas...', 'success');
            
            // Simulate API call delay
            setTimeout(() => {
                showNotification('New content ideas loaded!', 'success');
            }, 1000);
        }

        // NEW: Share gratitude post
        function shareGratitudeHandler() {
            openCreatePostModal();
            modalPostInput.value = "I'm grateful for... #Gratitude";
            modalPostInput.focus();
        }

        // NEW: View all badges
        function viewAllBadgesHandler() {
            // TODO: Open modal with all user badges and achievements
            showNotification('Opening achievements dashboard...', 'success');
        }

        // NEW: Check for toxic content
        function checkToxicity() {
            const content = modalPostInput.value;
            // TODO: Implement actual toxicity detection with AI/ML API
            // For now, using simple keyword matching as placeholder
            const toxicKeywords = ['hate', 'stupid', 'idiot', 'kill', 'hurt'];
            const hasToxicContent = toxicKeywords.some(keyword => 
                content.toLowerCase().includes(keyword)
            );
            
            if (hasToxicContent && content.length > 10) {
                toxicityWarning.classList.remove('hidden');
            } else {
                toxicityWarning.classList.add('hidden');
            }
        }

        // Set up keyboard shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Don't trigger shortcuts if user is typing in an input
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    return;
                }
                
                switch(e.key) {
                    case 'n':
                    case 'N':
                        if (e.ctrlKey || e.metaKey) {
                            e.preventDefault();
                            openCreatePostModal();
                        }
                        break;
                    case '/':
                        e.preventDefault();
                        searchInput.focus();
                        break;
                    case 't':
                    case 'T':
                        if (e.ctrlKey || e.metaKey) {
                            e.preventDefault();
                            toggleTheme();
                        }
                        break;
                    case '?':
                        e.preventDefault();
                        toggleKeyboardShortcuts();
                        break;
                    case 'Escape':
                        closeCreatePostModal();
                        keyboardShortcuts.classList.remove('show');
                        break;
                }
            });
        }

        // Set up infinite scroll
        function setupInfiniteScroll() {
            window.addEventListener('scroll', debounce(() => {
                if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 1000) {
                    if (hasMorePosts && !loadingIndicator.classList.contains('hidden')) {
                        loadMorePosts();
                    }
                }
            }, 200));
        }

        // Set up connection monitoring
        function setupConnectionMonitoring() {
            // Monitor online/offline status
            window.addEventListener('online', () => {
                updateConnectionStatus('connected');
            });
            
            window.addEventListener('offline', () => {
                updateConnectionStatus('disconnected');
            });
            
            // Check Firebase connection
            db.enableNetwork().then(() => {
                updateConnectionStatus('connected');
            }).catch(error => {
                console.error('Firebase connection error:', error);
                updateConnectionStatus('disconnected');
            });
        }

        // Update connection status UI
        function updateConnectionStatus(status) {
            connectionStatus.className = `connection-status ${status}`;
            
            switch(status) {
                case 'connected':
                    connectionText.innerHTML = '<i class="fas fa-wifi mr-2"></i> Connected to Kynecta';
                    break;
                case 'connecting':
                    connectionText.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-2"></i> Connecting to Kynecta...';
                    break;
                case 'disconnected':
                    connectionText.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i> Offline';
                    break;
            }
            
            // Hide status after 3 seconds if connected
            if (status === 'connected') {
                setTimeout(() => {
                    connectionStatus.classList.add('hidden');
                }, 3000);
            } else {
                connectionStatus.classList.remove('hidden');
            }
        }

        // Auth Functions
        function signOut() {
            auth.signOut()
                .then(() => {
                    console.log('User signed out');
                    // Redirect to index page
                    window.location.href = 'index.html';
                })
                .catch((error) => {
                    console.error('Sign out error:', error);
                });
        }

        // Toggle theme
        function toggleTheme() {
            const body = document.body;
            if (body.classList.contains('dark-theme')) {
                body.classList.remove('dark-theme');
                body.classList.add('light-theme');
                localStorage.setItem('theme', 'light');
            } else if (body.classList.contains('light-theme')) {
                body.classList.remove('light-theme');
                body.classList.add('cyber-theme');
                localStorage.setItem('theme', 'cyber');
            } else {
                body.classList.remove('cyber-theme');
                body.classList.add('dark-theme');
                localStorage.setItem('theme', 'dark');
            }
        }

        // Toggle emotion options
        function toggleEmotionOptions() {
            emotionOptions.classList.toggle('hidden');
            interestOptions.classList.add('hidden');
            contentTypeOptions.classList.add('hidden');
        }

        // Toggle interest options
        function toggleInterestOptions() {
            interestOptions.classList.toggle('hidden');
            emotionOptions.classList.add('hidden');
            contentTypeOptions.classList.add('hidden');
        }

        // Toggle content type options
        function toggleContentTypeOptions() {
            contentTypeOptions.classList.toggle('hidden');
            emotionOptions.classList.add('hidden');
            interestOptions.classList.add('hidden');
        }

        // Toggle keyboard shortcuts display
        function toggleKeyboardShortcuts() {
            keyboardShortcuts.classList.toggle('show');
        }

        // Open create post modal
        function openCreatePostModal() {
            if (!currentUser) {
                alert('Please sign in to create a post');
                return;
            }
            createPostModal.classList.remove('hidden');
            modalPostInput.focus();
        }

        // Close create post modal
        function closeCreatePostModal() {
            createPostModal.classList.add('hidden');
            resetPostModal();
        }

        // Reset post modal to initial state
        function resetPostModal() {
            modalPostInput.value = '';
            document.getElementById('pollCreator').classList.add('hidden');
            document.getElementById('modalMediaPreview').classList.add('hidden');
            document.getElementById('linkPreview').classList.add('hidden');
            document.getElementById('postMood').value = '';
            document.getElementById('postAudience').value = 'public';
            aiSuggestion.classList.add('hidden');
            collaborativePost.classList.add('hidden');
            collaborativeSettings.classList.add('hidden');
            toxicityWarning.classList.add('hidden');
        }

        // Create Post Function
        function createPost() {
            if (!currentUser) {
                alert('Please sign in to create a post');
                return;
            }

            const content = modalPostInput.value.trim();
            if (!content && !document.getElementById('modalMediaPreview').classList.contains('hidden')) {
                alert('Please add some content to your post');
                return;
            }
            
            const mood = document.getElementById('postMood').value;
            const audience = document.getElementById('postAudience').value;
            
            // Create post object
            const postData = {
                content: content,
                userId: currentUser.uid,
                userName: currentUser.displayName || 'Anonymous',
                userAvatar: currentUser.photoURL || '',
                mood: mood,
                audience: audience,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                likes: [],
                likesCount: 0,
                commentsCount: 0,
                sharesCount: 0,
                viewsCount: 0,
                hashtags: extractHashtags(content),
                mentions: extractMentions(content),
                // Kynecta Unique Feature: Post Energy
                energy: calculatePostEnergy(content),
                // Kynecta Unique Feature: AI Generated
                aiGenerated: false,
                // NEW: Vibe reactions
                vibeReactions: {
                    energy: 0,
                    deep: 0,
                    pure: 0,
                    creative: 0
                },
                // NEW: Appreciation count
                appreciationCount: 0
            };
            
            // Add poll data if applicable
            if (document.getElementById('pollCreator').classList.contains('hidden') === false) {
                const pollQuestion = document.getElementById('pollQuestion').value;
                const pollOptions = Array.from(document.querySelectorAll('#pollOptions input')).map(input => ({
                    text: input.value,
                    votes: 0,
                    voters: []
                }));
                
                if (pollQuestion && pollOptions.length >= 2) {
                    postData.poll = {
                        question: pollQuestion,
                        options: pollOptions,
                        multipleAnswers: document.getElementById('multiplePollAnswers').checked,
                        totalVotes: 0
                    };
                }
            }
            
            // Kynecta Unique Feature: Collaborative Post
            if (!collaborativeSettings.classList.contains('hidden')) {
                const collaborativeTitle = document.getElementById('collaborativeTitle').value;
                const collaborativeType = document.getElementById('collaborativeType').value;
                const allowEdits = document.getElementById('allowEdits').checked;
                
                if (collaborativeTitle) {
                    postData.collaborative = {
                        title: collaborativeTitle,
                        type: collaborativeType,
                        allowEdits: allowEdits,
                        collaborators: [currentUser.uid],
                        isActive: true
                    };
                }
            }
            
            // Save to Firebase
            db.collection('posts').add(postData)
                .then(docRef => {
                    console.log('Post published with ID: ', docRef.id);
                    showNotification('Post published successfully!', 'success');
                    closeCreatePostModal();
                    reloadPosts();
                    
                    // Update user's post count
                    updateUserPostCount(1);
                    
                    // Kynecta Unique Feature: Update user energy
                    updateUserEnergy(5);
                    
                    // NEW: Update user streak
                    updateUserStreak();
                })
                .catch(error => {
                    console.error('Error publishing post: ', error);
                    showNotification('Error publishing post: ' + error.message, 'error');
                });
        }

        // NEW: Update user streak
        function updateUserStreak() {
            // TODO: Implement streak tracking logic in Firebase
            console.log('Updating user streak...');
        }

        // Like Post Function
        function likePost(postId) {
            if (!currentUser) {
                alert('Please sign in to like posts');
                return;
            }

            const postRef = db.collection('posts').doc(postId);
            
            // Use a transaction to safely update the likes
            db.runTransaction(transaction => {
                return transaction.get(postRef).then(postDoc => {
                    if (!postDoc.exists) {
                        throw new Error('Post does not exist!');
                    }
                    
                    const postData = postDoc.data();
                    const likes = postData.likes || [];
                    const likesCount = postData.likesCount || 0;
                    const userLiked = likes.includes(currentUser.uid);
                    
                    if (userLiked) {
                        // Remove like
                        const newLikes = likes.filter(uid => uid !== currentUser.uid);
                        transaction.update(postRef, {
                            likes: newLikes,
                            likesCount: likesCount - 1
                        });
                        return false; // Unlike
                    } else {
                        // Add like
                        const newLikes = [...likes, currentUser.uid];
                        transaction.update(postRef, {
                            likes: newLikes,
                            likesCount: likesCount + 1
                        });
                        return true; // Like
                    }
                });
            }).then(likeAdded => {
                console.log(likeAdded ? 'Post liked' : 'Post unliked');
                reloadPosts();
                
                // Kynecta Unique Feature: Update user energy
                if (likeAdded) {
                    updateUserEnergy(1);
                }
            }).catch(error => {
                console.error('Transaction failed: ', error);
                showNotification('Error liking post: ' + error.message, 'error');
            });
        }

        // NEW: Add vibe reaction to post
        function addVibeReaction(postId, vibeType) {
            if (!currentUser) {
                alert('Please sign in to react to posts');
                return;
            }

            const postRef = db.collection('posts').doc(postId);
            
            // Use a transaction to safely update the vibe reactions
            db.runTransaction(transaction => {
                return transaction.get(postRef).then(postDoc => {
                    if (!postDoc.exists) {
                        throw new Error('Post does not exist!');
                    }
                    
                    const postData = postDoc.data();
                    const vibeReactions = postData.vibeReactions || {
                        energy: 0,
                        deep: 0,
                        pure: 0,
                        creative: 0
                    };
                    
                    // Increment the selected vibe reaction
                    vibeReactions[vibeType] = (vibeReactions[vibeType] || 0) + 1;
                    
                    transaction.update(postRef, {
                        vibeReactions: vibeReactions
                    });
                    
                    return true;
                });
            }).then(success => {
                console.log(`Added ${vibeType} vibe reaction`);
                reloadPosts();
                
                // Update user energy
                updateUserEnergy(1);
            }).catch(error => {
                console.error('Transaction failed: ', error);
                showNotification('Error adding reaction: ' + error.message, 'error');
            });
        }

        // NEW: Add appreciation to post
        function addAppreciation(postId) {
            if (!currentUser) {
                alert('Please sign in to appreciate posts');
                return;
            }

            const postRef = db.collection('posts').doc(postId);
            
            // Use a transaction to safely update the appreciation count
            db.runTransaction(transaction => {
                return transaction.get(postRef).then(postDoc => {
                    if (!postDoc.exists) {
                        throw new Error('Post does not exist!');
                    }
                    
                    const postData = postDoc.data();
                    const appreciationCount = postData.appreciationCount || 0;
                    
                    transaction.update(postRef, {
                        appreciationCount: appreciationCount + 1
                    });
                    
                    return true;
                });
            }).then(success => {
                console.log('Added appreciation');
                reloadPosts();
                
                // TODO: Process payment through Flutterwave/M-Pesa API
                showNotification('Thank you for your appreciation!', 'success');
            }).catch(error => {
                console.error('Transaction failed: ', error);
                showNotification('Error adding appreciation: ' + error.message, 'error');
            });
        }

        // Submit Comment Function
        function submitComment(postId, commentText) {
            if (!currentUser) {
                alert('Please sign in to comment');
                return;
            }

            if (!commentText.trim()) {
                alert('Please enter a comment');
                return;
            }

            const commentData = {
                userId: currentUser.uid,
                userName: currentUser.displayName || 'Anonymous',
                userAvatar: currentUser.photoURL || '',
                content: commentText.trim(),
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                // NEW: Nested replies
                replies: [],
                // NEW: Voice comment placeholder
                hasVoiceComment: false
            };

            const postRef = db.collection('posts').doc(postId);
            const commentRef = postRef.collection('comments').doc();
            
            // Use a batch write to update both the comment and the post's comment count
            const batch = db.batch();
            
            // Add the comment
            batch.set(commentRef, commentData);
            
            // Increment the post's comment count
            batch.update(postRef, {
                commentsCount: firebase.firestore.FieldValue.increment(1)
            });
            
            batch.commit()
                .then(() => {
                    console.log('Comment added successfully');
                    showNotification('Comment added!', 'success');
                    reloadPosts();
                    
                    // Kynecta Unique Feature: Update user energy
                    updateUserEnergy(2);
                })
                .catch(error => {
                    console.error('Error adding comment: ', error);
                    showNotification('Error adding comment: ' + error.message, 'error');
                });
        }

        // NEW: Submit nested reply to comment
        function submitReply(postId, commentId, replyText) {
            if (!currentUser) {
                alert('Please sign in to reply');
                return;
            }

            if (!replyText.trim()) {
                alert('Please enter a reply');
                return;
            }

            const replyData = {
                userId: currentUser.uid,
                userName: currentUser.displayName || 'Anonymous',
                userAvatar: currentUser.photoURL || '',
                content: replyText.trim(),
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            const commentRef = db.collection('posts').doc(postId).collection('comments').doc(commentId);
            
            // Use a transaction to add the reply to the comment's replies array
            db.runTransaction(transaction => {
                return transaction.get(commentRef).then(commentDoc => {
                    if (!commentDoc.exists) {
                        throw new Error('Comment does not exist!');
                    }
                    
                    const commentData = commentDoc.data();
                    const replies = commentData.replies || [];
                    
                    // Add the new reply
                    replies.push(replyData);
                    
                    transaction.update(commentRef, {
                        replies: replies
                    });
                    
                    return true;
                });
            }).then(success => {
                console.log('Reply added successfully');
                showNotification('Reply added!', 'success');
                reloadPosts();
                
                // Update user energy
                updateUserEnergy(1);
            }).catch(error => {
                console.error('Error adding reply: ', error);
                showNotification('Error adding reply: ' + error.message, 'error');
            });
        }

        // Toggle poll creator
        function togglePollCreator() {
            const pollCreator = document.getElementById('pollCreator');
            pollCreator.classList.toggle('hidden');
        }

        // Toggle collaborative post
        function toggleCollaborativePost() {
            collaborativePost.classList.toggle('hidden');
        }

        // Add poll option
        function addPollOption() {
            const pollOptions = document.getElementById('pollOptions');
            const optionCount = pollOptions.children.length;
            
            if (optionCount >= 6) {
                alert('Maximum 6 options allowed');
                return;
            }
            
            const newOption = document.createElement('div');
            newOption.className = 'flex items-center space-x-2';
            newOption.innerHTML = `
                <input type="text" placeholder="Option ${optionCount + 1}" class="flex-1 p-2 glass border border-purple-700 rounded-lg">
                <button class="text-red-500 remove-poll-option"><i class="fas fa-times"></i></button>
            `;
            
            pollOptions.appendChild(newOption);
        }

        // Add link to post
        function addLinkToPost() {
            const url = prompt('Enter URL:');
            if (url) {
                // In a real implementation, you would fetch the link metadata
                // For this demo, we'll use placeholder data
                document.getElementById('linkTitle').textContent = 'Example Website';
                document.getElementById('linkDescription').textContent = 'This is an example website description that would be fetched from the provided URL.';
                document.getElementById('linkDomain').textContent = new URL(url).hostname;
                document.getElementById('linkImage').src = 'https://via.placeholder.com/150';
                document.getElementById('linkPreview').classList.remove('hidden');
            }
        }

        // Kynecta Unique Feature: Generate AI Suggestion
        function generateAISuggestion() {
            const content = modalPostInput.value.trim();
            if (content.length > 10 && content.length < 100) {
                // Simple AI suggestion logic - in a real app, this would call an AI API
                const suggestions = [
                    "Try adding a question to engage your audience!",
                    "Consider adding relevant hashtags to increase visibility.",
                    "This would be a great post to add a poll to!",
                    "Your post might benefit from adding an image or video.",
                    "This sounds like a perfect topic for a collaborative discussion!"
                ];
                
                const randomSuggestion = suggestions[Math.floor(Math.random() * suggestions.length)];
                aiSuggestionText.textContent = randomSuggestion;
                aiSuggestion.classList.remove('hidden');
            } else {
                aiSuggestion.classList.add('hidden');
            }
        }

        // Kynecta Unique Feature: Apply AI Suggestion
        function applyAISuggestion() {
            const suggestion = aiSuggestionText.textContent;
            if (suggestion.includes("question")) {
                modalPostInput.value += " What do you think?";
            } else if (suggestion.includes("hashtags")) {
                modalPostInput.value += " #Kynecta #SocialMedia";
            } else if (suggestion.includes("poll")) {
                togglePollCreator();
            } else if (suggestion.includes("image") || suggestion.includes("video")) {
                document.getElementById('modalAddPhoto').click();
            } else if (suggestion.includes("collaborative")) {
                toggleCollaborativePost();
            }
            
            aiSuggestion.classList.add('hidden');
        }

        // Handle media upload
        function handleMediaUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const modalMediaPreview = document.getElementById('modalMediaPreview');
            modalMediaPreview.classList.remove('hidden');
            
            // Show upload progress
            const uploadProgress = document.getElementById('uploadProgress');
            const uploadProgressBar = document.getElementById('uploadProgressBar');
            uploadProgress.classList.remove('hidden');
            uploadProgressBar.style.width = '0%';
            
            // Determine file type
            const fileType = file.type.split('/')[0];
            
            // Hide all media previews first
            document.getElementById('modalPreviewImage').classList.add('hidden');
            document.getElementById('modalPreviewVideo').classList.add('hidden');
            document.getElementById('modalPreviewAudio').classList.add('hidden');
            
            // Show appropriate preview
            if (fileType === 'image') {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('modalPreviewImage').src = e.target.result;
                    document.getElementById('modalPreviewImage').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else if (fileType === 'video') {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('modalPreviewVideo').src = e.target.result;
                    document.getElementById('modalPreviewVideo').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else if (fileType === 'audio') {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('modalPreviewAudio').src = e.target.result;
                    document.getElementById('modalPreviewAudio').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
            
            // Simulate upload progress
            let progress = 0;
            const interval = setInterval(() => {
                progress += 5;
                uploadProgressBar.style.width = `${progress}%`;
                
                if (progress >= 100) {
                    clearInterval(interval);
                    uploadProgress.classList.add('hidden');
                    // In a real implementation, you would upload to Firebase Storage here
                }
            }, 100);
        }

        // Handle search
        function handleSearch() {
            const query = searchInput.value.trim();
            if (query.length < 2) {
                // Clear search results if query is too short
                document.getElementById('searchResults').innerHTML = '';
                return;
            }
            
            // Search users and posts
            const usersPromise = db.collection('users')
                .where('userName', '>=', query)
                .where('userName', '<=', query + '\uf8ff')
                .limit(5)
                .get();
                
            const postsPromise = db.collection('posts')
                .where('content', '>=', query)
                .where('content', '<=', query + '\uf8ff')
                .limit(5)
                .get();
            
            Promise.all([usersPromise, postsPromise])
                .then(([usersSnapshot, postsSnapshot]) => {
                    displaySearchResults(usersSnapshot, postsSnapshot, query);
                })
                .catch(error => {
                    console.error('Search error:', error);
                });
        }

        // Display search results
        function displaySearchResults(usersSnapshot, postsSnapshot, query) {
            const searchResults = document.getElementById('searchResults');
            searchResults.innerHTML = '';
            
            if (usersSnapshot.empty && postsSnapshot.empty) {
                searchResults.innerHTML = '<div class="p-4 text-center text-theme-secondary">No results found</div>';
                return;
            }
            
            let html = '<div class="search-results-container p-4">';
            
            // Add users
            if (!usersSnapshot.empty) {
                html += '<div class="mb-4"><h3 class="font-semibold text-theme-accent mb-2">People</h3>';
                usersSnapshot.forEach(doc => {
                    const user = doc.data();
                    html += `
                        <div class="search-result-item p-3 rounded-lg glass mb-2 cursor-pointer hover:bg-purple-900/30 transition flex items-center">
                            <img src="${user.userAvatar || 'https://via.placeholder.com/40'}" class="w-8 h-8 rounded-full mr-3">
                            <div>
                                <p class="font-medium">${highlightText(user.userName, query)}</p>
                                <p class="text-xs text-theme-secondary">${user.bio || ''}</p>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            // Add posts
            if (!postsSnapshot.empty) {
                html += '<div class="mb-4"><h3 class="font-semibold text-theme-accent mb-2">Posts</h3>';
                postsSnapshot.forEach(doc => {
                    const post = doc.data();
                    html += `
                        <div class="search-result-item p-3 rounded-lg glass mb-2 cursor-pointer hover:bg-purple-900/30 transition">
                            <p class="text-sm">${highlightText(post.content, query)}</p>
                            <div class="flex items-center mt-2 text-xs text-theme-secondary">
                                <img src="${post.userAvatar}" class="w-4 h-4 rounded-full mr-1">
                                <span>${post.userName}</span>
                                <span class="mx-1">‚Ä¢</span>
                                <span>${formatDate(post.timestamp?.toDate())}</span>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            html += '</div>';
            searchResults.innerHTML = html;
        }

        // Highlight search terms in text
        function highlightText(text, query) {
            if (!text) return '';
            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<mark class="bg-yellow-300 text-black">$1</mark>');
        }

        // Update user UI with current user data
        function updateUserUI() {
            if (currentUser) {
                userAvatar.src = currentUser.photoURL || 'https://via.placeholder.com/40';
                userDisplayName.textContent = currentUser.displayName || 'User';
                sidebarUserAvatar.src = currentUser.photoURL || 'https://via.placeholder.com/40';
                sidebarUserName.textContent = currentUser.displayName || 'User';
                currentUserAvatar.src = currentUser.photoURL || 'https://via.placeholder.com/40';
                currentUserName.textContent = currentUser.displayName || 'User';
            }
        }

        // Load user data from Firebase
        function loadUserData() {
            if (!currentUser) return;
            
            db.collection('users').doc(currentUser.uid).get()
                .then(doc => {
                    if (doc.exists) {
                        const userData = doc.data();
                        postCount.textContent = userData.postsCount || 0;
                        followerCount.textContent = userData.followersCount || 0;
                        followingCount.textContent = userData.followingCount || 0;
                        statusText.textContent = userData.status || 'Online';
                        sidebarUserStatus.textContent = userData.status || 'Online';
                        
                        // Kynecta Unique Feature: Update user energy
                        updateUserEnergyDisplay(userData.energy || 0);
                        
                        // Kynecta Unique Feature: Load user badges
                        loadUserBadges(userData.badges || []);
                    } else {
                        // Create user document if it doesn't exist
                        createUserDocument();
                    }
                })
                .catch(error => {
                    console.error('Error loading user data:', error);
                });
        }

        // Create user document
        function createUserDocument() {
            if (!currentUser) return;
            
            const userData = {
                userId: currentUser.uid,
                userName: currentUser.displayName || 'User',
                userAvatar: currentUser.photoURL || '',
                email: currentUser.email || '',
                status: 'Online',
                postsCount: 0,
                followersCount: 0,
                followingCount: 0,
                energy: 0,
                badges: ['newcomer'],
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                // NEW: Gamification data
                streak: 0,
                points: 0,
                achievements: []
            };
            
            db.collection('users').doc(currentUser.uid).set(userData)
                .then(() => {
                    console.log('User document created');
                    loadUserData();
                })
                .catch(error => {
                    console.error('Error creating user document:', error);
                });
        }

        // Update user post count
        function updateUserPostCount(increment) {
            if (!currentUser) return;
            
            db.collection('users').doc(currentUser.uid).update({
                postsCount: firebase.firestore.FieldValue.increment(increment)
            })
            .then(() => {
                loadUserData();
            })
            .catch(error => {
                console.error('Error updating user post count:', error);
            });
        }

        // Kynecta Unique Feature: Update user energy
        function updateUserEnergy(points) {
            if (!currentUser) return;
            
            db.collection('users').doc(currentUser.uid).update({
                energy: firebase.firestore.FieldValue.increment(points)
            })
            .then(() => {
                loadUserData();
            })
            .catch(error => {
                console.error('Error updating user energy:', error);
            });
        }

        // Kynecta Unique Feature: Update user energy display
        function updateUserEnergyDisplay(energy) {
            const percentage = Math.min(100, energy);
            userEnergyRing.style.background = `conic-gradient(var(--accent-color) ${percentage}%, transparent ${percentage}%)`;
            energyPercentage.textContent = `${percentage}%`;
        }

        // Kynecta Unique Feature: Load user badges
        function loadUserBadges(badges) {
            userBadges.innerHTML = '';
            
            const badgeConfig = {
                'newcomer': { text: 'Newcomer', color: 'bg-blue-500' },
                'contributor': { text: 'Contributor', color: 'bg-green-500' },
                'influencer': { text: 'Influencer', color: 'bg-purple-500' },
                'collaborator': { text: 'Collaborator', color: 'bg-yellow-500' },
                'visionary': { text: 'Visionary', color: 'bg-pink-500' }
            };
            
            badges.forEach(badge => {
                if (badgeConfig[badge]) {
                    const badgeElement = document.createElement('span');
                    badgeElement.className = `kynecta-badge ${badgeConfig[badge].color}`;
                    badgeElement.textContent = badgeConfig[badge].text;
                    userBadges.appendChild(badgeElement);
                }
            });
        }

        // Kynecta Unique Feature: Calculate post energy
        function calculatePostEnergy(content) {
            // Simple algorithm to calculate post "energy" based on content
            let energy = 0;
            
            // Base energy
            energy += Math.min(content.length / 10, 10);
            
            // Bonus for hashtags
            const hashtags = extractHashtags(content);
            energy += hashtags.length * 2;
            
            // Bonus for mentions
            const mentions = extractMentions(content);
            energy += mentions.length * 2;
            
            // Bonus for questions
            if (content.includes('?')) energy += 5;
            
            return Math.min(energy, 50);
        }

        // Load initial posts from Firebase
        function loadInitialPosts() {
            if (!currentUser) return;
            
            loadingIndicator.classList.remove('hidden');
            endOfFeed.classList.add('hidden');
            
            let query = db.collection('posts')
                .orderBy('timestamp', 'desc')
                .limit(10);
            
            // Apply filters if set
            if (currentFilter === 'top') {
                query = query.orderBy('likesCount', 'desc');
            } else if (currentFilter === 'trending') {
                query = query.orderBy('viewsCount', 'desc');
            }
            
            if (currentEmotionFilter) {
                query = query.where('mood', '==', currentEmotionFilter);
            }
            
            // NEW: Apply mood-based filtering
            if (currentMoodFilter && currentMoodFilter !== 'all') {
                // TODO: Implement mood-based filtering logic
                // This would require posts to have mood metadata
                console.log('Filtering by mood:', currentMoodFilter);
            }
            
            if (currentContentTypeFilter === 'poll') {
                query = query.where('poll', '!=', null);
            } else if (currentContentTypeFilter === 'collaborative') {
                query = query.where('collaborative', '!=', null);
            }
            
            query.get()
                .then(snapshot => {
                    posts = [];
                    snapshot.forEach(doc => {
                        posts.push({ id: doc.id, ...doc.data() });
                    });
                    
                    displayPosts(posts);
                    loadingIndicator.classList.add('hidden');
                    
                    if (snapshot.docs.length > 0) {
                        lastPost = snapshot.docs[snapshot.docs.length - 1];
                        hasMorePosts = true;
                    } else {
                        hasMorePosts = false;
                        endOfFeed.classList.remove('hidden');
                    }
                })
                .catch(error => {
                    console.error('Error loading posts:', error);
                    loadingIndicator.classList.add('hidden');
                    showNotification('Error loading posts: ' + error.message, 'error');
                });
        }

        // Load more posts for infinite scroll
        function loadMorePosts() {
            if (!hasMorePosts || !currentUser) return;
            
            loadingIndicator.classList.remove('hidden');
            
            let query = db.collection('posts')
                .orderBy('timestamp', 'desc')
                .startAfter(lastPost)
                .limit(10);
            
            // Apply filters if set
            if (currentFilter === 'top') {
                query = query.orderBy('likesCount', 'desc');
            } else if (currentFilter === 'trending') {
                query = query.orderBy('viewsCount', 'desc');
            }
            
            if (currentEmotionFilter) {
                query = query.where('mood', '==', currentEmotionFilter);
            }
            
            // NEW: Apply mood-based filtering
            if (currentMoodFilter && currentMoodFilter !== 'all') {
                // TODO: Implement mood-based filtering logic
                console.log('Filtering by mood:', currentMoodFilter);
            }
            
            if (currentContentTypeFilter === 'poll') {
                query = query.where('poll', '!=', null);
            } else if (currentContentTypeFilter === 'collaborative') {
                query = query.where('collaborative', '!=', null);
            }
            
            query.get()
                .then(snapshot => {
                    const newPosts = [];
                    snapshot.forEach(doc => {
                        newPosts.push({ id: doc.id, ...doc.data() });
                    });
                    
                    posts = [...posts, ...newPosts];
                    displayPosts(posts);
                    loadingIndicator.classList.add('hidden');
                    
                    if (snapshot.docs.length > 0) {
                        lastPost = snapshot.docs[snapshot.docs.length - 1];
                    } else {
                        hasMorePosts = false;
                        endOfFeed.classList.remove('hidden');
                    }
                })
                .catch(error => {
                    console.error('Error loading more posts:', error);
                    loadingIndicator.classList.add('hidden');
                    showNotification('Error loading more posts: ' + error.message, 'error');
                });
        }

        // Reload posts with current filters
        function reloadPosts() {
            if (!currentUser) return;
            feedContainer.innerHTML = '';
            loadInitialPosts();
        }

        // Display posts in the feed
        function displayPosts(postsToDisplay) {
            feedContainer.innerHTML = '';
            
            if (postsToDisplay.length === 0) {
                feedContainer.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <i class="fas fa-inbox text-4xl text-theme-secondary mb-4"></i>
                        <h3 class="text-xl font-semibold text-theme-primary mb-2">No posts found</h3>
                        <p class="text-theme-secondary">Try changing your filters or be the first to post!</p>
                    </div>
                `;
                return;
            }
            
            postsToDisplay.forEach(post => {
                const postElement = createPostElement(post);
                feedContainer.appendChild(postElement);
            });
        }

        // Create a post element
        function createPostElement(post) {
            const postElement = document.createElement('div');
            postElement.className = 'post-card p-5';
            postElement.dataset.postId = post.id;
            
            let mediaHtml = '';
            if (post.media) {
                if (post.media.type === 'image') {
                    mediaHtml = `<img src="${post.media.url}" alt="Post image" class="w-full h-auto rounded-xl mt-3">`;
                } else if (post.media.type === 'video') {
                    mediaHtml = `
                        <div class="relative mt-3">
                            <video src="${post.media.url}" controls class="w-full h-auto rounded-xl"></video>
                            <div class="absolute bottom-3 right-3 bg-black/50 text-white px-2 py-1 rounded-lg text-sm">
                                <i class="fas fa-play mr-1"></i> Video
                            </div>
                        </div>
                    `;
                } else if (post.media.type === 'audio') {
                    mediaHtml = `
                        <div class="mt-3 p-4 glass rounded-xl">
                            <audio src="${post.media.url}" controls class="w-full audio-player"></audio>
                        </div>
                    `;
                }
            }
            
            let pollHtml = '';
            if (post.poll) {
                const totalVotes = post.poll.totalVotes;
                pollHtml = `
                    <div class="mt-3 p-4 glass rounded-xl">
                        <h4 class="font-semibold mb-3">${post.poll.question}</h4>
                        <div class="space-y-2">
                            ${post.poll.options.map((option, index) => {
                                const percentage = totalVotes > 0 ? (option.votes / totalVotes) * 100 : 0;
                                const hasVoted = post.poll.voters && post.poll.voters.includes(currentUser.uid);
                                const isSelected = hasVoted && option.voters.includes(currentUser.uid);
                                
                                return `
                                    <div class="poll-option ${isSelected ? 'selected' : ''}" data-option-index="${index}">
                                        <div class="flex justify-between items-center">
                                            <span>${option.text}</span>
                                            <span class="text-xs">${option.votes} votes (${percentage.toFixed(1)}%)</span>
                                        </div>
                                        <div class="poll-bar" style="width: ${percentage}%"></div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <p class="text-xs text-theme-secondary mt-2">${totalVotes} total votes</p>
                    </div>
                `;
            }
            
            let linkPreviewHtml = '';
            if (post.linkPreview) {
                linkPreviewHtml = `
                    <div class="link-preview mt-3">
                        <div class="flex">
                            <div class="link-preview-content flex-1">
                                <h4 class="font-semibold text-theme-primary">${post.linkPreview.title}</h4>
                                <p class="text-sm text-theme-secondary mt-1">${post.linkPreview.description}</p>
                                <p class="text-xs text-theme-secondary mt-2">${post.linkPreview.domain}</p>
                            </div>
                            <img src="${post.linkPreview.image}" alt="Link preview" class="w-24 h-24 object-cover rounded-r-lg">
                        </div>
                    </div>
                `;
            }
            
            // Format hashtags and mentions
            let content = post.content || '';
            if (post.hashtags) {
                post.hashtags.forEach(tag => {
                    content = content.replace(
                        new RegExp(`#${tag}`, 'g'),
                        `<span class="hashtag text-theme-accent cursor-pointer">#${tag}</span>`
                    );
                });
            }
            
            if (post.mentions) {
                post.mentions.forEach(mention => {
                    content = content.replace(
                        new RegExp(`@${mention}`, 'g'),
                        `<span class="mention text-theme-accent cursor-pointer">@${mention}</span>`
                    );
                });
            }
            
            // Check if current user liked the post
            const userLiked = post.likes && post.likes.includes(currentUser.uid);
            
            // NEW: Vibe reactions
            const vibeReactions = post.vibeReactions || {
                energy: 0,
                deep: 0,
                pure: 0,
                creative: 0
            };
            
            // NEW: Appreciation count
            const appreciationCount = post.appreciationCount || 0;
            
            // Kynecta Unique Feature: Collaborative Post Indicator
            let collaborativeHtml = '';
            if (post.collaborative) {
                collaborativeHtml = `
                    <div class="collaboration-indicator mt-2">
                        <i class="fas fa-users text-theme-accent"></i>
                        <span>Collaborative: ${post.collaborative.title}</span>
                    </div>
                `;
            }
            
            // Kynecta Unique Feature: Post Energy Indicator
            let energyHtml = '';
            if (post.energy) {
                const energyPercentage = Math.min(100, post.energy * 2);
                energyHtml = `
                    <div class="flex items-center mt-2 text-xs text-theme-secondary">
                        <div class="w-16 h-2 bg-gray-700 rounded-full mr-2">
                            <div class="h-2 bg-theme-accent rounded-full" style="width: ${energyPercentage}%"></div>
                        </div>
                        <span>${post.energy} energy</span>
                    </div>
                `;
            }
            
            postElement.innerHTML = `
                <div class="flex items-start space-x-3">
                    <img src="${post.userAvatar || 'https://via.placeholder.com/40'}" alt="${post.userName}'s avatar" class="w-10 h-10 rounded-2xl object-cover cursor-pointer">
                    <div class="flex-1">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="font-semibold text-theme-primary cursor-pointer">${post.userName}</h3>
                                <div class="flex items-center space-x-2 mt-1">
                                    <span class="text-xs text-theme-secondary">${formatDate(post.timestamp?.toDate())}</span>
                                    ${post.mood ? `<span class="text-xs px-2 py-1 rounded-full bg-theme-accent/20 text-theme-accent">${getMoodEmoji(post.mood)} ${post.mood}</span>` : ''}
                                    ${post.audience === 'friends' ? '<span class="text-xs text-theme-secondary"><i class="fas fa-user-friends mr-1"></i>Friends</span>' : ''}
                                    ${post.audience === 'private' ? '<span class="text-xs text-theme-secondary"><i class="fas fa-lock mr-1"></i>Only Me</span>' : ''}
                                    ${post.aiGenerated ? '<span class="kynecta-badge bg-purple-500">AI Enhanced</span>' : ''}
                                </div>
                            </div>
                            <div class="relative">
                                <button class="post-options-btn text-theme-secondary hover:text-theme-accent transition">
                                    <i class="fas fa-ellipsis-h"></i>
                                </button>
                            </div>
                        </div>
                        
                        ${collaborativeHtml}
                        
                        <div class="mt-3 text-theme-primary">
                            ${content}
                        </div>
                        
                        ${energyHtml}
                        
                        ${mediaHtml}
                        ${pollHtml}
                        ${linkPreviewHtml}
                        
                        <!-- NEW: Vibe Reactions -->
                        <div class="vibe-reactions mt-3">
                            <div class="vibe-reaction" data-vibe="energy" data-post-id="${post.id}">
                                <span>üî•</span>
                                <span>${vibeReactions.energy || 0}</span>
                            </div>
                            <div class="vibe-reaction" data-vibe="deep" data-post-id="${post.id}">
                                <span>üí≠</span>
                                <span>${vibeReactions.deep || 0}</span>
                            </div>
                            <div class="vibe-reaction" data-vibe="pure" data-post-id="${post.id}">
                                <span>üíö</span>
                                <span>${vibeReactions.pure || 0}</span>
                            </div>
                            <div class="vibe-reaction" data-vibe="creative" data-post-id="${post.id}">
                                <span>üåà</span>
                                <span>${vibeReactions.creative || 0}</span>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between mt-4 pt-3 border-t border-purple-800">
                            <div class="flex items-center space-x-4 text-theme-secondary">
                                <div class="relative reaction-container">
                                    <button class="reaction-btn flex items-center space-x-1 ${userLiked ? 'text-red-500' : 'hover:text-theme-accent'} transition" data-post-id="${post.id}">
                                        <i class="fas fa-heart"></i>
                                        <span>${post.likesCount || 0}</span>
                                    </button>
                                </div>
                                <button class="comment-btn flex items-center space-x-1 hover:text-theme-accent transition" data-post-id="${post.id}">
                                    <i class="fas fa-comment"></i>
                                    <span>${post.commentsCount || 0}</span>
                                </button>
                                <button class="share-btn flex items-center space-x-1 hover:text-theme-accent transition">
                                    <i class="fas fa-share"></i>
                                    <span>${post.sharesCount || 0}</span>
                                </button>
                                <!-- NEW: Appreciation Button -->
                                <button class="appreciation-btn flex items-center space-x-1" data-post-id="${post.id}">
                                    <i class="fas fa-gift"></i>
                                    <span>${appreciationCount}</span>
                                </button>
                            </div>
                            <button class="save-post-btn text-theme-secondary hover:text-theme-accent transition">
                                <i class="far fa-bookmark"></i>
                            </button>
                        </div>
                        
                        <!-- Comment Input -->
                        <div class="comment-input mt-4 hidden" data-post-id="${post.id}">
                            <div class="flex items-start space-x-2">
                                <img src="${currentUser.photoURL || 'https://via.placeholder.com/32'}" alt="Your avatar" class="w-8 h-8 rounded-full object-cover">
                                <div class="flex-1 flex space-x-2">
                                    <input type="text" placeholder="Write a comment..." class="flex-1 p-2 glass border border-purple-700 rounded-2xl text-sm">
                                    <button class="emoji-picker-btn px-3 py-2 glass border border-purple-700 rounded-2xl text-sm">
                                        <i class="far fa-smile"></i>
                                    </button>
                                    <button class="voice-comment-btn">
                                        <i class="fas fa-microphone"></i>
                                    </button>
                                    <button class="submit-comment px-3 py-2 rounded-2xl text-sm" style="background: var(--accent-color); color: white;" data-post-id="${post.id}">Post</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Set up event listeners for this post
            setupPostEventListeners(postElement, post);
            
            return postElement;
        }

        // Set up event listeners for a post element
        function setupPostEventListeners(postElement, post) {
            // Like button
            const likeBtn = postElement.querySelector('.reaction-btn');
            likeBtn.addEventListener('click', function() {
                likePost(post.id);
            });
            
            // NEW: Vibe reaction buttons
            const vibeReactionBtns = postElement.querySelectorAll('.vibe-reaction');
            vibeReactionBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const vibeType = this.dataset.vibe;
                    addVibeReaction(post.id, vibeType);
                });
            });
            
            // NEW: Appreciation button
            const appreciationBtn = postElement.querySelector('.appreciation-btn');
            appreciationBtn.addEventListener('click', function() {
                addAppreciation(post.id);
            });
            
            // Comment button
            const commentBtn = postElement.querySelector('.comment-btn');
            const commentInput = postElement.querySelector('.comment-input');
            commentBtn.addEventListener('click', function() {
                commentInput.classList.toggle('hidden');
            });
            
            // NEW: Emoji picker button
            const emojiPickerBtn = postElement.querySelector('.emoji-picker-btn');
            emojiPickerBtn.addEventListener('click', function() {
                const rect = this.getBoundingClientRect();
                emojiPicker.style.bottom = `${window.innerHeight - rect.top + 10}px`;
                emojiPicker.style.left = `${rect.left}px`;
                emojiPicker.classList.toggle('show');
            });
            
            // NEW: Voice comment button
            const voiceCommentBtn = postElement.querySelector('.voice-comment-btn');
            voiceCommentBtn.addEventListener('click', function() {
                // TODO: Implement voice recording functionality
                showNotification('Voice comments coming soon!', 'success');
            });
            
            // Submit comment
            const submitCommentBtn = postElement.querySelector('.submit-comment');
            const commentInputField = postElement.querySelector('.comment-input input');
            submitCommentBtn.addEventListener('click', function() {
                submitComment(post.id, commentInputField.value);
                commentInputField.value = '';
                commentInput.classList.add('hidden');
            });
            
            // Enter key to submit comment
            commentInputField.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    submitComment(post.id, commentInputField.value);
                    commentInputField.value = '';
                    commentInput.classList.add('hidden');
                }
            });
            
            // Share button
            const shareBtn = postElement.querySelector('.share-btn');
            shareBtn.addEventListener('click', function() {
                sharePost(post.id);
            });
            
            // Save post button
            const saveBtn = postElement.querySelector('.save-post-btn');
            saveBtn.addEventListener('click', function() {
                toggleSavePost(post.id);
                this.querySelector('i').classList.toggle('far');
                this.querySelector('i').classList.toggle('fas');
            });
            
            // Hashtag and mention clicks
            const hashtags = postElement.querySelectorAll('.hashtag');
            hashtags.forEach(tag => {
                tag.addEventListener('click', function() {
                    const hashtag = this.textContent.substring(1);
                    searchInput.value = `#${hashtag}`;
                    handleSearch();
                });
            });
            
            const mentions = postElement.querySelectorAll('.mention');
            mentions.forEach(mention => {
                mention.addEventListener('click', function() {
                    const username = this.textContent.substring(1);
                    searchInput.value = `@${username}`;
                    handleSearch();
                });
            });
        }

        // Share a post
        function sharePost(postId) {
            if (!currentUser) {
                alert('Please sign in to share posts');
                return;
            }

            // In a real implementation, you would generate a shareable link
            // For this demo, we'll just show an alert and increment share count
            const postRef = db.collection('posts').doc(postId);
            postRef.update({
                sharesCount: firebase.firestore.FieldValue.increment(1)
            })
            .then(() => {
                showNotification('Post shared!', 'success');
                reloadPosts();
            })
            .catch(error => {
                console.error('Error sharing post:', error);
                showNotification('Error sharing post: ' + error.message, 'error');
            });
        }

        // Toggle save post
        function toggleSavePost(postId) {
            if (!currentUser) {
                alert('Please sign in to save posts');
                return;
            }

            // In a real implementation, you would update the user's saved posts
            showNotification('Post saved to collections!', 'success');
        }

        // Load stories from Firebase
        function loadStories() {
            if (!currentUser) return;
            
            // In a real implementation, you would fetch stories from Firebase
            // For now, we'll just show a placeholder
            storiesContainer.innerHTML = `
                <div class="flex flex-col items-center space-y-2 flex-shrink-0">
                    <div class="story-ring" id="createStoryBtn">
                        <div class="story-content">
                            <i class="fas fa-plus text-theme-accent"></i>
                        </div>
                    </div>
                    <span class="text-xs font-semibold text-theme-accent">Your Story</span>
                </div>
                <div class="text-theme-secondary p-4">
                    <p>No stories available</p>
                </div>
            `;
        }

        // Load trending topics from Firebase
        function loadTrendingTopics() {
            if (!currentUser) return;
            
            // In a real implementation, you would fetch trending topics from Firebase
            trendingTopicsContainer.innerHTML = `
                <div class="text-theme-secondary p-4 text-center">
                    <p>Trending topics will appear here</p>
                </div>
            `;
        }

        // Load leaderboard from Firebase
        function loadLeaderboard() {
            if (!currentUser) return;
            
            // In a real implementation, you would fetch leaderboard data from Firebase
            leaderboardContainer.innerHTML = `
                <div class="text-theme-secondary p-4 text-center">
                    <p>Leaderboard will appear here</p>
                </div>
            `;
        }

        // Load suggested users from Firebase
        function loadSuggestedUsers() {
            if (!currentUser) return;
            
            // In a real implementation, you would fetch suggested users from Firebase
            suggestedUsersContainer.innerHTML = `
                <div class="text-theme-secondary p-4 text-center">
                    <p>Suggested users will appear here</p>
                </div>
            `;
        }

        // Utility Functions

        // Extract hashtags from text
        function extractHashtags(text) {
            if (!text) return [];
            const hashtags = text.match(/#\w+/g) || [];
            return hashtags.map(tag => tag.substring(1));
        }

        // Extract mentions from text
        function extractMentions(text) {
            if (!text) return [];
            const mentions = text.match(/@\w+/g) || [];
            return mentions.map(mention => mention.substring(1));
        }

        // Format date
        function formatDate(date) {
            if (!date) return 'Just now';
            
            const now = new Date();
            const diffMs = now - date;
            const diffSecs = Math.floor(diffMs / 1000);
            const diffMins = Math.floor(diffSecs / 60);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffSecs < 60) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            
            return date.toLocaleDateString();
        }

        // Get mood emoji
        function getMoodEmoji(mood) {
            const moodEmojis = {
                joy: 'üòÑ',
                love: '‚ù§Ô∏è',
                calm: 'üòå',
                excited: 'ü§©',
                sad: 'üò¢',
                angry: 'üò†'
            };
            return moodEmojis[mood] || 'üòä';
        }

        // Show notification
        function showNotification(message, type) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed top-4 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-2xl z-50 ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            } text-white font-semibold shadow-lg`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Debounce function for performance
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>