<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ConnectSphere - Enhanced Social Feed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    
    <style>
        /* All CSS styles remain the same as in the original file */
        :root {
            --primary-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-primary: #ffffff;
            --text-secondary: #cbd5e1;
            --accent-color: #22d3ee;
            --accent-hover: #06b6d4;
        }

        .light-theme {
            --primary-bg: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            --glass-bg: rgba(255, 255, 255, 0.8);
            --glass-border: rgba(209, 213, 219, 0.5);
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --accent-color: #3b82f6;
            --accent-hover: #2563eb;
        }

        .dark-theme {
            --primary-bg: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            --glass-bg: rgba(30, 41, 59, 0.5);
            --glass-border: rgba(100, 116, 139, 0.3);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent-color: #22d3ee;
            --accent-hover: #06b6d4;
        }

        .cyber-theme {
            --primary-bg: linear-gradient(135deg, #1e3a8a 0%, #7e22ce 100%);
            --glass-bg: rgba(30, 58, 138, 0.3);
            --glass-border: rgba(124, 58, 237, 0.5);
            --text-primary: #f0f9ff;
            --text-secondary: #bae6fd;
            --accent-color: #f59e0b;
            --accent-hover: #d97706;
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            z-index: 1000;
            transition: all 0.3s ease-in-out;
            display: flex;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .connection-status.connected {
            background: rgba(34, 197, 94, 0.9);
            color: white;
            border: 1px solid rgba(34, 197, 94, 0.6);
        }
        .connection-status.connecting {
            background: rgba(245, 158, 11, 0.9);
            color: white;
            border: 1px solid rgba(245, 158, 11, 0.6);
        }
        .connection-status.disconnected {
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: 1px solid rgba(239, 68, 68, 0.6);
        }
        .connection-status.hidden {
            opacity: 0;
            transform: translateY(-20px);
            pointer-events: none;
        }

        /* Emotion Reactive Backgrounds */
        .emotion-joy { --primary-bg: linear-gradient(135deg, #FFD93D 0%, #FF6B6B 100%) !important; }
        .emotion-love { --primary-bg: linear-gradient(135deg, #FF6B9D 0%, #C44569 100%) !important; }
        .emotion-calm { --primary-bg: linear-gradient(135deg, #6BC5D2 0%, #3B82F6 100%) !important; }
        .emotion-excited { --primary-bg: linear-gradient(135deg, #FF9A3D 0%, #FF6B6B 100%) !important; }
        .emotion-sad { --primary-bg: linear-gradient(135deg, #3a7bd5 0%, #3a6073 100%) !important; }
        .emotion-angry { --primary-bg: linear-gradient(135deg, #c31432 0%, #240b36 100%) !important; }

        /* Gamification Elements */
        .streak-fire {
            animation: firePulse 2s infinite;
        }
        @keyframes firePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .unicoin-glow {
            animation: coinSpin 3s linear infinite;
        }
        @keyframes coinSpin {
            0% { transform: rotateY(0deg); }
            100% { transform: rotateY(360deg); }
        }

        /* Enhanced UI Components */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
        }

        .cyber-gradient {
            background: var(--primary-bg);
        }

        .hologram-border {
            border: 1px solid transparent;
            background: linear-gradient(45deg, #ff6b6b, #ffa726, #4ecdc4, #45b7d1) border-box;
            -webkit-mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
        }

        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        .status-online {
            background-color: #10B981;
            box-shadow: 0 0 8px #10B981;
        }
        .status-away {
            background-color: #F59E0B;
            box-shadow: 0 0 8px #F59E0B;
        }
        .status-busy {
            background-color: #EF4444;
            box-shadow: 0 0 8px #EF4444;
        }
        .status-offline {
            background-color: #6B7280;
            box-shadow: 0 0 8px #6B7280;
        }

        .media-preview {
            max-height: 300px;
            object-fit: cover;
            border-radius: 12px;
            margin-top: 10px;
        }

        .tag-pill {
            display: inline-flex;
            align-items: center;
            background: rgba(139, 92, 246, 0.3);
            border: 1px solid rgba(139, 92, 246, 0.5);
            border-radius: 20px;
            padding: 4px 10px;
            margin: 2px;
            font-size: 0.8rem;
        }

        .interaction-btn {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .interaction-btn:hover {
            color: var(--accent-color);
            transform: scale(1.1);
        }
        .interaction-btn.active {
            color: var(--accent-color);
        }

        .follow-btn {
            transition: all 0.3s ease;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            padding: 6px 12px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .follow-btn:hover {
            background: var(--accent-color);
            color: white;
        }
        .follow-btn.following {
            background: rgba(16, 185, 129, 0.2);
            color: #10B981;
            border-color: #10B981;
        }

        /* Emotion Reaction Styles */
        .emotion-reaction {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 15px;
            background: var(--glass-bg);
            margin: 2px;
            font-size: 0.8rem;
        }

        /* Theme Selector */
        .theme-selector {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        .theme-options {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 10px;
            display: none;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            width: 200px;
        }
        .theme-options.show {
            display: grid;
        }
        .theme-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .theme-option:hover {
            transform: scale(1.1);
        }
        .theme-option.active {
            border-color: white;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }
        .theme-dark {
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
        }
        .theme-light {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
        }
        .theme-cyber {
            background: linear-gradient(135deg, #1e3a8a 0%, #7e22ce 100%);
        }

        /* Search Results */
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }
        .search-results.show {
            display: block;
        }
        .search-result-item {
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .search-result-item:hover {
            background: rgba(139, 92, 246, 0.2);
        }

        /* Audio Player */
        .audio-player {
            width: 100%;
            margin-top: 10px;
        }
        .audio-player audio {
            width: 100%;
            border-radius: 20px;
        }

        /* Status Creation */
        .status-creation-modal {
            max-width: 500px;
            width: 90%;
        }
        .status-type-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .status-type-btn {
            flex: 1;
            padding: 10px;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
        }
        .status-type-btn.active {
            background: var(--accent-color);
            color: white;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-container {
            background: rgba(30, 30, 60, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        body {
            background: var(--primary-bg);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .text-theme-primary {
            color: var(--text-primary);
        }
        .text-theme-secondary {
            color: var(--text-secondary);
        }
        .bg-theme-accent {
            background-color: var(--accent-color);
        }
        .border-theme-accent {
            border-color: var(--accent-color);
        }
        .hover\:text-theme-accent:hover {
            color: var(--accent-color);
        }
        .hover\:bg-theme-accent:hover {
            background-color: var(--accent-hover);
        }
        
        /* Upload Progress */
        .upload-progress {
            width: 100%;
            height: 6px;
            background: var(--glass-bg);
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
        }
        .upload-progress-bar {
            height: 100%;
            background: var(--accent-color);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Notification System */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 20px;
            border-radius: 12px;
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }
        .notification.success {
            background: rgba(16, 185, 129, 0.9);
            color: white;
        }
        .notification.error {
            background: rgba(239, 68, 68, 0.9);
            color: white;
        }
        .notification.info {
            background: rgba(59, 130, 246, 0.9);
            color: white;
        }
        .notification.warning {
            background: rgba(245, 158, 11, 0.9);
            color: white;
        }

        /* Emotion Selector */
        .emotion-selector {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .emotion-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
        }
        .emotion-btn:hover {
            transform: scale(1.1);
        }
        .emotion-btn.active {
            border-color: var(--accent-color);
            box-shadow: 0 0 10px var(--accent-color);
        }

        /* Leaderboard Styles */
        .leaderboard-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 8px;
            background: var(--glass-bg);
        }
        .leaderboard-rank {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            background: var(--accent-color);
            color: white;
        }
        .leaderboard-top-3 {
            background: linear-gradient(135deg, #FFD700, #FFA500);
        }
    </style>
</head>
<body class="h-full dark-theme emotion-default" id="emotionBody">
    <!-- Connection Status -->
    <div class="connection-status connecting" id="connectionStatus">
        <i class="fas fa-circle-notch fa-spin mr-2"></i>
        <span id="connectionText">Connecting to Firebase...</span>
    </div>

    <!-- Gamification Header -->
    <div class="glass border-b border-purple-800 p-3">
        <div class="flex items-center justify-between max-w-6xl mx-auto">
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2">
                    <div class="streak-fire text-yellow-400">
                        <i class="fas fa-fire"></i>
                    </div>
                    <span class="text-sm font-bold" id="streakCount">0</span>
                    <span class="text-xs text-theme-secondary">day streak</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="unicoin-glow text-yellow-300">
                        <i class="fas fa-coins"></i>
                    </div>
                    <span class="text-sm font-bold" id="unicoinsCount">0</span>
                    <span class="text-xs text-theme-secondary">ConnectCoins</span>
                </div>
                <div class="level-badge bg-theme-accent px-3 py-1 rounded-full text-xs">
                    Level <span id="userLevel">1</span>
                </div>
            </div>
            
            <div class="flex items-center space-x-3">
                <button id="viewLeaderboard" class="text-theme-secondary hover:text-theme-accent text-sm">
                    <i class="fas fa-trophy"></i> Leaderboard
                </button>
                <button id="viewChallenges" class="text-theme-secondary hover:text-theme-accent text-sm">
                    <i class="fas fa-flag"></i> Challenges
                </button>
            </div>
        </div>
    </div>

    <!-- Theme Selector -->
    <div class="theme-selector">
        <button id="themeToggle" class="w-12 h-12 glass rounded-2xl flex items-center justify-center text-theme-secondary hover:text-theme-accent hover:scale-110 transition">
            <i class="fas fa-palette"></i>
        </button>
        <div class="theme-options">
            <div class="theme-option theme-dark active" data-theme="dark-theme"></div>
            <div class="theme-option theme-light" data-theme="light-theme"></div>
            <div class="theme-option theme-cyber" data-theme="cyber-theme"></div>
        </div>
    </div>

    <div class="flex h-full" style="height: calc(100vh - 80px);">
        <!-- Navigation -->
        <div class="w-20 lg:w-64 glass border-r border-purple-800 flex flex-col">
            <div class="p-4">
                <a href="#" class="flex items-center space-x-3">
                    <div class="w-10 h-10 cyber-gradient rounded-2xl flex items-center justify-center">
                        <i class="fas fa-brain text-white"></i>
                    </div>
                    <span class="hidden lg:block text-xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-400">
                        ConnectSphere
                    </span>
                </a>
            </div>

            <nav class="flex-1 px-2 lg:px-4 space-y-2">
                <a href="home.html" class="flex items-center space-x-3 p-3 rounded-xl bg-cyan-900/30 text-cyan-400 border border-cyan-500/50">
                    <i class="fas fa-home w-6"></i>
                    <span class="hidden lg:block font-semibold">Social Feed</span>
                </a>
                <a href="chat.html" class="flex items-center space-x-3 p-3 rounded-xl text-theme-secondary hover:bg-purple-900/30 hover:text-theme-accent transition">
                    <i class="fas fa-comment-dots w-6"></i>
                    <span class="hidden lg:block">Quantum Chat</span>
                </a>
                <a href="profile.html" class="flex items-center space-x-3 p-3 rounded-xl text-theme-secondary hover:bg-purple-900/30 hover:text-theme-accent transition">
                    <i class="fas fa-user-astronaut w-6"></i>
                    <span class="hidden lg:block">Profile</span>
                </a>
                <a href="marketplace.html" class="flex items-center space-x-3 p-3 rounded-xl text-theme-secondary hover:bg-purple-900/30 hover:text-theme-accent transition">
                    <i class="fas fa-store w-6"></i>
                    <span class="hidden lg:block">Marketplace</span>
                </a>
            </nav>

            <!-- User Status -->
            <div class="p-4 border-t border-purple-800">
                <div id="userStatusContainer" class="flex items-center space-x-3 p-3 glass rounded-xl cursor-pointer hover:bg-cyan-900/30 transition">
                    <div class="relative">
                        <img id="userAvatar" class="w-8 h-8 rounded-2xl object-cover" src="" alt="User Avatar">
                        <div id="statusIndicator" class="status-indicator status-online absolute -bottom-1 -right-1 border-2 border-gray-900"></div>
                    </div>
                    <div class="hidden lg:block">
                        <p id="userDisplayName" class="text-sm font-semibold text-theme-accent">Loading...</p>
                        <p id="statusText" class="text-xs text-theme-secondary">Online</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Header -->
            <header class="glass border-b border-purple-800 px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex-1 max-w-2xl relative">
                        <div class="relative">
                            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-theme-secondary"></i>
                            <input type="text" id="searchInput" placeholder="Search posts, people, or topics..." 
                                   class="w-full pl-10 pr-4 py-3 glass border border-purple-700 rounded-2xl focus:outline-none focus:ring-2 focus:ring-theme-accent focus:border-transparent placeholder-theme-secondary">
                        </div>
                        <div id="searchResults" class="search-results">
                            <!-- Search results will appear here -->
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button id="createPostBtn" class="w-10 h-10 glass rounded-2xl flex items-center justify-center text-theme-secondary hover:text-theme-accent hover:scale-110 transition">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
            </header>

            <!-- Stories -->
            <div class="glass border-b border-purple-800 p-4">
                <div class="flex space-x-6 overflow-x-auto scrollbar-hide pb-2" id="storiesContainer">
                    <!-- User Story -->
                    <div class="flex flex-col items-center space-y-2 flex-shrink-0">
                        <div class="w-20 h-20 hologram-border rounded-2xl p-0.5 cursor-pointer" id="createStoryBtn">
                            <div class="w-full h-full bg-gray-900 rounded-2xl flex items-center justify-center">
                                <i class="fas fa-plus text-theme-accent"></i>
                            </div>
                        </div>
                        <span class="text-xs font-semibold text-theme-accent">Your Story</span>
                    </div>
                    <!-- Stories will be loaded dynamically -->
                </div>
            </div>

            <!-- Post Creator -->
            <div class="glass border-b border-purple-800 p-6 hidden" id="postCreator">
                <div class="flex space-x-4">
                    <img id="currentUserAvatar" class="w-12 h-12 rounded-2xl object-cover" src="" alt="Your Avatar">
                    <div class="flex-1">
                        <textarea id="postInput" placeholder="Share with your network..." 
                               class="w-full p-4 glass border border-purple-700 rounded-2xl focus:outline-none focus:ring-2 focus:ring-theme-accent focus:border-transparent placeholder-theme-secondary h-32 resize-none"></textarea>
                        
                        <!-- Emotion Selector -->
                        <div class="emotion-selector">
                            <div class="emotion-btn" data-emotion="joy" title="Joy">
                                <i class="fas fa-laugh"></i>
                            </div>
                            <div class="emotion-btn" data-emotion="love" title="Love">
                                <i class="fas fa-heart"></i>
                            </div>
                            <div class="emotion-btn" data-emotion="calm" title="Calm">
                                <i class="fas fa-spa"></i>
                            </div>
                            <div class="emotion-btn" data-emotion="excited" title="Excited">
                                <i class="fas fa-star"></i>
                            </div>
                            <div class="emotion-btn" data-emotion="sad" title="Sad">
                                <i class="fas fa-sad-tear"></i>
                            </div>
                            <div class="emotion-btn" data-emotion="angry" title="Angry">
                                <i class="fas fa-angry"></i>
                            </div>
                        </div>
                        
                        <!-- Media Preview -->
                        <div id="mediaPreview" class="mt-3 hidden">
                            <img id="previewImage" class="media-preview w-full hidden">
                            <video id="previewVideo" class="media-preview w-full hidden" controls></video>
                            <audio id="previewAudio" class="audio-player hidden" controls></audio>
                        </div>
                        
                        <div class="flex items-center justify-between mt-4">
                            <div class="flex space-x-4 text-theme-secondary">
                                <button id="addPhoto" class="flex items-center space-x-2 hover:text-theme-accent transition">
                                    <i class="fas fa-image"></i>
                                    <span>Photo</span>
                                </button>
                                <button id="addVideo" class="flex items-center space-x-2 hover:text-theme-accent transition">
                                    <i class="fas fa-video"></i>
                                    <span>Video</span>
                                </button>
                                <button id="addAudio" class="flex items-center space-x-2 hover:text-theme-accent transition">
                                    <i class="fas fa-music"></i>
                                    <span>Audio</span>
                                </button>
                                <button id="addEmoji" class="flex items-center space-x-2 hover:text-theme-accent transition">
                                    <i class="fas fa-smile"></i>
                                    <span>Emoji</span>
                                </button>
                            </div>
                            <button id="sharePost" class="cyber-gradient text-white px-6 py-2 rounded-2xl font-semibold hover:scale-105 transition">
                                Share Post
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Feed -->
            <main class="flex-1 overflow-y-auto bg-gradient-to-b from-purple-900/20 to-gray-900/50">
                <div class="max-w-2xl mx-auto p-4 space-y-6">
                    <!-- Trending Section -->
                    <div class="glass border border-purple-700 rounded-2xl p-4">
                        <h3 class="font-bold text-theme-accent mb-4 flex items-center">
                            <i class="fas fa-fire mr-2"></i> Trending Now
                        </h3>
                        <div id="trendingContainer" class="space-y-2">
                            <!-- Trending posts will be loaded here -->
                        </div>
                    </div>

                    <!-- Main Feed -->
                    <div id="feedContainer">
                        <!-- Posts will be loaded dynamically from Firebase -->
                    </div>
                </div>
            </main>
        </div>

        <!-- Right Sidebar -->
        <div class="hidden lg:block w-80 glass border-l border-purple-800">
            <div class="p-6">
                <!-- User Profile Card -->
                <div class="glass border border-purple-700 rounded-2xl p-4 mb-6">
                    <div class="flex items-center space-x-3 mb-4">
                        <img id="sidebarUserAvatar" class="w-12 h-12 rounded-2xl object-cover" src="" alt="User Avatar">
                        <div>
                            <h3 id="sidebarUserName" class="font-bold text-theme-accent">Loading...</h3>
                            <p id="sidebarUserStatus" class="text-xs text-theme-secondary">Online</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-2 text-center">
                        <div>
                            <p class="font-bold text-theme-accent" id="postCount">0</p>
                            <p class="text-xs text-theme-secondary">Posts</p>
                        </div>
                        <div>
                            <p class="font-bold text-theme-accent" id="followerCount">0</p>
                            <p class="text-xs text-theme-secondary">Followers</p>
                        </div>
                        <div>
                            <p class="font-bold text-theme-accent" id="followingCount">0</p>
                            <p class="text-xs text-theme-secondary">Following</p>
                        </div>
                    </div>
                </div>

                <!-- Trending Topics -->
                <div class="glass border border-purple-700 rounded-2xl p-4 mb-6">
                    <h3 class="font-bold text-theme-accent mb-4">Trending Topics</h3>
                    <div id="trendingTopicsContainer" class="space-y-3">
                        <!-- Trending topics will be loaded dynamically -->
                    </div>
                </div>

                <!-- Suggested Connections -->
                <div class="glass border border-purple-700 rounded-2xl p-4">
                    <h3 class="font-bold text-theme-accent mb-4">Suggested Connections</h3>
                    <div id="suggestedUsersContainer" class="space-y-4">
                        <!-- Suggested users will be loaded dynamically -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Post Modal -->
    <div id="createPostModal" class="modal hidden">
        <div class="modal-container">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-theme-accent">Create Post</h2>
                <button id="closePostModal" class="text-theme-secondary hover:text-theme-accent transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <textarea id="modalPostInput" placeholder="What's on your mind?" 
                          class="w-full p-4 glass border border-purple-700 rounded-2xl focus:outline-none focus:ring-2 focus:ring-theme-accent focus:border-transparent placeholder-theme-secondary h-32 resize-none"></textarea>
                
                <!-- Emotion Selector -->
                <div class="emotion-selector">
                    <div class="emotion-btn" data-emotion="joy" title="Joy">
                        <i class="fas fa-laugh"></i>
                    </div>
                    <div class="emotion-btn" data-emotion="love" title="Love">
                        <i class="fas fa-heart"></i>
                    </div>
                    <div class="emotion-btn" data-emotion="calm" title="Calm">
                        <i class="fas fa-spa"></i>
                    </div>
                    <div class="emotion-btn" data-emotion="excited" title="Excited">
                        <i class="fas fa-star"></i>
                    </div>
                    <div class="emotion-btn" data-emotion="sad" title="Sad">
                        <i class="fas fa-sad-tear"></i>
                    </div>
                    <div class="emotion-btn" data-emotion="angry" title="Angry">
                        <i class="fas fa-angry"></i>
                    </div>
                </div>
                
                <div id="modalMediaPreview" class="hidden">
                    <img id="modalPreviewImage" class="media-preview w-full hidden">
                    <video id="modalPreviewVideo" class="media-preview w-full hidden" controls></video>
                    <audio id="modalPreviewAudio" class="audio-player hidden" controls></audio>
                    <div class="upload-progress hidden" id="uploadProgress">
                        <div class="upload-progress-bar" id="uploadProgressBar"></div>
                    </div>
                </div>
                
                <div class="flex space-x-4 text-theme-secondary justify-center">
                    <button id="modalAddPhoto" class="flex items-center space-x-2 hover:text-theme-accent transition">
                        <i class="fas fa-image"></i>
                        <span>Photo</span>
                    </button>
                    <button id="modalAddVideo" class="flex items-center space-x-2 hover:text-theme-accent transition">
                        <i class="fas fa-video"></i>
                        <span>Video</span>
                    </button>
                    <button id="modalAddAudio" class="flex items-center space-x-2 hover:text-theme-accent transition">
                        <i class="fas fa-music"></i>
                        <span>Audio</span>
                    </button>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4">
                    <button id="cancelPost" class="px-4 py-2 glass border border-purple-700 rounded-2xl text-theme-secondary hover:text-theme-accent transition">
                        Cancel
                    </button>
                    <button id="publishPost" class="cyber-gradient text-white px-6 py-2 rounded-2xl font-semibold hover:scale-105 transition">
                        Publish
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaderboard Modal -->
    <div id="leaderboardModal" class="modal hidden">
        <div class="modal-container">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-theme-accent">Leaderboard</h2>
                <button id="closeLeaderboard" class="text-theme-secondary hover:text-theme-accent transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div id="leaderboardContainer">
                <!-- Leaderboard items will be loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- Challenges Modal -->
    <div id="challengesModal" class="modal hidden">
        <div class="modal-container">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-theme-accent">Daily Challenges</h2>
                <button id="closeChallenges" class="text-theme-secondary hover:text-theme-accent transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div id="challengesContainer">
                <!-- Challenges will be loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- Status Creation Modal -->
    <div id="statusModal" class="modal hidden">
        <div class="modal-container status-creation-modal">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-theme-accent">Create Status</h2>
                <button id="closeStatusModal" class="text-theme-secondary hover:text-theme-accent transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="status-type-selector">
                <div class="status-type-btn active" data-type="text">
                    <i class="fas fa-font"></i>
                    <span>Text</span>
                </div>
                <div class="status-type-btn" data-type="image">
                    <i class="fas fa-image"></i>
                    <span>Image</span>
                </div>
                <div class="status-type-btn" data-type="video">
                    <i class="fas fa-video"></i>
                    <span>Video</span>
                </div>
            </div>
            
            <div id="statusContent">
                <textarea id="statusTextInput" placeholder="What's happening?" 
                          class="w-full p-4 glass border border-purple-700 rounded-2xl focus:outline-none focus:ring-2 focus:ring-theme-accent focus:border-transparent placeholder-theme-secondary h-32 resize-none"></textarea>
            </div>
            
            <div class="flex justify-end space-x-3 pt-4">
                <button id="cancelStatus" class="px-4 py-2 glass border border-purple-700 rounded-2xl text-theme-secondary hover:text-theme-accent transition">
                    Cancel
                </button>
                <button id="publishStatus" class="cyber-gradient text-white px-6 py-2 rounded-2xl font-semibold hover:scale-105 transition">
                    Publish Status
                </button>
            </div>
        </div>
    </div>

    <!-- File Inputs (Hidden) -->
    <input type="file" id="photoInput" accept="image/*" class="hidden">
    <input type="file" id="videoInput" accept="video/*" class="hidden">
    <input type="file" id="audioInput" accept="audio/*" class="hidden">
    <input type="file" id="modalPhotoInput" accept="image/*" class="hidden">
    <input type="file" id="modalVideoInput" accept="video/*" class="hidden">
    <input type="file" id="modalAudioInput" accept="audio/*" class="hidden">

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // Global Variables
        let currentUser = null;
        let posts = [];
        let users = [];
        let stories = [];
        let trendingTopics = [];
        let currentEmotion = null;
        let currentMediaFile = null;
        let currentMediaType = null;

        // DOM Elements
        const connectionStatus = document.getElementById('connectionStatus');
        const connectionText = document.getElementById('connectionText');
        const feedContainer = document.getElementById('feedContainer');
        const storiesContainer = document.getElementById('storiesContainer');
        const trendingContainer = document.getElementById('trendingContainer');
        const trendingTopicsContainer = document.getElementById('trendingTopicsContainer');
        const suggestedUsersContainer = document.getElementById('suggestedUsersContainer');
        const leaderboardContainer = document.getElementById('leaderboardContainer');
        const challengesContainer = document.getElementById('challengesContainer');
        const userAvatar = document.getElementById('userAvatar');
        const userDisplayName = document.getElementById('userDisplayName');
        const statusText = document.getElementById('statusText');
        const statusIndicator = document.getElementById('statusIndicator');
        const sidebarUserAvatar = document.getElementById('sidebarUserAvatar');
        const sidebarUserName = document.getElementById('sidebarUserName');
        const sidebarUserStatus = document.getElementById('sidebarUserStatus');
        const postCount = document.getElementById('postCount');
        const followerCount = document.getElementById('followerCount');
        const followingCount = document.getElementById('followingCount');
        const streakCount = document.getElementById('streakCount');
        const unicoinsCount = document.getElementById('unicoinsCount');
        const userLevel = document.getElementById('userLevel');
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');
        const createPostBtn = document.getElementById('createPostBtn');
        const createPostModal = document.getElementById('createPostModal');
        const closePostModal = document.getElementById('closePostModal');
        const publishPost = document.getElementById('publishPost');
        const cancelPost = document.getElementById('cancelPost');
        const modalPostInput = document.getElementById('modalPostInput');
        const modalMediaPreview = document.getElementById('modalMediaPreview');
        const modalPreviewImage = document.getElementById('modalPreviewImage');
        const modalPreviewVideo = document.getElementById('modalPreviewVideo');
        const modalPreviewAudio = document.getElementById('modalPreviewAudio');
        const uploadProgress = document.getElementById('uploadProgress');
        const uploadProgressBar = document.getElementById('uploadProgressBar');
        const modalAddPhoto = document.getElementById('modalAddPhoto');
        const modalAddVideo = document.getElementById('modalAddVideo');
        const modalAddAudio = document.getElementById('modalAddAudio');
        const modalPhotoInput = document.getElementById('modalPhotoInput');
        const modalVideoInput = document.getElementById('modalVideoInput');
        const modalAudioInput = document.getElementById('modalAudioInput');
        const viewLeaderboard = document.getElementById('viewLeaderboard');
        const leaderboardModal = document.getElementById('leaderboardModal');
        const closeLeaderboard = document.getElementById('closeLeaderboard');
        const viewChallenges = document.getElementById('viewChallenges');
        const challengesModal = document.getElementById('challengesModal');
        const closeChallenges = document.getElementById('closeChallenges');
        const createStoryBtn = document.getElementById('createStoryBtn');
        const statusModal = document.getElementById('statusModal');
        const closeStatusModal = document.getElementById('closeStatusModal');
        const cancelStatus = document.getElementById('cancelStatus');
        const publishStatus = document.getElementById('publishStatus');
        const statusTextInput = document.getElementById('statusTextInput');
        const themeToggle = document.getElementById('themeToggle');
        const themeOptions = document.querySelector('.theme-options');
        const emotionBtns = document.querySelectorAll('.emotion-btn');
        const emotionBody = document.getElementById('emotionBody');

        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            initializeFirebase();
            setupEventListeners();
            loadInitialData();
        });

        // Firebase Initialization
        function initializeFirebase() {
            // Monitor connection status
            firebase.database().ref('.info/connected').on('value', function(snapshot) {
                if (snapshot.val() === true) {
                    updateConnectionStatus('connected', 'Connected to Firebase');
                } else {
                    updateConnectionStatus('disconnected', 'Disconnected from Firebase');
                }
            });

            // Listen for auth state changes
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    loadUserData(user.uid);
                    loadPosts();
                    loadStories();
                    loadTrendingTopics();
                    loadSuggestedUsers();
                    loadLeaderboard();
                    loadChallenges();
                } else {
                    // Redirect to login if not authenticated
                    window.location.href = 'login.html';
                }
            });
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Theme toggle
            themeToggle.addEventListener('click', () => {
                themeOptions.classList.toggle('show');
            });

            // Theme selection
            document.querySelectorAll('.theme-option').forEach(option => {
                option.addEventListener('click', function() {
                    const theme = this.getAttribute('data-theme');
                    document.body.className = theme;
                    document.querySelectorAll('.theme-option').forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');
                    themeOptions.classList.remove('show');
                    
                    // Save theme preference
                    if (currentUser) {
                        db.collection('users').doc(currentUser.uid).update({
                            theme: theme
                        });
                    }
                });
            });

            // Emotion selection
            emotionBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const emotion = this.getAttribute('data-emotion');
                    emotionBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentEmotion = emotion;
                    emotionBody.className = document.body.className + ' emotion-' + emotion;
                });
            });

            // Search functionality
            searchInput.addEventListener('input', debounce(handleSearch, 300));

            // Create post button
            createPostBtn.addEventListener('click', () => {
                createPostModal.classList.remove('hidden');
            });

            // Close post modal
            closePostModal.addEventListener('click', () => {
                createPostModal.classList.add('hidden');
                resetPostForm();
            });

            // Cancel post
            cancelPost.addEventListener('click', () => {
                createPostModal.classList.add('hidden');
                resetPostForm();
            });

            // Publish post
            publishPost.addEventListener('click', publishNewPost);

            // Media upload buttons
            modalAddPhoto.addEventListener('click', () => modalPhotoInput.click());
            modalAddVideo.addEventListener('click', () => modalVideoInput.click());
            modalAddAudio.addEventListener('click', () => modalAudioInput.click());

            // File input changes
            modalPhotoInput.addEventListener('change', (e) => handleMediaUpload(e, 'image'));
            modalVideoInput.addEventListener('change', (e) => handleMediaUpload(e, 'video'));
            modalAudioInput.addEventListener('change', (e) => handleMediaUpload(e, 'audio'));

            // Leaderboard
            viewLeaderboard.addEventListener('click', () => {
                leaderboardModal.classList.remove('hidden');
            });

            closeLeaderboard.addEventListener('click', () => {
                leaderboardModal.classList.add('hidden');
            });

            // Challenges
            viewChallenges.addEventListener('click', () => {
                challengesModal.classList.remove('hidden');
            });

            closeChallenges.addEventListener('click', () => {
                challengesModal.classList.add('hidden');
            });

            // Create story
            createStoryBtn.addEventListener('click', () => {
                statusModal.classList.remove('hidden');
            });

            // Status modal
            closeStatusModal.addEventListener('click', () => {
                statusModal.classList.add('hidden');
            });

            cancelStatus.addEventListener('click', () => {
                statusModal.classList.add('hidden');
            });

            publishStatus.addEventListener('click', publishNewStatus);

            // Status type selection
            document.querySelectorAll('.status-type-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.status-type-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    // Handle status type change (implementation needed)
                });
            });

            // Click outside modals to close
            window.addEventListener('click', (e) => {
                if (e.target === createPostModal) {
                    createPostModal.classList.add('hidden');
                    resetPostForm();
                }
                if (e.target === leaderboardModal) {
                    leaderboardModal.classList.add('hidden');
                }
                if (e.target === challengesModal) {
                    challengesModal.classList.add('hidden');
                }
                if (e.target === statusModal) {
                    statusModal.classList.add('hidden');
                }
                if (!themeToggle.contains(e.target) && !themeOptions.contains(e.target)) {
                    themeOptions.classList.remove('show');
                }
            });
        }

        // Load Initial Data
        function loadInitialData() {
            // User data will be loaded in auth state change handler
            // Other data will be loaded after user authentication
        }

        // Load User Data
        function loadUserData(userId) {
            db.collection('users').doc(userId).onSnapshot((doc) => {
                if (doc.exists) {
                    const userData = doc.data();
                    updateUserUI(userData);
                } else {
                    // Create user document if it doesn't exist
                    createUserDocument(userId);
                }
            });
        }

        // Create User Document
        function createUserDocument(userId) {
            const userData = {
                displayName: currentUser.displayName || 'User',
                email: currentUser.email,
                avatar: currentUser.photoURL || 'https://via.placeholder.com/150',
                status: 'Online',
                streak: 0,
                unicoins: 0,
                level: 1,
                posts: 0,
                followers: 0,
                following: 0,
                theme: 'dark-theme',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            db.collection('users').doc(userId).set(userData)
                .then(() => {
                    console.log('User document created');
                })
                .catch((error) => {
                    console.error('Error creating user document:', error);
                });
        }

        // Update User UI
        function updateUserUI(userData) {
            // Update user avatar
            if (userData.avatar) {
                userAvatar.src = userData.avatar;
                sidebarUserAvatar.src = userData.avatar;
                document.getElementById('currentUserAvatar').src = userData.avatar;
            }

            // Update display name
            if (userData.displayName) {
                userDisplayName.textContent = userData.displayName;
                sidebarUserName.textContent = userData.displayName;
            }

            // Update status
            if (userData.status) {
                statusText.textContent = userData.status;
                sidebarUserStatus.textContent = userData.status;
                
                // Update status indicator
                statusIndicator.className = 'status-indicator status-' + userData.status.toLowerCase();
            }

            // Update stats
            if (userData.posts !== undefined) postCount.textContent = userData.posts;
            if (userData.followers !== undefined) followerCount.textContent = userData.followers;
            if (userData.following !== undefined) followingCount.textContent = userData.following;
            if (userData.streak !== undefined) streakCount.textContent = userData.streak;
            if (userData.unicoins !== undefined) unicoinsCount.textContent = userData.unicoins;
            if (userData.level !== undefined) userLevel.textContent = userData.level;

            // Apply theme
            if (userData.theme) {
                document.body.className = userData.theme;
                document.querySelectorAll('.theme-option').forEach(opt => {
                    opt.classList.remove('active');
                    if (opt.getAttribute('data-theme') === userData.theme) {
                        opt.classList.add('active');
                    }
                });
            }
        }

        // Load Posts
        function loadPosts() {
            db.collection('posts')
                .orderBy('timestamp', 'desc')
                .limit(20)
                .onSnapshot((snapshot) => {
                    posts = [];
                    feedContainer.innerHTML = '';
                    
                    snapshot.forEach((doc) => {
                        const post = {
                            id: doc.id,
                            ...doc.data()
                        };
                        posts.push(post);
                        renderPost(post);
                    });
                    
                    if (posts.length === 0) {
                        feedContainer.innerHTML = `
                            <div class="glass border border-purple-700 rounded-2xl p-6 text-center">
                                <i class="fas fa-newspaper text-4xl text-theme-secondary mb-4"></i>
                                <h3 class="text-lg font-bold text-theme-accent mb-2">No posts yet</h3>
                                <p class="text-theme-secondary">Be the first to share something with your network!</p>
                            </div>
                        `;
                    }
                }, (error) => {
                    console.error('Error loading posts:', error);
                    showNotification('Error loading posts', 'error');
                });
        }

        // Render Post
        function renderPost(post) {
            const postElement = document.createElement('div');
            postElement.className = 'glass border border-purple-700 rounded-2xl p-4 mb-4';
            postElement.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-3">
                        <img src="${post.userAvatar || 'https://via.placeholder.com/40'}" alt="${post.userName}" class="w-10 h-10 rounded-2xl object-cover">
                        <div>
                            <h4 class="font-bold text-theme-accent">${post.userName || 'User'}</h4>
                            <p class="text-xs text-theme-secondary">${formatTimestamp(post.timestamp)}</p>
                        </div>
                    </div>
                    <button class="text-theme-secondary hover:text-theme-accent transition">
                        <i class="fas fa-ellipsis-h"></i>
                    </button>
                </div>
                
                <div class="mb-4">
                    <p class="text-theme-primary">${post.content || ''}</p>
                    ${post.media ? `
                        ${post.mediaType === 'image' ? `<img src="${post.media}" class="media-preview mt-3">` : ''}
                        ${post.mediaType === 'video' ? `<video src="${post.media}" class="media-preview mt-3" controls></video>` : ''}
                        ${post.mediaType === 'audio' ? `<audio src="${post.media}" class="audio-player mt-3" controls></audio>` : ''}
                    ` : ''}
                </div>
                
                ${post.emotion ? `<div class="mb-4"><span class="emotion-reaction"><i class="fas fa-${getEmotionIcon(post.emotion)} mr-1"></i> Feeling ${post.emotion}</span></div>` : ''}
                
                <div class="flex items-center justify-between text-theme-secondary">
                    <div class="flex space-x-4">
                        <button class="interaction-btn flex items-center space-x-1 ${post.userLiked ? 'active' : ''}" data-post-id="${post.id}" data-action="like">
                            <i class="fas fa-heart"></i>
                            <span>${post.likes || 0}</span>
                        </button>
                        <button class="interaction-btn flex items-center space-x-1" data-post-id="${post.id}" data-action="comment">
                            <i class="fas fa-comment"></i>
                            <span>${post.comments || 0}</span>
                        </button>
                        <button class="interaction-btn flex items-center space-x-1" data-post-id="${post.id}" data-action="share">
                            <i class="fas fa-share"></i>
                            <span>${post.shares || 0}</span>
                        </button>
                    </div>
                    <button class="interaction-btn" data-post-id="${post.id}" data-action="save">
                        <i class="fas fa-bookmark"></i>
                    </button>
                </div>
            `;
            
            feedContainer.appendChild(postElement);
            
            // Add event listeners for interaction buttons
            const likeBtn = postElement.querySelector('[data-action="like"]');
            likeBtn.addEventListener('click', () => handlePostInteraction(post.id, 'like'));
            
            const commentBtn = postElement.querySelector('[data-action="comment"]');
            commentBtn.addEventListener('click', () => handlePostInteraction(post.id, 'comment'));
            
            const shareBtn = postElement.querySelector('[data-action="share"]');
            shareBtn.addEventListener('click', () => handlePostInteraction(post.id, 'share'));
            
            const saveBtn = postElement.querySelector('[data-action="save"]');
            saveBtn.addEventListener('click', () => handlePostInteraction(post.id, 'save'));
        }

        // Load Stories
        function loadStories() {
            db.collection('stories')
                .orderBy('timestamp', 'desc')
                .limit(10)
                .onSnapshot((snapshot) => {
                    stories = [];
                    // Clear existing stories except the "Your Story" item
                    const storyItems = storiesContainer.querySelectorAll('.flex-shrink-0');
                    for (let i = 1; i < storyItems.length; i++) {
                        storyItems[i].remove();
                    }
                    
                    snapshot.forEach((doc) => {
                        const story = {
                            id: doc.id,
                            ...doc.data()
                        };
                        stories.push(story);
                        renderStory(story);
                    });
                }, (error) => {
                    console.error('Error loading stories:', error);
                });
        }

        // Render Story
        function renderStory(story) {
            const storyElement = document.createElement('div');
            storyElement.className = 'flex flex-col items-center space-y-2 flex-shrink-0';
            storyElement.innerHTML = `
                <div class="w-20 h-20 hologram-border rounded-2xl p-0.5 cursor-pointer">
                    <img src="${story.userAvatar || 'https://via.placeholder.com/80'}" alt="${story.userName}" class="w-full h-full rounded-2xl object-cover">
                </div>
                <span class="text-xs font-semibold">${story.userName || 'User'}</span>
            `;
            
            storiesContainer.appendChild(storyElement);
        }

        // Load Trending Topics
        function loadTrendingTopics() {
            db.collection('trending')
                .orderBy('count', 'desc')
                .limit(5)
                .onSnapshot((snapshot) => {
                    trendingTopics = [];
                    trendingTopicsContainer.innerHTML = '';
                    
                    snapshot.forEach((doc) => {
                        const topic = {
                            id: doc.id,
                            ...doc.data()
                        };
                        trendingTopics.push(topic);
                        renderTrendingTopic(topic);
                    });
                    
                    if (trendingTopics.length === 0) {
                        trendingTopicsContainer.innerHTML = '<p class="text-theme-secondary text-center">No trending topics</p>';
                    }
                }, (error) => {
                    console.error('Error loading trending topics:', error);
                });
        }

        // Render Trending Topic
        function renderTrendingTopic(topic) {
            const topicElement = document.createElement('div');
            topicElement.className = 'flex justify-between items-center';
            topicElement.innerHTML = `
                <div>
                    <p class="font-semibold text-theme-primary">#${topic.name}</p>
                    <p class="text-xs text-theme-secondary">${topic.count || 0} posts</p>
                </div>
                <i class="fas fa-chevron-right text-theme-secondary"></i>
            `;
            
            trendingTopicsContainer.appendChild(topicElement);
        }

        // Load Suggested Users
        function loadSuggestedUsers() {
            db.collection('users')
                .where('followers', '<', 100) // Example condition for suggested users
                .limit(5)
                .onSnapshot((snapshot) => {
                    users = [];
                    suggestedUsersContainer.innerHTML = '';
                    
                    snapshot.forEach((doc) => {
                        // Don't suggest the current user
                        if (doc.id === currentUser.uid) return;
                        
                        const user = {
                            id: doc.id,
                            ...doc.data()
                        };
                        users.push(user);
                        renderSuggestedUser(user);
                    });
                    
                    if (users.length === 0) {
                        suggestedUsersContainer.innerHTML = '<p class="text-theme-secondary text-center">No suggestions</p>';
                    }
                }, (error) => {
                    console.error('Error loading suggested users:', error);
                });
        }

        // Render Suggested User
        function renderSuggestedUser(user) {
            const userElement = document.createElement('div');
            userElement.className = 'flex items-center justify-between';
            userElement.innerHTML = `
                <div class="flex items-center space-x-3">
                    <img src="${user.avatar || 'https://via.placeholder.com/40'}" alt="${user.displayName}" class="w-10 h-10 rounded-2xl object-cover">
                    <div>
                        <p class="font-semibold text-theme-primary">${user.displayName || 'User'}</p>
                        <p class="text-xs text-theme-secondary">${user.followers || 0} followers</p>
                    </div>
                </div>
                <button class="follow-btn" data-user-id="${user.id}">Follow</button>
            `;
            
            suggestedUsersContainer.appendChild(userElement);
            
            // Add follow button event listener
            const followBtn = userElement.querySelector('.follow-btn');
            followBtn.addEventListener('click', () => handleFollowUser(user.id, followBtn));
        }

        // Load Leaderboard
        function loadLeaderboard() {
            db.collection('users')
                .orderBy('unicoins', 'desc')
                .limit(10)
                .onSnapshot((snapshot) => {
                    leaderboardContainer.innerHTML = '';
                    let rank = 1;
                    
                    snapshot.forEach((doc) => {
                        const user = {
                            id: doc.id,
                            ...doc.data()
                        };
                        renderLeaderboardUser(user, rank);
                        rank++;
                    });
                    
                    if (rank === 1) {
                        leaderboardContainer.innerHTML = '<p class="text-theme-secondary text-center">No users yet</p>';
                    }
                }, (error) => {
                    console.error('Error loading leaderboard:', error);
                });
        }

        // Render Leaderboard User
        function renderLeaderboardUser(user, rank) {
            const userElement = document.createElement('div');
            userElement.className = 'leaderboard-item';
            userElement.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="leaderboard-rank ${rank <= 3 ? 'leaderboard-top-3' : ''}">${rank}</div>
                    <img src="${user.avatar || 'https://via.placeholder.com/40'}" alt="${user.displayName}" class="w-10 h-10 rounded-2xl object-cover">
                    <div>
                        <p class="font-semibold text-theme-primary">${user.displayName || 'User'}</p>
                        <p class="text-xs text-theme-secondary">Level ${user.level || 1}</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="font-bold text-theme-accent">${user.unicoins || 0}</p>
                    <p class="text-xs text-theme-secondary">ConnectCoins</p>
                </div>
            `;
            
            leaderboardContainer.appendChild(userElement);
        }

        // Load Challenges
        function loadChallenges() {
            // For now, we'll use static challenges, but in a real app these would come from Firestore
            const challenges = [
                { id: 1, title: 'Post your first status', reward: 10, completed: false },
                { id: 2, title: 'Like 5 posts', reward: 5, completed: false },
                { id: 3, title: 'Follow 3 users', reward: 8, completed: false },
                { id: 4, title: 'Share a post', reward: 15, completed: false },
                { id: 5, title: 'Complete your profile', reward: 20, completed: false }
            ];
            
            challengesContainer.innerHTML = '';
            
            challenges.forEach(challenge => {
                const challengeElement = document.createElement('div');
                challengeElement.className = 'flex justify-between items-center p-3 glass border border-purple-700 rounded-2xl mb-3';
                challengeElement.innerHTML = `
                    <div>
                        <p class="font-semibold text-theme-primary">${challenge.title}</p>
                        <p class="text-xs text-theme-secondary">Reward: ${challenge.reward} ConnectCoins</p>
                    </div>
                    <button class="follow-btn ${challenge.completed ? 'following' : ''}" data-challenge-id="${challenge.id}">
                        ${challenge.completed ? 'Completed' : 'Start'}
                    </button>
                `;
                
                challengesContainer.appendChild(challengeElement);
                
                // Add challenge button event listener
                const challengeBtn = challengeElement.querySelector('.follow-btn');
                challengeBtn.addEventListener('click', () => handleChallenge(challenge.id, challengeBtn));
            });
        }

        // Handle Post Interaction
        function handlePostInteraction(postId, action) {
            if (!currentUser) return;
            
            const postRef = db.collection('posts').doc(postId);
            
            switch(action) {
                case 'like':
                    // Toggle like
                    db.collection('postLikes').doc(`${postId}_${currentUser.uid}`).get()
                        .then((doc) => {
                            if (doc.exists) {
                                // Unlike
                                db.collection('postLikes').doc(`${postId}_${currentUser.uid}`).delete();
                                postRef.update({
                                    likes: firebase.firestore.FieldValue.increment(-1)
                                });
                            } else {
                                // Like
                                db.collection('postLikes').doc(`${postId}_${currentUser.uid}`).set({
                                    userId: currentUser.uid,
                                    postId: postId,
                                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                                });
                                postRef.update({
                                    likes: firebase.firestore.FieldValue.increment(1)
                                });
                                
                                // Award coins for interaction
                                awardCoins(1, 'liked a post');
                            }
                        });
                    break;
                    
                case 'comment':
                    // Implementation for comment action
                    showNotification('Comment functionality coming soon', 'info');
                    break;
                    
                case 'share':
                    // Implementation for share action
                    showNotification('Share functionality coming soon', 'info');
                    break;
                    
                case 'save':
                    // Implementation for save action
                    showNotification('Save functionality coming soon', 'info');
                    break;
            }
        }

        // Handle Follow User
        function handleFollowUser(userId, button) {
            if (!currentUser) return;
            
            db.collection('follows').doc(`${currentUser.uid}_${userId}`).get()
                .then((doc) => {
                    if (doc.exists) {
                        // Unfollow
                        db.collection('follows').doc(`${currentUser.uid}_${userId}`).delete();
                        
                        // Update follower count for the user being unfollowed
                        db.collection('users').doc(userId).update({
                            followers: firebase.firestore.FieldValue.increment(-1)
                        });
                        
                        // Update following count for current user
                        db.collection('users').doc(currentUser.uid).update({
                            following: firebase.firestore.FieldValue.increment(-1)
                        });
                        
                        button.textContent = 'Follow';
                        button.classList.remove('following');
                    } else {
                        // Follow
                        db.collection('follows').doc(`${currentUser.uid}_${userId}`).set({
                            followerId: currentUser.uid,
                            followingId: userId,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        // Update follower count for the user being followed
                        db.collection('users').doc(userId).update({
                            followers: firebase.firestore.FieldValue.increment(1)
                        });
                        
                        // Update following count for current user
                        db.collection('users').doc(currentUser.uid).update({
                            following: firebase.firestore.FieldValue.increment(1)
                        });
                        
                        button.textContent = 'Following';
                        button.classList.add('following');
                        
                        // Award coins for following
                        awardCoins(5, 'followed a user');
                    }
                })
                .catch((error) => {
                    console.error('Error following user:', error);
                    showNotification('Error following user', 'error');
                });
        }

        // Handle Challenge
        function handleChallenge(challengeId, button) {
            // Implementation for handling challenges
            showNotification('Challenge functionality coming soon', 'info');
        }

        // Handle Media Upload
        function handleMediaUpload(event, type) {
            const file = event.target.files[0];
            if (!file) return;
            
            currentMediaFile = file;
            currentMediaType = type;
            
            // Show preview
            modalMediaPreview.classList.remove('hidden');
            
            if (type === 'image') {
                modalPreviewImage.classList.remove('hidden');
                modalPreviewVideo.classList.add('hidden');
                modalPreviewAudio.classList.add('hidden');
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    modalPreviewImage.src = e.target.result;
                };
                reader.readAsDataURL(file);
            } else if (type === 'video') {
                modalPreviewVideo.classList.remove('hidden');
                modalPreviewImage.classList.add('hidden');
                modalPreviewAudio.classList.add('hidden');
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    modalPreviewVideo.src = e.target.result;
                };
                reader.readAsDataURL(file);
            } else if (type === 'audio') {
                modalPreviewAudio.classList.remove('hidden');
                modalPreviewImage.classList.add('hidden');
                modalPreviewVideo.classList.add('hidden');
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    modalPreviewAudio.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        // Publish New Post
        function publishNewPost() {
            const content = modalPostInput.value.trim();
            if (!content && !currentMediaFile) {
                showNotification('Please add some content or media to your post', 'warning');
                return;
            }
            
            // Show upload progress if there's media
            if (currentMediaFile) {
                uploadProgress.classList.remove('hidden');
                uploadMediaAndPublishPost(content);
            } else {
                publishPostToFirestore(content);
            }
        }

        // Upload Media and Publish Post
        function uploadMediaAndPublishPost(content) {
            const file = currentMediaFile;
            const fileExtension = file.name.split('.').pop();
            const fileName = `posts/${currentUser.uid}/${Date.now()}.${fileExtension}`;
            const uploadTask = storage.ref(fileName).put(file);
            
            uploadTask.on('state_changed',
                (snapshot) => {
                    // Update progress bar
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    uploadProgressBar.style.width = progress + '%';
                },
                (error) => {
                    console.error('Error uploading media:', error);
                    showNotification('Error uploading media', 'error');
                    uploadProgress.classList.add('hidden');
                },
                () => {
                    // Upload completed successfully
                    uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                        publishPostToFirestore(content, downloadURL);
                        uploadProgress.classList.add('hidden');
                    });
                }
            );
        }

        // Publish Post to Firestore
        function publishPostToFirestore(content, mediaURL = null) {
            const postData = {
                userId: currentUser.uid,
                userName: currentUser.displayName || 'User',
                userAvatar: currentUser.photoURL || 'https://via.placeholder.com/150',
                content: content,
                media: mediaURL,
                mediaType: currentMediaType,
                emotion: currentEmotion,
                likes: 0,
                comments: 0,
                shares: 0,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            db.collection('posts').add(postData)
                .then(() => {
                    showNotification('Post published successfully!', 'success');
                    
                    // Update user's post count
                    db.collection('users').doc(currentUser.uid).update({
                        posts: firebase.firestore.FieldValue.increment(1)
                    });
                    
                    // Award coins for posting
                    awardCoins(10, 'published a post');
                    
                    // Reset form and close modal
                    resetPostForm();
                    createPostModal.classList.add('hidden');
                })
                .catch((error) => {
                    console.error('Error publishing post:', error);
                    showNotification('Error publishing post', 'error');
                });
        }

        // Publish New Status
        function publishNewStatus() {
            const content = statusTextInput.value.trim();
            if (!content) {
                showNotification('Please add some content to your status', 'warning');
                return;
            }
            
            const statusData = {
                userId: currentUser.uid,
                userName: currentUser.displayName || 'User',
                userAvatar: currentUser.photoURL || 'https://via.placeholder.com/150',
                content: content,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000) // 24 hours from now
            };
            
            db.collection('stories').add(statusData)
                .then(() => {
                    showNotification('Status published successfully!', 'success');
                    statusModal.classList.add('hidden');
                    statusTextInput.value = '';
                    
                    // Award coins for posting a status
                    awardCoins(5, 'published a status');
                })
                .catch((error) => {
                    console.error('Error publishing status:', error);
                    showNotification('Error publishing status', 'error');
                });
        }

        // Handle Search
        function handleSearch() {
            const query = searchInput.value.trim();
            if (query.length < 2) {
                searchResults.classList.remove('show');
                return;
            }
            
            // Search users
            db.collection('users')
                .where('displayName', '>=', query)
                .where('displayName', '<=', query + '\uf8ff')
                .limit(5)
                .get()
                .then((snapshot) => {
                    searchResults.innerHTML = '';
                    
                    if (snapshot.empty) {
                        searchResults.innerHTML = '<div class="search-result-item text-theme-secondary">No results found</div>';
                    } else {
                        snapshot.forEach((doc) => {
                            const user = doc.data();
                            const resultItem = document.createElement('div');
                            resultItem.className = 'search-result-item';
                            resultItem.innerHTML = `
                                <div class="flex items-center space-x-3">
                                    <img src="${user.avatar || 'https://via.placeholder.com/40'}" alt="${user.displayName}" class="w-8 h-8 rounded-2xl object-cover">
                                    <span>${user.displayName}</span>
                                </div>
                            `;
                            resultItem.addEventListener('click', () => {
                                // Navigate to user profile
                                window.location.href = `profile.html?userId=${doc.id}`;
                            });
                            searchResults.appendChild(resultItem);
                        });
                    }
                    
                    searchResults.classList.add('show');
                })
                .catch((error) => {
                    console.error('Error searching users:', error);
                });
        }

        // Award Coins
        function awardCoins(amount, reason) {
            if (!currentUser) return;
            
            db.collection('users').doc(currentUser.uid).update({
                unicoins: firebase.firestore.FieldValue.increment(amount)
            });
            
            // Log the transaction
            db.collection('coinTransactions').add({
                userId: currentUser.uid,
                amount: amount,
                reason: reason,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            showNotification(`+${amount} ConnectCoins earned!`, 'success');
        }

        // Reset Post Form
        function resetPostForm() {
            modalPostInput.value = '';
            modalMediaPreview.classList.add('hidden');
            modalPreviewImage.classList.add('hidden');
            modalPreviewVideo.classList.add('hidden');
            modalPreviewAudio.classList.add('hidden');
            currentMediaFile = null;
            currentMediaType = null;
            currentEmotion = null;
            
            // Reset emotion buttons
            emotionBtns.forEach(btn => btn.classList.remove('active'));
            emotionBody.className = document.body.className;
        }

        // Update Connection Status
        function updateConnectionStatus(status, message) {
            connectionStatus.className = `connection-status ${status}`;
            connectionText.textContent = message;
            
            if (status === 'connected') {
                setTimeout(() => {
                    connectionStatus.classList.add('hidden');
                }, 3000);
            }
        }

        // Show Notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${getNotificationIcon(type)}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            // Remove notification after 3 seconds
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Get Notification Icon
        function getNotificationIcon(type) {
            switch(type) {
                case 'success': return 'check-circle';
                case 'error': return 'exclamation-circle';
                case 'warning': return 'exclamation-triangle';
                default: return 'info-circle';
            }
        }

        // Get Emotion Icon
        function getEmotionIcon(emotion) {
            switch(emotion) {
                case 'joy': return 'laugh';
                case 'love': return 'heart';
                case 'calm': return 'spa';
                case 'excited': return 'star';
                case 'sad': return 'sad-tear';
                case 'angry': return 'angry';
                default: return 'smile';
            }
        }

        // Format Timestamp
        function formatTimestamp(timestamp) {
            if (!timestamp) return 'Just now';
            
            const date = timestamp.toDate();
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'Just now';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
            if (diffInSeconds < 604800) return `${Math.floor(diffInSeconds / 86400)}d ago`;
            
            return date.toLocaleDateString();
        }

        // Debounce Function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>
</body>
</html>