<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Kynecta - Enhanced Social Feed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    
    <!-- Cloudinary -->
    <script src="https://upload-widget.cloudinary.com/global/all.js"></script>
    
    <!-- Emoji Picker -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/emoji-picker-element@1.12.0/index.css" />
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@1.12.0/index.min.js"></script>
    
    <style>
        /* All existing CSS styles remain exactly the same */
        /* CSS Variables for Themes */
        :root {
            --primary-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-primary: #ffffff;
            --text-secondary: #cbd5e1;
            --accent-color: #22d3ee;
            --accent-hover: #06b6d4;
            --card-bg: rgba(30, 41, 59, 0.5);
            --card-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .light-theme {
            --primary-bg: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            --glass-bg: rgba(255, 255, 255, 0.8);
            --glass-border: rgba(209, 213, 219, 0.5);
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --accent-color: #3b82f6;
            --accent-hover: #2563eb;
            --card-bg: rgba(255, 255, 255, 0.9);
            --card-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .dark-theme {
            --primary-bg: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            --glass-bg: rgba(30, 41, 59, 0.5);
            --glass-border: rgba(100, 116, 139, 0.3);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent-color: #22d3ee;
            --accent-hover: #06b6d4;
            --card-bg: rgba(30, 41, 59, 0.5);
            --card-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .cyber-theme {
            --primary-bg: linear-gradient(135deg, #1e3a8a 0%, #7e22ce 100%);
            --glass-bg: rgba(30, 58, 138, 0.3);
            --glass-border: rgba(124, 58, 237, 0.5);
            --text-primary: #f0f9ff;
            --text-secondary: #bae6fd;
            --accent-color: #f59e0b;
            --accent-hover: #d97706;
            --card-bg: rgba(30, 58, 138, 0.3);
            --card-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
        }

        /* Enhanced UI Components */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
        }

        .post-card {
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .post-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
        }

        .masonry-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            align-items: start;
        }

        /* Floating Create Button */
        .floating-create-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--accent-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            z-index: 100;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .floating-create-btn:hover {
            transform: scale(1.1);
            background: var(--accent-hover);
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            z-index: 1000;
            transition: all 0.3s ease-in-out;
            display: flex;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .connection-status.connected {
            background: rgba(34, 197, 94, 0.9);
            color: white;
            border: 1px solid rgba(34, 197, 94, 0.6);
        }
        .connection-status.connecting {
            background: rgba(245, 158, 11, 0.9);
            color: white;
            border: 1px solid rgba(245, 158, 11, 0.6);
        }
        .connection-status.disconnected {
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: 1px solid rgba(239, 68, 68, 0.6);
        }
        .connection-status.hidden {
            opacity: 0;
            transform: translateY(-20px);
            pointer-events: none;
        }

        /* Scrollbar Styling */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: var(--accent-color);
            border-radius: 10px;
        }

        /* Loading Animation */
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid var(--accent-color);
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .modal.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .modal-container {
            background: rgba(30, 30, 60, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        
        .modal.active .modal-container {
            transform: scale(1);
        }

        .hidden {
            display: none !important;
        }

        /* Status Indicator */
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        .status-online {
            background-color: #10B981;
            box-shadow: 0 0 8px #10B981;
        }
        .status-away {
            background-color: #F59E0B;
            box-shadow: 0 0 8px #F59E0B;
        }
        .status-busy {
            background-color: #EF4444;
            box-shadow: 0 0 8px #EF4444;
        }
        .status-offline {
            background-color: #6B7280;
            box-shadow: 0 0 8px #6B7280;
        }

        /* Media Preview */
        .media-preview {
            max-height: 300px;
            object-fit: cover;
            border-radius: 12px;
            margin-top: 10px;
        }

        /* Kynecta Unique Features */
        .energy-ring {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: conic-gradient(var(--accent-color) 0%, transparent 0%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .energy-ring-inner {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--card-bg);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .kynecta-badge {
            background: linear-gradient(45deg, #ff6b6b, #ffa726, #4ecdc4, #45b7d1);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
        }
        
        .collaboration-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(34, 211, 238, 0.2);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }
        
        .ai-suggestion {
            background: rgba(139, 92, 246, 0.1);
            border-left: 3px solid var(--accent-color);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
        }

        /* NEW FEATURES STYLES */

        /* Mood-based Filtering */
        .mood-filter-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background: var(--glass-bg);
            border-radius: 12px;
        }

        .mood-option {
            padding: 8px 12px;
            border-radius: 20px;
            background: var(--card-bg);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .mood-option.active {
            background: var(--accent-color);
            color: white;
        }

        /* Interactive Reactions */
        .vibe-reactions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .vibe-reaction {
            padding: 6px 12px;
            border-radius: 20px;
            background: var(--glass-bg);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .vibe-reaction.active {
            background: var(--accent-color);
            color: white;
        }

        .vibe-reaction:hover {
            transform: scale(1.05);
        }

        /* Story Styles */
        .story-ring {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            padding: 3px;
            background: linear-gradient(45deg, #ff6b6b, #ffa726, #4ecdc4, #45b7d1);
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .story-ring:hover {
            transform: scale(1.05);
        }

        .story-content {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            overflow: hidden;
            background: var(--card-bg);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .story-content img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Story Viewer Modal */
        .story-viewer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .story-viewer.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .story-viewer-container {
            width: 100%;
            max-width: 400px;
            height: 80%;
            background: var(--card-bg);
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        
        .story-viewer.active .story-viewer-container {
            transform: scale(1);
        }
        
        .story-progress {
            display: flex;
            gap: 4px;
            padding: 10px;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 10;
        }
        
        .story-progress-bar {
            height: 3px;
            flex: 1;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .story-progress-fill {
            height: 100%;
            background: white;
            width: 0%;
            transition: width 0.1s linear;
        }
        
        .story-content-viewer {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .story-content-viewer img,
        .story-content-viewer video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .story-nav {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 50%;
            cursor: pointer;
            z-index: 5;
        }
        
        .story-nav.prev {
            left: 0;
        }
        
        .story-nav.next {
            right: 0;
        }
        
        .story-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.5);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            z-index: 15;
        }

        /* Post hiding animation */
        .post-card.hiding {
            transform: translateX(-100%);
            opacity: 0;
            transition: transform 0.5s ease, opacity 0.5s ease;
        }

        /* NEW FEATURE STYLES */

        /* User Tagging System */
        .tagging-container {
            position: relative;
            margin-bottom: 15px;
        }

        .tagged-users {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .tagged-user {
            display: flex;
            align-items: center;
            background: var(--glass-bg);
            padding: 4px 8px;
            border-radius: 16px;
            font-size: 0.8rem;
        }

        .tagged-user img {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .tagged-user .remove-tag {
            margin-left: 5px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .tag-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border-radius: 12px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .tag-suggestion {
            padding: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tag-suggestion:hover {
            background: var(--glass-bg);
        }

        .tag-suggestion img {
            width: 30px;
            height: 30px;
            border-radius: 50%;
        }

        /* Reels Styles */
        .reel-container {
            position: relative;
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
        }

        .reel-video {
            width: 100%;
            border-radius: 16px;
            background: black;
        }

        .reel-actions {
            position: absolute;
            right: 10px;
            bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .reel-action {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: white;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        }

        .reel-action i {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .reel-action span {
            font-size: 0.8rem;
        }

        /* Enhanced Audience Control */
        .audience-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .audience-option {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            border-radius: 20px;
            background: var(--glass-bg);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.85rem;
        }

        .audience-option.active {
            background: var(--accent-color);
            color: white;
        }

        /* Enhanced Mood & Interest System */
        .mood-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .mood-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 12px;
            background: var(--glass-bg);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .mood-item.active {
            background: var(--accent-color);
            color: white;
        }

        .interest-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .interest-item {
            padding: 8px 12px;
            border-radius: 12px;
            background: var(--glass-bg);
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .interest-item.active {
            background: var(--accent-color);
            color: white;
        }

        /* NEW: Section Headers */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 30px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--glass-border);
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: var(--text-primary);
        }

        .section-link {
            color: var(--accent-color);
            font-size: 0.9rem;
            text-decoration: none;
        }

        .section-link:hover {
            text-decoration: underline;
        }

        /* NEW: Group Card Styles */
        .group-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .group-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
        }

        .group-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .group-avatar {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            margin-right: 12px;
            object-fit: cover;
        }

        .group-info {
            flex: 1;
        }

        .group-name {
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .group-members {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .group-description {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .group-actions {
            display: flex;
            gap: 8px;
        }

        .group-action-btn {
            flex: 1;
            padding: 8px 12px;
            border-radius: 20px;
            text-align: center;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .group-join-btn {
            background: var(--accent-color);
            color: white;
        }

        .group-join-btn:hover {
            background: var(--accent-hover);
        }

        .group-view-btn {
            background: var(--glass-bg);
            color: var(--text-primary);
        }

        .group-view-btn:hover {
            background: var(--glass-border);
        }

        /* NEW: Event Card Styles */
        .event-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .event-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
        }

        .event-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .event-date {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            margin-right: 12px;
            background: var(--accent-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .event-month {
            font-size: 0.7rem;
        }

        .event-day {
            font-size: 1.2rem;
        }

        .event-info {
            flex: 1;
        }

        .event-name {
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .event-details {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .event-description {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .event-actions {
            display: flex;
            gap: 8px;
        }

        .event-action-btn {
            flex: 1;
            padding: 8px 12px;
            border-radius: 20px;
            text-align: center;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .event-rsvp-btn {
            background: var(--accent-color);
            color: white;
        }

        .event-rsvp-btn:hover {
            background: var(--accent-hover);
        }

        .event-view-btn {
            background: var(--glass-bg);
            color: var(--text-primary);
        }

        .event-view-btn:hover {
            background: var(--glass-border);
        }

        /* NEW: Space Card Styles */
        .space-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .space-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
        }

        .space-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .space-avatar {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            margin-right: 12px;
            object-fit: cover;
        }

        .space-info {
            flex: 1;
        }

        .space-name {
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .space-members {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .space-description {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .space-actions {
            display: flex;
            gap: 8px;
        }

        .space-action-btn {
            flex: 1;
            padding: 8px 12px;
            border-radius: 20px;
            text-align: center;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .space-join-btn {
            background: var(--accent-color);
            color: white;
        }

        .space-join-btn:hover {
            background: var(--accent-hover);
        }

        .space-view-btn {
            background: var(--glass-bg);
            color: var(--text-primary);
        }

        .space-view-btn:hover {
            background: var(--glass-border);
        }

        /* NEW: Profile Cover Photo */
        .profile-cover-container {
            position: relative;
            width: 100%;
            height: 300px;
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .profile-cover {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-cover-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .profile-cover-container:hover .profile-cover-overlay {
            opacity: 1;
        }

        .profile-avatar-container {
            position: relative;
            width: 120px;
            height: 120px;
            margin-top: -60px;
            margin-left: 20px;
            z-index: 10;
        }

        .profile-avatar {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--card-bg);
        }

        .profile-avatar-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            cursor: pointer;
        }

        .profile-avatar-container:hover .profile-avatar-overlay {
            opacity: 1;
        }

        /* NEW: Horizontal Scroll Sections */
        .horizontal-scroll-container {
            display: flex;
            overflow-x: auto;
            gap: 16px;
            padding: 10px 0;
            scrollbar-width: none; /* Firefox */
        }

        .horizontal-scroll-container::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Edge */
        }

        .horizontal-card {
            min-width: 280px;
            background: var(--card-bg);
            border-radius: 16px;
            padding: 16px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .horizontal-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
        }

        /* Emoji Picker Styles */
        .emoji-picker-container {
            position: absolute;
            bottom: 100%;
            right: 0;
            margin-bottom: 10px;
            z-index: 100;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .emoji-picker-container.hidden {
            display: none;
        }

        .emoji-trigger {
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background 0.2s ease;
        }

        .emoji-trigger:hover {
            background: var(--glass-bg);
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .masonry-grid {
                grid-template-columns: 1fr;
            }
            
            .floating-create-btn {
                bottom: 20px;
                right: 20px;
                width: 50px;
                height: 50px;
            }

            .mood-filter-container {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .vibe-reactions {
                flex-wrap: wrap;
            }
            
            /* Mobile-specific improvements */
            .container {
                padding-left: 10px;
                padding-right: 10px;
            }
            
            .post-card {
                margin-bottom: 15px;
            }
            
            .filter-controls {
                justify-content: center;
            }
            
            .filter-btn {
                padding: 6px 12px;
                font-size: 0.8rem;
            }
            
            .mood-option {
                padding: 6px 10px;
                font-size: 0.8rem;
            }
            
            .modal-container {
                width: 95%;
                padding: 20px;
            }
            
            .story-viewer-container {
                max-width: 95%;
                height: 70%;
            }

            /* New features mobile responsiveness */
            .mood-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .interest-grid {
                grid-template-columns: 1fr;
            }
            
            .reel-container {
                max-width: 100%;
            }

            /* NEW: Section responsiveness */
            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .group-actions,
            .event-actions,
            .space-actions {
                flex-direction: column;
            }

            /* NEW: Profile mobile responsiveness */
            .profile-cover-container {
                height: 200px;
            }
            
            .profile-avatar-container {
                width: 100px;
                height: 100px;
                margin-top: -50px;
            }

            /* Emoji Picker on Mobile */
            .emoji-picker-container {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                top: auto;
                margin-bottom: 0;
                border-radius: 12px 12px 0 0;
            }
        }

        @media (max-width: 480px) {
            .filter-controls {
                justify-content: center;
            }
            
            /* Extra small screen improvements */
            .post-card {
                padding: 15px;
            }
            
            .vibe-reaction {
                padding: 4px 8px;
                font-size: 0.75rem;
            }
            
            .mood-filter-container {
                padding: 8px;
            }

            /* New features extra small screen */
            .mood-grid {
                grid-template-columns: 1fr;
            }
            
            .audience-selector {
                flex-direction: column;
            }

            /* NEW: Profile extra small screen */
            .profile-cover-container {
                height: 150px;
            }
            
            .profile-avatar-container {
                width: 80px;
                height: 80px;
                margin-top: -40px;
            }
        }
        
        /* Ensure all content is visible on mobile */
        @media (max-width: 768px) {
            #rightSidebar {
                display: none;
            }
            
            #sidebar {
                width: 100%;
                max-width: 280px;
            }
            
            .main-content-container {
                width: 100%;
            }
            
            .connection-status {
                right: 5px;
                top: 5px;
                font-size: 0.7rem;
                padding: 6px 12px;
            }
        }
    </style>
</head>
<body class="h-full dark-theme overflow-x-hidden">
    <!-- Connection Status -->
    <div class="connection-status connecting" id="connectionStatus">
        <i class="fas fa-circle-notch fa-spin mr-2"></i>
        <span id="connectionText">Connecting to Kynecta...</span>
    </div>

    <!-- Floating Create Button -->
    <div class="floating-create-btn" id="floatingCreateBtn">
        <i class="fas fa-plus"></i>
    </div>

    <!-- Story Viewer Modal -->
    <div class="story-viewer" id="storyViewer">
        <div class="story-viewer-container">
            <div class="story-progress" id="storyProgress">
                <!-- Progress bars will be added dynamically -->
            </div>
            <div class="story-content-viewer" id="storyContentViewer">
                <!-- Story content will be displayed here -->
            </div>
            <div class="story-nav prev" id="storyPrev"></div>
            <div class="story-nav next" id="storyNext"></div>
            <div class="story-close" id="storyClose">
                <i class="fas fa-times"></i>
            </div>
        </div>
    </div>

    <!-- Create Story Modal -->
    <div id="createStoryModal" class="modal">
        <div class="modal-container">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-theme-accent">Create Story</h2>
                <button id="closeStoryModal" class="text-theme-secondary hover:text-theme-accent transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div class="flex items-center space-x-3 mb-4">
                    <img id="storyUserAvatar" class="w-10 h-10 rounded-2xl object-cover" src="" alt="Your Avatar">
                    <div>
                        <p id="storyUserName" class="font-semibold text-theme-primary">Loading...</p>
                        <p class="text-xs text-theme-secondary">Your story will be visible for 24 hours</p>
                    </div>
                </div>
                
                <!-- Enhanced Audience Control for Stories -->
                <div class="audience-selector">
                    <div class="audience-option active" data-audience="public">
                        <i class="fas fa-globe"></i>
                        <span>Public</span>
                    </div>
                    <div class="audience-option" data-audience="friends">
                        <i class="fas fa-user-friends"></i>
                        <span>Friends</span>
                    </div>
                    <div class="audience-option" data-audience="close-friends">
                        <i class="fas fa-star"></i>
                        <span>Close Friends</span>
                    </div>
                    <div class="audience-option" data-audience="only-me">
                        <i class="fas fa-lock"></i>
                        <span>Only Me</span>
                    </div>
                </div>
                
                <div id="storyTextInput" class="hidden">
                    <textarea id="storyTextContent" placeholder="What's happening?" 
                              class="w-full p-4 glass border border-purple-700 rounded-2xl focus:outline-none focus:ring-2 focus:ring-theme-accent focus:border-transparent placeholder-theme-secondary h-32 resize-none"></textarea>
                </div>
                
                <div id="storyMediaPreview" class="hidden">
                    <img id="storyPreviewImage" class="media-preview w-full hidden rounded-xl">
                    <video id="storyPreviewVideo" class="media-preview w-full hidden rounded-xl" controls></video>
                </div>
                
                <div class="flex flex-wrap gap-4 text-theme-secondary justify-center">
                    <button id="addTextStory" class="flex items-center space-x-2 hover:text-theme-accent transition">
                        <i class="fas fa-font"></i>
                        <span>Text</span>
                    </button>
                    <button id="addImageStory" class="flex items-center space-x-2 hover:text-theme-accent transition">
                        <i class="fas fa-image"></i>
                        <span>Image</span>
                    </button>
                    <button id="addVideoStory" class="flex items-center space-x-2 hover:text-theme-accent transition">
                        <i class="fas fa-video"></i>
                        <span>Video</span>
                    </button>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4">
                    <button id="cancelStory" class="px-4 py-2 glass border border-purple-700 rounded-2xl text-theme-secondary hover:text-theme-accent transition">
                        Cancel
                    </button>
                    <button id="publishStory" class="px-6 py-2 rounded-2xl font-semibold hover:scale-105 transition" style="background: var(--accent-color); color: white;">
                        Publish Story
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Navigation Toggle -->
    <div class="lg:hidden fixed top-4 left-4 z-50">
        <button id="mobileNavToggle" class="w-10 h-10 glass rounded-2xl flex items-center justify-center text-theme-secondary hover:text-theme-accent">
            <i class="fas fa-bars"></i>
        </button>
    </div>

    <div class="flex h-full" style="height: 100vh;">
        <!-- Navigation Sidebar -->
        <div id="sidebar" class="w-20 lg:w-64 glass border-r border-purple-800 flex flex-col fixed lg:relative h-full z-40 transform -translate-x-full lg:translate-x-0 transition-transform duration-300">
            <div class="p-4">
                <a href="#" class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-2xl flex items-center justify-center" style="background: var(--accent-color);">
                        <i class="fas fa-network-wired text-white"></i>
                    </div>
                    <span class="hidden lg:block text-xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-400">
                        Kynecta
                    </span>
                </a>
            </div>

            <nav class="flex-1 px-2 lg:px-4 space-y-2">
                <a href="home.html" class="flex items-center space-x-3 p-3 rounded-xl bg-cyan-900/30 text-cyan-400 border border-cyan-500/50">
                    <i class="fas fa-home w-6"></i>
                    <span class="hidden lg:block font-semibold">Social Feed</span>
                </a>
                <a href="chat.html" class="flex items-center space-x-3 p-3 rounded-xl text-theme-secondary hover:bg-purple-900/30 hover:text-theme-accent transition">
                    <i class="fas fa-comment-dots w-6"></i>
                    <span class="hidden lg:block">Quantum Chat</span>
                </a>
                <a href="profile.html" class="flex items-center space-x-3 p-3 rounded-xl text-theme-secondary hover:bg-purple-900/30 hover:text-theme-accent transition">
                    <i class="fas fa-user-astronaut w-6"></i>
                    <span class="hidden lg:block">Profile</span>
                </a>
                <a href="marketplace.html" class="flex items-center space-x-3 p-3 rounded-xl text-theme-secondary hover:bg-purple-900/30 hover:text-theme-accent transition">
                    <i class="fas fa-store w-6"></i>
                    <span class="hidden lg:block">Marketplace</span>
                </a>
                <a href="games.html" class="flex items-center space-x-3 p-3 rounded-xl text-theme-secondary hover:bg-purple-900/30 hover:text-theme-accent transition">
                    <i class="fas fa-gamepad w-6"></i>
                    <span class="hidden lg:block">Games</span>
                </a>
                <a href="payment.html" class="flex items-center space-x-3 p-3 rounded-xl text-theme-secondary hover:bg-purple-900/30 hover:text-theme-accent transition">
                    <i class="fas fa-credit-card w-6"></i>
                    <span class="hidden lg:block">Payment</span>
                </a>
            </nav>

            <!-- User Status -->
            <div class="p-4 border-t border-purple-800">
                <div id="userStatusContainer" class="flex items-center space-x-3 p-3 glass rounded-xl cursor-pointer hover:bg-cyan-900/30 transition">
                    <div class="relative">
                        <img id="userAvatar" class="w-8 h-8 rounded-2xl object-cover" src="" alt="User Avatar">
                        <div id="statusIndicator" class="status-indicator status-online absolute -bottom-1 -right-1 border-2 border-gray-900"></div>
                    </div>
                    <div class="hidden lg:block">
                        <p id="userDisplayName" class="text-sm font-semibold text-theme-accent">Loading...</p>
                        <p id="statusText" class="text-xs text-theme-secondary">Online</p>
                    </div>
                </div>
                <!-- Kynecta Unique Feature: User Energy Level -->
                <div class="flex items-center justify-between mt-2 mb-2">
                    <span class="text-xs text-theme-secondary">Connection Energy</span>
                    <div class="energy-ring" id="userEnergyRing">
                        <div class="energy-ring-inner">
                            <span class="text-xs font-bold" id="energyPercentage">0%</span>
                        </div>
                    </div>
                </div>
                <button id="signOutBtn" class="w-full mt-2 py-2 glass border border-purple-700 rounded-2xl text-theme-secondary hover:text-theme-accent transition text-sm">
                    <i class="fas fa-sign-out-alt mr-2"></i>Sign Out
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden w-full lg:w-auto main-content-container">
            <!-- Header -->
            <header class="glass border-b border-purple-800 px-4 md:px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex-1 max-w-2xl relative">
                        <div class="relative">
                            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-theme-secondary"></i>
                            <input type="text" id="searchInput" placeholder="Search posts, people, or topics..." 
                                   class="w-full pl-10 pr-4 py-3 glass border border-purple-700 rounded-2xl focus:outline-none focus:ring-2 focus:ring-theme-accent focus:border-transparent placeholder-theme-secondary">
                        </div>
                        <div id="searchResults" class="search-results">
                            <!-- Search results will appear here -->
                        </div>
                    </div>
                    <div class="flex items-center space-x-4 ml-4">
                        <button id="themeToggle" class="w-10 h-10 glass rounded-2xl flex items-center justify-center text-theme-secondary hover:text-theme-accent hover:scale-110 transition">
                            <i class="fas fa-palette"></i>
                        </button>
                        <button id="notificationsBtn" class="w-10 h-10 glass rounded-2xl flex items-center justify-center text-theme-secondary hover:text-theme-accent hover:scale-110 transition relative">
                            <i class="fas fa-bell"></i>
                            <span id="notificationCount" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
                        </button>
                    </div>
                </div>
            </header>

            <!-- Stories Section -->
            <div class="glass border-b border-purple-800 p-4">
                <div class="flex space-x-6 overflow-x-auto scrollbar-hide pb-2" id="storiesContainer">
                    <!-- Stories will be loaded dynamically -->
                </div>
            </div>

            <!-- NEW FEATURE: Mood-based Filtering -->
            <div class="mood-filter-container glass border-b border-purple-800">
                <span class="text-theme-primary font-medium">My Mood:</span>
                <div class="mood-option active" data-mood="all">All</div>
                <div class="mood-option" data-mood="happy">üòä Happy</div>
                <div class="mood-option" data-mood="creative">üé® Creative</div>
                <div class="mood-option" data-mood="motivated">üí™ Motivated</div>
                <div class="mood-option" data-mood="calm">üòå Calm</div>
                <div class="mood-option" data-mood="reflective">ü§î Reflective</div>
            </div>

            <!-- Filter & Sort Controls -->
            <div class="glass border-b border-purple-800 p-4">
                <div class="filter-controls">
                    <button class="filter-btn active" data-filter="all">All Posts</button>
                    <button class="filter-btn" data-filter="top">Top</button>
                    <button class="filter-btn" data-filter="trending">Trending</button>
                    <button class="filter-btn" data-filter="latest">Latest</button>
                    
                    <!-- Emotion Filters -->
                    <div class="relative emotion-filter">
                        <button class="filter-btn" id="emotionFilterBtn">
                            <i class="fas fa-smile mr-1"></i> Mood
                        </button>
                        <div class="emotion-options absolute mt-2 p-3 glass rounded-xl z-10 hidden" id="emotionOptions">
                            <div class="grid grid-cols-3 gap-2">
                                <div class="emotion-option" data-emotion="joy">üòÑ Joy</div>
                                <div class="emotion-option" data-emotion="love">‚ù§Ô∏è Love</div>
                                <div class="emotion-option" data-emotion="calm">üòå Calm</div>
                                <div class="emotion-option" data-emotion="excited">ü§© Excited</div>
                                <div class="emotion-option" data-emotion="sad">üò¢ Sad</div>
                                <div class="emotion-option" data-emotion="angry">üò† Angry</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Interest Filters -->
                    <div class="relative interest-filter">
                        <button class="filter-btn" id="interestFilterBtn">
                            <i class="fas fa-tags mr-1"></i> Interests
                        </button>
                        <div class="interest-options absolute mt-2 p-3 glass rounded-xl z-10 hidden" id="interestOptions">
                            <div class="space-y-2">
                                <div class="interest-option" data-interest="technology">Technology</div>
                                <div class="interest-option" data-interest="sports">Sports</div>
                                <div class="interest-option" data-interest="music">Music</div>
                                <div class="interest-option" data-interest="art">Art</div>
                                <div class="interest-option" data-interest="travel">Travel</div>
                                <div class="interest-option" data-interest="food">Food</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Feed -->
            <main class="flex-1 overflow-y-auto bg-gradient-to-b from-purple-900/20 to-gray-900/50 custom-scrollbar">
                <div class="container mx-auto px-4 py-4">
                    <!-- NEW: Profile Section -->
                    <div class="post-card p-0 mb-6">
                        <div class="profile-cover-container">
                            <img id="profileCover" class="profile-cover" src="" alt="Cover Photo">
                            <div class="profile-cover-overlay">
                                <button id="changeCoverBtn" class="px-4 py-2 glass rounded-2xl text-theme-primary hover:text-theme-accent transition">
                                    <i class="fas fa-camera mr-2"></i>Change Cover
                                </button>
                            </div>
                        </div>
                        <div class="p-5">
                            <div class="flex items-start justify-between">
                                <div class="flex items-end">
                                    <div class="profile-avatar-container">
                                        <img id="profileAvatar" class="profile-avatar" src="" alt="Profile Picture">
                                        <div class="profile-avatar-overlay">
                                            <button id="changeAvatarBtn" class="text-white">
                                                <i class="fas fa-camera text-xl"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="ml-4 mb-2">
                                        <h2 id="profileName" class="text-2xl font-bold text-theme-primary">Loading...</h2>
                                        <p id="profileBio" class="text-theme-secondary">Welcome to my profile!</p>
                                    </div>
                                </div>
                                <button id="editProfileBtn" class="px-4 py-2 glass border border-purple-700 rounded-2xl text-theme-secondary hover:text-theme-accent transition">
                                    <i class="fas fa-edit mr-2"></i>Edit Profile
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- NEW: Groups Section -->
                    <div class="section-header">
                        <h2 class="section-title">Your Groups</h2>
                        <a href="#" class="section-link">See All</a>
                    </div>
                    <div class="horizontal-scroll-container" id="groupsContainer">
                        <!-- Groups will be loaded dynamically from Firebase -->
                    </div>
                    
                    <!-- NEW: Collaborative Spaces Section -->
                    <div class="section-header">
                        <h2 class="section-title">Collaborative Spaces</h2>
                        <a href="#" class="section-link">See All</a>
                    </div>
                    <div class="horizontal-scroll-container" id="spacesContainer">
                        <!-- Spaces will be loaded dynamically from Firebase -->
                    </div>
                    
                    <!-- NEW: Events Section -->
                    <div class="section-header">
                        <h2 class="section-title">Upcoming Events</h2>
                        <a href="#" class="section-link">See All</a>
                    </div>
                    <div class="horizontal-scroll-container" id="eventsContainer">
                        <!-- Events will be loaded dynamically from Firebase -->
                    </div>
                    
                    <!-- NEW: Reels Section -->
                    <div class="section-header">
                        <h2 class="section-title">Reels</h2>
                        <a href="#" class="section-link">See All</a>
                    </div>
                    <div class="horizontal-scroll-container" id="reelsContainer">
                        <!-- Reels will be loaded dynamically from Firebase -->
                    </div>
                    
                    <!-- NEW: Saved Posts Section -->
                    <div class="section-header">
                        <h2 class="section-title">Saved Posts</h2>
                        <a href="#" class="section-link">See All</a>
                    </div>
                    <div id="savedContainer">
                        <!-- Saved posts will be loaded dynamically from Firebase -->
                    </div>
                    
                    <!-- Posts Section -->
                    <div class="section-header">
                        <h2 class="section-title">Recent Posts</h2>
                    </div>
                    <div class="masonry-grid" id="feedContainer">
                        <!-- Posts will be loaded dynamically from Firebase -->
                    </div>
                    
                    <!-- Loading Indicator -->
                    <div id="loadingIndicator" class="loading-spinner hidden"></div>
                    
                    <!-- End of Feed Message -->
                    <div id="endOfFeed" class="text-center py-8 text-theme-secondary hidden">
                        <i class="fas fa-check-circle text-2xl mb-2"></i>
                        <p>You're all caught up!</p>
                    </div>
                </div>
            </main>
        </div>

        <!-- Right Sidebar -->
        <div id="rightSidebar" class="hidden lg:block w-80 glass border-l border-purple-800 overflow-y-auto custom-scrollbar">
            <div class="p-4 md:p-6">
                <!-- User Profile Card -->
                <div class="glass border border-purple-700 rounded-2xl p-4 mb-6">
                    <div class="flex items-center space-x-3 mb-4">
                        <img id="sidebarUserAvatar" class="w-12 h-12 rounded-2xl object-cover" src="" alt="User Avatar">
                        <div>
                            <h3 id="sidebarUserName" class="font-bold text-theme-accent">Loading...</h3>
                            <p id="sidebarUserStatus" class="text-xs text-theme-secondary">Online</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-2 text-center">
                        <div>
                            <p class="font-bold text-theme-accent" id="postCount">0</p>
                            <p class="text-xs text-theme-secondary">Posts</p>
                        </div>
                        <div>
                            <p class="font-bold text-theme-accent" id="followerCount">0</p>
                            <p class="text-xs text-theme-secondary">Followers</p>
                        </div>
                        <div>
                            <p class="font-bold text-theme-accent" id="followingCount">0</p>
                            <p class="text-xs text-theme-secondary">Following</p>
                        </div>
                    </div>
                    <!-- Kynecta Unique Feature: User Badges -->
                    <div class="mt-4 flex flex-wrap gap-2" id="userBadges">
                        <!-- Badges will be loaded dynamically -->
                    </div>
                </div>

                <!-- Trending Topics -->
                <div class="glass border border-purple-700 rounded-2xl p-4 mb-6">
                    <h3 class="font-bold text-theme-accent mb-4 flex items-center">
                        <i class="fas fa-fire mr-2"></i> Trending Topics
                    </h3>
                    <div id="trendingTopicsContainer" class="space-y-3">
                        <!-- Trending topics will be loaded dynamically -->
                    </div>
                </div>

                <!-- Suggested Connections -->
                <div class="glass border border-purple-700 rounded-2xl p-4">
                    <h3 class="font-bold text-theme-accent mb-4">Suggested Connections</h3>
                    <div id="suggestedUsersContainer" class="space-y-4">
                        <!-- Suggested users will be loaded dynamically -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Post Modal -->
    <div id="createPostModal" class="modal">
        <div class="modal-container">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-theme-accent">Create Post</h2>
                <button id="closePostModal" class="text-theme-secondary hover:text-theme-accent transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div class="flex items-center space-x-3 mb-4">
                    <img id="currentUserAvatar" class="w-10 h-10 rounded-2xl object-cover" src="" alt="Your Avatar">
                    <div>
                        <p id="currentUserName" class="font-semibold text-theme-primary">Loading...</p>
                        <!-- Enhanced Audience Control -->
                        <div class="audience-selector mt-2">
                            <div class="audience-option active" data-audience="public">
                                <i class="fas fa-globe"></i>
                                <span>Public</span>
                            </div>
                            <div class="audience-option" data-audience="friends">
                                <i class="fas fa-user-friends"></i>
                                <span>Friends</span>
                            </div>
                            <div class="audience-option" data-audience="close-friends">
                                <i class="fas fa-star"></i>
                                <span>Close Friends</span>
                            </div>
                            <div class="audience-option" data-audience="only-me">
                                <i class="fas fa-lock"></i>
                                <span>Only Me</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- User Tagging System -->
                <div class="tagging-container">
                    <div class="relative">
                        <textarea id="modalPostInput" placeholder="What's on your mind? Tag friends with @..." 
                                  class="w-full p-4 glass border border-purple-700 rounded-2xl focus:outline-none focus:ring-2 focus:ring-theme-accent focus:border-transparent placeholder-theme-secondary h-32 resize-none"></textarea>
                        <div class="absolute bottom-3 right-3 flex space-x-2">
                            <button id="emojiTrigger" class="emoji-trigger">
                                <i class="fas fa-smile text-theme-secondary"></i>
                            </button>
                        </div>
                    </div>
                    <div class="emoji-picker-container hidden" id="emojiPickerContainer">
                        <emoji-picker></emoji-picker>
                    </div>
                    <div class="tagged-users" id="taggedUsers">
                        <!-- Tagged users will appear here -->
                    </div>
                    <div class="tag-suggestions hidden" id="tagSuggestions">
                        <!-- Tag suggestions will appear here -->
                    </div>
                </div>
                
                <!-- Enhanced Mood & Interest System -->
                <div class="mood-grid" id="moodGrid">
                    <div class="mood-item" data-mood="joy">
                        <span>üòÑ</span>
                        <span>Joyful</span>
                    </div>
                    <div class="mood-item" data-mood="love">
                        <span>‚ù§Ô∏è</span>
                        <span>Loving</span>
                    </div>
                    <div class="mood-item" data-mood="calm">
                        <span>üòå</span>
                        <span>Calm</span>
                    </div>
                    <div class="mood-item" data-mood="excited">
                        <span>ü§©</span>
                        <span>Excited</span>
                    </div>
                    <div class="mood-item" data-mood="sad">
                        <span>üò¢</span>
                        <span>Sad</span>
                    </div>
                    <div class="mood-item" data-mood="angry">
                        <span>üò†</span>
                        <span>Angry</span>
                    </div>
                </div>
                
                <!-- Media Preview -->
                <div id="modalMediaPreview" class="hidden">
                    <img id="modalPreviewImage" class="media-preview w-full hidden rounded-xl">
                    <video id="modalPreviewVideo" class="media-preview w-full hidden rounded-xl" controls></video>
                </div>
                
                <div class="flex flex-wrap gap-4 text-theme-secondary justify-center">
                    <button id="modalAddPhoto" class="flex items-center space-x-2 hover:text-theme-accent transition">
                        <i class="fas fa-image"></i>
                        <span>Photo</span>
                    </button>
                    <button id="modalAddVideo" class="flex items-center space-x-2 hover:text-theme-accent transition">
                        <i class="fas fa-video"></i>
                        <span>Video</span>
                    </button>
                    <button id="modalAddReel" class="flex items-center space-x-2 hover:text-theme-accent transition">
                        <i class="fas fa-film"></i>
                        <span>Reel</span>
                    </button>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4">
                    <button id="cancelPost" class="px-4 py-2 glass border border-purple-700 rounded-2xl text-theme-secondary hover:text-theme-accent transition">
                        Cancel
                    </button>
                    <button id="publishPost" class="px-6 py-2 rounded-2xl font-semibold hover:scale-105 transition" style="background: var(--accent-color); color: white;">
                        Publish
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Reel Modal -->
    <div id="createReelModal" class="modal">
        <div class="modal-container">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-theme-accent">Create Reel</h2>
                <button id="closeReelModal" class="text-theme-secondary hover:text-theme-accent transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div class="flex items-center space-x-3 mb-4">
                    <img id="reelUserAvatar" class="w-10 h-10 rounded-2xl object-cover" src="" alt="Your Avatar">
                    <div>
                        <p id="reelUserName" class="font-semibold text-theme-primary">Loading...</p>
                        <p class="text-xs text-theme-secondary">Max 6 seconds</p>
                    </div>
                </div>
                
                <div id="reelVideoPreview" class="hidden">
                    <video id="reelPreviewVideo" class="media-preview w-full hidden rounded-xl" controls></video>
                    <div class="text-center mt-2 text-theme-secondary" id="reelDuration">Duration: 0s</div>
                </div>
                
                <div class="flex flex-col items-center justify-center border-2 border-dashed border-purple-700 rounded-2xl p-8 text-center" id="reelUploadArea">
                    <i class="fas fa-video text-4xl text-theme-secondary mb-4"></i>
                    <p class="text-theme-primary font-medium">Upload a video for your reel</p>
                    <p class="text-theme-secondary text-sm mt-2">Maximum duration: 6 seconds</p>
                    <button id="uploadReelVideo" class="mt-4 px-4 py-2 rounded-2xl font-semibold" style="background: var(--accent-color); color: white;">
                        Select Video
                    </button>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4">
                    <button id="cancelReel" class="px-4 py-2 glass border border-purple-700 rounded-2xl text-theme-secondary hover:text-theme-accent transition">
                        Cancel
                    </button>
                    <button id="publishReel" class="px-6 py-2 rounded-2xl font-semibold hover:scale-105 transition" style="background: var(--accent-color); color: white;">
                        Publish Reel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Picture Upload Modal -->
    <div id="profilePictureModal" class="modal">
        <div class="modal-container">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-theme-accent">Update Profile Picture</h2>
                <button id="closeProfilePictureModal" class="text-theme-secondary hover:text-theme-accent transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div class="flex justify-center">
                    <div class="relative w-40 h-40">
                        <img id="profilePicturePreview" class="w-full h-full rounded-full object-cover" src="" alt="Profile Picture Preview">
                        <div class="absolute inset-0 rounded-full border-4 border-theme-accent opacity-0" id="profilePictureFrame"></div>
                    </div>
                </div>
                
                <div class="flex flex-col items-center justify-center border-2 border-dashed border-purple-700 rounded-2xl p-8 text-center">
                    <i class="fas fa-camera text-4xl text-theme-secondary mb-4"></i>
                    <p class="text-theme-primary font-medium">Upload a new profile picture</p>
                    <p class="text-theme-secondary text-sm mt-2">JPG, PNG or GIF - Max 5MB</p>
                    <button id="uploadProfilePicture" class="mt-4 px-4 py-2 rounded-2xl font-semibold" style="background: var(--accent-color); color: white;">
                        Select Image
                    </button>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4">
                    <button id="cancelProfilePicture" class="px-4 py-2 glass border border-purple-700 rounded-2xl text-theme-secondary hover:text-theme-accent transition">
                        Cancel
                    </button>
                    <button id="saveProfilePicture" class="px-6 py-2 rounded-2xl font-semibold hover:scale-105 transition" style="background: var(--accent-color); color: white;">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cover Photo Upload Modal -->
    <div id="coverPhotoModal" class="modal">
        <div class="modal-container">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-theme-accent">Update Cover Photo</h2>
                <button id="closeCoverPhotoModal" class="text-theme-secondary hover:text-theme-accent transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div class="flex justify-center">
                    <div class="relative w-full h-32">
                        <img id="coverPhotoPreview" class="w-full h-full rounded-xl object-cover" src="" alt="Cover Photo Preview">
                        <div class="absolute inset-0 rounded-xl border-4 border-theme-accent opacity-0" id="coverPhotoFrame"></div>
                    </div>
                </div>
                
                <div class="flex flex-col items-center justify-center border-2 border-dashed border-purple-700 rounded-2xl p-8 text-center">
                    <i class="fas fa-image text-4xl text-theme-secondary mb-4"></i>
                    <p class="text-theme-primary font-medium">Upload a new cover photo</p>
                    <p class="text-theme-secondary text-sm mt-2">JPG or PNG - Max 10MB</p>
                    <button id="uploadCoverPhoto" class="mt-4 px-4 py-2 rounded-2xl font-semibold" style="background: var(--accent-color); color: white;">
                        Select Image
                    </button>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4">
                    <button id="cancelCoverPhoto" class="px-4 py-2 glass border border-purple-700 rounded-2xl text-theme-secondary hover:text-theme-accent transition">
                        Cancel
                    </button>
                    <button id="saveCoverPhoto" class="px-6 py-2 rounded-2xl font-semibold hover:scale-105 transition" style="background: var(--accent-color); color: white;">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- File Inputs (Hidden) -->
    <input type="file" id="modalPhotoInput" accept="image/*" class="hidden">
    <input type="file" id="modalVideoInput" accept="video/*" class="hidden">
    <input type="file" id="storyImageInput" accept="image/*" class="hidden">
    <input type="file" id="storyVideoInput" accept="video/*" class="hidden">
    <input type="file" id="reelVideoInput" accept="video/*" class="hidden">
    <input type="file" id="profilePictureInput" accept="image/*" class="hidden">
    <input type="file" id="coverPhotoInput" accept="image/*" class="hidden">

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDHHyGgsSV18BcXrGgzi4C8frzDAE1C1zo",
            authDomain: "uniconnect-ee95c.firebaseapp.com",
            projectId: "uniconnect-ee95c",
            storageBucket: "uniconnect-ee95c.firebasestorage.app",
            messagingSenderId: "1003264444309",
            appId: "1:1003264444309:web:9f0307516e44d21e97d89c"
        };

        // Cloudinary Configuration
        const cloudinaryConfig = {
            cloudName: 'dhjnxa5rh',
            apiKey: '817591969559894',
            uploadPreset: 'kynecta_stories'
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // Global Variables
        let currentUser = null;
        let userData = null;
        let posts = [];
        let lastPost = null;
        let hasMorePosts = true;
        let currentFilter = 'all';
        let currentEmotionFilter = null;
        let currentInterestFilter = null;
        let currentMoodFilter = 'all';
        let viewedPosts = new Set();
        let currentStories = [];
        let currentStoryIndex = 0;
        let storyInterval = null;
        let currentStoryType = null;
        
        // NEW: User Tagging System Variables
        let taggedUsers = [];
        let friendsList = [];
        let currentTaggingIndex = -1;
        
        // NEW: Reels Variables
        let reelVideoFile = null;
        let reelVideoDuration = 0;

        // NEW: Additional Data Variables
        let groups = [];
        let spaces = [];
        let events = [];
        let reels = [];
        let savedPosts = [];

        // NEW: Profile Picture and Cover Photo Variables
        let profilePictureFile = null;
        let coverPhotoFile = null;

        // DOM Elements
        const connectionStatus = document.getElementById('connectionStatus');
        const connectionText = document.getElementById('connectionText');
        const feedContainer = document.getElementById('feedContainer');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const endOfFeed = document.getElementById('endOfFeed');
        const floatingCreateBtn = document.getElementById('floatingCreateBtn');
        const createPostModal = document.getElementById('createPostModal');
        const closePostModal = document.getElementById('closePostModal');
        const cancelPost = document.getElementById('cancelPost');
        const publishPost = document.getElementById('publishPost');
        const modalPostInput = document.getElementById('modalPostInput');
        const themeToggle = document.getElementById('themeToggle');
        const searchInput = document.getElementById('searchInput');
        const userStatusContainer = document.getElementById('userStatusContainer');
        const userAvatar = document.getElementById('userAvatar');
        const userDisplayName = document.getElementById('userDisplayName');
        const statusText = document.getElementById('statusText');
        const sidebarUserAvatar = document.getElementById('sidebarUserAvatar');
        const sidebarUserName = document.getElementById('sidebarUserName');
        const sidebarUserStatus = document.getElementById('sidebarUserStatus');
        const postCount = document.getElementById('postCount');
        const followerCount = document.getElementById('followerCount');
        const followingCount = document.getElementById('followingCount');
        const emotionFilterBtn = document.getElementById('emotionFilterBtn');
        const emotionOptions = document.getElementById('emotionOptions');
        const interestFilterBtn = document.getElementById('interestFilterBtn');
        const interestOptions = document.getElementById('interestOptions');
        const storiesContainer = document.getElementById('storiesContainer');
        const trendingTopicsContainer = document.getElementById('trendingTopicsContainer');
        const suggestedUsersContainer = document.getElementById('suggestedUsersContainer');
        const currentUserAvatar = document.getElementById('currentUserAvatar');
        const currentUserName = document.getElementById('currentUserName');
        const signOutBtn = document.getElementById('signOutBtn');
        const userEnergyRing = document.getElementById('userEnergyRing');
        const energyPercentage = document.getElementById('energyPercentage');
        const userBadges = document.getElementById('userBadges');
        
        // NEW: Additional Section Containers
        const groupsContainer = document.getElementById('groupsContainer');
        const spacesContainer = document.getElementById('spacesContainer');
        const eventsContainer = document.getElementById('eventsContainer');
        const reelsContainer = document.getElementById('reelsContainer');
        const savedContainer = document.getElementById('savedContainer');
        
        // NEW: Profile Elements
        const profileCover = document.getElementById('profileCover');
        const profileAvatar = document.getElementById('profileAvatar');
        const profileName = document.getElementById('profileName');
        const profileBio = document.getElementById('profileBio');
        const changeCoverBtn = document.getElementById('changeCoverBtn');
        const changeAvatarBtn = document.getElementById('changeAvatarBtn');
        const editProfileBtn = document.getElementById('editProfileBtn');
        
        // NEW: Profile Picture Modal Elements
        const profilePictureModal = document.getElementById('profilePictureModal');
        const closeProfilePictureModal = document.getElementById('closeProfilePictureModal');
        const profilePicturePreview = document.getElementById('profilePicturePreview');
        const uploadProfilePicture = document.getElementById('uploadProfilePicture');
        const cancelProfilePicture = document.getElementById('cancelProfilePicture');
        const saveProfilePicture = document.getElementById('saveProfilePicture');
        
        // NEW: Cover Photo Modal Elements
        const coverPhotoModal = document.getElementById('coverPhotoModal');
        const closeCoverPhotoModal = document.getElementById('closeCoverPhotoModal');
        const coverPhotoPreview = document.getElementById('coverPhotoPreview');
        const uploadCoverPhoto = document.getElementById('uploadCoverPhoto');
        const cancelCoverPhoto = document.getElementById('cancelCoverPhoto');
        const saveCoverPhoto = document.getElementById('saveCoverPhoto');
        
        // Story Elements
        const storyViewer = document.getElementById('storyViewer');
        const storyProgress = document.getElementById('storyProgress');
        const storyContentViewer = document.getElementById('storyContentViewer');
        const storyPrev = document.getElementById('storyPrev');
        const storyNext = document.getElementById('storyNext');
        const storyClose = document.getElementById('storyClose');
        const createStoryModal = document.getElementById('createStoryModal');
        const closeStoryModal = document.getElementById('closeStoryModal');
        const cancelStory = document.getElementById('cancelStory');
        const publishStory = document.getElementById('publishStory');
        const addTextStory = document.getElementById('addTextStory');
        const addImageStory = document.getElementById('addImageStory');
        const addVideoStory = document.getElementById('addVideoStory');
        const storyTextInput = document.getElementById('storyTextInput');
        const storyTextContent = document.getElementById('storyTextContent');
        const storyMediaPreview = document.getElementById('storyMediaPreview');
        const storyPreviewImage = document.getElementById('storyPreviewImage');
        const storyPreviewVideo = document.getElementById('storyPreviewVideo');
        const storyUserAvatar = document.getElementById('storyUserAvatar');
        const storyUserName = document.getElementById('storyUserName');

        // Mood-based Filtering Elements
        const moodOptions = document.querySelectorAll('.mood-option');
        
        // NEW: User Tagging System Elements
        const taggedUsersContainer = document.getElementById('taggedUsers');
        const tagSuggestions = document.getElementById('tagSuggestions');
        
        // NEW: Enhanced Mood & Interest System Elements
        const moodGrid = document.getElementById('moodGrid');
        const moodItems = document.querySelectorAll('.mood-item');
        
        // NEW: Enhanced Audience Control Elements
        const audienceOptions = document.querySelectorAll('.audience-option');
        
        // NEW: Reels Elements
        const createReelModal = document.getElementById('createReelModal');
        const closeReelModal = document.getElementById('closeReelModal');
        const cancelReel = document.getElementById('cancelReel');
        const publishReel = document.getElementById('publishReel');
        const reelVideoPreview = document.getElementById('reelVideoPreview');
        const reelPreviewVideo = document.getElementById('reelPreviewVideo');
        const reelDuration = document.getElementById('reelDuration');
        const reelUploadArea = document.getElementById('reelUploadArea');
        const uploadReelVideo = document.getElementById('uploadReelVideo');
        const modalAddReel = document.getElementById('modalAddReel');

        // NEW: Emoji Picker Elements
        const emojiTrigger = document.getElementById('emojiTrigger');
        const emojiPickerContainer = document.getElementById('emojiPickerContainer');
        const emojiPicker = document.querySelector('emoji-picker');

        // Mobile Navigation Elements
        const mobileNavToggle = document.getElementById('mobileNavToggle');
        const sidebar = document.getElementById('sidebar');
        const rightSidebar = document.getElementById('rightSidebar');

        // Initialize the application
        function init() {
            // Set up Firebase authentication state observer
            auth.onAuthStateChanged(user => {
                if (user) {
                    // User is signed in
                    currentUser = user;
                    console.log('User signed in:', user.uid);
                    
                    // Load user data from Firestore
                    loadUserData().then(() => {
                        updateUserUI();
                        loadFeed(); // Real-time feed listener
                        loadStories();
                        loadTrendingTopics();
                        loadSuggestedUsers();
                        
                        // NEW: Load additional data
                        loadGroups();
                        loadSpaces();
                        loadEvents();
                        loadReels();
                        loadSavedPosts();
                        
                        // Initialize new features
                        initializeNewFeatures();
                    }).catch(error => {
                        console.error('Error loading user data:', error);
                    });
                    
                    signOutBtn.classList.remove('hidden');
                } else {
                    // User is signed out - redirect to index page
                    console.log('User not signed in, redirecting to index...');
                    window.location.href = 'index.html';
                }
            });

            // Set up event listeners
            setupEventListeners();
            
            // Set up keyboard shortcuts
            setupKeyboardShortcuts();
            
            // Set up infinite scroll
            setupInfiniteScroll();
            
            // Set up connection monitoring
            setupConnectionMonitoring();
        }

        // Initialize new features
        function initializeNewFeatures() {
            // Initialize mood-based filtering
            initializeMoodFiltering();
            
            // Initialize story viewer
            initializeStoryViewer();
            
            // NEW: Initialize user tagging system
            initializeUserTagging();
            
            // NEW: Initialize enhanced mood & interest system
            initializeEnhancedMoodInterest();
            
            // NEW: Initialize enhanced audience control
            initializeEnhancedAudienceControl();
            
            // NEW: Initialize reels system
            initializeReelsSystem();
            
            // NEW: Initialize emoji picker
            initializeEmojiPicker();
            
            // NEW: Initialize profile picture and cover photo system
            initializeProfilePhotoSystem();
        }

        // Initialize mood-based filtering
        function initializeMoodFiltering() {
            moodOptions.forEach(option => {
                option.addEventListener('click', function() {
                    moodOptions.forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');
                    currentMoodFilter = this.dataset.mood;
                    reloadPosts();
                });
            });
        }

        // Initialize story viewer
        function initializeStoryViewer() {
            // Event listeners for story navigation
            storyPrev.addEventListener('click', showPreviousStory);
            storyNext.addEventListener('click', showNextStory);
            storyClose.addEventListener('click', closeStoryViewer);
            
            // Keyboard navigation for stories
            document.addEventListener('keydown', function(e) {
                if (storyViewer.classList.contains('active')) {
                    if (e.key === 'ArrowLeft') {
                        showPreviousStory();
                    } else if (e.key === 'ArrowRight') {
                        showNextStory();
                    } else if (e.key === 'Escape') {
                        closeStoryViewer();
                    }
                }
            });
        }

        // NEW: Initialize user tagging system
        function initializeUserTagging() {
            // Load friends list
            loadFriendsList();
            
            // Set up tagging event listeners
            modalPostInput.addEventListener('input', handleTaggingInput);
            modalPostInput.addEventListener('keydown', handleTaggingKeydown);
            
            // Close tag suggestions when clicking outside
            document.addEventListener('click', function(event) {
                if (!modalPostInput.contains(event.target) && !tagSuggestions.contains(event.target)) {
                    tagSuggestions.classList.add('hidden');
                }
            });
        }

        // NEW: Initialize enhanced mood & interest system
        function initializeEnhancedMoodInterest() {
            moodItems.forEach(item => {
                item.addEventListener('click', function() {
                    moodItems.forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        }

        // NEW: Initialize enhanced audience control
        function initializeEnhancedAudienceControl() {
            audienceOptions.forEach(option => {
                option.addEventListener('click', function() {
                    audienceOptions.forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        }

        // NEW: Initialize reels system
        function initializeReelsSystem() {
            // Set up event listeners for reels
            modalAddReel.addEventListener('click', openCreateReelModal);
            closeReelModal.addEventListener('click', closeCreateReelModal);
            cancelReel.addEventListener('click', closeCreateReelModal);
            uploadReelVideo.addEventListener('click', () => document.getElementById('reelVideoInput').click());
            publishReel.addEventListener('click', createReel);
            
            // Handle reel video upload
            document.getElementById('reelVideoInput').addEventListener('change', handleReelVideoUpload);
        }

        // NEW: Initialize emoji picker
        function initializeEmojiPicker() {
            if (emojiPicker) {
                emojiTrigger.addEventListener('click', function(e) {
                    e.stopPropagation();
                    emojiPickerContainer.classList.toggle('hidden');
                });
                
                emojiPicker.addEventListener('emoji-click', event => {
                    const emoji = event.detail.unicode;
                    const textarea = modalPostInput;
                    const start = textarea.selectionStart;
                    const end = textarea.selectionEnd;
                    const text = textarea.value;
                    const newText = text.substring(0, start) + emoji + text.substring(end);
                    
                    textarea.value = newText;
                    textarea.focus();
                    textarea.setSelectionRange(start + emoji.length, start + emoji.length);
                    
                    // Hide the picker after selection
                    emojiPickerContainer.classList.add('hidden');
                });
                
                // Close emoji picker when clicking outside
                document.addEventListener('click', function(event) {
                    if (!emojiPickerContainer.contains(event.target) && !emojiTrigger.contains(event.target)) {
                        emojiPickerContainer.classList.add('hidden');
                    }
                });
            }
        }

        // NEW: Initialize profile picture and cover photo system
        function initializeProfilePhotoSystem() {
            // Set up event listeners for profile photo changes
            changeAvatarBtn.addEventListener('click', openProfilePictureModal);
            changeCoverBtn.addEventListener('click', openCoverPhotoModal);
            
            // Profile picture modal events
            closeProfilePictureModal.addEventListener('click', closeProfilePictureModalFunc);
            cancelProfilePicture.addEventListener('click', closeProfilePictureModalFunc);
            saveProfilePicture.addEventListener('click', saveProfilePictureFunc);
            uploadProfilePicture.addEventListener('click', () => document.getElementById('profilePictureInput').click());
            
            // Cover photo modal events
            closeCoverPhotoModal.addEventListener('click', closeCoverPhotoModalFunc);
            cancelCoverPhoto.addEventListener('click', closeCoverPhotoModalFunc);
            saveCoverPhoto.addEventListener('click', saveCoverPhotoFunc);
            uploadCoverPhoto.addEventListener('click', () => document.getElementById('coverPhotoInput').click());
            
            // Handle file inputs
            document.getElementById('profilePictureInput').addEventListener('change', handleProfilePictureUpload);
            document.getElementById('coverPhotoInput').addEventListener('change', handleCoverPhotoUpload);
        }

        // Set up event listeners
        function setupEventListeners() {
            // Theme toggle
            themeToggle.addEventListener('click', toggleTheme);
            
            // Create post modal
            floatingCreateBtn.addEventListener('click', openCreatePostModal);
            closePostModal.addEventListener('click', closeCreatePostModal);
            cancelPost.addEventListener('click', closeCreatePostModal);
            publishPost.addEventListener('click', createPost);
            
            // Filter buttons
            document.querySelectorAll('.filter-btn[data-filter]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn[data-filter]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentFilter = this.dataset.filter;
                    reloadPosts();
                });
            });
            
            // Emotion filter
            emotionFilterBtn.addEventListener('click', toggleEmotionOptions);
            document.querySelectorAll('.emotion-option').forEach(option => {
                option.addEventListener('click', function() {
                    currentEmotionFilter = this.dataset.emotion;
                    emotionFilterBtn.innerHTML = `<i class="fas fa-smile mr-1"></i> ${this.textContent}`;
                    emotionOptions.classList.add('hidden');
                    reloadPosts();
                });
            });
            
            // Interest filter
            interestFilterBtn.addEventListener('click', toggleInterestOptions);
            document.querySelectorAll('.interest-option').forEach(option => {
                option.addEventListener('click', function() {
                    currentInterestFilter = this.dataset.interest;
                    interestFilterBtn.innerHTML = `<i class="fas fa-tags mr-1"></i> ${this.textContent}`;
                    interestOptions.classList.add('hidden');
                    reloadPosts();
                });
            });
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', function(event) {
                if (!emotionFilterBtn.contains(event.target) && !emotionOptions.contains(event.target)) {
                    emotionOptions.classList.add('hidden');
                }
                if (!interestFilterBtn.contains(event.target) && !interestOptions.contains(event.target)) {
                    interestOptions.classList.add('hidden');
                }
            });
            
            // Search functionality
            searchInput.addEventListener('input', debounce(handleSearch, 300));
            
            // Media upload buttons
            document.getElementById('modalAddPhoto').addEventListener('click', () => document.getElementById('modalPhotoInput').click());
            document.getElementById('modalAddVideo').addEventListener('click', () => document.getElementById('modalVideoInput').click());
            
            // File inputs
            document.getElementById('modalPhotoInput').addEventListener('change', handlePostMediaUpload);
            document.getElementById('modalVideoInput').addEventListener('change', handlePostMediaUpload);
            
            // Story creation buttons
            addTextStory.addEventListener('click', () => openStoryTextInput());
            addImageStory.addEventListener('click', () => document.getElementById('storyImageInput').click());
            addVideoStory.addEventListener('click', () => document.getElementById('storyVideoInput').click());
            
            // Story file inputs
            document.getElementById('storyImageInput').addEventListener('change', handleStoryMediaUpload);
            document.getElementById('storyVideoInput').addEventListener('change', handleStoryMediaUpload);
            
            // Story modal buttons
            closeStoryModal.addEventListener('click', closeCreateStoryModal);
            cancelStory.addEventListener('click', closeCreateStoryModal);
            publishStory.addEventListener('click', createStory);
            
            // Sign out button
            signOutBtn.addEventListener('click', signOut);
            
            // Mobile Navigation
            mobileNavToggle.addEventListener('click', toggleMobileNav);
        }

        // Toggle mobile navigation
        function toggleMobileNav() {
            sidebar.classList.toggle('-translate-x-full');
        }

        // Set up keyboard shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Don't trigger shortcuts if user is typing in an input
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    return;
                }
                
                switch(e.key) {
                    case 'n':
                    case 'N':
                        if (e.ctrlKey || e.metaKey) {
                            e.preventDefault();
                            openCreatePostModal();
                        }
                        break;
                    case '/':
                        e.preventDefault();
                        searchInput.focus();
                        break;
                    case 't':
                    case 'T':
                        if (e.ctrlKey || e.metaKey) {
                            e.preventDefault();
                            toggleTheme();
                        }
                        break;
                    case 'Escape':
                        closeCreatePostModal();
                        closeCreateStoryModal();
                        closeStoryViewer();
                        closeCreateReelModal();
                        closeProfilePictureModalFunc();
                        closeCoverPhotoModalFunc();
                        break;
                }
            });
        }

        // Set up infinite scroll
        function setupInfiniteScroll() {
            window.addEventListener('scroll', debounce(() => {
                if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 1000) {
                    if (hasMorePosts && !loadingIndicator.classList.contains('hidden')) {
                        loadMorePosts();
                    }
                }
            }, 200));
        }

        // Set up connection monitoring
        function setupConnectionMonitoring() {
            // Monitor online/offline status
            window.addEventListener('online', () => {
                updateConnectionStatus('connected');
            });
            
            window.addEventListener('offline', () => {
                updateConnectionStatus('disconnected');
            });
            
            // Check Firebase connection
            db.enableNetwork().then(() => {
                updateConnectionStatus('connected');
            }).catch(error => {
                console.error('Firebase connection error:', error);
                updateConnectionStatus('disconnected');
            });
        }

        // Update connection status UI
        function updateConnectionStatus(status) {
            connectionStatus.className = `connection-status ${status}`;
            
            switch(status) {
                case 'connected':
                    connectionText.innerHTML = '<i class="fas fa-wifi mr-2"></i> Connected to Kynecta';
                    break;
                case 'connecting':
                    connectionText.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-2"></i> Connecting to Kynecta...';
                    break;
                case 'disconnected':
                    connectionText.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i> Offline';
                    break;
            }
            
            // Hide status after 3 seconds if connected
            if (status === 'connected') {
                setTimeout(() => {
                    connectionStatus.classList.add('hidden');
                }, 3000);
            } else {
                connectionStatus.classList.remove('hidden');
            }
        }

        // Auth Functions
        function signOut() {
            auth.signOut()
                .then(() => {
                    console.log('User signed out');
                    // Redirect to index page
                    window.location.href = 'index.html';
                })
                .catch((error) => {
                    console.error('Sign out error:', error);
                });
        }

        // Load user data from Firebase
        async function loadUserData() {
            if (!currentUser) return;
            
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                
                if (userDoc.exists) {
                    userData = userDoc.data();
                    console.log('User data loaded:', userData);
                    
                    // Update UI with user data
                    updateUserUI();
                    
                    return userData;
                } else {
                    // Create user document if it doesn't exist
                    return createUserDocument();
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                throw error;
            }
        }

        // Create user document
        function createUserDocument() {
            if (!currentUser) return;
            
            const userData = {
                userId: currentUser.uid,
                userName: currentUser.displayName || 'User',
                userAvatar: currentUser.photoURL || '',
                coverPhoto: '',
                bio: 'Welcome to my profile!',
                email: currentUser.email || '',
                status: 'Online',
                postsCount: 0,
                followersCount: 0,
                followingCount: 0,
                energy: 0,
                badges: ['newcomer'],
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                // Gamification data
                streak: 0,
                points: 0,
                achievements: []
            };
            
            return db.collection('users').doc(currentUser.uid).set(userData)
                .then(() => {
                    console.log('User document created');
                    return userData;
                })
                .catch(error => {
                    console.error('Error creating user document:', error);
                    throw error;
                });
        }

        // Update user UI with current user data
        function updateUserUI() {
            if (currentUser && userData) {
                const displayName = userData.userName || currentUser.displayName || 'User';
                const photoURL = userData.userAvatar || currentUser.photoURL || '';
                const coverURL = userData.coverPhoto || '';
                const bio = userData.bio || 'Welcome to my profile!';
                
                // Update all avatar images
                userAvatar.src = photoURL;
                sidebarUserAvatar.src = photoURL;
                currentUserAvatar.src = photoURL;
                storyUserAvatar.src = photoURL;
                reelUserAvatar.src = photoURL;
                profileAvatar.src = photoURL;
                
                // Update profile cover
                if (coverURL) {
                    profileCover.src = coverURL;
                } else {
                    // Set a default gradient if no cover photo
                    profileCover.src = '';
                    profileCover.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                }
                
                // Update display names
                userDisplayName.textContent = displayName;
                sidebarUserName.textContent = displayName;
                currentUserName.textContent = displayName;
                storyUserName.textContent = displayName;
                reelUserName.textContent = displayName;
                profileName.textContent = displayName;
                profileBio.textContent = bio;
                
                // Update counts
                postCount.textContent = userData.postsCount || 0;
                followerCount.textContent = userData.followersCount || 0;
                followingCount.textContent = userData.followingCount || 0;
                statusText.textContent = userData.status || 'Online';
                sidebarUserStatus.textContent = userData.status || 'Online';
                
                // Kynecta Unique Feature: Update user energy
                updateUserEnergyDisplay(userData.energy || 0);
                
                // Kynecta Unique Feature: Load user badges
                loadUserBadges(userData.badges || []);
            } else if (currentUser) {
                // Fallback to Firebase Auth data if userData not loaded yet
                const photoURL = currentUser.photoURL || '';
                const displayName = currentUser.displayName || 'User';
                
                // Update all avatar images
                userAvatar.src = photoURL;
                sidebarUserAvatar.src = photoURL;
                currentUserAvatar.src = photoURL;
                storyUserAvatar.src = photoURL;
                reelUserAvatar.src = photoURL;
                profileAvatar.src = photoURL;
                
                // Update display names
                userDisplayName.textContent = displayName;
                sidebarUserName.textContent = displayName;
                currentUserName.textContent = displayName;
                storyUserName.textContent = displayName;
                reelUserName.textContent = displayName;
                profileName.textContent = displayName;
            }
        }

        // NEW: Load friends list for tagging
        function loadFriendsList() {
            if (!currentUser) return;
            
            // Fetch user's friends from Firebase
            db.collection('users').doc(currentUser.uid).collection('friends')
                .get()
                .then(snapshot => {
                    friendsList = [];
                    snapshot.forEach(doc => {
                        const friend = doc.data();
                        friendsList.push({
                            id: doc.id,
                            userName: friend.userName,
                            userAvatar: friend.userAvatar
                        });
                    });
                })
                .catch(error => {
                    console.error('Error loading friends list:', error);
                    friendsList = [];
                });
        }

        // NEW: Load groups from Firebase
        function loadGroups() {
            if (!currentUser) return;
            
            db.collection('groups')
                .where('members', 'array-contains', currentUser.uid)
                .limit(5)
                .get()
                .then(snapshot => {
                    groups = [];
                    snapshot.forEach(doc => {
                        groups.push({ id: doc.id, ...doc.data() });
                    });
                    displayGroups(groups);
                })
                .catch(error => {
                    console.error('Error loading groups:', error);
                    groupsContainer.innerHTML = '<div class="text-center py-4 text-theme-secondary">Unable to load groups</div>';
                });
        }

        // NEW: Display groups
        function displayGroups(groups) {
            if (groups.length === 0) {
                groupsContainer.innerHTML = '<div class="text-center py-4 text-theme-secondary">You haven\'t joined any groups yet</div>';
                return;
            }
            
            let html = '';
            groups.forEach(group => {
                html += `
                    <div class="horizontal-card">
                        <div class="group-header">
                            <img src="${group.avatar || ''}" alt="${group.name}" class="group-avatar">
                            <div class="group-info">
                                <div class="group-name">${group.name}</div>
                                <div class="group-members">${group.memberCount || 0} members</div>
                            </div>
                        </div>
                        <div class="group-description">${group.description || 'No description available'}</div>
                        <div class="group-actions">
                            <div class="group-action-btn group-view-btn">View Group</div>
                        </div>
                    </div>
                `;
            });
            
            groupsContainer.innerHTML = html;
        }

        // NEW: Load collaborative spaces from Firebase
        function loadSpaces() {
            if (!currentUser) return;
            
            db.collection('spaces')
                .where('members', 'array-contains', currentUser.uid)
                .limit(5)
                .get()
                .then(snapshot => {
                    spaces = [];
                    snapshot.forEach(doc => {
                        spaces.push({ id: doc.id, ...doc.data() });
                    });
                    displaySpaces(spaces);
                })
                .catch(error => {
                    console.error('Error loading spaces:', error);
                    spacesContainer.innerHTML = '<div class="text-center py-4 text-theme-secondary">Unable to load spaces</div>';
                });
        }

        // NEW: Display spaces
        function displaySpaces(spaces) {
            if (spaces.length === 0) {
                spacesContainer.innerHTML = '<div class="text-center py-4 text-theme-secondary">You haven\'t joined any spaces yet</div>';
                return;
            }
            
            let html = '';
            spaces.forEach(space => {
                html += `
                    <div class="horizontal-card">
                        <div class="space-header">
                            <img src="${space.avatar || ''}" alt="${space.name}" class="space-avatar">
                            <div class="space-info">
                                <div class="space-name">${space.name}</div>
                                <div class="space-members">${space.memberCount || 0} members</div>
                            </div>
                        </div>
                        <div class="space-description">${space.description || 'No description available'}</div>
                        <div class="space-actions">
                            <div class="space-action-btn space-view-btn">View Space</div>
                        </div>
                    </div>
                `;
            });
            
            spacesContainer.innerHTML = html;
        }

        // NEW: Load events from Firebase
        function loadEvents() {
            if (!currentUser) return;
            
            const now = new Date();
            db.collection('events')
                .where('date', '>=', now)
                .orderBy('date', 'asc')
                .limit(5)
                .get()
                .then(snapshot => {
                    events = [];
                    snapshot.forEach(doc => {
                        events.push({ id: doc.id, ...doc.data() });
                    });
                    displayEvents(events);
                })
                .catch(error => {
                    console.error('Error loading events:', error);
                    eventsContainer.innerHTML = '<div class="text-center py-4 text-theme-secondary">Unable to load events</div>';
                });
        }

        // NEW: Display events
        function displayEvents(events) {
            if (events.length === 0) {
                eventsContainer.innerHTML = '<div class="text-center py-4 text-theme-secondary">No upcoming events</div>';
                return;
            }
            
            let html = '';
            events.forEach(event => {
                const eventDate = event.date.toDate();
                const month = eventDate.toLocaleString('default', { month: 'short' });
                const day = eventDate.getDate();
                
                html += `
                    <div class="horizontal-card">
                        <div class="event-header">
                            <div class="event-date">
                                <div class="event-month">${month}</div>
                                <div class="event-day">${day}</div>
                            </div>
                            <div class="event-info">
                                <div class="event-name">${event.name}</div>
                                <div class="event-details">${event.location || 'Online'} ‚Ä¢ ${event.attendeeCount || 0} attending</div>
                            </div>
                        </div>
                        <div class="event-description">${event.description || 'No description available'}</div>
                        <div class="event-actions">
                            <div class="event-action-btn event-rsvp-btn">RSVP</div>
                        </div>
                    </div>
                `;
            });
            
            eventsContainer.innerHTML = html;
        }

        // NEW: Load reels from Firebase
        function loadReels() {
            if (!currentUser) return;
            
            db.collection('reels')
                .orderBy('timestamp', 'desc')
                .limit(5)
                .get()
                .then(snapshot => {
                    reels = [];
                    snapshot.forEach(doc => {
                        reels.push({ id: doc.id, ...doc.data() });
                    });
                    displayReels(reels);
                })
                .catch(error => {
                    console.error('Error loading reels:', error);
                    reelsContainer.innerHTML = '<div class="text-center py-4 text-theme-secondary">Unable to load reels</div>';
                });
        }

        // NEW: Display reels
        function displayReels(reels) {
            if (reels.length === 0) {
                reelsContainer.innerHTML = '<div class="text-center py-4 text-theme-secondary">No reels available</div>';
                return;
            }
            
            let html = '';
            reels.forEach(reel => {
                html += `
                    <div class="horizontal-card">
                        <div class="flex items-start space-x-3">
                            <img src="${reel.userAvatar || ''}" alt="${reel.userName}'s avatar" class="w-10 h-10 rounded-2xl object-cover cursor-pointer">
                            <div class="flex-1">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="font-semibold text-theme-primary cursor-pointer">${reel.userName}</h3>
                                        <span class="text-xs text-theme-secondary">${formatDate(reel.timestamp?.toDate())}</span>
                                    </div>
                                </div>
                                
                                <div class="reel-container mt-3">
                                    <video class="reel-video" controls>
                                        <source src="${reel.videoUrl}" type="video/mp4">
                                        Your browser does not support the video tag.
                                    </video>
                                    <div class="reel-actions">
                                        <div class="reel-action">
                                            <i class="fas fa-heart"></i>
                                            <span>${reel.likesCount || 0}</span>
                                        </div>
                                        <div class="reel-action">
                                            <i class="fas fa-comment"></i>
                                            <span>${reel.commentsCount || 0}</span>
                                        </div>
                                        <div class="reel-action">
                                            <i class="fas fa-share"></i>
                                            <span>${reel.sharesCount || 0}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            reelsContainer.innerHTML = html;
        }

        // NEW: Load saved posts from Firebase
        function loadSavedPosts() {
            if (!currentUser) return;
            
            db.collection('users').doc(currentUser.uid).collection('savedPosts')
                .orderBy('savedAt', 'desc')
                .limit(5)
                .get()
                .then(snapshot => {
                    const savedPostIds = [];
                    snapshot.forEach(doc => {
                        savedPostIds.push(doc.id);
                    });
                    
                    // Fetch the actual posts
                    if (savedPostIds.length > 0) {
                        db.collection('posts')
                            .where(firebase.firestore.FieldPath.documentId(), 'in', savedPostIds)
                            .get()
                            .then(postsSnapshot => {
                                savedPosts = [];
                                postsSnapshot.forEach(doc => {
                                    savedPosts.push({ id: doc.id, ...doc.data() });
                                });
                                displaySavedPosts(savedPosts);
                            })
                            .catch(error => {
                                console.error('Error loading saved posts:', error);
                                savedContainer.innerHTML = '<div class="text-center py-4 text-theme-secondary">Unable to load saved posts</div>';
                            });
                    } else {
                        savedContainer.innerHTML = '<div class="text-center py-4 text-theme-secondary">No saved posts yet</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading saved posts:', error);
                    savedContainer.innerHTML = '<div class="text-center py-4 text-theme-secondary">Unable to load saved posts</div>';
                });
        }

        // NEW: Display saved posts
        function displaySavedPosts(savedPosts) {
            if (savedPosts.length === 0) {
                savedContainer.innerHTML = '<div class="text-center py-4 text-theme-secondary">No saved posts yet</div>';
                return;
            }
            
            let html = '';
            savedPosts.forEach(post => {
                // Format hashtags and mentions
                let content = post.content || '';
                if (post.hashtags) {
                    post.hashtags.forEach(tag => {
                        content = content.replace(
                            new RegExp(`#${tag}`, 'g'),
                            `<span class="hashtag text-theme-accent cursor-pointer">#${tag}</span>`
                        );
                    });
                }
                
                if (post.mentions) {
                    post.mentions.forEach(mention => {
                        content = content.replace(
                            new RegExp(`@${mention}`, 'g'),
                            `<span class="mention text-theme-accent cursor-pointer">@${mention}</span>`
                        );
                    });
                }
                
                // Check if current user liked the post
                const userLiked = post.likes && post.likes.includes(currentUser.uid);
                
                html += `
                    <div class="post-card p-5 mb-4">
                        <div class="flex items-start space-x-3">
                            <img src="${post.userAvatar || ''}" alt="${post.userName}'s avatar" class="w-10 h-10 rounded-2xl object-cover cursor-pointer">
                            <div class="flex-1">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="font-semibold text-theme-primary cursor-pointer">${post.userName}</h3>
                                        <span class="text-xs text-theme-secondary">${formatDate(post.timestamp?.toDate())}</span>
                                    </div>
                                </div>
                                
                                <div class="mt-3 text-theme-primary">
                                    ${content}
                                </div>
                                
                                <div class="flex items-center justify-between mt-4 pt-3 border-t border-purple-800">
                                    <div class="flex items-center space-x-4 text-theme-secondary">
                                        <div class="relative reaction-container">
                                            <button class="reaction-btn flex items-center space-x-1 ${userLiked ? 'text-red-500' : 'hover:text-theme-accent'} transition" data-post-id="${post.id}">
                                                <i class="fas fa-heart"></i>
                                                <span>${post.likesCount || 0}</span>
                                            </button>
                                        </div>
                                        <button class="comment-btn flex items-center space-x-1 hover:text-theme-accent transition" data-post-id="${post.id}">
                                            <i class="fas fa-comment"></i>
                                            <span>${post.commentsCount || 0}</span>
                                        </button>
                                        <button class="share-btn flex items-center space-x-1 hover:text-theme-accent transition">
                                            <i class="fas fa-share"></i>
                                            <span>${post.sharesCount || 0}</span>
                                        </button>
                                    </div>
                                    <button class="save-post-btn text-theme-accent transition">
                                        <i class="fas fa-bookmark"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            savedContainer.innerHTML = html;
        }

        // NEW: Open profile picture modal
        function openProfilePictureModal() {
            profilePictureModal.classList.add('active');
            profilePicturePreview.src = profileAvatar.src;
        }

        // NEW: Close profile picture modal
        function closeProfilePictureModalFunc() {
            profilePictureModal.classList.remove('active');
            profilePictureFile = null;
        }

        // NEW: Handle profile picture upload
        function handleProfilePictureUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Check if file is an image
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file');
                return;
            }
            
            // Check file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('File size must be less than 5MB');
                return;
            }
            
            // Store file and show preview
            profilePictureFile = file;
            const reader = new FileReader();
            reader.onload = function(e) {
                profilePicturePreview.src = e.target.result;
                document.getElementById('profilePictureFrame').style.opacity = '1';
            };
            reader.readAsDataURL(file);
        }

        // NEW: Save profile picture
        function saveProfilePictureFunc() {
            if (!profilePictureFile) {
                alert('Please select a profile picture');
                return;
            }
            
            // Upload to Cloudinary
            const formData = new FormData();
            formData.append('file', profilePictureFile);
            formData.append('upload_preset', cloudinaryConfig.uploadPreset);
            formData.append('cloud_name', cloudinaryConfig.cloudName);
            
            fetch(`https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/image/upload`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.secure_url) {
                    // Update user document in Firebase
                    return db.collection('users').doc(currentUser.uid).update({
                        userAvatar: data.secure_url
                    });
                } else {
                    throw new Error('Upload failed');
                }
            })
            .then(() => {
                console.log('Profile picture updated');
                showNotification('Profile picture updated successfully!', 'success');
                closeProfilePictureModalFunc();
                
                // Reload user data to reflect changes
                loadUserData();
            })
            .catch(error => {
                console.error('Error updating profile picture:', error);
                showNotification('Error updating profile picture: ' + error.message, 'error');
            });
        }

        // NEW: Open cover photo modal
        function openCoverPhotoModal() {
            coverPhotoModal.classList.add('active');
            coverPhotoPreview.src = profileCover.src || '';
        }

        // NEW: Close cover photo modal
        function closeCoverPhotoModalFunc() {
            coverPhotoModal.classList.remove('active');
            coverPhotoFile = null;
        }

        // NEW: Handle cover photo upload
        function handleCoverPhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Check if file is an image
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file');
                return;
            }
            
            // Check file size (max 10MB)
            if (file.size > 10 * 1024 * 1024) {
                alert('File size must be less than 10MB');
                return;
            }
            
            // Store file and show preview
            coverPhotoFile = file;
            const reader = new FileReader();
            reader.onload = function(e) {
                coverPhotoPreview.src = e.target.result;
                document.getElementById('coverPhotoFrame').style.opacity = '1';
            };
            reader.readAsDataURL(file);
        }

        // NEW: Save cover photo
        function saveCoverPhotoFunc() {
            if (!coverPhotoFile) {
                alert('Please select a cover photo');
                return;
            }
            
            // Upload to Cloudinary
            const formData = new FormData();
            formData.append('file', coverPhotoFile);
            formData.append('upload_preset', cloudinaryConfig.uploadPreset);
            formData.append('cloud_name', cloudinaryConfig.cloudName);
            
            fetch(`https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/image/upload`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.secure_url) {
                    // Update user document in Firebase
                    return db.collection('users').doc(currentUser.uid).update({
                        coverPhoto: data.secure_url
                    });
                } else {
                    throw new Error('Upload failed');
                }
            })
            .then(() => {
                console.log('Cover photo updated');
                showNotification('Cover photo updated successfully!', 'success');
                closeCoverPhotoModalFunc();
                
                // Reload user data to reflect changes
                loadUserData();
            })
            .catch(error => {
                console.error('Error updating cover photo:', error);
                showNotification('Error updating cover photo: ' + error.message, 'error');
            });
        }

        // Toggle theme
        function toggleTheme() {
            const body = document.body;
            if (body.classList.contains('dark-theme')) {
                body.classList.remove('dark-theme');
                body.classList.add('light-theme');
                localStorage.setItem('theme', 'light');
            } else if (body.classList.contains('light-theme')) {
                body.classList.remove('light-theme');
                body.classList.add('cyber-theme');
                localStorage.setItem('theme', 'cyber');
            } else {
                body.classList.remove('cyber-theme');
                body.classList.add('dark-theme');
                localStorage.setItem('theme', 'dark');
            }
        }

        // Toggle emotion options
        function toggleEmotionOptions() {
            emotionOptions.classList.toggle('hidden');
            interestOptions.classList.add('hidden');
        }

        // Toggle interest options
        function toggleInterestOptions() {
            interestOptions.classList.toggle('hidden');
            emotionOptions.classList.add('hidden');
        }

        // Open create post modal
        function openCreatePostModal() {
            if (!currentUser) {
                alert('Please sign in to create a post');
                return;
            }
            createPostModal.classList.add('active');
            modalPostInput.focus();
        }

        // Close create post modal
        function closeCreatePostModal() {
            createPostModal.classList.remove('active');
            setTimeout(() => {
                resetPostModal();
            }, 300);
        }

        // Reset post modal to initial state
        function resetPostModal() {
            modalPostInput.value = '';
            document.getElementById('modalMediaPreview').classList.add('hidden');
            document.getElementById('postMood').value = '';
            document.getElementById('postAudience').value = 'public';
            
            // NEW: Reset tagging system
            taggedUsers = [];
            updateTaggedUsersDisplay();
            tagSuggestions.classList.add('hidden');
            
            // NEW: Reset mood selection
            moodItems.forEach(item => item.classList.remove('active'));
            
            // NEW: Reset audience selection
            audienceOptions.forEach(option => {
                if (option.dataset.audience === 'public') {
                    option.classList.add('active');
                } else {
                    option.classList.remove('active');
                }
            });
            
            // NEW: Hide emoji picker
            emojiPickerContainer.classList.add('hidden');
        }

        // NEW: Open create reel modal
        function openCreateReelModal() {
            if (!currentUser) {
                alert('Please sign in to create a reel');
                return;
            }
            closeCreatePostModal();
            createReelModal.classList.add('active');
        }

        // NEW: Close create reel modal
        function closeCreateReelModal() {
            createReelModal.classList.remove('active');
            setTimeout(() => {
                resetReelModal();
            }, 300);
        }

        // NEW: Reset reel modal to initial state
        function resetReelModal() {
            reelVideoFile = null;
            reelVideoDuration = 0;
            reelVideoPreview.classList.add('hidden');
            reelUploadArea.classList.remove('hidden');
            reelPreviewVideo.src = '';
            reelDuration.textContent = 'Duration: 0s';
        }

        // NEW: Handle user tagging input
        function handleTaggingInput(event) {
            const value = event.target.value;
            const cursorPosition = event.target.selectionStart;
            
            // Check if user is typing @ to tag someone
            const textBeforeCursor = value.substring(0, cursorPosition);
            const lastAtIndex = textBeforeCursor.lastIndexOf('@');
            
            if (lastAtIndex !== -1) {
                const textAfterAt = textBeforeCursor.substring(lastAtIndex + 1);
                const spaceIndex = textAfterAt.indexOf(' ');
                
                if (spaceIndex === -1) {
                    // User is typing a tag without spaces
                    const searchTerm = textAfterAt.toLowerCase();
                    currentTaggingIndex = lastAtIndex;
                    
                    // Show tag suggestions
                    showTagSuggestions(searchTerm);
                    return;
                }
            }
            
            // Hide tag suggestions if not tagging
            tagSuggestions.classList.add('hidden');
        }

        // NEW: Handle tagging keyboard events
        function handleTaggingKeydown(event) {
            if (tagSuggestions.classList.contains('hidden')) return;
            
            if (event.key === 'ArrowDown') {
                event.preventDefault();
                const firstSuggestion = tagSuggestions.querySelector('.tag-suggestion');
                if (firstSuggestion) firstSuggestion.focus();
            } else if (event.key === 'Escape') {
                tagSuggestions.classList.add('hidden');
            }
        }

        // NEW: Show tag suggestions
        function showTagSuggestions(searchTerm) {
            const filteredFriends = friendsList.filter(friend => 
                friend.userName.toLowerCase().includes(searchTerm)
            );
            
            if (filteredFriends.length === 0) {
                tagSuggestions.classList.add('hidden');
                return;
            }
            
            tagSuggestions.innerHTML = '';
            filteredFriends.forEach(friend => {
                const suggestion = document.createElement('div');
                suggestion.className = 'tag-suggestion';
                suggestion.innerHTML = `
                    <img src="${friend.userAvatar}" alt="${friend.userName}">
                    <span>${friend.userName}</span>
                `;
                suggestion.addEventListener('click', () => selectTag(friend));
                tagSuggestions.appendChild(suggestion);
            });
            
            tagSuggestions.classList.remove('hidden');
        }

        // NEW: Select a tag from suggestions
        function selectTag(friend) {
            const text = modalPostInput.value;
            const textBeforeTag = text.substring(0, currentTaggingIndex);
            const textAfterTag = text.substring(currentTaggingIndex).replace(/@[^\s]*/, '');
            
            // Update text with tagged user
            modalPostInput.value = textBeforeTag + `@${friend.userName} ` + textAfterTag;
            
            // Add to tagged users
            if (!taggedUsers.some(tagged => tagged.id === friend.id)) {
                taggedUsers.push(friend);
                updateTaggedUsersDisplay();
            }
            
            // Hide suggestions and focus back on input
            tagSuggestions.classList.add('hidden');
            modalPostInput.focus();
            
            // Set cursor position after the tag
            const newCursorPosition = textBeforeTag.length + friend.userName.length + 2;
            modalPostInput.setSelectionRange(newCursorPosition, newCursorPosition);
        }

        // NEW: Update tagged users display
        function updateTaggedUsersDisplay() {
            taggedUsersContainer.innerHTML = '';
            
            taggedUsers.forEach(user => {
                const tagElement = document.createElement('div');
                tagElement.className = 'tagged-user';
                tagElement.innerHTML = `
                    <img src="${user.userAvatar}" alt="${user.userName}">
                    <span>${user.userName}</span>
                    <span class="remove-tag" data-user-id="${user.id}">√ó</span>
                `;
                taggedUsersContainer.appendChild(tagElement);
            });
            
            // Add event listeners to remove buttons
            document.querySelectorAll('.remove-tag').forEach(button => {
                button.addEventListener('click', function() {
                    const userId = this.dataset.userId;
                    taggedUsers = taggedUsers.filter(user => user.id !== userId);
                    updateTaggedUsersDisplay();
                    
                    // Also remove from text
                    const text = modalPostInput.value;
                    const userName = this.previousElementSibling.textContent;
                    modalPostInput.value = text.replace(`@${userName} `, '');
                });
            });
        }

        // NEW: Handle reel video upload
        function handleReelVideoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Check if file is a video
            if (!file.type.startsWith('video/')) {
                alert('Please select a video file');
                return;
            }
            
            // Create a video element to check duration
            const video = document.createElement('video');
            video.preload = 'metadata';
            
            video.onloadedmetadata = function() {
                window.URL.revokeObjectURL(video.src);
                const duration = video.duration;
                
                // Check if video is within 6 seconds
                if (duration > 6) {
                    alert('Reel videos must be 6 seconds or shorter');
                    return;
                }
                
                // Store video file and duration
                reelVideoFile = file;
                reelVideoDuration = duration;
                
                // Show preview
                reelPreviewVideo.src = URL.createObjectURL(file);
                reelDuration.textContent = `Duration: ${duration.toFixed(1)}s`;
                reelVideoPreview.classList.remove('hidden');
                reelUploadArea.classList.add('hidden');
            };
            
            video.src = URL.createObjectURL(file);
        }

        // Create Post Function - IMPLEMENTED
        async function createPost() {
            if (!currentUser) {
                alert('Please sign in to create a post');
                return;
            }

            const content = modalPostInput.value.trim();
            if (!content && !document.getElementById('modalMediaPreview').classList.contains('hidden')) {
                alert('Please add some content to your post');
                return;
            }
            
            // Get selected mood
            const selectedMoodItem = document.querySelector('.mood-item.active');
            const mood = selectedMoodItem ? selectedMoodItem.dataset.mood : '';
            
            // Get selected audience
            const selectedAudienceOption = document.querySelector('.audience-option.active');
            const audience = selectedAudienceOption ? selectedAudienceOption.dataset.audience : 'public';
            
            // Create post object
            const postData = {
                content: content,
                userId: currentUser.uid,
                userName: userData?.userName || currentUser.displayName || 'Anonymous',
                userAvatar: userData?.userAvatar || currentUser.photoURL || '',
                mood: mood,
                audience: audience,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                likes: [],
                likesCount: 0,
                commentsCount: 0,
                sharesCount: 0,
                viewsCount: 0,
                hashtags: extractHashtags(content),
                mentions: extractMentions(content),
                // NEW: Tagged users
                taggedUsers: taggedUsers.map(user => ({
                    id: user.id,
                    userName: user.userName,
                    userAvatar: user.userAvatar
                })),
                // Kynecta Unique Feature: Post Energy
                energy: calculatePostEnergy(content),
                // Vibe reactions
                vibeReactions: {
                    energy: 0,
                    deep: 0,
                    pure: 0,
                    creative: 0
                },
                // Appreciation count
                appreciationCount: 0
            };
            
            // Handle media upload if present
            const modalPreviewImage = document.getElementById('modalPreviewImage');
            const modalPreviewVideo = document.getElementById('modalPreviewVideo');
            
            if (!modalPreviewImage.classList.contains('hidden')) {
                // Upload image to Cloudinary
                try {
                    const imageUrl = await uploadMediaToCloudinary(modalPreviewImage.src, 'image');
                    postData.mediaUrl = imageUrl;
                    postData.mediaType = 'image';
                } catch (error) {
                    console.error('Error uploading image:', error);
                    showNotification('Error uploading image: ' + error.message, 'error');
                    return;
                }
            } else if (!modalPreviewVideo.classList.contains('hidden')) {
                // Upload video to Cloudinary
                try {
                    const videoUrl = await uploadMediaToCloudinary(modalPreviewVideo.src, 'video');
                    postData.mediaUrl = videoUrl;
                    postData.mediaType = 'video';
                } catch (error) {
                    console.error('Error uploading video:', error);
                    showNotification('Error uploading video: ' + error.message, 'error');
                    return;
                }
            }
            
            // Save to Firebase
            try {
                const docRef = await db.collection('posts').add(postData);
                console.log('Post published with ID: ', docRef.id);
                showNotification('Post published successfully!', 'success');
                closeCreatePostModal();
                
                // Update user's post count
                await updateUserPostCount(1);
                
                // Kynecta Unique Feature: Update user energy
                await updateUserEnergy(5);
                
                // The real-time listener will automatically update the feed
            } catch (error) {
                console.error('Error publishing post: ', error);
                showNotification('Error publishing post: ' + error.message, 'error');
            }
        }

        // NEW: Upload media to Cloudinary
        async function uploadMediaToCloudinary(fileData, type) {
            const formData = new FormData();
            
            // Convert data URL to blob if needed
            let file;
            if (fileData.startsWith('data:')) {
                const response = await fetch(fileData);
                file = await response.blob();
            } else {
                // Handle file object
                file = fileData;
            }
            
            formData.append('file', file);
            formData.append('upload_preset', cloudinaryConfig.uploadPreset);
            formData.append('cloud_name', cloudinaryConfig.cloudName);
            
            const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/${type}/upload`, {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.secure_url) {
                return data.secure_url;
            } else {
                throw new Error('Upload failed');
            }
        }

        // NEW: Load Feed with Real-time Listener - IMPLEMENTED
        function loadFeed() {
            if (!currentUser) return;
            
            loadingIndicator.classList.remove('hidden');
            endOfFeed.classList.add('hidden');
            
            let query = db.collection('posts')
                .orderBy('timestamp', 'desc')
                .limit(20);
            
            // Apply filters if set
            if (currentFilter === 'top') {
                query = query.orderBy('likesCount', 'desc');
            } else if (currentFilter === 'trending') {
                query = query.orderBy('viewsCount', 'desc');
            }
            
            if (currentEmotionFilter) {
                query = query.where('mood', '==', currentEmotionFilter);
            }
            
            // Apply mood-based filtering
            if (currentMoodFilter && currentMoodFilter !== 'all') {
                // Filter by mood if posts have mood metadata
                console.log('Filtering by mood:', currentMoodFilter);
            }
            
            // Set up real-time listener
            query.onSnapshot(snapshot => {
                posts = [];
                snapshot.forEach(doc => {
                    posts.push({ id: doc.id, ...doc.data() });
                });
                
                displayPosts(posts);
                loadingIndicator.classList.add('hidden');
                
                if (snapshot.docs.length > 0) {
                    lastPost = snapshot.docs[snapshot.docs.length - 1];
                    hasMorePosts = true;
                } else {
                    hasMorePosts = false;
                    endOfFeed.classList.remove('hidden');
                }
            }, error => {
                console.error('Error loading posts:', error);
                loadingIndicator.classList.add('hidden');
                showNotification('Error loading posts: ' + error.message, 'error');
            });
        }

        // NEW: Create Reel Function - IMPLEMENTED
        async function createReel() {
            if (!currentUser) {
                alert('Please sign in to create a reel');
                return;
            }

            if (!reelVideoFile) {
                alert('Please select a video for your reel');
                return;
            }
            
            try {
                // Upload video to Cloudinary
                const videoUrl = await uploadMediaToCloudinary(reelVideoFile, 'video');
                
                // Create reel object
                const reelData = {
                    videoUrl: videoUrl,
                    userId: currentUser.uid,
                    userName: userData?.userName || currentUser.displayName || 'Anonymous',
                    userAvatar: userData?.userAvatar || currentUser.photoURL || '',
                    duration: reelVideoDuration,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    likes: [],
                    likesCount: 0,
                    commentsCount: 0,
                    sharesCount: 0,
                    viewsCount: 0
                };
                
                // Save to Firebase
                const docRef = await db.collection('reels').add(reelData);
                console.log('Reel published with ID: ', docRef.id);
                showNotification('Reel published successfully!', 'success');
                closeCreateReelModal();
                
                // Update user's post count
                await updateUserPostCount(1);
                
                // Kynecta Unique Feature: Update user energy
                await updateUserEnergy(5);
                
                // The real-time listener will automatically update the reels section
            } catch (error) {
                console.error('Error publishing reel: ', error);
                showNotification('Error publishing reel: ' + error.message, 'error');
            }
        }

        // Update user post count
        async function updateUserPostCount(increment) {
            if (!currentUser) return;
            
            try {
                await db.collection('users').doc(currentUser.uid).update({
                    postsCount: firebase.firestore.FieldValue.increment(increment)
                });
                
                // Reload user data to reflect changes
                loadUserData();
            } catch (error) {
                console.error('Error updating user post count:', error);
            }
        }

        // Kynecta Unique Feature: Update user energy
        async function updateUserEnergy(points) {
            if (!currentUser) return;
            
            try {
                await db.collection('users').doc(currentUser.uid).update({
                    energy: firebase.firestore.FieldValue.increment(points)
                });
                
                // Reload user data to reflect changes
                loadUserData();
            } catch (error) {
                console.error('Error updating user energy:', error);
            }
        }

        // Kynecta Unique Feature: Update user energy display
        function updateUserEnergyDisplay(energy) {
            const percentage = Math.min(100, energy);
            userEnergyRing.style.background = `conic-gradient(var(--accent-color) ${percentage}%, transparent ${percentage}%)`;
            energyPercentage.textContent = `${percentage}%`;
        }

        // Kynecta Unique Feature: Load user badges
        function loadUserBadges(badges) {
            userBadges.innerHTML = '';
            
            const badgeConfig = {
                'newcomer': { text: 'Newcomer', color: 'bg-blue-500' },
                'contributor': { text: 'Contributor', color: 'bg-green-500' },
                'influencer': { text: 'Influencer', color: 'bg-purple-500' },
                'collaborator': { text: 'Collaborator', color: 'bg-yellow-500' },
                'visionary': { text: 'Visionary', color: 'bg-pink-500' }
            };
            
            badges.forEach(badge => {
                if (badgeConfig[badge]) {
                    const badgeElement = document.createElement('span');
                    badgeElement.className = `kynecta-badge ${badgeConfig[badge].color}`;
                    badgeElement.textContent = badgeConfig[badge].text;
                    userBadges.appendChild(badgeElement);
                }
            });
        }

        // Like Post Function - IMPLEMENTED
        async function likePost(postId) {
            if (!currentUser) {
                alert('Please sign in to like posts');
                return;
            }

            try {
                const postRef = db.collection('posts').doc(postId);
                const postDoc = await postRef.get();
                
                if (!postDoc.exists) {
                    throw new Error('Post does not exist!');
                }
                
                const postData = postDoc.data();
                const likes = postData.likes || [];
                const likesCount = postData.likesCount || 0;
                const userLiked = likes.includes(currentUser.uid);
                
                if (userLiked) {
                    // Remove like
                    const newLikes = likes.filter(uid => uid !== currentUser.uid);
                    await postRef.update({
                        likes: newLikes,
                        likesCount: likesCount - 1
                    });
                    console.log('Post unliked');
                } else {
                    // Add like
                    const newLikes = [...likes, currentUser.uid];
                    await postRef.update({
                        likes: newLikes,
                        likesCount: likesCount + 1
                    });
                    console.log('Post liked');
                    
                    // Kynecta Unique Feature: Update user energy
                    await updateUserEnergy(1);
                }
                
                // Mark post as viewed for automatic hiding
                markPostAsViewed(postId);
            } catch (error) {
                console.error('Error liking post: ', error);
                showNotification('Error liking post: ' + error.message, 'error');
            }
        }

        // Add vibe reaction to post - IMPLEMENTED
        async function addVibeReaction(postId, vibeType) {
            if (!currentUser) {
                alert('Please sign in to react to posts');
                return;
            }

            try {
                const postRef = db.collection('posts').doc(postId);
                const postDoc = await postRef.get();
                
                if (!postDoc.exists) {
                    throw new Error('Post does not exist!');
                }
                
                const postData = postDoc.data();
                const vibeReactions = postData.vibeReactions || {
                    energy: 0,
                    deep: 0,
                    pure: 0,
                    creative: 0
                };
                
                // Increment the selected vibe reaction
                vibeReactions[vibeType] = (vibeReactions[vibeType] || 0) + 1;
                
                await postRef.update({
                    vibeReactions: vibeReactions
                });
                
                console.log(`Added ${vibeType} vibe reaction`);
                
                // Update user energy
                await updateUserEnergy(1);
                
                // Mark post as viewed for automatic hiding
                markPostAsViewed(postId);
            } catch (error) {
                console.error('Error adding reaction: ', error);
                showNotification('Error adding reaction: ' + error.message, 'error');
            }
        }

        // Mark post as viewed for automatic hiding
        function markPostAsViewed(postId) {
            viewedPosts.add(postId);
            
            // Hide the post after a short delay
            setTimeout(() => {
                const postElement = document.querySelector(`[data-post-id="${postId}"]`);
                if (postElement) {
                    postElement.classList.add('hiding');
                    setTimeout(() => {
                        postElement.remove();
                    }, 500);
                }
            }, 1000);
        }

        // Submit Comment Function - IMPLEMENTED
        async function submitComment(postId, commentText) {
            if (!currentUser) {
                alert('Please sign in to comment');
                return;
            }

            if (!commentText.trim()) {
                alert('Please enter a comment');
                return;
            }

            const commentData = {
                userId: currentUser.uid,
                userName: userData?.userName || currentUser.displayName || 'Anonymous',
                userAvatar: userData?.userAvatar || currentUser.photoURL || '',
                content: commentText.trim(),
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                replies: [],
                hasVoiceComment: false
            };

            try {
                const postRef = db.collection('posts').doc(postId);
                const commentRef = postRef.collection('comments').doc();
                
                // Use a batch write to update both the comment and the post's comment count
                const batch = db.batch();
                
                // Add the comment
                batch.set(commentRef, commentData);
                
                // Increment the post's comment count
                batch.update(postRef, {
                    commentsCount: firebase.firestore.FieldValue.increment(1)
                });
                
                await batch.commit();
                
                console.log('Comment added successfully');
                showNotification('Comment added!', 'success');
                
                // Kynecta Unique Feature: Update user energy
                await updateUserEnergy(2);
                
                // Mark post as viewed for automatic hiding
                markPostAsViewed(postId);
            } catch (error) {
                console.error('Error adding comment: ', error);
                showNotification('Error adding comment: ' + error.message, 'error');
            }
        }

        // Handle post media upload
        function handlePostMediaUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const modalMediaPreview = document.getElementById('modalMediaPreview');
            modalMediaPreview.classList.remove('hidden');
            
            // Determine file type
            const fileType = file.type.split('/')[0];
            
            // Hide all media previews first
            document.getElementById('modalPreviewImage').classList.add('hidden');
            document.getElementById('modalPreviewVideo').classList.add('hidden');
            
            // Show appropriate preview
            if (fileType === 'image') {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('modalPreviewImage').src = e.target.result;
                    document.getElementById('modalPreviewImage').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else if (fileType === 'video') {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('modalPreviewVideo').src = e.target.result;
                    document.getElementById('modalPreviewVideo').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        // Handle search
        function handleSearch() {
            const query = searchInput.value.trim();
            if (query.length < 2) {
                // Clear search results if query is too short
                document.getElementById('searchResults').innerHTML = '';
                return;
            }
            
            // Search users and posts
            const usersPromise = db.collection('users')
                .where('userName', '>=', query)
                .where('userName', '<=', query + '\uf8ff')
                .limit(5)
                .get();
                
            const postsPromise = db.collection('posts')
                .where('content', '>=', query)
                .where('content', '<=', query + '\uf8ff')
                .limit(5)
                .get();
            
            Promise.all([usersPromise, postsPromise])
                .then(([usersSnapshot, postsSnapshot]) => {
                    displaySearchResults(usersSnapshot, postsSnapshot, query);
                })
                .catch(error => {
                    console.error('Search error:', error);
                });
        }

        // Display search results
        function displaySearchResults(usersSnapshot, postsSnapshot, query) {
            const searchResults = document.getElementById('searchResults');
            searchResults.innerHTML = '';
            
            if (usersSnapshot.empty && postsSnapshot.empty) {
                searchResults.innerHTML = '<div class="p-4 text-center text-theme-secondary">No results found</div>';
                return;
            }
            
            let html = '<div class="search-results-container p-4">';
            
            // Add users
            if (!usersSnapshot.empty) {
                html += '<div class="mb-4"><h3 class="font-semibold text-theme-accent mb-2">People</h3>';
                usersSnapshot.forEach(doc => {
                    const user = doc.data();
                    html += `
                        <div class="search-result-item p-3 rounded-lg glass mb-2 cursor-pointer hover:bg-purple-900/30 transition flex items-center">
                            <img src="${user.userAvatar || ''}" class="w-8 h-8 rounded-full mr-3">
                            <div>
                                <p class="font-medium">${highlightText(user.userName, query)}</p>
                                <p class="text-xs text-theme-secondary">${user.bio || ''}</p>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            // Add posts
            if (!postsSnapshot.empty) {
                html += '<div class="mb-4"><h3 class="font-semibold text-theme-accent mb-2">Posts</h3>';
                postsSnapshot.forEach(doc => {
                    const post = doc.data();
                    html += `
                        <div class="search-result-item p-3 rounded-lg glass mb-2 cursor-pointer hover:bg-purple-900/30 transition">
                            <p class="text-sm">${highlightText(post.content, query)}</p>
                            <div class="flex items-center mt-2 text-xs text-theme-secondary">
                                <img src="${post.userAvatar}" class="w-4 h-4 rounded-full mr-1">
                                <span>${post.userName}</span>
                                <span class="mx-1">‚Ä¢</span>
                                <span>${formatDate(post.timestamp?.toDate())}</span>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            html += '</div>';
            searchResults.innerHTML = html;
        }

        // Highlight search terms in text
        function highlightText(text, query) {
            if (!text) return '';
            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<mark class="bg-yellow-300 text-black">$1</mark>');
        }

        // Load more posts for infinite scroll
        function loadMorePosts() {
            if (!hasMorePosts || !currentUser) return;
            
            loadingIndicator.classList.remove('hidden');
            
            let query = db.collection('posts')
                .orderBy('timestamp', 'desc')
                .startAfter(lastPost)
                .limit(10);
            
            // Apply filters if set
            if (currentFilter === 'top') {
                query = query.orderBy('likesCount', 'desc');
            } else if (currentFilter === 'trending') {
                query = query.orderBy('viewsCount', 'desc');
            }
            
            if (currentEmotionFilter) {
                query = query.where('mood', '==', currentEmotionFilter);
            }
            
            // Apply mood-based filtering
            if (currentMoodFilter && currentMoodFilter !== 'all') {
                console.log('Filtering by mood:', currentMoodFilter);
            }
            
            query.get()
                .then(snapshot => {
                    const newPosts = [];
                    snapshot.forEach(doc => {
                        newPosts.push({ id: doc.id, ...doc.data() });
                    });
                    
                    posts = [...posts, ...newPosts];
                    displayPosts(posts);
                    loadingIndicator.classList.add('hidden');
                    
                    if (snapshot.docs.length > 0) {
                        lastPost = snapshot.docs[snapshot.docs.length - 1];
                    } else {
                        hasMorePosts = false;
                        endOfFeed.classList.remove('hidden');
                    }
                })
                .catch(error => {
                    console.error('Error loading more posts:', error);
                    loadingIndicator.classList.add('hidden');
                    showNotification('Error loading more posts: ' + error.message, 'error');
                });
        }

        // Reload posts with current filters
        function reloadPosts() {
            if (!currentUser) return;
            feedContainer.innerHTML = '';
            loadFeed();
        }

        // Display posts in the feed
        function displayPosts(postsToDisplay) {
            feedContainer.innerHTML = '';
            
            if (postsToDisplay.length === 0) {
                feedContainer.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <i class="fas fa-inbox text-4xl text-theme-secondary mb-4"></i>
                        <h3 class="text-xl font-semibold text-theme-primary mb-2">No posts found</h3>
                        <p class="text-theme-secondary">Try changing your filters or be the first to post!</p>
                    </div>
                `;
                return;
            }
            
            postsToDisplay.forEach(post => {
                // Skip posts that have been viewed
                if (viewedPosts.has(post.id)) return;
                
                const postElement = createPostElement(post);
                feedContainer.appendChild(postElement);
            });
        }

        // Create a post element
        function createPostElement(post) {
            const postElement = document.createElement('div');
            postElement.className = 'post-card p-5';
            postElement.dataset.postId = post.id;
            
            // Format hashtags and mentions
            let content = post.content || '';
            if (post.hashtags) {
                post.hashtags.forEach(tag => {
                    content = content.replace(
                        new RegExp(`#${tag}`, 'g'),
                        `<span class="hashtag text-theme-accent cursor-pointer">#${tag}</span>`
                    );
                });
            }
            
            if (post.mentions) {
                post.mentions.forEach(mention => {
                    content = content.replace(
                        new RegExp(`@${mention}`, 'g'),
                        `<span class="mention text-theme-accent cursor-pointer">@${mention}</span>`
                    );
                });
            }
            
            // Check if current user liked the post
            const userLiked = post.likes && post.likes.includes(currentUser.uid);
            
            // Vibe reactions
            const vibeReactions = post.vibeReactions || {
                energy: 0,
                deep: 0,
                pure: 0,
                creative: 0
            };
            
            // Appreciation count
            const appreciationCount = post.appreciationCount || 0;
            
            // Post Energy Indicator
            let energyHtml = '';
            if (post.energy) {
                const energyPercentage = Math.min(100, post.energy * 2);
                energyHtml = `
                    <div class="flex items-center mt-2 text-xs text-theme-secondary">
                        <div class="w-16 h-2 bg-gray-700 rounded-full mr-2">
                            <div class="h-2 bg-theme-accent rounded-full" style="width: ${energyPercentage}%"></div>
                        </div>
                        <span>${post.energy} energy</span>
                    </div>
                `;
            }
            
            // NEW: Tagged users display
            let taggedUsersHtml = '';
            if (post.taggedUsers && post.taggedUsers.length > 0) {
                taggedUsersHtml = `
                    <div class="tagged-users mt-2">
                        ${post.taggedUsers.map(user => `
                            <div class="tagged-user">
                                <img src="${user.userAvatar}" alt="${user.userName}">
                                <span>${user.userName}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Media content
            let mediaHtml = '';
            if (post.mediaUrl) {
                if (post.mediaType === 'image') {
                    mediaHtml = `<img src="${post.mediaUrl}" class="media-preview w-full mt-3 rounded-xl" alt="Post image">`;
                } else if (post.mediaType === 'video') {
                    mediaHtml = `<video src="${post.mediaUrl}" class="media-preview w-full mt-3 rounded-xl" controls></video>`;
                }
            }
            
            postElement.innerHTML = `
                <div class="flex items-start space-x-3">
                    <img src="${post.userAvatar || ''}" alt="${post.userName}'s avatar" class="w-10 h-10 rounded-2xl object-cover cursor-pointer" onclick="redirectToChat('${post.userId}')">
                    <div class="flex-1">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="font-semibold text-theme-primary cursor-pointer" onclick="redirectToChat('${post.userId}')">${post.userName}</h3>
                                <div class="flex items-center space-x-2 mt-1">
                                    <span class="text-xs text-theme-secondary">${formatDate(post.timestamp?.toDate())}</span>
                                    ${post.mood ? `<span class="text-xs px-2 py-1 rounded-full bg-theme-accent/20 text-theme-accent">${getMoodEmoji(post.mood)} ${post.mood}</span>` : ''}
                                    ${post.audience === 'friends' ? '<span class="text-xs text-theme-secondary"><i class="fas fa-user-friends mr-1"></i>Friends</span>' : ''}
                                    ${post.audience === 'close-friends' ? '<span class="text-xs text-theme-secondary"><i class="fas fa-star mr-1"></i>Close Friends</span>' : ''}
                                    ${post.audience === 'only-me' ? '<span class="text-xs text-theme-secondary"><i class="fas fa-lock mr-1"></i>Only Me</span>' : ''}
                                </div>
                            </div>
                            <div class="relative">
                                <button class="post-options-btn text-theme-secondary hover:text-theme-accent transition">
                                    <i class="fas fa-ellipsis-h"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="mt-3 text-theme-primary">
                            ${content}
                        </div>
                        
                        ${mediaHtml}
                        
                        ${taggedUsersHtml}
                        
                        ${energyHtml}
                        
                        <!-- Vibe Reactions -->
                        <div class="vibe-reactions mt-3">
                            <div class="vibe-reaction" data-vibe="energy" data-post-id="${post.id}">
                                <span>üî•</span>
                                <span>${vibeReactions.energy || 0}</span>
                            </div>
                            <div class="vibe-reaction" data-vibe="deep" data-post-id="${post.id}">
                                <span>üí≠</span>
                                <span>${vibeReactions.deep || 0}</span>
                            </div>
                            <div class="vibe-reaction" data-vibe="pure" data-post-id="${post.id}">
                                <span>üíö</span>
                                <span>${vibeReactions.pure || 0}</span>
                            </div>
                            <div class="vibe-reaction" data-vibe="creative" data-post-id="${post.id}">
                                <span>üåà</span>
                                <span>${vibeReactions.creative || 0}</span>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between mt-4 pt-3 border-t border-purple-800">
                            <div class="flex items-center space-x-4 text-theme-secondary">
                                <div class="relative reaction-container">
                                    <button class="reaction-btn flex items-center space-x-1 ${userLiked ? 'text-red-500' : 'hover:text-theme-accent'} transition" data-post-id="${post.id}">
                                        <i class="fas fa-heart"></i>
                                        <span>${post.likesCount || 0}</span>
                                    </button>
                                </div>
                                <button class="comment-btn flex items-center space-x-1 hover:text-theme-accent transition" data-post-id="${post.id}">
                                    <i class="fas fa-comment"></i>
                                    <span>${post.commentsCount || 0}</span>
                                </button>
                                <button class="share-btn flex items-center space-x-1 hover:text-theme-accent transition">
                                    <i class="fas fa-share"></i>
                                    <span>${post.sharesCount || 0}</span>
                                </button>
                            </div>
                            <button class="save-post-btn text-theme-secondary hover:text-theme-accent transition">
                                <i class="far fa-bookmark"></i>
                            </button>
                        </div>
                        
                        <!-- Comment Input -->
                        <div class="comment-input mt-4 hidden" data-post-id="${post.id}">
                            <div class="flex items-start space-x-2">
                                <img src="${currentUser.photoURL || ''}" alt="Your avatar" class="w-8 h-8 rounded-full object-cover">
                                <div class="flex-1 flex space-x-2">
                                    <input type="text" placeholder="Write a comment..." class="flex-1 p-2 glass border border-purple-700 rounded-2xl text-sm">
                                    <button class="submit-comment px-3 py-2 rounded-2xl text-sm" style="background: var(--accent-color); color: white;" data-post-id="${post.id}">Post</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Set up event listeners for this post
            setupPostEventListeners(postElement, post);
            
            return postElement;
        }

        // NEW: Redirect to chat with user
        function redirectToChat(userId) {
            window.location.href = `chat.html?uid=${userId}`;
        }

        // Set up event listeners for a post element
        function setupPostEventListeners(postElement, post) {
            // Like button
            const likeBtn = postElement.querySelector('.reaction-btn');
            likeBtn.addEventListener('click', function() {
                likePost(post.id);
            });
            
            // Vibe reaction buttons
            const vibeReactionBtns = postElement.querySelectorAll('.vibe-reaction');
            vibeReactionBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const vibeType = this.dataset.vibe;
                    addVibeReaction(post.id, vibeType);
                });
            });
            
            // Comment button
            const commentBtn = postElement.querySelector('.comment-btn');
            const commentInput = postElement.querySelector('.comment-input');
            commentBtn.addEventListener('click', function() {
                commentInput.classList.toggle('hidden');
            });
            
            // Submit comment
            const submitCommentBtn = postElement.querySelector('.submit-comment');
            const commentInputField = postElement.querySelector('.comment-input input');
            submitCommentBtn.addEventListener('click', function() {
                submitComment(post.id, commentInputField.value);
                commentInputField.value = '';
                commentInput.classList.add('hidden');
            });
            
            // Enter key to submit comment
            commentInputField.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    submitComment(post.id, commentInputField.value);
                    commentInputField.value = '';
                    commentInput.classList.add('hidden');
                }
            });
            
            // Share button
            const shareBtn = postElement.querySelector('.share-btn');
            shareBtn.addEventListener('click', function() {
                sharePost(post.id);
            });
            
            // Save post button
            const saveBtn = postElement.querySelector('.save-post-btn');
            saveBtn.addEventListener('click', function() {
                toggleSavePost(post.id);
                this.querySelector('i').classList.toggle('far');
                this.querySelector('i').classList.toggle('fas');
            });
            
            // Hashtag and mention clicks
            const hashtags = postElement.querySelectorAll('.hashtag');
            hashtags.forEach(tag => {
                tag.addEventListener('click', function() {
                    const hashtag = this.textContent.substring(1);
                    searchInput.value = `#${hashtag}`;
                    handleSearch();
                });
            });
            
            const mentions = postElement.querySelectorAll('.mention');
            mentions.forEach(mention => {
                mention.addEventListener('click', function() {
                    const username = this.textContent.substring(1);
                    searchInput.value = `@${username}`;
                    handleSearch();
                });
            });
        }

        // Share a post
        async function sharePost(postId) {
            if (!currentUser) {
                alert('Please sign in to share posts');
                return;
            }

            try {
                const postRef = db.collection('posts').doc(postId);
                await postRef.update({
                    sharesCount: firebase.firestore.FieldValue.increment(1)
                });
                
                showNotification('Post shared!', 'success');
                
                // Mark post as viewed for automatic hiding
                markPostAsViewed(postId);
            } catch (error) {
                console.error('Error sharing post:', error);
                showNotification('Error sharing post: ' + error.message, 'error');
            }
        }

        // Toggle save post
        function toggleSavePost(postId) {
            if (!currentUser) {
                alert('Please sign in to save posts');
                return;
            }

            showNotification('Post saved to collections!', 'success');
        }

        // Load stories from Firebase
        function loadStories() {
            if (!currentUser) return;
            
            // Fetch stories from Firebase
            db.collection('stories')
                .where('expiresAt', '>', new Date())
                .orderBy('expiresAt', 'asc')
                .limit(20)
                .get()
                .then(snapshot => {
                    currentStories = [];
                    snapshot.forEach(doc => {
                        currentStories.push({ id: doc.id, ...doc.data() });
                    });
                    
                    displayStories(currentStories);
                })
                .catch(error => {
                    console.error('Error loading stories:', error);
                    // Fallback to placeholder if no stories found
                    displayStories([]);
                });
        }

        // Display stories
        function displayStories(stories) {
            storiesContainer.innerHTML = '';
            
            // Add "Create Story" button
            const createStoryElement = document.createElement('div');
            createStoryElement.className = 'flex flex-col items-center space-y-2 flex-shrink-0';
            createStoryElement.innerHTML = `
                <div class="story-ring" id="createStoryBtn">
                    <div class="story-content">
                        <i class="fas fa-plus text-theme-accent"></i>
                    </div>
                </div>
                <span class="text-xs font-semibold text-theme-accent">Your Story</span>
            `;
            storiesContainer.appendChild(createStoryElement);
            
            // Add user stories
            stories.forEach(story => {
                const storyElement = document.createElement('div');
                storyElement.className = 'flex flex-col items-center space-y-2 flex-shrink-0';
                storyElement.innerHTML = `
                    <div class="story-ring" data-story-id="${story.id}">
                        <div class="story-content">
                            <img src="${story.userAvatar || ''}" alt="${story.userName}'s story">
                        </div>
                    </div>
                    <span class="text-xs font-semibold text-theme-primary">${story.userName}</span>
                `;
                storiesContainer.appendChild(storyElement);
                
                // Add click event to open story viewer
                storyElement.querySelector('.story-ring').addEventListener('click', function() {
                    openStoryViewer(story.id);
                });
            });
            
            // Add "Create Story" functionality
            document.getElementById('createStoryBtn').addEventListener('click', function() {
                openCreateStoryModal();
            });
        }

        // Open create story modal
        function openCreateStoryModal() {
            if (!currentUser) {
                alert('Please sign in to create a story');
                return;
            }
            createStoryModal.classList.add('active');
            resetStoryModal();
        }

        // Close create story modal
        function closeCreateStoryModal() {
            createStoryModal.classList.remove('active');
            setTimeout(() => {
                resetStoryModal();
            }, 300);
        }

        // Reset story modal to initial state
        function resetStoryModal() {
            storyTextInput.classList.add('hidden');
            storyMediaPreview.classList.add('hidden');
            storyTextContent.value = '';
            currentStoryType = null;
        }

        // Open story text input
        function openStoryTextInput() {
            storyTextInput.classList.remove('hidden');
            storyMediaPreview.classList.add('hidden');
            currentStoryType = 'text';
            storyTextContent.focus();
        }

        // Handle story media upload
        function handleStoryMediaUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Check file size and type
            const maxSize = 10 * 1024 * 1024; // 10MB
            if (file.size > maxSize) {
                alert('File size must be less than 10MB');
                return;
            }
            
            const fileType = file.type.split('/')[0];
            
            // For videos, check duration (max 6 seconds)
            if (fileType === 'video') {
                const video = document.createElement('video');
                video.preload = 'metadata';
                
                video.onloadedmetadata = function() {
                    window.URL.revokeObjectURL(video.src);
                    if (video.duration > 6) {
                        alert('Video must be 6 seconds or shorter');
                        return;
                    }
                    
                    displayStoryMediaPreview(file, fileType);
                };
                
                video.src = URL.createObjectURL(file);
            } else {
                displayStoryMediaPreview(file, fileType);
            }
        }

        // Display story media preview
        function displayStoryMediaPreview(file, fileType) {
            storyMediaPreview.classList.remove('hidden');
            storyTextInput.classList.add('hidden');
            currentStoryType = fileType;
            
            // Hide all media previews first
            storyPreviewImage.classList.add('hidden');
            storyPreviewVideo.classList.add('hidden');
            
            // Show appropriate preview
            if (fileType === 'image') {
                const reader = new FileReader();
                reader.onload = function(e) {
                    storyPreviewImage.src = e.target.result;
                    storyPreviewImage.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else if (fileType === 'video') {
                const reader = new FileReader();
                reader.onload = function(e) {
                    storyPreviewVideo.src = e.target.result;
                    storyPreviewVideo.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        // Create Story Function
        function createStory() {
            if (!currentUser) {
                alert('Please sign in to create a story');
                return;
            }

            if (!currentStoryType) {
                alert('Please add content to your story');
                return;
            }
            
            // Get selected audience
            const selectedAudienceOption = document.querySelector('.audience-option.active');
            const audience = selectedAudienceOption ? selectedAudienceOption.dataset.audience : 'public';
            
            // Create story object
            const storyData = {
                userId: currentUser.uid,
                userName: userData?.userName || currentUser.displayName || 'Anonymous',
                userAvatar: userData?.userAvatar || currentUser.photoURL || '',
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000), // 24 hours from now
                audience: audience,
                views: [],
                viewsCount: 0
            };
            
            // Add content based on story type
            if (currentStoryType === 'text') {
                const content = storyTextContent.value.trim();
                if (!content) {
                    alert('Please add text to your story');
                    return;
                }
                storyData.content = content;
                storyData.mediaType = 'text';
                
                // Save text story to Firebase
                saveStoryToFirebase(storyData);
            } else if (currentStoryType === 'image' || currentStoryType === 'video') {
                // Upload media to Cloudinary
                const fileInput = currentStoryType === 'image' ? 
                    document.getElementById('storyImageInput') : 
                    document.getElementById('storyVideoInput');
                
                const file = fileInput.files[0];
                if (!file) {
                    alert('Please select a file');
                    return;
                }
                
                uploadToCloudinary(file, storyData);
            }
        }

        // Upload media to Cloudinary
        function uploadToCloudinary(file, storyData) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', cloudinaryConfig.uploadPreset);
            formData.append('cloud_name', cloudinaryConfig.cloudName);
            
            fetch(`https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/${file.type.startsWith('video') ? 'video' : 'image'}/upload`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.secure_url) {
                    storyData.mediaUrl = data.secure_url;
                    storyData.mediaType = file.type.startsWith('video') ? 'video' : 'image';
                    
                    // Save story to Firebase
                    saveStoryToFirebase(storyData);
                } else {
                    throw new Error('Upload failed');
                }
            })
            .catch(error => {
                console.error('Error uploading to Cloudinary:', error);
                showNotification('Error uploading media: ' + error.message, 'error');
            });
        }

        // Save story to Firebase
        function saveStoryToFirebase(storyData) {
            db.collection('stories').add(storyData)
                .then(docRef => {
                    console.log('Story published with ID: ', docRef.id);
                    showNotification('Story published successfully!', 'success');
                    closeCreateStoryModal();
                    loadStories();
                })
                .catch(error => {
                    console.error('Error publishing story: ', error);
                    showNotification('Error publishing story: ' + error.message, 'error');
                });
        }

        // Open story viewer
        function openStoryViewer(storyId) {
            const story = currentStories.find(s => s.id === storyId);
            if (!story) return;
            
            // Set current story index
            currentStoryIndex = currentStories.findIndex(s => s.id === storyId);
            
            // Display the story
            displayStory(story);
            
            // Show the story viewer
            storyViewer.classList.add('active');
            
            // Start auto-advance timer
            startStoryTimer();
            
            // Mark story as viewed
            markStoryAsViewed(storyId);
        }

        // Display a story in the viewer
        function displayStory(story) {
            // Clear previous content
            storyContentViewer.innerHTML = '';
            storyProgress.innerHTML = '';
            
            // Create progress bars for each story
            currentStories.forEach((s, index) => {
                const progressBar = document.createElement('div');
                progressBar.className = 'story-progress-bar';
                progressBar.innerHTML = `<div class="story-progress-fill" ${index === currentStoryIndex ? 'style="width: 0%"' : ''}></div>`;
                storyProgress.appendChild(progressBar);
            });
            
            // Display story content
            if (story.mediaType === 'image') {
                const img = document.createElement('img');
                img.src = story.mediaUrl;
                img.alt = 'Story image';
                storyContentViewer.appendChild(img);
            } else if (story.mediaType === 'video') {
                const video = document.createElement('video');
                video.src = story.mediaUrl;
                video.controls = true;
                video.autoplay = true;
                video.muted = true; // Muted autoplay
                storyContentViewer.appendChild(video);
            } else {
                // Text story
                const textContainer = document.createElement('div');
                textContainer.className = 'p-8 text-center';
                textContainer.innerHTML = `
                    <h2 class="text-2xl font-bold mb-4">${story.userName}</h2>
                    <p class="text-lg">${story.content}</p>
                `;
                textContainer.style.background = 'var(--card-bg)';
                textContainer.style.color = 'var(--text-primary)';
                textContainer.style.width = '100%';
                textContainer.style.height = '100%';
                textContainer.style.display = 'flex';
                textContainer.style.flexDirection = 'column';
                textContainer.style.justifyContent = 'center';
                textContainer.style.alignItems = 'center';
                storyContentViewer.appendChild(textContainer);
            }
        }

        // Start story timer for auto-advance
        function startStoryTimer() {
            // Clear any existing timer
            if (storyInterval) clearInterval(storyInterval);
            
            // Get current progress bar
            const currentProgressBar = storyProgress.children[currentStoryIndex].querySelector('.story-progress-fill');
            
            // Reset progress
            currentProgressBar.style.width = '0%';
            
            // Start timer
            let progress = 0;
            storyInterval = setInterval(() => {
                progress += 1;
                currentProgressBar.style.width = `${progress}%`;
                
                if (progress >= 100) {
                    showNextStory();
                }
            }, 50); // 5 seconds total for each story
        }

        // Show next story
        function showNextStory() {
            if (currentStoryIndex < currentStories.length - 1) {
                currentStoryIndex++;
                displayStory(currentStories[currentStoryIndex]);
                startStoryTimer();
                
                // Mark story as viewed
                markStoryAsViewed(currentStories[currentStoryIndex].id);
            } else {
                closeStoryViewer();
            }
        }

        // Show previous story
        function showPreviousStory() {
            if (currentStoryIndex > 0) {
                currentStoryIndex--;
                displayStory(currentStories[currentStoryIndex]);
                startStoryTimer();
            }
        }

        // Mark story as viewed
        function markStoryAsViewed(storyId) {
            if (!currentUser) return;
            
            const storyRef = db.collection('stories').doc(storyId);
            
            // Use a transaction to safely update the views
            db.runTransaction(transaction => {
                return transaction.get(storyRef).then(storyDoc => {
                    if (!storyDoc.exists) {
                        throw new Error('Story does not exist!');
                    }
                    
                    const storyData = storyDoc.data();
                    const views = storyData.views || [];
                    
                    // Add user to views if not already viewed
                    if (!views.includes(currentUser.uid)) {
                        views.push(currentUser.uid);
                        transaction.update(storyRef, {
                            views: views,
                            viewsCount: views.length
                        });
                    }
                    
                    return true;
                });
            }).then(success => {
                console.log('Story marked as viewed');
            }).catch(error => {
                console.error('Error marking story as viewed: ', error);
            });
        }

        // Close story viewer
        function closeStoryViewer() {
            storyViewer.classList.remove('active');
            if (storyInterval) clearInterval(storyInterval);
        }

        // Load trending topics from Firebase
        function loadTrendingTopics() {
            if (!currentUser) return;
            
            // Fetch trending topics from Firebase
            db.collection('trending')
                .orderBy('count', 'desc')
                .limit(5)
                .get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        trendingTopicsContainer.innerHTML = '<div class="text-theme-secondary p-4 text-center"><p>No trending topics</p></div>';
                        return;
                    }
                    
                    let html = '<div class="space-y-3">';
                    snapshot.forEach(doc => {
                        const topic = doc.data();
                        html += `
                            <div class="flex justify-between items-center">
                                <span class="text-theme-primary">${topic.hashtag}</span>
                                <span class="text-xs text-theme-secondary">${topic.count} posts</span>
                            </div>
                        `;
                    });
                    html += '</div>';
                    trendingTopicsContainer.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error loading trending topics:', error);
                });
        }

        // Load suggested users from Firebase
        function loadSuggestedUsers() {
            if (!currentUser) return;
            
            // Fetch suggested users from Firebase
            db.collection('users')
                .where('userId', '!=', currentUser.uid)
                .limit(5)
                .get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        suggestedUsersContainer.innerHTML = '<div class="text-theme-secondary p-4 text-center"><p>No suggestions available</p></div>';
                        return;
                    }
                    
                    let html = '<div class="space-y-4">';
                    snapshot.forEach(doc => {
                        const user = doc.data();
                        html += `
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <img src="${user.userAvatar || ''}" class="w-10 h-10 rounded-full">
                                    <div>
                                        <p class="text-sm font-semibold text-theme-primary">${user.userName}</p>
                                        <p class="text-xs text-theme-secondary">${user.followersCount || 0} followers</p>
                                    </div>
                                </div>
                                <button class="text-xs bg-theme-accent text-white px-3 py-1 rounded-full">Follow</button>
                            </div>
                        `;
                    });
                    html += '</div>';
                    suggestedUsersContainer.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error loading suggested users:', error);
                });
        }

        // Utility Functions

        // Extract hashtags from text
        function extractHashtags(text) {
            if (!text) return [];
            const hashtags = text.match(/#\w+/g) || [];
            return hashtags.map(tag => tag.substring(1));
        }

        // Extract mentions from text
        function extractMentions(text) {
            if (!text) return [];
            const mentions = text.match(/@\w+/g) || [];
            return mentions.map(mention => mention.substring(1));
        }

        // Calculate post energy
        function calculatePostEnergy(content) {
            // Simple algorithm to calculate post "energy" based on content
            let energy = 0;
            
            // Base energy
            energy += Math.min(content.length / 10, 10);
            
            // Bonus for hashtags
            const hashtags = extractHashtags(content);
            energy += hashtags.length * 2;
            
            // Bonus for mentions
            const mentions = extractMentions(content);
            energy += mentions.length * 2;
            
            // Bonus for questions
            if (content.includes('?')) energy += 5;
            
            return Math.min(energy, 50);
        }

        // Format date
        function formatDate(date) {
            if (!date) return 'Just now';
            
            const now = new Date();
            const diffMs = now - date;
            const diffSecs = Math.floor(diffMs / 1000);
            const diffMins = Math.floor(diffSecs / 60);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffSecs < 60) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            
            return date.toLocaleDateString();
        }

        // Get mood emoji
        function getMoodEmoji(mood) {
            const moodEmojis = {
                joy: 'üòÑ',
                love: '‚ù§Ô∏è',
                calm: 'üòå',
                excited: 'ü§©',
                sad: 'üò¢',
                angry: 'üò†'
            };
            return moodEmojis[mood] || 'üòä';
        }

        // Show notification
        function showNotification(message, type) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed top-4 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-2xl z-50 ${type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'} text-white font-semibold shadow-lg`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Debounce function for performance
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>