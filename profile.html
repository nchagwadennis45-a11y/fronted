<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - Kynecta</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <link rel="stylesheet" href="responsive.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    
    <style>
        .glass-effect {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        .primary-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .cyber-gradient {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .neon-glow {
            box-shadow: 0 0 20px rgba(79, 172, 254, 0.4);
        }
        
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 0.85rem;
            z-index: 1000;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid;
        }
        .connection-status.connected {
            background: rgba(34, 197, 94, 0.15);
            color: #4ade80;
            border-color: rgba(34, 197, 94, 0.4);
        }
        .connection-status.connecting {
            background: rgba(251, 191, 36, 0.15);
            color: #fbbf24;
            border-color: rgba(251, 191, 36, 0.4);
        }
        .connection-status.error {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.4);
        }

        .profile-cover {
            height: 280px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
            border-radius: 20px 20px 0 0;
            overflow: hidden;
        }
        .profile-avatar {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            border: 4px solid rgba(255, 255, 255, 0.3);
            position: absolute;
            bottom: -70px;
            left: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 48px;
            background-size: cover;
            background-position: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .profile-stats {
            display: flex;
            justify-content: space-around;
            margin: 30px 0;
            text-align: center;
        }
        .stat-item {
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 15px;
        }
        .stat-item:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateY(-5px);
        }
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .profile-tabs {
            display: flex;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 25px;
            overflow-x: auto;
        }
        .profile-tab {
            padding: 18px 25px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            white-space: nowrap;
            position: relative;
            color: #93C5FD;
            font-weight: 500;
        }
        .profile-tab.active {
            border-bottom: 3px solid #667eea;
            color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), transparent);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 15px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.4);
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        .feature-card:hover {
            transform: translateY(-8px);
            border-color: rgba(102, 126, 234, 0.3);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .loading-spinner {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(102, 126, 234, 0.3);
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .social-media-icons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }
        .social-icon {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }
        .social-icon:hover {
            transform: translateY(-5px) scale(1.1);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.3);
        }

        .mood-selector {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .mood-option {
            padding: 10px 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
            border: 1px solid transparent;
        }
        .mood-option:hover, .mood-option.active {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }
        .skill-tag {
            display: inline-block;
            background: rgba(102, 126, 234, 0.2);
            color: #93C5FD;
            padding: 8px 15px;
            border-radius: 20px;
            margin: 5px;
            font-size: 0.9rem;
            border: 1px solid rgba(102, 126, 234, 0.3);
        }
        .online-status {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #10B981;
            position: absolute;
            bottom: 10px;
            right: 10px;
            border: 2px solid white;
        }
        .interest-bubble {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            margin: 5px;
            display: inline-block;
            font-size: 0.9rem;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .completion-bar {
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.1);
            overflow: hidden;
            margin-top: 8px;
        }
        .completion-fill {
            height: 100%;
            border-radius: 3px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            transition: width 0.5s ease;
        }
        
        .mood-glow-happy {
            box-shadow: 0 0 20px rgba(250, 204, 21, 0.5);
        }
        .mood-glow-productive {
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.5);
        }
        .mood-glow-creative {
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.5);
        }
        .mood-glow-focused {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
        }
        .mood-glow-relaxed {
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.5);
        }
        
        .fade-in {
            opacity: 0;
            animation: fadeIn 1s ease forwards;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .badge {
            display: inline-flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 5px 12px;
            margin: 0 5px 5px 0;
            font-size: 0.8rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .badge.verified {
            background: rgba(34, 197, 94, 0.2);
            border-color: rgba(34, 197, 94, 0.4);
            color: #4ade80;
        }
        .badge.top-contributor {
            background: rgba(249, 115, 22, 0.2);
            border-color: rgba(249, 115, 22, 0.4);
            color: #fb923c;
        }
        
        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        .media-item {
            aspect-ratio: 1;
            border-radius: 10px;
            overflow: hidden;
            background-size: cover;
            background-position: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .media-item:hover {
            transform: scale(1.05);
        }
        
        .theme-toggle {
            position: relative;
            width: 60px;
            height: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .theme-toggle:after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        .theme-toggle.dark:after {
            transform: translateX(30px);
        }
        
        .follow-btn {
            position: relative;
            overflow: hidden;
        }
        .follow-btn:after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }
        .follow-btn:focus:not(:active)::after {
            animation: ripple 1s ease-out;
        }
        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            100% {
                transform: scale(20, 20);
                opacity: 0;
            }
        }
        
        .diary-entry {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }
        
        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin: 5px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .color-option.active {
            border-color: white;
            transform: scale(1.2);
        }
        
        .privacy-option {
            padding: 12px 16px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .privacy-option.active {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .music-player {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .engagement-bar {
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.1);
            margin: 2px 0;
        }
        .engagement-fill {
            height: 100%;
            border-radius: 3px;
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }
        .particle {
            position: absolute;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            animation: float 6s infinite ease-in-out;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        .holographic {
            background: linear-gradient(45deg, 
                rgba(102, 126, 234, 0.1), 
                rgba(139, 92, 246, 0.1), 
                rgba(79, 172, 254, 0.1));
            background-size: 400% 400%;
            animation: holographic 8s ease infinite;
        }
        @keyframes holographic {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .cyber-grid {
            background: 
                linear-gradient(rgba(102, 126, 234, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(102, 126, 234, 0.1) 1px, transparent 1px);
            background-size: 50px 50px;
        }

        .friends-sidebar {
            width: 350px;
            background: rgba(255, 255, 255, 0.05);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            overflow-y: auto;
        }
        .friend-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        .friend-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }
        .friend-item.active {
            background: rgba(102, 126, 234, 0.15);
            border-left: 3px solid #667eea;
        }
        .friend-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 12px;
            background-size: cover;
            background-position: center;
        }
        .friend-info {
            flex: 1;
        }
        .friend-name {
            font-weight: 600;
            color: white;
        }
        .friend-status {
            font-size: 0.8rem;
            color: #93C5FD;
        }
        .friend-online {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10B981;
            margin-left: auto;
        }
        .friend-offline {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #6B7280;
            margin-left: auto;
        }

        .chat-window {
            display: none;
            flex-direction: column;
            height: 100%;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            overflow: hidden;
        }
        .chat-header {
            padding: 16px 20px;
            background: rgba(255, 255, 255, 0.08);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
        }
        .chat-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 12px;
        }
        .chat-name {
            font-weight: 600;
            color: white;
        }
        .chat-status {
            font-size: 0.8rem;
            color: #93C5FD;
            margin-left: auto;
        }
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .message {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
        }
        .message.sent {
            align-self: flex-end;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-bottom-right-radius: 4px;
        }
        .message.received {
            align-self: flex-start;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-bottom-left-radius: 4px;
        }
        .message-sender {
            font-size: 0.8rem;
            margin-bottom: 4px;
            opacity: 0.8;
        }
        .message-time {
            font-size: 0.7rem;
            opacity: 0.6;
            margin-top: 4px;
            text-align: right;
        }
        .chat-input-container {
            padding: 16px 20px;
            background: rgba(255, 255, 255, 0.08);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 12px;
        }
        .chat-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 24px;
            padding: 12px 20px;
            color: white;
            outline: none;
        }
        .chat-input:focus {
            border-color: #667eea;
        }
        .send-button {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .send-button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .no-chat-selected {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #93C5FD;
            text-align: center;
            padding: 40px;
        }
        .no-chat-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .friend-request-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        .request-actions {
            display: flex;
            gap: 8px;
            margin-left: auto;
        }
        .accept-btn {
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .reject-btn {
            background: rgba(239, 68, 68, 0.2);
            color: #EF4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .suggestion-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        .add-friend-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-left: auto;
        }

        .search-container {
            padding: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .search-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 10px 16px;
            color: white;
            outline: none;
        }
        .search-input:focus {
            border-color: #667eea;
        }
        .search-results {
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="h-full bg-gradient-to-br from-gray-900 via-blue-900 to-purple-900 text-white">
    <!-- Floating Particles -->
    <div class="particles" id="particles"></div>

    <!-- Connection Status -->
    <div class="connection-status connecting" id="connectionStatus">
        <i class="fas fa-circle-notch fa-spin mr-2"></i>
        <span id="connectionText">Connecting to Kynecta...</span>
    </div>

    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loadingSpinner">
        <div class="glass-effect rounded-2xl p-8 border border-blue-700 flex items-center space-x-4">
            <div class="spinner"></div>
            <span class="text-blue-300 text-lg">Loading your profile...</span>
        </div>
    </div>

    <!-- Image Cropper Modal -->
    <div class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50" id="cropperModal">
        <div class="bg-gray-800 rounded-2xl p-6 max-w-2xl w-full mx-4">
            <h3 class="text-xl font-bold text-blue-300 mb-4 text-center" id="cropperTitle">Crop Image</h3>
            <img id="cropperImage" class="w-full max-h-96 object-contain mb-4">
            <div class="flex justify-center space-x-4">
                <button id="cancelCrop" class="px-6 py-2 glass-effect text-blue-400 rounded-xl hover:bg-blue-800/30 transition">
                    Cancel
                </button>
                <button id="applyCrop" class="px-6 py-2 primary-gradient text-white rounded-xl hover:scale-105 transition">
                    Apply Crop
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50" id="editProfileModal">
        <div class="bg-gray-800 rounded-2xl p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold text-blue-300 mb-4 text-center">Edit Profile</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-blue-300 mb-2">Display Name</label>
                    <input type="text" id="editDisplayName" class="w-full glass-effect border border-blue-700 rounded-xl px-4 py-3 text-white">
                </div>
                <div>
                    <label class="block text-blue-300 mb-2">Username</label>
                    <div class="flex space-x-2">
                        <input type="text" id="editUsername" class="flex-1 glass-effect border border-blue-700 rounded-xl px-4 py-3 text-white">
                        <button id="checkUsername" class="px-4 py-3 glass-effect text-blue-400 rounded-xl hover:bg-blue-800/30 transition">
                            Check
                        </button>
                    </div>
                    <div id="usernameAvailability" class="mt-2 text-sm hidden"></div>
                </div>
                <div>
                    <label class="block text-blue-300 mb-2">Bio</label>
                    <textarea id="editBio" class="w-full glass-effect border border-blue-700 rounded-xl px-4 py-3 text-white" rows="3"></textarea>
                </div>
                <div>
                    <label class="block text-blue-300 mb-2">Location</label>
                    <input type="text" id="editLocation" class="w-full glass-effect border border-blue-700 rounded-xl px-4 py-3 text-white">
                </div>
                <div>
                    <label class="block text-blue-300 mb-2">Interests</label>
                    <div class="flex flex-wrap gap-2 mb-2" id="editInterestsContainer"></div>
                    <div class="flex space-x-2">
                        <input type="text" id="newInterestInput" placeholder="Add an interest..." class="flex-1 glass-effect border border-blue-700 rounded-xl px-4 py-3 text-white">
                        <button id="addInterestBtn" class="px-4 py-3 glass-effect text-blue-400 rounded-xl hover:bg-blue-800/30 transition">
                            Add
                        </button>
                    </div>
                </div>
                <div>
                    <label class="block text-blue-300 mb-2">Skills</label>
                    <div class="flex flex-wrap gap-2 mb-2" id="editSkillsContainer"></div>
                    <div class="flex space-x-2">
                        <input type="text" id="newSkillInput" placeholder="Add a skill..." class="flex-1 glass-effect border border-blue-700 rounded-xl px-4 py-3 text-white">
                        <button id="addSkillBtn" class="px-4 py-3 glass-effect text-blue-400 rounded-xl hover:bg-blue-800/30 transition">
                            Add
                        </button>
                    </div>
                </div>
                <div>
                    <label class="block text-blue-300 mb-2">Social Links</label>
                    <div class="space-y-3">
                        <div class="flex items-center space-x-2">
                            <i class="fab fa-twitter text-blue-400 w-5"></i>
                            <input type="text" id="editTwitter" placeholder="Twitter URL" class="flex-1 glass-effect border border-blue-700 rounded-xl px-4 py-3 text-white">
                        </div>
                        <div class="flex items-center space-x-2">
                            <i class="fab fa-instagram text-pink-500 w-5"></i>
                            <input type="text" id="editInstagram" placeholder="Instagram URL" class="flex-1 glass-effect border border-blue-700 rounded-xl px-4 py-3 text-white">
                        </div>
                        <div class="flex items-center space-x-2">
                            <i class="fab fa-facebook text-blue-600 w-5"></i>
                            <input type="text" id="editFacebook" placeholder="Facebook URL" class="flex-1 glass-effect border border-blue-700 rounded-xl px-4 py-3 text-white">
                        </div>
                        <div class="flex items-center space-x-2">
                            <i class="fab fa-linkedin text-blue-400 w-5"></i>
                            <input type="text" id="editLinkedin" placeholder="LinkedIn URL" class="flex-1 glass-effect border border-blue-700 rounded-xl px-4 py-3 text-white">
                        </div>
                        <div class="flex items-center space-x-2">
                            <i class="fab fa-github text-gray-400 w-5"></i>
                            <input type="text" id="editGithub" placeholder="GitHub URL" class="flex-1 glass-effect border border-blue-700 rounded-xl px-4 py-3 text-white">
                        </div>
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-globe text-green-400 w-5"></i>
                            <input type="text" id="editWebsite" placeholder="Personal Website" class="flex-1 glass-effect border border-blue-700 rounded-xl px-4 py-3 text-white">
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-blue-300 mb-2">Profile Privacy</label>
                    <div class="space-y-2">
                        <div class="privacy-option" data-privacy="public">
                            <div class="flex items-center">
                                <i class="fas fa-globe-americas text-green-400 mr-3"></i>
                                <div>
                                    <div class="font-medium text-white">Public</div>
                                    <div class="text-blue-300 text-sm">Anyone can see your profile</div>
                                </div>
                            </div>
                        </div>
                        <div class="privacy-option" data-privacy="friends">
                            <div class="flex items-center">
                                <i class="fas fa-user-friends text-blue-400 mr-3"></i>
                                <div>
                                    <div class="font-medium text-white">Friends Only</div>
                                    <div class="text-blue-300 text-sm">Only your connections can see your profile</div>
                                </div>
                            </div>
                        </div>
                        <div class="privacy-option" data-privacy="private">
                            <div class="flex items-center">
                                <i class="fas fa-lock text-red-400 mr-3"></i>
                                <div>
                                    <div class="font-medium text-white">Private</div>
                                    <div class="text-blue-300 text-sm">Only you can see your profile</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-blue-300 mb-2">Profile Theme Color</label>
                    <div class="flex flex-wrap" id="colorOptions">
                        <div class="color-option bg-gradient-to-br from-blue-500 to-purple-600 active" data-color="blue-purple"></div>
                        <div class="color-option bg-gradient-to-br from-green-500 to-blue-600" data-color="green-blue"></div>
                        <div class="color-option bg-gradient-to-br from-red-500 to-pink-600" data-color="red-pink"></div>
                        <div class="color-option bg-gradient-to-br from-yellow-500 to-orange-600" data-color="yellow-orange"></div>
                        <div class="color-option bg-gradient-to-br from-teal-500 to-cyan-600" data-color="teal-cyan"></div>
                    </div>
                </div>
            </div>
            <div class="flex justify-center space-x-4 mt-6">
                <button id="cancelEdit" class="px-6 py-2 glass-effect text-blue-400 rounded-xl hover:bg-blue-800/30 transition">
                    Cancel
                </button>
                <button id="saveProfile" class="px-6 py-2 primary-gradient text-white rounded-xl hover:scale-105 transition">
                    Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- Diary Entry Modal -->
    <div class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50" id="diaryModal">
        <div class="bg-gray-800 rounded-2xl p-6 max-w-2xl w-full mx-4">
            <h3 class="text-xl font-bold text-blue-300 mb-4 text-center">Add Diary Entry</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-blue-300 mb-2">Title</label>
                    <input type="text" id="diaryTitle" class="w-full glass-effect border border-blue-700 rounded-xl px-4 py-3 text-white" placeholder="What's on your mind?">
                </div>
                <div>
                    <label class="block text-blue-300 mb-2">Entry</label>
                    <textarea id="diaryContent" class="w-full glass-effect border border-blue-700 rounded-xl px-4 py-3 text-white" rows="6" placeholder="Share your thoughts..."></textarea>
                </div>
                <div>
                    <label class="block text-blue-300 mb-2">Mood</label>
                    <div class="flex space-x-2" id="diaryMoodOptions">
                        <button class="mood-option flex-1" data-mood="happy">
                            <i class="fas fa-smile text-yellow-400 mr-2"></i>
                            Happy
                        </button>
                        <button class="mood-option flex-1" data-mood="productive">
                            <i class="fas fa-rocket text-green-400 mr-2"></i>
                            Productive
                        </button>
                        <button class="mood-option flex-1" data-mood="creative">
                            <i class="fas fa-palette text-purple-400 mr-2"></i>
                            Creative
                        </button>
                    </div>
                </div>
                <div>
                    <label class="block text-blue-300 mb-2">Privacy</label>
                    <select id="diaryPrivacy" class="w-full glass-effect border border-blue-700 rounded-xl px-4 py-3 text-white">
                        <option value="private">Private (Only me)</option>
                        <option value="friends">Friends Only</option>
                        <option value="public">Public</option>
                    </select>
                </div>
            </div>
            <div class="flex justify-center space-x-4 mt-6">
                <button id="cancelDiary" class="px-6 py-2 glass-effect text-blue-400 rounded-xl hover:bg-blue-800/30 transition">
                    Cancel
                </button>
                <button id="saveDiary" class="px-6 py-2 primary-gradient text-white rounded-xl hover:scale-105 transition">
                    Save Entry
                </button>
            </div>
        </div>
    </div>

    <!-- Find Friends Modal -->
    <div class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50" id="findFriendsModal">
        <div class="bg-gray-800 rounded-2xl p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
            <h3 class="text-xl font-bold text-blue-300 mb-4 text-center">Find Friends</h3>
            <div class="space-y-4">
                <div class="search-container">
                    <input type="text" id="friendSearchInput" placeholder="Search by name, email, or phone..." class="search-input">
                </div>
                <div class="search-results" id="friendSearchResults">
                    <!-- Search results will appear here -->
                </div>
                <div>
                    <h4 class="text-lg font-bold text-blue-300 mb-3">People You May Know</h4>
                    <div id="peopleYouMayKnow">
                        <!-- Suggestions will appear here -->
                    </div>
                </div>
            </div>
            <div class="flex justify-center mt-6">
                <button id="closeFindFriends" class="px-6 py-2 glass-effect text-blue-400 rounded-xl hover:bg-blue-800/30 transition">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Profile Layout -->
    <div class="flex h-full hidden" id="profileLayout">
        <!-- Navigation Sidebar -->
        <div class="w-20 lg:w-64 glass-effect border-r border-blue-800 flex flex-col">
            <div class="p-4">
                <a href="integration.html" class="flex items-center space-x-3">
                    <div class="w-10 h-10 cyber-gradient rounded-2xl flex items-center justify-center neon-glow">
                        <i class="fas fa-brain text-white"></i>
                    </div>
                    <span class="hidden lg:block text-xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-400">
                        Kynecta
                    </span>
                </a>
            </div>

            <nav class="flex-1 px-2 lg:px-4 space-y-2">
                <a href="home.html" class="flex items-center space-x-3 p-3 rounded-xl text-blue-300 hover:bg-blue-900/30 hover:text-cyan-400 transition">
                    <i class="fas fa-home w-6"></i>
                    <span class="hidden lg:block">Feed</span>
                </a>
                <a href="chat.html" class="flex items-center space-x-3 p-3 rounded-xl text-blue-300 hover:bg-blue-900/30 hover:text-cyan-400 transition">
                    <i class="fas fa-comment-dots w-6"></i>
                    <span class="hidden lg:block">Chat</span>
                </a>
                <a href="notifications.html" class="flex items-center space-x-3 p-3 rounded-xl text-blue-300 hover:bg-blue-900/30 hover:text-cyan-400 transition">
                    <i class="fas fa-bell w-6"></i>
                    <span class="hidden lg:block">Notifications</span>
                </a>
                <a href="profile.html" class="flex items-center space-x-3 p-3 rounded-xl bg-blue-900/30 text-cyan-400 border border-cyan-500/50">
                    <i class="fas fa-user-astronaut w-6"></i>
                    <span class="hidden lg:block">Profile</span>
                </a>
            </nav>

            <!-- Theme Toggle -->
            <div class="p-4 border-t border-blue-800 flex items-center justify-between">
                <div class="hidden lg:flex items-center space-x-2 text-blue-300">
                    <i class="fas fa-moon"></i>
                    <span>Dark Mode</span>
                </div>
                <div class="theme-toggle" id="themeToggle"></div>
            </div>

            <!-- Quick User Info -->
            <div class="p-4 border-t border-blue-800">
                <div class="hidden lg:flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-r from-blue-500 to-purple-500 flex items-center justify-center text-white font-bold text-sm" id="sidebarAvatar">
                        <!-- Dynamically filled -->
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="font-semibold text-white truncate" id="sidebarName"></div>
                        <div class="text-blue-300 text-sm truncate" id="sidebarUsername"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Profile Area -->
        <div class="flex-1 flex flex-col overflow-y-auto">
            <!-- Profile Header -->
            <div class="glass-effect border-b border-blue-800 px-6 py-4">
                <div class="flex items-center justify-between">
                    <h1 class="text-2xl font-bold text-blue-300">My Profile</h1>
                    <div class="flex items-center space-x-4">
                        <a href="notifications.html" class="px-4 py-2 glass-effect text-blue-400 rounded-2xl hover:bg-blue-800/30 border border-blue-700 transition relative">
                            <i class="fas fa-bell mr-2"></i>
                            Notifications
                            <span class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center hidden" id="notificationBadge">0</span>
                        </a>
                        <a href="settings.html" class="px-4 py-2 glass-effect text-blue-400 rounded-2xl hover:bg-blue-800/30 border border-blue-700 transition">
                            <i class="fas fa-cog mr-2"></i>
                            Settings
                        </a>
                        <button id="logoutBtn" class="px-4 py-2 primary-gradient text-white rounded-2xl hover:scale-105 font-medium transition">
                            <i class="fas fa-sign-out-alt mr-2"></i>
                            Logout
                        </button>
                    </div>
                </div>
            </div>

            <!-- Profile Content -->
            <div class="flex-1 overflow-y-auto p-6">
                <!-- Profile Card -->
                <div class="glass-effect rounded-2xl border border-blue-700 overflow-hidden mb-6 holographic">
                    <!-- Profile Cover -->
                    <div class="profile-cover" id="profileCover">
                        <button class="edit-cover-btn absolute top-6 right-6 glass-effect text-blue-400 rounded-xl px-4 py-2 hover:bg-blue-800/30 transition">
                            <i class="fas fa-camera mr-2"></i>
                            Edit Cover
                        </button>
                        <input type="file" id="coverInput" class="hidden" accept="image/*">
                    </div>
                    
                    <!-- Profile Avatar -->
                    <div class="profile-avatar" id="profileAvatar">
                        <div id="avatarIcon"></div>
                        <div class="online-status" id="onlineStatus"></div>
                        <button class="edit-avatar-btn absolute bottom-3 right-3 w-8 h-8 bg-black/50 rounded-full flex items-center justify-center text-white hover:bg-black/70 transition">
                            <i class="fas fa-camera text-xs"></i>
                        </button>
                        <input type="file" id="avatarInput" class="hidden" accept="image/*">
                    </div>
                    
                    <!-- Profile Info -->
                    <div class="profile-info pt-20 px-6">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center flex-wrap gap-4 mb-4">
                                    <div class="fade-in">
                                        <h1 class="text-3xl font-bold text-white" id="profileName">Loading...</h1>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <div class="mood-selector inline-flex items-center space-x-2 glass-effect px-3 py-1 rounded-full cursor-pointer" id="currentMood">
                                            <i class="fas fa-smile text-yellow-400"></i>
                                            <span class="text-blue-300 text-sm">Set your mood</span>
                                        </div>
                                        <div class="badges flex space-x-2" id="profileBadges">
                                            <!-- Badges will be dynamically added here -->
                                        </div>
                                    </div>
                                </div>
                                <div class="fade-in" style="animation-delay: 0.2s;">
                                    <p class="text-blue-300 text-lg mb-2" id="profileUsername">@username</p>
                                    <p class="text-blue-300 mb-2 flex items-center" id="profileLocation">
                                        <i class="fas fa-map-marker-alt mr-2"></i>
                                        <span>Location not set</span>
                                    </p>
                                    <p class="text-blue-300 mb-2" id="profileJoined">
                                        <i class="fas fa-calendar-alt mr-2"></i>
                                        <span>Joined recently</span>
                                    </p>
                                </div>
                                <div class="fade-in" style="animation-delay: 0.4s;">
                                    <p class="text-blue-200 mt-2 leading-relaxed" id="profileBio">Your bio will appear here</p>
                                </div>
                                
                                <!-- Skills & Interests -->
                                <div class="mt-4 fade-in" style="animation-delay: 0.6s;" id="skillsInterests">
                                    <div class="flex flex-wrap gap-2 mb-3" id="skillsContainer"></div>
                                    <div class="flex flex-wrap gap-2" id="interestsContainer"></div>
                                </div>
                                
                                <!-- Profile Completion -->
                                <div class="mt-4 fade-in" style="animation-delay: 0.8s;">
                                    <div class="flex justify-between items-center text-sm text-blue-300">
                                        <span>Profile Completion</span>
                                        <span id="completionPercent">0%</span>
                                    </div>
                                    <div class="completion-bar">
                                        <div class="completion-fill" id="completionFill" style="width: 0%"></div>
                                    </div>
                                </div>
                                
                                <!-- Social Media Links -->
                                <div class="social-media-icons" id="socialMediaIcons">
                                    <!-- Dynamically filled -->
                                </div>
                            </div>
                            
                            <div class="flex space-x-3 ml-6">
                                <button id="editProfileBtn" class="px-4 py-2 glass-effect text-blue-400 rounded-xl hover:bg-blue-800/30 border border-blue-700 transition">
                                    <i class="fas fa-edit mr-2"></i>
                                    Edit Profile
                                </button>
                                <button id="findFriendsBtn" class="px-4 py-2 glass-effect text-blue-400 rounded-xl hover:bg-blue-800/30 border border-blue-700 transition">
                                    <i class="fas fa-user-plus mr-2"></i>
                                    Find Friends
                                </button>
                                <button id="shareProfileBtn" class="px-4 py-2 glass-effect text-blue-400 rounded-xl hover:bg-blue-800/30 border border-blue-700 transition">
                                    <i class="fas fa-share-alt mr-2"></i>
                                    Share Profile
                                </button>
                            </div>
                        </div>
                        
                        <!-- Profile Stats -->
                        <div class="profile-stats">
                            <div class="stat-item">
                                <div class="stat-value" id="postsCount">0</div>
                                <div class="stat-label">Posts</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="followersCount">0</div>
                                <div class="stat-label">Followers</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="followingCount">0</div>
                                <div class="stat-label">Following</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="reputationScore">0</div>
                                <div class="stat-label">Reputation</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Profile Tabs and Chat Area -->
                <div class="flex gap-6">
                    <!-- Left Column: Profile Tabs -->
                    <div class="flex-1">
                        <div class="glass-effect rounded-2xl border border-blue-700 overflow-hidden cyber-grid">
                            <div class="profile-tabs">
                                <div class="profile-tab active" data-tab="posts">
                                    <i class="fas fa-stream mr-2"></i>
                                    Posts
                                </div>
                                <div class="profile-tab" data-tab="about">
                                    <i class="fas fa-user mr-2"></i>
                                    About
                                </div>
                                <div class="profile-tab" data-tab="media">
                                    <i class="fas fa-images mr-2"></i>
                                    Media
                                </div>
                                <div class="profile-tab" data-tab="activity">
                                    <i class="fas fa-chart-line mr-2"></i>
                                    Activity
                                </div>
                                <div class="profile-tab" data-tab="achievements">
                                    <i class="fas fa-trophy mr-2"></i>
                                    Achievements
                                </div>
                                <div class="profile-tab" data-tab="diary">
                                    <i class="fas fa-book mr-2"></i>
                                    Diary
                                </div>
                            </div>
                            
                            <!-- Tab Content -->
                            <div class="p-6">
                                <!-- Posts Tab -->
                                <div class="tab-content active" id="postsTab">
                                    <div class="text-center py-8" id="postsContent">
                                        <i class="fas fa-circle-notch fa-spin text-4xl text-blue-400 mb-4"></i>
                                        <p class="text-blue-300">Loading your posts...</p>
                                    </div>
                                </div>
                                
                                <!-- About Tab -->
                                <div class="tab-content hidden" id="aboutTab">
                                    <div class="text-center py-8" id="aboutContent">
                                        <i class="fas fa-circle-notch fa-spin text-4xl text-blue-400 mb-4"></i>
                                        <p class="text-blue-300">Loading your information...</p>
                                    </div>
                                </div>
                                
                                <!-- Media Tab -->
                                <div class="tab-content hidden" id="mediaTab">
                                    <div class="text-center py-8" id="mediaContent">
                                        <i class="fas fa-circle-notch fa-spin text-4xl text-blue-400 mb-4"></i>
                                        <p class="text-blue-300">Loading your media...</p>
                                    </div>
                                </div>
                                
                                <!-- Activity Tab -->
                                <div class="tab-content hidden" id="activityTab">
                                    <div class="text-center py-8" id="activityContent">
                                        <i class="fas fa-circle-notch fa-spin text-4xl text-blue-400 mb-4"></i>
                                        <p class="text-blue-300">Loading your activity...</p>
                                    </div>
                                </div>
                                
                                <!-- Achievements Tab -->
                                <div class="tab-content hidden" id="achievementsTab">
                                    <div class="text-center py-8" id="achievementsContent">
                                        <i class="fas fa-circle-notch fa-spin text-4xl text-blue-400 mb-4"></i>
                                        <p class="text-blue-300">Loading your achievements...</p>
                                    </div>
                                </div>
                                
                                <!-- Diary Tab -->
                                <div class="tab-content hidden" id="diaryTab">
                                    <div class="flex justify-between items-center mb-6">
                                        <h3 class="text-xl font-bold text-blue-300">Personal Diary</h3>
                                        <button id="addDiaryEntry" class="px-4 py-2 primary-gradient text-white rounded-xl hover:scale-105 transition">
                                            <i class="fas fa-plus mr-2"></i>
                                            New Entry
                                        </button>
                                    </div>
                                    <div class="text-center py-8" id="diaryEntriesContent">
                                        <i class="fas fa-circle-notch fa-spin text-4xl text-blue-400 mb-4"></i>
                                        <p class="text-blue-300">Loading your diary entries...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right Column: Friends Sidebar and Chat -->
                    <div class="w-80 flex flex-col gap-6">
                        <!-- Friends Sidebar -->
                        <div class="friends-sidebar rounded-2xl">
                            <div class="p-4 border-b border-blue-800">
                                <div class="flex justify-between items-center">
                                    <h3 class="text-lg font-bold text-blue-300 flex items-center">
                                        <i class="fas fa-user-friends mr-2"></i>
                                        Friends
                                        <span class="ml-2 text-sm bg-blue-500 text-white rounded-full px-2 py-1" id="friendsCount">0</span>
                                    </h3>
                                    <button id="viewFriendRequests" class="text-blue-400 hover:text-cyan-400 transition relative">
                                        <i class="fas fa-user-clock"></i>
                                        <span class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center hidden" id="friendRequestBadge">0</span>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Friend Requests Section -->
                            <div class="hidden" id="friendRequestsSection">
                                <div class="p-3 border-b border-blue-800 bg-blue-900/20">
                                    <h4 class="text-md font-semibold text-blue-300">Friend Requests</h4>
                                </div>
                                <div id="friendRequestsList">
                                    <!-- Friend requests will appear here -->
                                </div>
                            </div>
                            
                            <!-- Friends List -->
                            <div id="friendsList">
                                <div class="p-4 text-center text-blue-300">
                                    <i class="fas fa-circle-notch fa-spin mb-2"></i>
                                    <p>Loading friends...</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Chat Window -->
                        <div class="chat-window flex-1" id="chatWindow">
                            <div class="no-chat-selected" id="noChatSelected">
                                <div class="no-chat-icon">
                                    <i class="fas fa-comments"></i>
                                </div>
                                <h3 class="text-xl font-bold text-blue-300 mb-2">No Chat Selected</h3>
                                <p class="text-blue-300">Select a friend from the list to start chatting</p>
                            </div>
                            
                            <div class="chat-container hidden" id="chatContainer">
                                <div class="chat-header">
                                    <div class="chat-avatar" id="chatFriendAvatar"></div>
                                    <div class="chat-info">
                                        <div class="chat-name" id="chatFriendName">Friend Name</div>
                                        <div class="chat-status" id="chatFriendStatus">Online</div>
                                    </div>
                                </div>
                                <div class="chat-messages" id="chatMessages">
                                    <!-- Messages will be loaded here -->
                                </div>
                                <div class="chat-input-container">
                                    <input type="text" class="chat-input" id="chatInput" placeholder="Type a message..." />
                                    <button class="send-button" id="sendMessageBtn">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp, doc, getDoc, setDoc, onSnapshot, updateDoc, query, where, getDocs, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDHHyGgsSV18BcXrGgzi4C8frzDAE1C1zo",
            authDomain: "uniconnect-ee95c.firebaseapp.com",
            projectId: "uniconnect-ee95c",
            storageBucket: "uniconnect-ee95c.firebasestorage.app",
            messagingSenderId: "1003264444309",
            appId: "1:1003264444309:web:9f0307516e44d21e97d89c"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app);

        // Make Firebase available globally
        window.firebaseApp = {
            app,
            db,
            auth,
            storage,
            authFunctions: {
                signOut,
                onAuthStateChanged
            },
            firestore: {
                collection,
                addDoc,
                serverTimestamp,
                doc,
                getDoc,
                setDoc,
                onSnapshot,
                updateDoc,
                query,
                where,
                getDocs,
                orderBy,
                deleteDoc
            },
            storageFunctions: {
                ref,
                uploadBytes,
                getDownloadURL
            }
        };

        console.log(' Kynecta initialized successfully!');

        // Initialize profile app after Firebase is ready
        if (window.initProfileApp) {
            window.initProfileApp();
        }
    </script>

    <script>
        // Complete Profile Application Class
        class ProfileApplication {
            constructor() {
                this.currentUser = null;
                this.userProfile = null;
                this.profileUnsubscribe = null;
                this.cropper = null;
                this.currentEditingImage = null;
                this.isConnected = false;
                this.userPosts = [];
                this.userMedia = [];
                this.userAchievements = [];
                this.diaryEntries = [];
                this.friends = [];
                this.friendRequests = [];
                this.peopleSuggestions = [];
                this.isDarkMode = true;
                
                // Chat properties
                this.activeChat = null;
                this.activeFriend = null;
                this.chatUnsubscribe = null;
                this.friendsUnsubscribe = null;
                this.friendRequestsUnsubscribe = null;
            }

            async initialize() {
                try {
                    await this.initializeFirebase();
                    this.createParticles();
                    this.setupEventListeners();
                    this.checkAuthentication();
                    console.log(' Kynecta profile app initialized successfully');
                } catch (error) {
                    console.error(' Profile app initialization failed:', error);
                    this.updateConnectionStatus('error');
                    this.showNotification('Connection failed. Please check your connection.', 'error');
                }
            }

            createParticles() {
                const particlesContainer = document.getElementById('particles');
                for (let i = 0; i < 50; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    particle.style.width = `${Math.random() * 4 + 2}px`;
                    particle.style.height = particle.style.width;
                    particle.style.left = `${Math.random() * 100}%`;
                    particle.style.top = `${Math.random() * 100}%`;
                    particle.style.animationDelay = `${Math.random() * 6}s`;
                    particle.style.opacity = Math.random() * 0.3 + 0.1;
                    particlesContainer.appendChild(particle);
                }
            }

            async initializeFirebase() {
                if (!window.firebaseApp) {
                    throw new Error('Firebase not available');
                }
                this.isConnected = true;
                this.updateConnectionStatus('connected');
            }

            checkAuthentication() {
                this.showLoading(true);
                
                const userEmail = localStorage.getItem('userEmail');
                const userId = localStorage.getItem('userId');
                const userDisplayName = localStorage.getItem('userDisplayName');
                
                if (userEmail && userId) {
                    console.log('User found in localStorage:', userEmail);
                    this.currentUser = {
                        uid: userId,
                        email: userEmail,
                        displayName: userDisplayName
                    };
                    this.loadProfileData(userId);
                }

                window.firebaseApp.authFunctions.onAuthStateChanged(window.firebaseApp.auth, (user) => {
                    if (user) {
                        console.log('Authenticated user detected:', user.email);
                        this.currentUser = user;
                        localStorage.setItem('userEmail', user.email);
                        localStorage.setItem('userId', user.uid);
                        localStorage.setItem('userDisplayName', user.displayName || user.email.split('@')[0]);
                        this.loadProfileData(user.uid);
                    } else {
                        console.log('No authenticated user, redirecting to login...');
                        localStorage.clear();
                        sessionStorage.clear();
                        window.location.href = 'login.html';
                    }
                }, (error) => {
                    console.error('Auth state change error:', error);
                    this.updateConnectionStatus('error');
                    this.showNotification('Authentication error. Please try again.', 'error');
                });
            }

            async loadProfileData(uid) {
                try {
                    console.log("Loading profile data for user:", uid);
                    
                    const userRef = window.firebaseApp.firestore.doc(window.firebaseApp.db, "users", uid);
                    
                    this.profileUnsubscribe = window.firebaseApp.firestore.onSnapshot(userRef, async (doc) => {
                        if (doc.exists()) {
                            this.userProfile = { id: doc.id, ...doc.data() };
                            console.log("Real-time profile update:", this.userProfile);
                            this.updateProfileUI(this.userProfile);
                            this.updateSidebar(this.userProfile);
                            this.calculateProfileCompletion(this.userProfile);
                            
                            // Load additional data
                            await this.loadUserPosts(uid);
                            await this.loadUserMedia(uid);
                            await this.loadAchievements(uid);
                            await this.loadDiaryEntries(uid);
                            await this.loadFriends(uid);
                            await this.loadFriendRequests(uid);
                            await this.loadPeopleSuggestions(uid);
                            
                            this.showLoading(false);
                            this.showProfileLayout();
                            
                            this.loadTabContent('posts');
                        } else {
                            console.log("No profile found, creating new one...");
                            this.createNewProfile(uid);
                        }
                    }, (error) => {
                        console.error("Error in real-time listener:", error);
                        this.loadProfileOnce(uid);
                    });
                    
                } catch (error) {
                    console.error('Error setting up real-time listener:', error);
                    this.createFallbackProfile();
                }
            }

            async loadUserPosts(uid) {
                try {
                    const postsQuery = window.firebaseApp.firestore.query(
                        window.firebaseApp.firestore.collection(window.firebaseApp.db, "posts"),
                        window.firebaseApp.firestore.where("userId", "==", uid),
                        window.firebaseApp.firestore.orderBy("createdAt", "desc")
                    );
                    
                    const querySnapshot = await window.firebaseApp.firestore.getDocs(postsQuery);
                    this.userPosts = querySnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    
                    console.log("Loaded user posts:", this.userPosts.length);
                    this.loadPostsTab();
                } catch (error) {
                    console.error("Error loading user posts:", error);
                }
            }

            async loadUserMedia(uid) {
                try {
                    const mediaQuery = window.firebaseApp.firestore.query(
                        window.firebaseApp.firestore.collection(window.firebaseApp.db, "media"),
                        window.firebaseApp.firestore.where("userId", "==", uid),
                        window.firebaseApp.firestore.orderBy("uploadedAt", "desc")
                    );
                    
                    const querySnapshot = await window.firebaseApp.firestore.getDocs(mediaQuery);
                    this.userMedia = querySnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    
                    console.log("Loaded user media:", this.userMedia.length);
                } catch (error) {
                    console.error("Error loading user media:", error);
                }
            }

            async loadAchievements(uid) {
                try {
                    const achievementsQuery = window.firebaseApp.firestore.query(
                        window.firebaseApp.firestore.collection(window.firebaseApp.db, "achievements"),
                        window.firebaseApp.firestore.where("userId", "==", uid)
                    );
                    
                    const querySnapshot = await window.firebaseApp.firestore.getDocs(achievementsQuery);
                    this.userAchievements = querySnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    
                    console.log("Loaded user achievements:", this.userAchievements.length);
                } catch (error) {
                    console.error("Error loading achievements:", error);
                }
            }

            async loadDiaryEntries(uid) {
                try {
                    const diaryQuery = window.firebaseApp.firestore.query(
                        window.firebaseApp.firestore.collection(window.firebaseApp.db, "diary"),
                        window.firebaseApp.firestore.where("userId", "==", uid),
                        window.firebaseApp.firestore.orderBy("createdAt", "desc")
                    );
                    
                    const querySnapshot = await window.firebaseApp.firestore.getDocs(diaryQuery);
                    this.diaryEntries = querySnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    
                    console.log("Loaded diary entries:", this.diaryEntries.length);
                } catch (error) {
                    console.error("Error loading diary entries:", error);
                }
            }

            async loadFriends(uid) {
                try {
                    // Get the user's friends list
                    const friendsQuery = window.firebaseApp.firestore.query(
                        window.firebaseApp.firestore.collection(window.firebaseApp.db, "friends"),
                        window.firebaseApp.firestore.where("userId", "==", uid)
                    );
                    
                    const querySnapshot = await window.firebaseApp.firestore.getDocs(friendsQuery);
                    const friendIds = [];
                    
                    querySnapshot.forEach(doc => {
                        const friendData = doc.data();
                        friendIds.push(friendData.friendId);
                    });
                    
                    console.log("Friend IDs:", friendIds);
                    
                    // Get the actual user profiles for each friend
                    this.friends = [];
                    for (const friendId of friendIds) {
                        const friendRef = window.firebaseApp.firestore.doc(window.firebaseApp.db, "users", friendId);
                        const friendDoc = await window.firebaseApp.firestore.getDoc(friendRef);
                        
                        if (friendDoc.exists()) {
                            this.friends.push({
                                id: friendDoc.id,
                                ...friendDoc.data()
                            });
                        }
                    }
                    
                    console.log("Loaded friends:", this.friends.length);
                    this.updateFriendsList();
                    
                    // Set up real-time listener for friends
                    this.setupFriendsListener(uid);
                    
                } catch (error) {
                    console.error("Error loading friends:", error);
                }
            }

            async loadFriendRequests(uid) {
                try {
                    // Get incoming friend requests
                    const requestsQuery = window.firebaseApp.firestore.query(
                        window.firebaseApp.firestore.collection(window.firebaseApp.db, "friendRequests"),
                        window.firebaseApp.firestore.where("toUserId", "==", uid),
                        window.firebaseApp.firestore.where("status", "==", "pending")
                    );
                    
                    const querySnapshot = await window.firebaseApp.firestore.getDocs(requestsQuery);
                    this.friendRequests = [];
                    
                    for (const doc of querySnapshot.docs) {
                        const requestData = doc.data();
                        const fromUserRef = window.firebaseApp.firestore.doc(window.firebaseApp.db, "users", requestData.fromUserId);
                        const fromUserDoc = await window.firebaseApp.firestore.getDoc(fromUserRef);
                        
                        if (fromUserDoc.exists()) {
                            this.friendRequests.push({
                                id: doc.id,
                                ...requestData,
                                fromUser: { id: fromUserDoc.id, ...fromUserDoc.data() }
                            });
                        }
                    }
                    
                    console.log("Loaded friend requests:", this.friendRequests.length);
                    this.updateFriendRequestsList();
                    
                    // Set up real-time listener for friend requests
                    this.setupFriendRequestsListener(uid);
                    
                } catch (error) {
                    console.error("Error loading friend requests:", error);
                }
            }

            async loadPeopleSuggestions(uid) {
                try {
                    // Get random users for suggestions (excluding current user and friends)
                    const usersQuery = window.firebaseApp.firestore.query(
                        window.firebaseApp.firestore.collection(window.firebaseApp.db, "users"),
                        window.firebaseApp.firestore.where("__name__", "!=", uid)
                    );
                    
                    const querySnapshot = await window.firebaseApp.firestore.getDocs(usersQuery);
                    this.peopleSuggestions = [];
                    
                    const friendIds = this.friends.map(friend => friend.id);
                    
                    querySnapshot.forEach(doc => {
                        if (doc.id !== uid && !friendIds.includes(doc.id)) {
                            this.peopleSuggestions.push({
                                id: doc.id,
                                ...doc.data()
                            });
                        }
                    });
                    
                    // Limit to 5 suggestions
                    this.peopleSuggestions = this.peopleSuggestions.slice(0, 5);
                    console.log("Loaded people suggestions:", this.peopleSuggestions.length);
                    
                } catch (error) {
                    console.error("Error loading people suggestions:", error);
                }
            }

            setupFriendsListener(uid) {
                const friendsQuery = window.firebaseApp.firestore.query(
                    window.firebaseApp.firestore.collection(window.firebaseApp.db, "friends"),
                    window.firebaseApp.firestore.where("userId", "==", uid)
                );
                
                this.friendsUnsubscribe = window.firebaseApp.firestore.onSnapshot(friendsQuery, async (snapshot) => {
                    const friendIds = [];
                    
                    snapshot.forEach(doc => {
                        const friendData = doc.data();
                        friendIds.push(friendData.friendId);
                    });
                    
                    // Update friends list
                    this.friends = [];
                    for (const friendId of friendIds) {
                        const friendRef = window.firebaseApp.firestore.doc(window.firebaseApp.db, "users", friendId);
                        const friendDoc = await window.firebaseApp.firestore.getDoc(friendRef);
                        
                        if (friendDoc.exists()) {
                            this.friends.push({
                                id: friendDoc.id,
                                ...friendDoc.data()
                            });
                        }
                    }
                    
                    this.updateFriendsList();
                });
            }

            setupFriendRequestsListener(uid) {
                const requestsQuery = window.firebaseApp.firestore.query(
                    window.firebaseApp.firestore.collection(window.firebaseApp.db, "friendRequests"),
                    window.firebaseApp.firestore.where("toUserId", "==", uid),
                    window.firebaseApp.firestore.where("status", "==", "pending")
                );
                
                this.friendRequestsUnsubscribe = window.firebaseApp.firestore.onSnapshot(requestsQuery, async (snapshot) => {
                    this.friendRequests = [];
                    
                    for (const doc of snapshot.docs) {
                        const requestData = doc.data();
                        const fromUserRef = window.firebaseApp.firestore.doc(window.firebaseApp.db, "users", requestData.fromUserId);
                        const fromUserDoc = await window.firebaseApp.firestore.getDoc(fromUserRef);
                        
                        if (fromUserDoc.exists()) {
                            this.friendRequests.push({
                                id: doc.id,
                                ...requestData,
                                fromUser: { id: fromUserDoc.id, ...fromUserDoc.data() }
                            });
                        }
                    }
                    
                    this.updateFriendRequestsList();
                });
            }

            updateFriendsList() {
                const friendsList = document.getElementById('friendsList');
                const friendsCount = document.getElementById('friendsCount');
                
                friendsCount.textContent = this.friends.length;
                
                if (this.friends.length === 0) {
                    friendsList.innerHTML = `
                        <div class="p-4 text-center text-blue-300">
                            <i class="fas fa-user-friends text-2xl mb-2 opacity-50"></i>
                            <p>No friends yet</p>
                            <p class="text-sm mt-2">Connect with people to see them here</p>
                        </div>
                    `;
                    return;
                }
                
                let friendsHTML = '';
                
                this.friends.forEach(friend => {
                    const isOnline = friend.isOnline;
                    const lastActive = friend.lastActive?.toDate ? friend.lastActive.toDate() : new Date(friend.lastActive);
                    const statusText = isOnline ? 'Online' : `Last seen ${this.formatLastSeen(lastActive)}`;
                    const statusClass = isOnline ? 'friend-online' : 'friend-offline';
                    
                    friendsHTML += `
                        <div class="friend-item" data-friend-id="${friend.id}">
                            <div class="friend-avatar" style="${friend.profilePicture ? `background-image: url('${friend.profilePicture}')` : ''}">
                                ${friend.profilePicture ? '' : friend.displayName?.charAt(0) || 'F'}
                            </div>
                            <div class="friend-info">
                                <div class="friend-name">${friend.displayName}</div>
                                <div class="friend-status">${statusText}</div>
                            </div>
                            <div class="${statusClass}"></div>
                        </div>
                    `;
                });
                
                friendsList.innerHTML = friendsHTML;
                
                // Add click event listeners to friend items
                document.querySelectorAll('.friend-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const friendId = item.getAttribute('data-friend-id');
                        this.selectFriend(friendId);
                    });
                });
            }

            updateFriendRequestsList() {
                const friendRequestsSection = document.getElementById('friendRequestsSection');
                const friendRequestsList = document.getElementById('friendRequestsList');
                const friendRequestBadge = document.getElementById('friendRequestBadge');
                
                // Update badge
                if (this.friendRequests.length > 0) {
                    friendRequestBadge.textContent = this.friendRequests.length;
                    friendRequestBadge.classList.remove('hidden');
                    friendRequestsSection.classList.remove('hidden');
                } else {
                    friendRequestBadge.classList.add('hidden');
                    friendRequestsSection.classList.add('hidden');
                }
                
                if (this.friendRequests.length === 0) {
                    friendRequestsList.innerHTML = `
                        <div class="p-4 text-center text-blue-300">
                            <p>No pending friend requests</p>
                        </div>
                    `;
                    return;
                }
                
                let requestsHTML = '';
                
                this.friendRequests.forEach(request => {
                    requestsHTML += `
                        <div class="friend-request-item">
                            <div class="friend-avatar" style="${request.fromUser.profilePicture ? `background-image: url('${request.fromUser.profilePicture}')` : ''}">
                                ${request.fromUser.profilePicture ? '' : request.fromUser.displayName?.charAt(0) || 'U'}
                            </div>
                            <div class="friend-info">
                                <div class="friend-name">${request.fromUser.displayName}</div>
                                <div class="friend-status">Wants to connect with you</div>
                            </div>
                            <div class="request-actions">
                                <button class="accept-btn" data-request-id="${request.id}" data-from-user-id="${request.fromUserId}">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="reject-btn" data-request-id="${request.id}">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                friendRequestsList.innerHTML = requestsHTML;
                
                // Add event listeners to accept/reject buttons
                document.querySelectorAll('.accept-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const requestId = btn.getAttribute('data-request-id');
                        const fromUserId = btn.getAttribute('data-from-user-id');
                        this.acceptFriendRequest(requestId, fromUserId);
                    });
                });
                
                document.querySelectorAll('.reject-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const requestId = btn.getAttribute('data-request-id');
                        this.rejectFriendRequest(requestId);
                    });
                });
            }

            async acceptFriendRequest(requestId, fromUserId) {
                try {
                    // Update the friend request status
                    const requestRef = window.firebaseApp.firestore.doc(window.firebaseApp.db, "friendRequests", requestId);
                    await window.firebaseApp.firestore.updateDoc(requestRef, {
                        status: "accepted",
                        respondedAt: window.firebaseApp.firestore.serverTimestamp()
                    });
                    
                    // Create friendship for current user
                    const currentUserFriendRef = window.firebaseApp.firestore.collection(window.firebaseApp.db, "friends");
                    await window.firebaseApp.firestore.addDoc(currentUserFriendRef, {
                        userId: this.currentUser.uid,
                        friendId: fromUserId,
                        createdAt: window.firebaseApp.firestore.serverTimestamp()
                    });
                    
                    // Create friendship for the other user
                    const otherUserFriendRef = window.firebaseApp.firestore.collection(window.firebaseApp.db, "friends");
                    await window.firebaseApp.firestore.addDoc(otherUserFriendRef, {
                        userId: fromUserId,
                        friendId: this.currentUser.uid,
                        createdAt: window.firebaseApp.firestore.serverTimestamp()
                    });
                    
                    this.showNotification('Friend request accepted!', 'success');
                    
                } catch (error) {
                    console.error('Error accepting friend request:', error);
                    this.showNotification('Error accepting friend request', 'error');
                }
            }

            async rejectFriendRequest(requestId) {
                try {
                    // Update the friend request status
                    const requestRef = window.firebaseApp.firestore.doc(window.firebaseApp.db, "friendRequests", requestId);
                    await window.firebaseApp.firestore.updateDoc(requestRef, {
                        status: "rejected",
                        respondedAt: window.firebaseApp.firestore.serverTimestamp()
                    });
                    
                    this.showNotification('Friend request rejected', 'info');
                    
                } catch (error) {
                    console.error('Error rejecting friend request:', error);
                    this.showNotification('Error rejecting friend request', 'error');
                }
            }

            async searchUsers(searchTerm) {
                try {
                    // Search by display name
                    const nameQuery = window.firebaseApp.firestore.query(
                        window.firebaseApp.firestore.collection(window.firebaseApp.db, "users"),
                        window.firebaseApp.firestore.where("displayName", ">=", searchTerm),
                        window.firebaseApp.firestore.where("displayName", "<=", searchTerm + '\uf8ff')
                    );
                    
                    // Search by email
                    const emailQuery = window.firebaseApp.firestore.query(
                        window.firebaseApp.firestore.collection(window.firebaseApp.db, "users"),
                        window.firebaseApp.firestore.where("email", ">=", searchTerm),
                        window.firebaseApp.firestore.where("email", "<=", searchTerm + '\uf8ff')
                    );
                    
                    const [nameSnapshot, emailSnapshot] = await Promise.all([
                        window.firebaseApp.firestore.getDocs(nameQuery),
                        window.firebaseApp.firestore.getDocs(emailQuery)
                    ]);
                    
                    const results = [];
                    const addedIds = new Set();
                    
                    // Add name results
                    nameSnapshot.forEach(doc => {
                        if (doc.id !== this.currentUser.uid && !addedIds.has(doc.id)) {
                            results.push({ id: doc.id, ...doc.data() });
                            addedIds.add(doc.id);
                        }
                    });
                    
                    // Add email results
                    emailSnapshot.forEach(doc => {
                        if (doc.id !== this.currentUser.uid && !addedIds.has(doc.id)) {
                            results.push({ id: doc.id, ...doc.data() });
                            addedIds.add(doc.id);
                        }
                    });
                    
                    return results;
                    
                } catch (error) {
                    console.error('Error searching users:', error);
                    return [];
                }
            }

            async sendFriendRequest(toUserId) {
                try {
                    // Check if request already exists
                    const existingRequestQuery = window.firebaseApp.firestore.query(
                        window.firebaseApp.firestore.collection(window.firebaseApp.db, "friendRequests"),
                        window.firebaseApp.firestore.where("fromUserId", "==", this.currentUser.uid),
                        window.firebaseApp.firestore.where("toUserId", "==", toUserId),
                        window.firebaseApp.firestore.where("status", "==", "pending")
                    );
                    
                    const existingRequest = await window.firebaseApp.firestore.getDocs(existingRequestQuery);
                    
                    if (!existingRequest.empty) {
                        this.showNotification('Friend request already sent', 'info');
                        return;
                    }
                    
                    // Create new friend request
                    const requestRef = window.firebaseApp.firestore.collection(window.firebaseApp.db, "friendRequests");
                    await window.firebaseApp.firestore.addDoc(requestRef, {
                        fromUserId: this.currentUser.uid,
                        toUserId: toUserId,
                        status: "pending",
                        createdAt: window.firebaseApp.firestore.serverTimestamp()
                    });
                    
                    this.showNotification('Friend request sent!', 'success');
                    
                } catch (error) {
                    console.error('Error sending friend request:', error);
                    this.showNotification('Error sending friend request', 'error');
                }
            }

            formatLastSeen(date) {
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMins / 60);
                const diffDays = Math.floor(diffHours / 24);
                
                if (diffMins < 1) return 'just now';
                if (diffMins < 60) return `${diffMins} min ago`;
                if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
                if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
                
                return date.toLocaleDateString();
            }

            async selectFriend(friendId) {
                // Remove active class from all friends
                document.querySelectorAll('.friend-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                // Add active class to selected friend
                const selectedFriend = document.querySelector(`.friend-item[data-friend-id="${friendId}"]`);
                if (selectedFriend) {
                    selectedFriend.classList.add('active');
                }
                
                // Find friend data
                this.activeFriend = this.friends.find(friend => friend.id === friendId);
                
                if (!this.activeFriend) {
                    console.error('Friend not found:', friendId);
                    return;
                }
                
                // Show chat window
                this.showChatWindow();
                
                // Load or create chat
                await this.loadOrCreateChat(friendId);
            }

            showChatWindow() {
                document.getElementById('noChatSelected').classList.add('hidden');
                document.getElementById('chatContainer').classList.remove('hidden');
                
                // Update chat header
                document.getElementById('chatFriendName').textContent = this.activeFriend.displayName;
                document.getElementById('chatFriendStatus').textContent = this.activeFriend.isOnline ? 'Online' : 'Offline';
                
                const avatarElement = document.getElementById('chatFriendAvatar');
                if (this.activeFriend.profilePicture) {
                    avatarElement.style.backgroundImage = `url(${this.activeFriend.profilePicture})`;
                    avatarElement.textContent = '';
                } else {
                    avatarElement.style.backgroundImage = '';
                    avatarElement.textContent = this.activeFriend.displayName?.charAt(0) || 'F';
                }
            }

            async loadOrCreateChat(friendId) {
                // Generate a unique chat ID based on user IDs (sorted to ensure consistency)
                const chatId = [this.currentUser.uid, friendId].sort().join('_');
                
                // Check if chat already exists
                const chatRef = window.firebaseApp.firestore.doc(window.firebaseApp.db, "chats", chatId);
                const chatDoc = await window.firebaseApp.firestore.getDoc(chatRef);
                
                if (chatDoc.exists()) {
                    this.activeChat = { id: chatDoc.id, ...chatDoc.data() };
                } else {
                    // Create new chat
                    const newChat = {
                        members: [this.currentUser.uid, friendId],
                        createdAt: window.firebaseApp.firestore.serverTimestamp(),
                        lastMessage: null,
                        lastMessageAt: null
                    };
                    
                    await window.firebaseApp.firestore.setDoc(chatRef, newChat);
                    this.activeChat = { id: chatId, ...newChat };
                }
                
                // Load messages for this chat
                this.loadChatMessages(chatId);
            }

            loadChatMessages(chatId) {
                // Clear previous message listener
                if (this.chatUnsubscribe) {
                    this.chatUnsubscribe();
                }
                
                const messagesQuery = window.firebaseApp.firestore.query(
                    window.firebaseApp.firestore.collection(window.firebaseApp.db, "chats", chatId, "messages"),
                    window.firebaseApp.firestore.orderBy("timestamp", "asc")
                );
                
                // Set up real-time listener for messages
                this.chatUnsubscribe = window.firebaseApp.firestore.onSnapshot(messagesQuery, (snapshot) => {
                    const messages = [];
                    
                    snapshot.forEach(doc => {
                        messages.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    this.displayMessages(messages);
                    
                    // Scroll to bottom of messages
                    const messagesContainer = document.getElementById('chatMessages');
                    setTimeout(() => {
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }, 100);
                });
            }

            displayMessages(messages) {
                const messagesContainer = document.getElementById('chatMessages');
                
                if (messages.length === 0) {
                    messagesContainer.innerHTML = `
                        <div class="text-center text-blue-300 py-8">
                            <i class="fas fa-comments text-2xl mb-2 opacity-50"></i>
                            <p>No messages yet</p>
                            <p class="text-sm">Start a conversation with ${this.activeFriend.displayName}</p>
                        </div>
                    `;
                    return;
                }
                
                let messagesHTML = '';
                
                messages.forEach(message => {
                    const isSent = message.senderId === this.currentUser.uid;
                    const senderName = isSent ? 'You' : this.activeFriend.displayName;
                    const messageClass = isSent ? 'sent' : 'received';
                    const timestamp = message.timestamp?.toDate ? message.timestamp.toDate() : new Date();
                    const timeString = timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    
                    messagesHTML += `
                        <div class="message ${messageClass}">
                            <div class="message-sender">${senderName}</div>
                            <div class="message-text">${message.text}</div>
                            <div class="message-time">${timeString}</div>
                        </div>
                    `;
                });
                
                messagesContainer.innerHTML = messagesHTML;
            }

            async sendMessage() {
                const messageInput = document.getElementById('chatInput');
                const messageText = messageInput.value.trim();
                
                if (!messageText || !this.activeChat || !this.activeFriend) {
                    return;
                }
                
                try {
                    // Create message object
                    const newMessage = {
                        text: messageText,
                        senderId: this.currentUser.uid,
                        timestamp: window.firebaseApp.firestore.serverTimestamp()
                    };
                    
                    // Add message to Firestore
                    await window.firebaseApp.firestore.addDoc(
                        window.firebaseApp.firestore.collection(window.firebaseApp.db, "chats", this.activeChat.id, "messages"),
                        newMessage
                    );
                    
                    // Update chat's last message
                    const chatRef = window.firebaseApp.firestore.doc(window.firebaseApp.db, "chats", this.activeChat.id);
                    await window.firebaseApp.firestore.updateDoc(chatRef, {
                        lastMessage: messageText,
                        lastMessageAt: window.firebaseApp.firestore.serverTimestamp()
                    });
                    
                    // Clear input
                    messageInput.value = '';
                    
                } catch (error) {
                    console.error('Error sending message:', error);
                    this.showNotification('Failed to send message. Please try again.', 'error');
                }
            }

            // ... (Previous methods for profile management, tabs, etc. remain the same)

            updateProfileUI(profile) {
                // Update basic profile information
                document.getElementById('profileName').textContent = profile.displayName || 'User';
                document.getElementById('profileUsername').textContent = `@${profile.username || 'user'}`;
                document.getElementById('profileBio').textContent = profile.bio || 'No bio yet. Click edit to add one!';
                
                // Update location
                const locationElement = document.getElementById('profileLocation');
                if (profile.location) {
                    locationElement.innerHTML = `<i class="fas fa-map-marker-alt mr-2"></i><span>${profile.location}</span>`;
                } else {
                    locationElement.innerHTML = `<i class="fas fa-map-marker-alt mr-2"></i><span>Location not set</span>`;
                }
                
                // Update joined date
                const joinedElement = document.getElementById('profileJoined');
                if (profile.createdAt) {
                    const date = profile.createdAt.toDate ? profile.createdAt.toDate() : new Date();
                    joinedElement.innerHTML = `<i class="fas fa-calendar-alt mr-2"></i><span>Joined ${date.toLocaleDateString()}</span>`;
                } else {
                    joinedElement.innerHTML = `<i class="fas fa-calendar-alt mr-2"></i><span>Joined recently</span>`;
                }
                
                // Update stats
                const stats = profile.stats || {};
                document.getElementById('postsCount').textContent = stats.posts || 0;
                document.getElementById('followersCount').textContent = stats.followers || 0;
                document.getElementById('followingCount').textContent = stats.following || 0;
                document.getElementById('reputationScore').textContent = stats.reputation || 0;
                
                // Update avatar and cover
                this.updateAvatar(profile);
                this.updateCover(profile);
                
                // Update social links
                this.updateSocialLinks(profile.socialLinks);
                
                // Update skills and interests
                this.updateSkillsAndInterests(profile);
                
                // Update mood
                this.updateMoodIndicator(profile.mood || 'happy');
                
                // Update badges
                this.updateProfileBadges(profile);
                
                // Apply theme
                if (profile.theme) {
                    this.applyTheme(profile.theme);
                }
            }

            updateAvatar(profile) {
                const avatarIcon = document.getElementById('avatarIcon');
                const sidebarAvatar = document.getElementById('sidebarAvatar');
                const profileAvatar = document.getElementById('profileAvatar');
                
                if (profile.profilePicture) {
                    profileAvatar.style.backgroundImage = `url(${profile.profilePicture})`;
                    avatarIcon.style.display = 'none';
                    sidebarAvatar.style.backgroundImage = `url(${profile.profilePicture})`;
                    sidebarAvatar.textContent = '';
                } else {
                    profileAvatar.style.backgroundImage = '';
                    avatarIcon.style.display = 'flex';
                    const initials = (profile.displayName || 'U').charAt(0).toUpperCase();
                    avatarIcon.textContent = initials;
                    sidebarAvatar.style.backgroundImage = '';
                    sidebarAvatar.textContent = initials;
                }
            }

            updateCover(profile) {
                const coverElement = document.getElementById('profileCover');
                if (profile.coverPhoto) {
                    coverElement.style.backgroundImage = `url(${profile.coverPhoto})`;
                    coverElement.style.backgroundSize = 'cover';
                    coverElement.style.backgroundPosition = 'center';
                } else {
                    coverElement.style.backgroundImage = '';
                    coverElement.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                }
            }

            updateSocialLinks(socialLinks) {
                const container = document.getElementById('socialMediaIcons');
                container.innerHTML = '';
                
                if (!socialLinks) return;

                const platforms = [
                    { key: 'twitter', icon: 'fab fa-twitter', color: 'bg-blue-400', url: socialLinks.twitter },
                    { key: 'instagram', icon: 'fab fa-instagram', color: 'bg-pink-500', url: socialLinks.instagram },
                    { key: 'facebook', icon: 'fab fa-facebook', color: 'bg-blue-600', url: socialLinks.facebook },
                    { key: 'linkedin', icon: 'fab fa-linkedin', color: 'bg-blue-500', url: socialLinks.linkedin },
                    { key: 'github', icon: 'fab fa-github', color: 'bg-gray-700', url: socialLinks.github },
                    { key: 'website', icon: 'fas fa-globe', color: 'bg-green-500', url: socialLinks.website }
                ];
                
                platforms.forEach(platform => {
                    if (platform.url) {
                        const link = document.createElement('a');
                        link.href = platform.url;
                        link.target = '_blank';
                        link.className = `social-icon ${platform.color}`;
                        link.innerHTML = `<i class="${platform.icon}"></i>`;
                        container.appendChild(link);
                    }
                });
                
                if (container.children.length === 0) {
                    const addButton = document.createElement('button');
                    addButton.className = 'social-icon bg-blue-500';
                    addButton.innerHTML = '<i class="fas fa-plus"></i>';
                    addButton.title = 'Add social links';
                    addButton.addEventListener('click', () => {
                        this.openEditProfileModal();
                    });
                    container.appendChild(addButton);
                }
            }

            updateSkillsAndInterests(profile) {
                const skillsContainer = document.getElementById('skillsContainer');
                const interestsContainer = document.getElementById('interestsContainer');
                
                // Update skills
                skillsContainer.innerHTML = '';
                if (profile.skills && profile.skills.length > 0) {
                    profile.skills.forEach(skill => {
                        const skillElement = document.createElement('div');
                        skillElement.className = 'skill-tag';
                        skillElement.textContent = skill;
                        skillsContainer.appendChild(skillElement);
                    });
                } else {
                    skillsContainer.innerHTML = '<span class="text-blue-400 text-sm">No skills added yet</span>';
                }
                
                // Update interests
                interestsContainer.innerHTML = '';
                if (profile.interests && profile.interests.length > 0) {
                    profile.interests.forEach(interest => {
                        const interestElement = document.createElement('div');
                        interestElement.className = 'interest-bubble';
                        interestElement.textContent = interest;
                        interestsContainer.appendChild(interestElement);
                    });
                } else {
                    interestsContainer.innerHTML = '<span class="text-blue-400 text-sm">No interests added yet</span>';
                }
            }

            updateMoodIndicator(mood) {
                const moodIcons = {
                    happy: { icon: 'fa-smile', color: 'text-yellow-400', label: 'Happy' },
                    productive: { icon: 'fa-rocket', color: 'text-green-400', label: 'Productive' },
                    creative: { icon: 'fa-palette', color: 'text-purple-400', label: 'Creative' },
                    focused: { icon: 'fa-bullseye', color: 'text-blue-400', label: 'Focused' },
                    relaxed: { icon: 'fa-couch', color: 'text-indigo-400', label: 'Relaxed' }
                };
                
                const moodData = moodIcons[mood] || moodIcons.happy;
                const currentMood = document.getElementById('currentMood');
                
                currentMood.innerHTML = `
                    <i class="fas ${moodData.icon} ${moodData.color}"></i>
                    <span class="text-blue-300 text-sm">${moodData.label}</span>
                `;
                
                // Apply mood-based border glow
                const profileAvatar = document.getElementById('profileAvatar');
                profileAvatar.classList.remove('mood-glow-happy', 'mood-glow-productive', 'mood-glow-creative', 'mood-glow-focused', 'mood-glow-relaxed');
                profileAvatar.classList.add(`mood-glow-${mood}`);
            }

            updateProfileBadges(profile) {
                const badgesContainer = document.getElementById('profileBadges');
                badgesContainer.innerHTML = '';
                
                // Welcome badge for all users
                const welcomeBadge = document.createElement('div');
                welcomeBadge.className = 'badge';
                welcomeBadge.innerHTML = '<i class="fas fa-seedling mr-1"></i> New Member';
                badgesContainer.appendChild(welcomeBadge);
                
                // Verified badge based on reputation
                if ((profile.stats?.reputation || 0) > 200) {
                    const verifiedBadge = document.createElement('div');
                    verifiedBadge.className = 'badge verified';
                    verifiedBadge.innerHTML = '<i class="fas fa-check-circle mr-1"></i> Verified';
                    badgesContainer.appendChild(verifiedBadge);
                }
                
                // Top contributor badge based on posts
                if ((profile.stats?.posts || 0) > 10) {
                    const topContributorBadge = document.createElement('div');
                    topContributorBadge.className = 'badge top-contributor';
                    topContributorBadge.innerHTML = '<i class="fas fa-star mr-1"></i> Active User';
                    badgesContainer.appendChild(topContributorBadge);
                }
                
                // Online status badge
                if (profile.isOnline) {
                    const onlineBadge = document.createElement('div');
                    onlineBadge.className = 'badge';
                    onlineBadge.innerHTML = '<i class="fas fa-circle mr-1" style="color: #10B981; font-size: 8px;"></i> Online';
                    badgesContainer.appendChild(onlineBadge);
                }
            }

            updateSidebar(profile) {
                document.getElementById('sidebarName').textContent = profile.displayName || 'User';
                document.getElementById('sidebarUsername').textContent = `@${profile.username || 'user'}`;
            }

            calculateProfileCompletion(profile) {
                let completion = 0;
                const totalFields = 8;
                
                if (profile.displayName && profile.displayName !== 'New User') completion++;
                if (profile.bio && profile.bio.length > 10) completion++;
                if (profile.location) completion++;
                if (profile.interests && profile.interests.length > 0) completion++;
                if (profile.skills && profile.skills.length > 0) completion++;
                if (profile.profilePicture) completion++;
                if (profile.coverPhoto) completion++;
                if (profile.socialLinks && Object.values(profile.socialLinks).some(link => link)) completion++;
                
                const percent = Math.round((completion / totalFields) * 100);
                document.getElementById('completionPercent').textContent = `${percent}%`;
                document.getElementById('completionFill').style.width = `${percent}%`;
            }

            loadTabContent(tabName) {
                switch(tabName) {
                    case 'posts':
                        this.loadPostsTab();
                        break;
                    case 'about':
                        this.loadAboutTab();
                        break;
                    case 'media':
                        this.loadMediaTab();
                        break;
                    case 'activity':
                        this.loadActivityTab();
                        break;
                    case 'achievements':
                        this.loadAchievementsTab();
                        break;
                    case 'diary':
                        this.loadDiaryTab();
                        break;
                }
            }

            loadPostsTab() {
                const content = document.getElementById('postsContent');
                
                if (this.userPosts.length > 0) {
                    let postsHTML = '<div class="space-y-6">';
                    this.userPosts.forEach(post => {
                        postsHTML += `
                            <div class="feature-card">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-10 h-10 rounded-full bg-gradient-to-r from-blue-500 to-purple-500 flex items-center justify-center text-white font-bold">
                                            ${this.userProfile.displayName?.charAt(0) || 'U'}
                                        </div>
                                        <div>
                                            <h4 class="font-bold text-white">${this.userProfile.displayName}</h4>
                                            <p class="text-blue-300 text-sm">${post.createdAt?.toDate?.().toLocaleDateString() || 'Recently'}</p>
                                        </div>
                                    </div>
                                </div>
                                <p class="text-blue-200 mb-4">${post.content}</p>
                                ${post.image ? `<img src="${post.image}" class="w-full rounded-xl mb-4" alt="Post image">` : ''}
                                <div class="flex justify-between text-blue-300 text-sm">
                                    <span><i class="fas fa-heart mr-1"></i> ${post.likes || 0}</span>
                                    <span><i class="fas fa-comment mr-1"></i> ${post.comments || 0}</span>
                                    <span><i class="fas fa-share mr-1"></i> ${post.shares || 0}</span>
                                </div>
                            </div>
                        `;
                    });
                    postsHTML += '</div>';
                    content.innerHTML = postsHTML;
                } else {
                    content.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-newspaper text-4xl text-blue-400 mb-4"></i>
                            <h3 class="text-xl font-bold text-white mb-2">No Posts Yet</h3>
                            <p class="text-blue-300 mb-6">Start sharing your thoughts with the community!</p>
                            <button class="px-6 py-3 primary-gradient text-white rounded-xl hover:scale-105 transition">
                                <i class="fas fa-plus mr-2"></i>
                                Create Your First Post
                            </button>
                        </div>
                    `;
                }
            }

            loadAboutTab() {
                const content = document.getElementById('aboutContent');
                const profile = this.userProfile;
                
                content.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="feature-card">
                            <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                                <i class="fas fa-info-circle text-blue-400 mr-2"></i>
                                Basic Information
                            </h3>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-blue-300">Display Name</span>
                                    <span class="text-white">${profile.displayName}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-blue-300">Username</span>
                                    <span class="text-white">@${profile.username}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-blue-300">Email</span>
                                    <span class="text-white">${profile.email}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-blue-300">Location</span>
                                    <span class="text-white">${profile.location || 'Not set'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-blue-300">Joined</span>
                                    <span class="text-white">${profile.createdAt?.toDate?.().toLocaleDateString() || 'Recently'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-blue-300">Privacy</span>
                                    <span class="text-white capitalize">${profile.privacy || 'public'}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="feature-card">
                            <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                                <i class="fas fa-heart text-red-400 mr-2"></i>
                                Interests & Hobbies
                            </h3>
                            <div class="flex flex-wrap gap-2">
                                ${profile.interests && profile.interests.length > 0 
                                    ? profile.interests.map(interest => 
                                        `<div class="interest-bubble">${interest}</div>`
                                    ).join('') 
                                    : '<p class="text-blue-400">Add your interests to connect with like-minded people</p>'
                                }
                            </div>
                        </div>
                        
                        <div class="feature-card">
                            <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                                <i class="fas fa-tools text-yellow-400 mr-2"></i>
                                Skills & Expertise
                            </h3>
                            <div class="flex flex-wrap gap-2">
                                ${profile.skills && profile.skills.length > 0 
                                    ? profile.skills.map(skill => 
                                        `<div class="skill-tag">${skill}</div>`
                                    ).join('') 
                                    : '<p class="text-blue-400">Add your skills to showcase your expertise</p>'
                                }
                            </div>
                        </div>
                        
                        <div class="feature-card">
                            <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                                <i class="fas fa-share-alt text-green-400 mr-2"></i>
                                Social Connections
                            </h3>
                            <div class="space-y-3">
                                ${profile.socialLinks && Object.values(profile.socialLinks).some(link => link) 
                                    ? `
                                        ${profile.socialLinks.twitter ? `
                                        <div class="flex items-center">
                                            <i class="fab fa-twitter text-blue-400 w-5 mr-3"></i>
                                            <a href="${profile.socialLinks.twitter}" target="_blank" class="text-white hover:text-blue-300">Twitter</a>
                                        </div>` : ''}
                                        ${profile.socialLinks.instagram ? `
                                        <div class="flex items-center">
                                            <i class="fab fa-instagram text-pink-500 w-5 mr-3"></i>
                                            <a href="${profile.socialLinks.instagram}" target="_blank" class="text-white hover:text-blue-300">Instagram</a>
                                        </div>` : ''}
                                        ${profile.socialLinks.facebook ? `
                                        <div class="flex items-center">
                                            <i class="fab fa-facebook text-blue-600 w-5 mr-3"></i>
                                            <a href="${profile.socialLinks.facebook}" target="_blank" class="text-white hover:text-blue-300">Facebook</a>
                                        </div>` : ''}
                                        ${profile.socialLinks.linkedin ? `
                                        <div class="flex items-center">
                                            <i class="fab fa-linkedin text-blue-400 w-5 mr-3"></i>
                                            <a href="${profile.socialLinks.linkedin}" target="_blank" class="text-white hover:text-blue-300">LinkedIn</a>
                                        </div>` : ''}
                                        ${profile.socialLinks.github ? `
                                        <div class="flex items-center">
                                            <i class="fab fa-github text-gray-400 w-5 mr-3"></i>
                                            <a href="${profile.socialLinks.github}" target="_blank" class="text-white hover:text-blue-300">GitHub</a>
                                        </div>` : ''}
                                        ${profile.socialLinks.website ? `
                                        <div class="flex items-center">
                                            <i class="fas fa-globe text-green-400 w-5 mr-3"></i>
                                            <a href="${profile.socialLinks.website}" target="_blank" class="text-white hover:text-blue-300">Website</a>
                                        </div>` : ''}
                                    `
                                    : '<p class="text-blue-400">Add your social media links to connect with others</p>'
                                }
                            </div>
                        </div>
                    </div>
                `;
            }

            loadMediaTab() {
                const content = document.getElementById('mediaContent');
                
                if (this.userMedia.length > 0) {
                    let mediaHTML = `
                        <div class="mb-6">
                            <h3 class="text-xl font-bold text-white mb-4">Your Media Gallery</h3>
                            <div class="flex space-x-4 mb-6">
                                <button class="px-4 py-2 glass-effect text-blue-400 rounded-xl hover:bg-blue-800/30 border border-blue-700 transition active">
                                    <i class="fas fa-image mr-2"></i>
                                    Photos
                                </button>
                                <button class="px-4 py-2 glass-effect text-blue-400 rounded-xl hover:bg-blue-800/30 border border-blue-700 transition">
                                    <i class="fas fa-video mr-2"></i>
                                    Videos
                                </button>
                                <button class="px-4 py-2 glass-effect text-blue-400 rounded-xl hover:bg-blue-800/30 border border-blue-700 transition">
                                    <i class="fas fa-link mr-2"></i>
                                    Links
                                </button>
                            </div>
                            
                            <div class="media-grid">
                    `;
                    
                    this.userMedia.forEach(media => {
                        if (media.type === 'image') {
                            mediaHTML += `<div class="media-item" style="background-image: url('${media.url}')"></div>`;
                        }
                    });
                    
                    mediaHTML += `
                            </div>
                        </div>
                    `;
                    content.innerHTML = mediaHTML;
                } else {
                    content.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-images text-4xl text-blue-400 mb-4"></i>
                            <h3 class="text-xl font-bold text-white mb-2">No Media Yet</h3>
                            <p class="text-blue-300 mb-6">Share your photos and videos with the community!</p>
                            <button class="px-6 py-3 glass-effect text-blue-400 rounded-xl hover:bg-blue-800/30 border border-blue-700 transition">
                                <i class="fas fa-plus mr-2"></i>
                                Upload Media
                            </button>
                        </div>
                    `;
                }
            }

            loadActivityTab() {
                const content = document.getElementById('activityContent');
                
                content.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="feature-card">
                            <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                                <i class="fas fa-chart-bar text-green-400 mr-2"></i>
                                Engagement Stats
                            </h3>
                            <div class="space-y-4">
                                <div>
                                    <div class="flex justify-between mb-1">
                                        <span class="text-blue-300">Post Interactions</span>
                                        <span class="text-white">${this.userPosts.reduce((sum, post) => sum + (post.likes || 0) + (post.comments || 0), 0)}</span>
                                    </div>
                                    <div class="engagement-bar">
                                        <div class="engagement-fill" style="width: ${Math.min(this.userPosts.length * 10, 100)}%"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between mb-1">
                                        <span class="text-blue-300">Profile Views</span>
                                        <span class="text-white">${this.userProfile.stats?.profileViews || 0}</span>
                                    </div>
                                    <div class="engagement-bar">
                                        <div class="engagement-fill" style="width: ${Math.min((this.userProfile.stats?.profileViews || 0) / 10, 100)}%"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between mb-1">
                                        <span class="text-blue-300">New Followers</span>
                                        <span class="text-white">${this.userProfile.stats?.followers || 0}</span>
                                    </div>
                                    <div class="engagement-bar">
                                        <div class="engagement-fill" style="width: ${Math.min((this.userProfile.stats?.followers || 0) * 10, 100)}%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="feature-card">
                            <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                                <i class="fas fa-calendar-alt text-yellow-400 mr-2"></i>
                                Posting Frequency
                            </h3>
                            <div class="bg-gray-800 rounded-xl p-4">
                                <div class="flex justify-between items-end h-32">
                                    ${this.generateWeeklyActivityChart()}
                                </div>
                            </div>
                        </div>
                        
                        <div class="feature-card">
                            <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                                <i class="fas fa-heart text-red-400 mr-2"></i>
                                Recent Activity
                            </h3>
                            <div class="space-y-4">
                                ${this.generateRecentActivity()}
                            </div>
                        </div>
                        
                        <div class="feature-card">
                            <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                                <i class="fas fa-music text-purple-400 mr-2"></i>
                                Currently Playing
                            </h3>
                            <div class="music-player">
                                <div class="flex items-center">
                                    <div class="w-16 h-16 rounded-xl bg-gradient-to-r from-purple-500 to-pink-500 flex items-center justify-center text-white mr-4">
                                        <i class="fas fa-play"></i>
                                    </div>
                                    <div class="flex-1">
                                        <p class="text-white font-semibold">Your Favorite Song</p>
                                        <p class="text-blue-300 text-sm">Your Favorite Artist</p>
                                        <div class="flex items-center mt-1">
                                            <div class="w-full bg-gray-700 rounded-full h-1">
                                                <div class="bg-purple-500 h-1 rounded-full" style="width: 65%"></div>
                                            </div>
                                            <span class="text-blue-300 text-xs ml-2">3:42</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            generateWeeklyActivityChart() {
                const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                let chartHTML = '';
                
                days.forEach(day => {
                    const height = Math.floor(Math.random() * 60) + 20;
                    chartHTML += `
                        <div class="flex flex-col items-center">
                            <div class="w-6 bg-blue-500 rounded-t" style="height: ${height}px"></div>
                            <span class="text-xs text-blue-300 mt-1">${day}</span>
                        </div>
                    `;
                });
                
                return chartHTML;
            }

            generateRecentActivity() {
                if (this.userPosts.length === 0) {
                    return '<p class="text-blue-400 text-center">No recent activity</p>';
                }
                
                let activityHTML = '';
                const recentPosts = this.userPosts.slice(0, 3);
                
                recentPosts.forEach(post => {
                    activityHTML += `
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full bg-gradient-to-r from-blue-500 to-purple-500 flex items-center justify-center text-white font-bold text-sm mr-3">
                                ${this.userProfile.displayName?.charAt(0) || 'U'}
                            </div>
                            <div class="flex-1">
                                <p class="text-white text-sm">You posted: "${post.content.substring(0, 50)}..."</p>
                                <p class="text-blue-400 text-xs">${post.createdAt?.toDate?.().toLocaleDateString() || 'Recently'}</p>
                            </div>
                        </div>
                    `;
                });
                
                return activityHTML;
            }

            loadAchievementsTab() {
                const content = document.getElementById('achievementsContent');
                
                const achievements = [
                    { id: 1, name: 'First Post', icon: 'fa-feather', color: 'from-yellow-500 to-orange-500', progress: 100, target: 1, current: 1, description: 'Create your first post' },
                    { id: 2, name: 'Social Butterfly', icon: 'fa-user-friends', color: 'from-blue-500 to-purple-500', progress: 60, target: 10, current: 6, description: 'Follow 10 users' },
                    { id: 3, name: 'Active Commenter', icon: 'fa-comment', color: 'from-green-500 to-teal-500', progress: 40, target: 25, current: 10, description: 'Leave 25 comments' },
                    { id: 4, name: 'Popular User', icon: 'fa-fire', color: 'from-red-500 to-pink-500', progress: 28, target: 7, current: 2, description: 'Post for 7 consecutive days' },
                    { id: 5, name: 'Photographer', icon: 'fa-camera', color: 'from-purple-500 to-indigo-500', progress: 30, target: 10, current: 3, description: 'Upload 10 photos' },
                    { id: 6, name: 'Top Contributor', icon: 'fa-trophy', color: 'from-indigo-500 to-blue-500', progress: 65, target: 100, current: 65, description: 'Receive 100 likes' }
                ];
                
                let achievementsHTML = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">';
                
                achievements.forEach(achievement => {
                    const isCompleted = achievement.progress === 100;
                    achievementsHTML += `
                        <div class="feature-card text-center">
                            <div class="w-16 h-16 rounded-full bg-gradient-to-r ${achievement.color} flex items-center justify-center text-white text-2xl mx-auto mb-4">
                                <i class="fas ${achievement.icon}"></i>
                            </div>
                            <h3 class="text-lg font-bold text-white mb-2">${achievement.name}</h3>
                            <p class="text-blue-300 text-sm mb-4">${achievement.description}</p>
                            <div class="w-full bg-gray-700 rounded-full h-2">
                                <div class="h-2 rounded-full bg-gradient-to-r ${achievement.color}" style="width: ${achievement.progress}%"></div>
                            </div>
                            <span class="text-blue-400 text-xs mt-1">${isCompleted ? 'Completed' : `${achievement.current}/${achievement.target}`}</span>
                        </div>
                    `;
                });
                
                achievementsHTML += '</div>';
                content.innerHTML = achievementsHTML;
            }

            loadDiaryTab() {
                const content = document.getElementById('diaryEntriesContent');
                
                if (this.diaryEntries.length > 0) {
                    let diaryHTML = '<div class="space-y-4">';
                    
                    this.diaryEntries.forEach(entry => {
                        diaryHTML += `
                            <div class="diary-entry">
                                <div class="flex justify-between items-start mb-2">
                                    <h4 class="text-lg font-bold text-white">${entry.title}</h4>
                                    <span class="text-blue-300 text-sm">${entry.createdAt?.toDate?.().toLocaleDateString() || 'Recently'}</span>
                                </div>
                                <p class="text-blue-200 mb-2">${entry.content}</p>
                                <div class="flex justify-between items-center">
                                    <div class="flex items-center">
                                        <i class="fas ${this.getMoodIcon(entry.mood)} ${this.getMoodColor(entry.mood)} mr-2"></i>
                                        <span class="text-blue-300 text-sm capitalize">${entry.mood || 'happy'}</span>
                                    </div>
                                    <span class="text-blue-400 text-sm capitalize">${entry.privacy || 'private'}</span>
                                </div>
                            </div>
                        `;
                    });
                    
                    diaryHTML += '</div>';
                    content.innerHTML = diaryHTML;
                } else {
                    content.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-book-open text-4xl text-blue-400 mb-4"></i>
                            <h3 class="text-xl font-bold text-white mb-2">Your Personal Diary</h3>
                            <p class="text-blue-300 mb-6">Start writing your thoughts and experiences</p>
                        </div>
                    `;
                }
            }

            getMoodIcon(mood) {
                const icons = {
                    happy: 'fa-smile',
                    productive: 'fa-rocket',
                    creative: 'fa-palette',
                    focused: 'fa-bullseye',
                    relaxed: 'fa-couch'
                };
                return icons[mood] || 'fa-smile';
            }

            getMoodColor(mood) {
                const colors = {
                    happy: 'text-yellow-400',
                    productive: 'text-green-400',
                    creative: 'text-purple-400',
                    focused: 'text-blue-400',
                    relaxed: 'text-indigo-400'
                };
                return colors[mood] || 'text-yellow-400';
            }

            applyTheme(theme) {
                const body = document.body;
                const gradients = {
                    'blue-purple': 'from-gray-900 via-blue-900 to-purple-900',
                    'green-blue': 'from-gray-900 via-green-900 to-blue-900',
                    'red-pink': 'from-gray-900 via-red-900 to-pink-900',
                    'yellow-orange': 'from-gray-900 via-yellow-900 to-orange-900',
                    'teal-cyan': 'from-gray-900 via-teal-900 to-cyan-900'
                };
                
                body.className = `h-full bg-gradient-to-br ${gradients[theme] || gradients['blue-purple']} text-white`;
            }

            setupEventListeners() {
                // Tab switching
                document.querySelectorAll('.profile-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        document.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('active'));
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                        
                        tab.classList.add('active');
                        const tabName = tab.getAttribute('data-tab');
                        document.getElementById(`${tabName}Tab`).classList.remove('hidden');
                        
                        this.loadTabContent(tabName);
                    });
                });

                // Logout button
                document.getElementById('logoutBtn').addEventListener('click', () => {
                    this.logout();
                });

                // Edit profile button
                document.getElementById('editProfileBtn').addEventListener('click', () => {
                    this.openEditProfileModal();
                });

                // Find friends button
                document.getElementById('findFriendsBtn').addEventListener('click', () => {
                    this.openFindFriendsModal();
                });

                // View friend requests button
                document.getElementById('viewFriendRequests').addEventListener('click', () => {
                    this.toggleFriendRequests();
                });

                // Close find friends modal
                document.getElementById('closeFindFriends').addEventListener('click', () => {
                    document.getElementById('findFriendsModal').classList.add('hidden');
                });

                // Friend search input
                document.getElementById('friendSearchInput').addEventListener('input', (e) => {
                    this.handleFriendSearch(e.target.value);
                });

                // Cancel edit button
                document.getElementById('cancelEdit').addEventListener('click', () => {
                    document.getElementById('editProfileModal').classList.add('hidden');
                });

                // Save profile button
                document.getElementById('saveProfile').addEventListener('click', () => {
                    this.saveProfileChanges();
                });

                // Add diary entry
                document.getElementById('addDiaryEntry').addEventListener('click', () => {
                    this.openDiaryModal();
                });

                // Cancel diary
                document.getElementById('cancelDiary').addEventListener('click', () => {
                    document.getElementById('diaryModal').classList.add('hidden');
                });

                // Save diary
                document.getElementById('saveDiary').addEventListener('click', () => {
                    this.saveDiaryEntry();
                });

                // Diary mood options
                document.querySelectorAll('#diaryMoodOptions .mood-option').forEach(option => {
                    option.addEventListener('click', () => {
                        document.querySelectorAll('#diaryMoodOptions .mood-option').forEach(opt => opt.classList.remove('active'));
                        option.classList.add('active');
                    });
                });

                // Avatar upload
                document.querySelector('.edit-avatar-btn').addEventListener('click', () => {
                    document.getElementById('avatarInput').click();
                });

                // Cover upload
                document.querySelector('.edit-cover-btn').addEventListener('click', () => {
                    document.getElementById('coverInput').click();
                });

                // File input changes
                document.getElementById('avatarInput').addEventListener('change', (e) => {
                    if (e.target.files && e.target.files[0]) {
                        this.openImageCropper(e.target.files[0], 'avatar');
                    }
                });

                document.getElementById('coverInput').addEventListener('change', (e) => {
                    if (e.target.files && e.target.files[0]) {
                        this.openImageCropper(e.target.files[0], 'cover');
                    }
                });

                // Cropper modal buttons
                document.getElementById('cancelCrop').addEventListener('click', () => {
                    document.getElementById('cropperModal').classList.add('hidden');
                    if (this.cropper) {
                        this.cropper.destroy();
                        this.cropper = null;
                    }
                });

                document.getElementById('applyCrop').addEventListener('click', () => {
                    this.applyImageCrop();
                });

                // Mood selector
                document.getElementById('currentMood').addEventListener('click', () => {
                    this.openMoodSelector();
                });

                // Theme toggle
                document.getElementById('themeToggle').addEventListener('click', () => {
                    this.toggleTheme();
                });

                // Add interest button
                document.getElementById('addInterestBtn').addEventListener('click', () => {
                    this.addNewInterest();
                });

                // Add skill button
                document.getElementById('addSkillBtn').addEventListener('click', () => {
                    this.addNewSkill();
                });

                // Check username button
                document.getElementById('checkUsername').addEventListener('click', () => {
                    this.checkUsernameAvailability();
                });

                // Color options
                document.querySelectorAll('.color-option').forEach(option => {
                    option.addEventListener('click', () => {
                        document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('active'));
                        option.classList.add('active');
                    });
                });

                // Privacy options
                document.querySelectorAll('.privacy-option').forEach(option => {
                    option.addEventListener('click', () => {
                        document.querySelectorAll('.privacy-option').forEach(opt => opt.classList.remove('active'));
                        option.classList.add('active');
                    });
                });

                // Chat input and send button
                document.getElementById('sendMessageBtn').addEventListener('click', () => {
                    this.sendMessage();
                });

                document.getElementById('chatInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.sendMessage();
                    }
                });
            }

            toggleFriendRequests() {
                const friendRequestsSection = document.getElementById('friendRequestsSection');
                friendRequestsSection.classList.toggle('hidden');
            }

            async openFindFriendsModal() {
                document.getElementById('findFriendsModal').classList.remove('hidden');
                await this.loadPeopleSuggestions(this.currentUser.uid);
                this.displayPeopleSuggestions();
            }

            async handleFriendSearch(searchTerm) {
                const resultsContainer = document.getElementById('friendSearchResults');
                
                if (searchTerm.length < 2) {
                    resultsContainer.innerHTML = '<p class="text-blue-300 text-center p-4">Type at least 2 characters to search</p>';
                    return;
                }
                
                resultsContainer.innerHTML = '<p class="text-blue-300 text-center p-4">Searching...</p>';
                
                const results = await this.searchUsers(searchTerm);
                
                if (results.length === 0) {
                    resultsContainer.innerHTML = '<p class="text-blue-300 text-center p-4">No users found</p>';
                    return;
                }
                
                let resultsHTML = '';
                results.forEach(user => {
                    const isFriend = this.friends.some(friend => friend.id === user.id);
                    const hasPendingRequest = this.friendRequests.some(req => req.fromUserId === user.id);
                    
                    resultsHTML += `
                        <div class="suggestion-item">
                            <div class="friend-avatar" style="${user.profilePicture ? `background-image: url('${user.profilePicture}')` : ''}">
                                ${user.profilePicture ? '' : user.displayName?.charAt(0) || 'U'}
                            </div>
                            <div class="friend-info">
                                <div class="friend-name">${user.displayName}</div>
                                <div class="friend-status">@${user.username}</div>
                            </div>
                            ${!isFriend && !hasPendingRequest ? `
                                <button class="add-friend-btn" data-user-id="${user.id}">
                                    <i class="fas fa-user-plus"></i>
                                </button>
                            ` : ''}
                            ${hasPendingRequest ? `
                                <button class="add-friend-btn" disabled style="opacity: 0.5;">
                                    <i class="fas fa-clock"></i> Pending
                                </button>
                            ` : ''}
                            ${isFriend ? `
                                <button class="add-friend-btn" disabled style="opacity: 0.5;">
                                    <i class="fas fa-check"></i> Friends
                                </button>
                            ` : ''}
                        </div>
                    `;
                });
                
                resultsContainer.innerHTML = resultsHTML;
                
                // Add event listeners to add friend buttons
                document.querySelectorAll('.add-friend-btn:not(:disabled)').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const userId = btn.getAttribute('data-user-id');
                        this.sendFriendRequest(userId);
                        btn.disabled = true;
                        btn.innerHTML = '<i class="fas fa-clock"></i> Pending';
                        btn.style.opacity = '0.5';
                    });
                });
            }

            displayPeopleSuggestions() {
                const container = document.getElementById('peopleYouMayKnow');
                
                if (this.peopleSuggestions.length === 0) {
                    container.innerHTML = '<p class="text-blue-300 text-center p-4">No suggestions available</p>';
                    return;
                }
                
                let suggestionsHTML = '';
                this.peopleSuggestions.forEach(user => {
                    const isFriend = this.friends.some(friend => friend.id === user.id);
                    const hasPendingRequest = this.friendRequests.some(req => req.fromUserId === user.id);
                    
                    suggestionsHTML += `
                        <div class="suggestion-item">
                            <div class="friend-avatar" style="${user.profilePicture ? `background-image: url('${user.profilePicture}')` : ''}">
                                ${user.profilePicture ? '' : user.displayName?.charAt(0) || 'U'}
                            </div>
                            <div class="friend-info">
                                <div class="friend-name">${user.displayName}</div>
                                <div class="friend-status">@${user.username}</div>
                            </div>
                            ${!isFriend && !hasPendingRequest ? `
                                <button class="add-friend-btn" data-user-id="${user.id}">
                                    <i class="fas fa-user-plus"></i>
                                </button>
                            ` : ''}
                            ${hasPendingRequest ? `
                                <button class="add-friend-btn" disabled style="opacity: 0.5;">
                                    <i class="fas fa-clock"></i> Pending
                                </button>
                            ` : ''}
                            ${isFriend ? `
                                <button class="add-friend-btn" disabled style="opacity: 0.5;">
                                    <i class="fas fa-check"></i> Friends
                                </button>
                            ` : ''}
                        </div>
                    `;
                });
                
                container.innerHTML = suggestionsHTML;
                
                // Add event listeners to add friend buttons
                document.querySelectorAll('.add-friend-btn:not(:disabled)').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const userId = btn.getAttribute('data-user-id');
                        this.sendFriendRequest(userId);
                        btn.disabled = true;
                        btn.innerHTML = '<i class="fas fa-clock"></i> Pending';
                        btn.style.opacity = '0.5';
                    });
                });
            }

            // ... (Other methods like openEditProfileModal, saveProfileChanges, etc. remain the same)

            async loadProfileOnce(uid) {
                try {
                    const userRef = window.firebaseApp.firestore.doc(window.firebaseApp.db, "users", uid);
                    const doc = await window.firebaseApp.firestore.getDoc(userRef);
                    
                    if (doc.exists()) {
                        this.userProfile = { id: doc.id, ...doc.data() };
                        this.updateProfileUI(this.userProfile);
                        this.updateSidebar(this.userProfile);
                        this.calculateProfileCompletion(this.userProfile);
                        this.showLoading(false);
                        this.showProfileLayout();
                    } else {
                        this.createNewProfile(uid);
                    }
                } catch (error) {
                    console.error("Fallback load also failed:", error);
                    this.createFallbackProfile();
                }
            }

            async createNewProfile(uid) {
                try {
                    const newProfile = {
                        displayName: this.currentUser.displayName || this.currentUser.email.split('@')[0],
                        email: this.currentUser.email,
                        username: this.generateUsername(this.currentUser.email),
                        bio: "Welcome to my Kynecta profile!  Share your thoughts, connect with friends, and explore the community!",
                        location: "",
                        interests: ["Technology", "Networking", "Learning", "Innovation"],
                        skills: ["Communication", "Problem Solving", "Creativity"],
                        socialLinks: {
                            twitter: "",
                            instagram: "",
                            facebook: "",
                            linkedin: "",
                            github: "",
                            website: ""
                        },
                        profilePicture: "",
                        coverPhoto: "",
                        privacy: "public",
                        theme: "blue-purple",
                        mood: "happy",
                        createdAt: window.firebaseApp.firestore.serverTimestamp(),
                        lastActive: window.firebaseApp.firestore.serverTimestamp(),
                        stats: {
                            posts: 0,
                            followers: 0,
                            following: 0,
                            reputation: 100,
                            profileViews: 0
                        },
                        isOnline: true
                    };

                    const userRef = window.firebaseApp.firestore.doc(window.firebaseApp.db, "users", uid);
                    await window.firebaseApp.firestore.setDoc(userRef, newProfile);
                    
                    console.log("New profile created successfully");
                    this.userProfile = newProfile;
                    
                } catch (error) {
                    console.error("Error creating new profile:", error);
                    this.createFallbackProfile();
                }
            }

            createFallbackProfile() {
                console.log("Creating fallback profile UI");
                const fallbackProfile = {
                    displayName: this.currentUser.displayName || this.currentUser.email.split('@')[0],
                    email: this.currentUser.email,
                    username: this.generateUsername(this.currentUser.email),
                    bio: "Welcome to my Kynecta profile! ",
                    location: "Unknown",
                    interests: ["Technology", "Networking", "Learning"],
                    skills: ["Communication", "Problem Solving"],
                    stats: {
                        posts: 0,
                        followers: 0,
                        following: 0,
                        reputation: 100
                    }
                };
                
                this.userProfile = fallbackProfile;
                this.updateProfileUI(fallbackProfile);
                this.updateSidebar(fallbackProfile);
                this.showLoading(false);
                this.showProfileLayout();
            }

            generateUsername(email) {
                return email.split('@')[0].toLowerCase().replace(/[^a-z0-9]/g, '');
            }

            openEditProfileModal() {
                if (!this.userProfile) return;
                
                // Populate form fields
                document.getElementById('editDisplayName').value = this.userProfile.displayName;
                document.getElementById('editUsername').value = this.userProfile.username;
                document.getElementById('editBio').value = this.userProfile.bio || '';
                document.getElementById('editLocation').value = this.userProfile.location || '';
                document.getElementById('editTwitter').value = this.userProfile.socialLinks?.twitter || '';
                document.getElementById('editInstagram').value = this.userProfile.socialLinks?.instagram || '';
                document.getElementById('editFacebook').value = this.userProfile.socialLinks?.facebook || '';
                document.getElementById('editLinkedin').value = this.userProfile.socialLinks?.linkedin || '';
                document.getElementById('editGithub').value = this.userProfile.socialLinks?.github || '';
                document.getElementById('editWebsite').value = this.userProfile.socialLinks?.website || '';
                
                // Populate interests
                const interestsContainer = document.getElementById('editInterestsContainer');
                interestsContainer.innerHTML = '';
                if (this.userProfile.interests) {
                    this.userProfile.interests.forEach(interest => {
                        this.addInterestToEditForm(interest);
                    });
                }
                
                // Populate skills
                const skillsContainer = document.getElementById('editSkillsContainer');
                skillsContainer.innerHTML = '';
                if (this.userProfile.skills) {
                    this.userProfile.skills.forEach(skill => {
                        this.addSkillToEditForm(skill);
                    });
                }
                
                // Set privacy option
                document.querySelectorAll('.privacy-option').forEach(option => {
                    if (option.getAttribute('data-privacy') === this.userProfile.privacy) {
                        option.classList.add('active');
                    }
                });
                
                // Set color option
                document.querySelectorAll('.color-option').forEach(option => {
                    if (option.getAttribute('data-color') === this.userProfile.theme) {
                        option.classList.add('active');
                    }
                });
                
                // Show modal
                document.getElementById('editProfileModal').classList.remove('hidden');
            }

            addInterestToEditForm(interest) {
                const container = document.getElementById('editInterestsContainer');
                const interestElement = document.createElement('div');
                interestElement.className = 'flex items-center glass-effect px-3 py-1 rounded-full';
                interestElement.innerHTML = `
                    <span class="text-blue-300 text-sm">${interest}</span>
                    <button type="button" class="ml-2 text-red-400 hover:text-red-300">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                `;
                
                const removeButton = interestElement.querySelector('button');
                removeButton.addEventListener('click', () => {
                    interestElement.remove();
                });
                
                container.appendChild(interestElement);
            }

            addSkillToEditForm(skill) {
                const container = document.getElementById('editSkillsContainer');
                const skillElement = document.createElement('div');
                skillElement.className = 'flex items-center glass-effect px-3 py-1 rounded-full';
                skillElement.innerHTML = `
                    <span class="text-blue-300 text-sm">${skill}</span>
                    <button type="button" class="ml-2 text-red-400 hover:text-red-300">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                `;
                
                const removeButton = skillElement.querySelector('button');
                removeButton.addEventListener('click', () => {
                    skillElement.remove();
                });
                
                container.appendChild(skillElement);
            }

            addNewInterest() {
                const input = document.getElementById('newInterestInput');
                const interest = input.value.trim();
                if (interest) {
                    this.addInterestToEditForm(interest);
                    input.value = '';
                }
            }

            addNewSkill() {
                const input = document.getElementById('newSkillInput');
                const skill = input.value.trim();
                if (skill) {
                    this.addSkillToEditForm(skill);
                    input.value = '';
                }
            }

            async checkUsernameAvailability() {
                const username = document.getElementById('editUsername').value.trim().toLowerCase();
                const availability = document.getElementById('usernameAvailability');
                
                if (!username) {
                    availability.innerHTML = '<span class="text-red-400">Please enter a username</span>';
                    availability.classList.remove('hidden');
                    return;
                }
                
                if (username === this.userProfile.username) {
                    availability.innerHTML = '<span class="text-green-400">This is your current username</span>';
                    availability.classList.remove('hidden');
                    return;
                }
                
                // Simulate username check
                setTimeout(() => {
                    const isAvailable = Math.random() > 0.5;
                    if (isAvailable) {
                        availability.innerHTML = '<span class="text-green-400">Username is available!</span>';
                    } else {
                        availability.innerHTML = '<span class="text-red-400">Username is already taken</span>';
                    }
                    availability.classList.remove('hidden');
                }, 1000);
            }

            async saveProfileChanges() {
                try {
                    // Get interests from edit form
                    const interestElements = document.getElementById('editInterestsContainer').querySelectorAll('div');
                    const interests = Array.from(interestElements).map(el => 
                        el.querySelector('span').textContent
                    );

                    // Get skills from edit form
                    const skillElements = document.getElementById('editSkillsContainer').querySelectorAll('div');
                    const skills = Array.from(skillElements).map(el => 
                        el.querySelector('span').textContent
                    );

                    // Get selected privacy
                    const selectedPrivacy = document.querySelector('.privacy-option.active').getAttribute('data-privacy');
                    
                    // Get selected theme
                    const selectedTheme = document.querySelector('.color-option.active').getAttribute('data-color');

                    const updatedProfile = {
                        displayName: document.getElementById('editDisplayName').value.trim(),
                        username: document.getElementById('editUsername').value.trim().toLowerCase(),
                        bio: document.getElementById('editBio').value.trim(),
                        location: document.getElementById('editLocation').value.trim(),
                        interests: interests,
                        skills: skills,
                        socialLinks: {
                            twitter: document.getElementById('editTwitter').value.trim(),
                            instagram: document.getElementById('editInstagram').value.trim(),
                            facebook: document.getElementById('editFacebook').value.trim(),
                            linkedin: document.getElementById('editLinkedin').value.trim(),
                            github: document.getElementById('editGithub').value.trim(),
                            website: document.getElementById('editWebsite').value.trim()
                        },
                        privacy: selectedPrivacy,
                        theme: selectedTheme,
                        updatedAt: window.firebaseApp.firestore.serverTimestamp()
                    };
                    
                    // Update in Firestore
                    const userRef = window.firebaseApp.firestore.doc(window.firebaseApp.db, "users", this.currentUser.uid);
                    await window.firebaseApp.firestore.updateDoc(userRef, updatedProfile);
                    
                    // Close modal
                    document.getElementById('editProfileModal').classList.add('hidden');
                    
                    this.showNotification('Profile updated successfully!', 'success');
                } catch (error) {
                    console.error('Error updating profile:', error);
                    this.showNotification('Error updating profile. Please try again.', 'error');
                }
            }

            openImageCropper(file, type) {
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    document.getElementById('cropperImage').src = e.target.result;
                    document.getElementById('cropperModal').classList.remove('hidden');
                    document.getElementById('cropperTitle').textContent = `Crop ${type === 'avatar' ? 'Profile Picture' : 'Cover Photo'}`;
                    this.currentEditingImage = type;
                    
                    // Initialize cropper
                    if (this.cropper) {
                        this.cropper.destroy();
                    }
                    
                    this.cropper = new Cropper(document.getElementById('cropperImage'), {
                        aspectRatio: type === 'avatar' ? 1 : 16/9,
                        viewMode: 1,
                        autoCropArea: 1,
                        responsive: true,
                        guides: false
                    });
                };
                
                reader.readAsDataURL(file);
            }

            applyImageCrop() {
                if (!this.cropper || !this.currentEditingImage) return;
                
                // Get cropped canvas
                const canvas = this.cropper.getCroppedCanvas({
                    width: this.currentEditingImage === 'avatar' ? 400 : 1200,
                    height: this.currentEditingImage === 'avatar' ? 400 : 675
                });
                
                // Convert to blob and simulate upload
                canvas.toBlob(async (blob) => {
                    try {
                        // Simulate upload delay
                        this.showNotification('Uploading image...', 'info');
                        
                        setTimeout(async () => {
                            // Create a mock URL for the uploaded image
                            const mockImageUrl = URL.createObjectURL(blob);
                            
                            // Update user profile with new image URL
                            const updateData = {};
                            updateData[this.currentEditingImage === 'avatar' ? 'profilePicture' : 'coverPhoto'] = mockImageUrl;
                            
                            const userRef = window.firebaseApp.firestore.doc(window.firebaseApp.db, "users", this.currentUser.uid);
                            await window.firebaseApp.firestore.updateDoc(userRef, updateData);
                            
                            // Close cropper
                            document.getElementById('cropperModal').classList.add('hidden');
                            this.cropper.destroy();
                            this.cropper = null;
                            this.currentEditingImage = null;
                            
                            this.showNotification(`${this.currentEditingImage === 'avatar' ? 'Profile picture' : 'Cover photo'} updated successfully!`, 'success');
                        }, 2000);
                        
                    } catch (error) {
                        console.error('Error updating image:', error);
                        this.showNotification('Error updating image', 'error');
                    }
                });
            }

            openMoodSelector() {
                const moodSelector = document.createElement('div');
                moodSelector.className = 'absolute top-full left-0 mt-2 z-10 glass-effect rounded-2xl p-4 border border-blue-700';
                moodSelector.innerHTML = `
                    <h4 class="text-blue-300 font-semibold mb-2">How are you feeling?</h4>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="mood-option" data-mood="happy">
                            <i class="fas fa-smile text-yellow-400 mr-2"></i>
                            <span>Happy</span>
                        </div>
                        <div class="mood-option" data-mood="productive">
                            <i class="fas fa-rocket text-green-400 mr-2"></i>
                            <span>Productive</span>
                        </div>
                        <div class="mood-option" data-mood="creative">
                            <i class="fas fa-palette text-purple-400 mr-2"></i>
                            <span>Creative</span>
                        </div>
                        <div class="mood-option" data-mood="focused">
                            <i class="fas fa-bullseye text-blue-400 mr-2"></i>
                            <span>Focused</span>
                        </div>
                        <div class="mood-option" data-mood="relaxed">
                            <i class="fas fa-couch text-indigo-400 mr-2"></i>
                            <span>Relaxed</span>
                        </div>
                    </div>
                `;
                
                const currentMood = document.getElementById('currentMood');
                currentMood.appendChild(moodSelector);
                
                const moodOptions = moodSelector.querySelectorAll('.mood-option');
                moodOptions.forEach(option => {
                    option.addEventListener('click', () => {
                        const mood = option.getAttribute('data-mood');
                        this.updateUserMood(mood);
                        moodSelector.remove();
                    });
                });
                
                document.addEventListener('click', (e) => {
                    if (!currentMood.contains(e.target)) {
                        moodSelector.remove();
                    }
                });
            }

            async updateUserMood(mood) {
                try {
                    const userRef = window.firebaseApp.firestore.doc(window.firebaseApp.db, "users", this.currentUser.uid);
                    await window.firebaseApp.firestore.updateDoc(userRef, {
                        mood: mood,
                        lastActive: window.firebaseApp.firestore.serverTimestamp()
                    });
                    
                    this.showNotification(`Mood updated to ${mood}`, 'success');
                } catch (error) {
                    console.error('Error updating mood:', error);
                    this.showNotification('Error updating mood', 'error');
                }
            }

            openDiaryModal() {
                // Reset form
                document.getElementById('diaryTitle').value = '';
                document.getElementById('diaryContent').value = '';
                document.querySelectorAll('#diaryMoodOptions .mood-option').forEach(opt => opt.classList.remove('active'));
                document.querySelector('#diaryMoodOptions .mood-option').classList.add('active');
                document.getElementById('diaryPrivacy').value = 'private';
                
                document.getElementById('diaryModal').classList.remove('hidden');
            }

            async saveDiaryEntry() {
                const title = document.getElementById('diaryTitle').value.trim();
                const content = document.getElementById('diaryContent').value.trim();
                const privacy = document.getElementById('diaryPrivacy').value;
                const moodElement = document.querySelector('#diaryMoodOptions .mood-option.active');
                const mood = moodElement ? moodElement.getAttribute('data-mood') : 'happy';
                
                if (!title || !content) {
                    this.showNotification('Please fill in both title and content', 'error');
                    return;
                }
                
                try {
                    const newEntry = {
                        userId: this.currentUser.uid,
                        title: title,
                        content: content,
                        mood: mood,
                        privacy: privacy,
                        createdAt: window.firebaseApp.firestore.serverTimestamp()
                    };
                    
                    await window.firebaseApp.firestore.addDoc(
                        window.firebaseApp.firestore.collection(window.firebaseApp.db, "diary"),
                        newEntry
                    );
                    
                    document.getElementById('diaryModal').classList.add('hidden');
                    
                    this.showNotification('Diary entry saved successfully!', 'success');
                    
                    // Reload diary entries
                    await this.loadDiaryEntries(this.currentUser.uid);
                    this.loadDiaryTab();
                    
                } catch (error) {
                    console.error('Error saving diary entry:', error);
                    this.showNotification('Error saving diary entry. Please try again.', 'error');
                }
            }

            toggleTheme() {
                this.isDarkMode = !this.isDarkMode;
                const themeToggle = document.getElementById('themeToggle');
                
                if (this.isDarkMode) {
                    themeToggle.classList.add('dark');
                    document.body.className = 'h-full bg-gradient-to-br from-gray-900 via-blue-900 to-purple-900 text-white';
                } else {
                    themeToggle.classList.remove('dark');
                    document.body.className = 'h-full bg-gradient-to-br from-blue-50 via-white to-purple-50 text-gray-800';
                }
                
                this.showNotification(`${this.isDarkMode ? 'Dark' : 'Light'} mode activated`, 'success');
            }

            async logout() {
                try {
                    // Update user status to offline
                    if (this.currentUser && this.userProfile) {
                        const userRef = window.firebaseApp.firestore.doc(window.firebaseApp.db, "users", this.currentUser.uid);
                        await window.firebaseApp.firestore.updateDoc(userRef, {
                            isOnline: false,
                            lastActive: window.firebaseApp.firestore.serverTimestamp()
                        });
                    }
                    
                    // Unsubscribe from listeners
                    if (this.profileUnsubscribe) this.profileUnsubscribe();
                    if (this.chatUnsubscribe) this.chatUnsubscribe();
                    if (this.friendsUnsubscribe) this.friendsUnsubscribe();
                    if (this.friendRequestsUnsubscribe) this.friendRequestsUnsubscribe();
                    
                    await window.firebaseApp.authFunctions.signOut(window.firebaseApp.auth);
                    localStorage.clear();
                    sessionStorage.clear();
                    window.location.href = 'login.html';
                } catch (error) {
                    console.error('Logout error:', error);
                    this.showNotification('Logout failed. Please try again.', 'error');
                }
            }

            updateConnectionStatus(status) {
                const statusElement = document.getElementById('connectionStatus');
                const textElement = document.getElementById('connectionText');
                
                statusElement.className = 'connection-status ' + status;
                
                switch(status) {
                    case 'connected':
                        textElement.textContent = 'Connected to Kynecta';
                        statusElement.innerHTML = '<i class="fas fa-wifi mr-2"></i><span id="connectionText">Connected to Kynecta</span>';
                        break;
                    case 'connecting':
                        textElement.textContent = 'Connecting to Kynecta...';
                        statusElement.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-2"></i><span id="connectionText">Connecting to Kynecta...</span>';
                        break;
                    case 'error':
                        textElement.textContent = 'Connection Error';
                        statusElement.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i><span id="connectionText">Connection Error</span>';
                        break;
                }
            }

            showLoading(show) {
                const spinner = document.getElementById('loadingSpinner');
                spinner.style.display = show ? 'flex' : 'none';
            }

            showProfileLayout() {
                const layout = document.getElementById('profileLayout');
                layout.classList.remove('hidden');
            }

            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 glass-effect border rounded-2xl px-6 py-4 z-50 ${
                    type === 'error' ? 'border-red-500 text-red-300' : 
                    type === 'success' ? 'border-green-500 text-green-300' : 
                    'border-blue-500 text-blue-300'
                }`;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 5000);
            }
        }

        // Initialize the application
        window.initProfileApp = function() {
            const app = new ProfileApplication();
            app.initialize();
        };

        // Start the app when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', window.initProfileApp);
        } else {
            window.initProfileApp();
        }
    </script>
</body>
</html>