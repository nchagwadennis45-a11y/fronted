<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premium Games Hub - Kynecta</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="responsive.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            --premium-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            --game-gradient-1: linear-gradient(135deg, #8b5cf6, #a855f7);
            --game-gradient-2: linear-gradient(135deg, #ec4899, #db2777);
            --game-gradient-3: linear-gradient(135deg, #10b981, #059669);
            --game-gradient-4: linear-gradient(135deg, #06b6d4, #0891b2);
            --game-gradient-5: linear-gradient(135deg, #f97316, #ea580c);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .primary-gradient {
            background: var(--primary-gradient);
        }
        .premium-gradient {
            background: var(--premium-gradient);
        }
        .game-gradient-1 { background: var(--game-gradient-1); }
        .game-gradient-2 { background: var(--game-gradient-2); }
        .game-gradient-3 { background: var(--game-gradient-3); }
        .game-gradient-4 { background: var(--game-gradient-4); }
        .game-gradient-5 { background: var(--game-gradient-5); }
        
        .card-glow {
            box-shadow: 0 0 30px rgba(59, 130, 246, 0.4);
        }
        
        /* Game-specific styles */
        .game-card {
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        .game-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        .game-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-gradient);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }
        .game-card:hover::before {
            transform: scaleX(1);
        }
        
        /* Animated backgrounds */
        .animated-bg {
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
        }
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* Chess Board */
        .chess-board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            width: 400px;
            height: 400px;
            border: 2px solid #374151;
        }
        .chess-square {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .chess-square.white {
            background: #f0d9b5;
        }
        .chess-square.black {
            background: #b58863;
        }
        .chess-square.selected {
            background: #bbcb2b;
        }
        .chess-square.valid-move {
            background: #86efac;
        }
        
        /* Word Puzzle */
        .word-puzzle-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
            margin-bottom: 20px;
        }
        .word-cell {
            width: 50px;
            height: 50px;
            border: 2px solid #374151;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            text-transform: uppercase;
        }
        .word-cell.filled {
            background: #4b5563;
        }
        .word-cell.correct {
            background: #10b981;
            border-color: #059669;
        }
        .word-cell.partial {
            background: #f59e0b;
            border-color: #d97706;
        }
        .word-cell.incorrect {
            background: #6b7280;
            border-color: #4b5563;
        }
        
        /* Memory Game */
        .memory-card {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            transition: transform 0.3s ease;
            transform-style: preserve-3d;
        }
        .memory-card.flipped {
            transform: rotateY(180deg);
            background: linear-gradient(135deg, #4fd1c7, #38b2ac);
        }
        .memory-card.matched {
            background: linear-gradient(135deg, #10b981, #059669);
            cursor: default;
        }
        
        /* Quiz Game */
        .quiz-option {
            background: #374151;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .quiz-option:hover {
            background: #4b5563;
        }
        .quiz-option.correct {
            background: #10b981;
        }
        .quiz-option.incorrect {
            background: #ef4444;
        }
        
        /* Tic Tac Toe */
        .tic-tac-toe-board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            width: 300px;
            height: 300px;
            gap: 5px;
            background: #374151;
        }
        .tic-tac-toe-cell {
            background: #1f2937;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .tic-tac-toe-cell:hover {
            background: #374151;
        }
        .tic-tac-toe-cell.x {
            color: #3b82f6;
        }
        .tic-tac-toe-cell.o {
            color: #ef4444;
        }
        
        /* Sudoku */
        .sudoku-board {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            grid-template-rows: repeat(9, 1fr);
            width: 450px;
            height: 450px;
            border: 2px solid #374151;
        }
        .sudoku-cell {
            border: 1px solid #4b5563;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            background: #1f2937;
        }
        .sudoku-cell:nth-child(3n) {
            border-right: 2px solid #374151;
        }
        .sudoku-cell:nth-child(9n) {
            border-right: 1px solid #4b5563;
        }
        .sudoku-cell:nth-child(n+19):nth-child(-n+27),
        .sudoku-cell:nth-child(n+46):nth-child(-n+54) {
            border-bottom: 2px solid #374151;
        }
        .sudoku-cell.selected {
            background: #3b82f6;
        }
        .sudoku-cell.prefilled {
            background: #374151;
            font-weight: bold;
        }
        .sudoku-cell.error {
            background: #ef4444;
        }
        
        /* Premium Badge */
        .premium-badge {
            background: var(--premium-gradient);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* Loading states */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Toast notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            z-index: 10000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        .toast.show {
            transform: translateX(0);
        }
        .toast.success {
            background: #10b981;
        }
        .toast.error {
            background: #ef4444;
        }
        .toast.info {
            background: #3b82f6;
        }

        /* Debug panel */
        .debug-panel {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            z-index: 1000;
        }

        /* Keyboard for word puzzle */
        .keyboard {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 5px;
            margin-top: 20px;
        }
        .key {
            padding: 10px;
            background: #4b5563;
            border: none;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .key:hover {
            background: #6b7280;
        }
        .key:active {
            transform: scale(0.95);
        }
        .key.used {
            background: #6b7280;
        }
        .key.correct {
            background: #10b981;
        }
        .key.partial {
            background: #f59e0b;
        }

        /* Level progression */
        .level-badge {
            background: linear-gradient(135deg, #8b5cf6, #a855f7);
            animation: glow 2s infinite;
        }
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 5px #8b5cf6; }
            50% { box-shadow: 0 0 20px #8b5cf6; }
        }

        /* Payment methods */
        .payment-method {
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .payment-method.selected {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }

        /* Fade in animation */
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Chat styles */
        .chat-container {
            height: 300px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
        }
        .chat-message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            max-width: 80%;
        }
        .chat-message.own {
            background: rgba(59, 130, 246, 0.3);
            margin-left: auto;
        }
        .chat-message.other {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Leaderboard styles */
        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 5px;
            transition: all 0.2s ease;
        }
        .leaderboard-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        .leaderboard-rank {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-weight: bold;
            margin-right: 10px;
        }
        .rank-1 { background: gold; color: black; }
        .rank-2 { background: silver; color: black; }
        .rank-3 { background: #cd7f32; color: white; }
        .rank-other { background: #4b5563; color: white; }

        /* Game image placeholder */
        .game-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            background: linear-gradient(45deg, #3b82f6, #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 48px;
        }

        /* Search and filter styles */
        .search-container {
            position: relative;
        }
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(30, 41, 59, 0.95);
            border-radius: 8px;
            z-index: 10;
            max-height: 300px;
            overflow-y: auto;
        }
        .search-result-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .search-result-item:hover {
            background: rgba(59, 130, 246, 0.2);
        }

        /* Dark mode toggle */
        .theme-toggle {
            width: 60px;
            height: 30px;
            background: #4b5563;
            border-radius: 15px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
        }
        .theme-toggle.active {
            background: #3b82f6;
        }
        .theme-toggle::after {
            content: '';
            position: absolute;
            width: 26px;
            height: 26px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
        }
        .theme-toggle.active::after {
            transform: translateX(30px);
        }

        /* New Game Features */
        .live-tournament {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(249, 115, 22, 0.2));
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        .achievement-badge {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-right: 10px;
        }
        .streak-counter {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            animation: streakGlow 2s infinite;
        }
        @keyframes streakGlow {
            0%, 100% { box-shadow: 0 0 10px rgba(245, 158, 11, 0.5); }
            50% { box-shadow: 0 0 20px rgba(245, 158, 11, 0.8); }
        }
        .game-trailer {
            width: 100%;
            height: 200px;
            background: linear-gradient(45deg, #3b82f6, #8b5cf6);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 48px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .game-trailer:hover {
            transform: scale(1.02);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .chess-board {
                width: 300px;
                height: 300px;
            }
            .memory-card {
                width: 60px;
                height: 60px;
            }
            .word-cell {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }
            .tic-tac-toe-board {
                width: 250px;
                height: 250px;
            }
            .sudoku-board {
                width: 300px;
                height: 300px;
            }
            .search-container input {
                width: 200px;
            }
        }
    </style>
</head>
<body class="h-full bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 text-white">
    <!-- Debug Panel -->
    <div class="debug-panel" id="debugPanel">
        <div>Firebase: <span id="firebaseStatus">Checking...</span></div>
        <div>User: <span id="userStatus">Unknown</span></div>
        <div>Coins: <span id="coinsStatus">0</span></div>
        <div>Level: <span id="levelStatus">1</span></div>
    </div>

    <!-- Toast Notifications -->
    <div id="toastContainer"></div>

    <div class="min-h-screen">
        <!-- Header -->
        <div class="glass-card border-b border-slate-700">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 primary-gradient rounded-2xl flex items-center justify-center">
                            <i class="fas fa-gamepad text-white"></i>
                        </div>
                        <div>
                            <h1 class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-400">
                                Kynecta Game Center
                            </h1>
                            <p class="text-slate-400 text-sm">Unlimited levels & premium rewards</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <!-- Theme Toggle -->
                        <div class="theme-toggle" id="themeToggle" onclick="toggleTheme()">
                            <i class="fas fa-moon absolute left-1 top-1 text-yellow-400 text-xs"></i>
                            <i class="fas fa-sun absolute right-1 top-1 text-yellow-400 text-xs"></i>
                        </div>
                        
                        <!-- Search Bar -->
                        <div class="search-container relative">
                            <input type="text" id="gameSearch" placeholder="Search games..." 
                                   class="bg-slate-800 text-white px-4 py-2 rounded-lg w-64 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <div class="search-results hidden" id="searchResults"></div>
                        </div>
                        
                        <div class="text-right">
                            <div class="font-semibold text-white" id="userCoins">0 coins</div>
                            <div class="text-slate-400 text-sm" id="userLevel">Level 1</div>
                        </div>
                        <img id="userAvatar" class="w-10 h-10 rounded-full border-2 border-slate-600" alt="User Avatar">
                    </div>
                </div>
            </div>
        </div>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Quick Stats & Mood-Based Suggestions -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- Quick Stats -->
                <div class="glass-card rounded-2xl p-6">
                    <h3 class="text-lg font-bold text-white mb-4">Your Gaming Stats</h3>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-slate-400">Games Played</span>
                            <span class="text-white font-semibold" id="gamesPlayedCount">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-400">Total Coins</span>
                            <span class="text-yellow-400 font-semibold" id="totalCoinsEarned">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-400">Current Streak</span>
                            <span class="text-green-400 font-semibold" id="currentStreak">0 days</span>
                        </div>
                    </div>
                </div>
                
                <!-- Mood-Based Suggestions -->
                <div class="glass-card rounded-2xl p-6">
                    <h3 class="text-lg font-bold text-white mb-4">Mood-Based Suggestions</h3>
                    <div class="space-y-3">
                        <button class="w-full text-left p-3 rounded-lg bg-slate-800 hover:bg-slate-700 transition" onclick="suggestGames('relaxing')">
                            <div class="flex items-center">
                                <i class="fas fa-spa text-green-400 mr-3"></i>
                                <div>
                                    <div class="font-medium text-white">Feeling relaxed?</div>
                                    <div class="text-sm text-slate-400">Try puzzle games</div>
                                </div>
                            </div>
                        </button>
                        <button class="w-full text-left p-3 rounded-lg bg-slate-800 hover:bg-slate-700 transition" onclick="suggestGames('energetic')">
                            <div class="flex items-center">
                                <i class="fas fa-bolt text-yellow-400 mr-3"></i>
                                <div>
                                    <div class="font-medium text-white">Feeling energetic?</div>
                                    <div class="text-sm text-slate-400">Try action games</div>
                                </div>
                            </div>
                        </button>
                        <button class="w-full text-left p-3 rounded-lg bg-slate-800 hover:bg-slate-700 transition" onclick="suggestGames('competitive')">
                            <div class="flex items-center">
                                <i class="fas fa-trophy text-purple-400 mr-3"></i>
                                <div>
                                    <div class="font-medium text-white">Feeling competitive?</div>
                                    <div class="text-sm text-slate-400">Try multiplayer games</div>
                                </div>
                            </div>
                        </button>
                    </div>
                </div>
                
                <!-- Daily Rewards -->
                <div class="glass-card rounded-2xl p-6 premium-gradient text-white">
                    <h3 class="text-lg font-bold mb-4">Daily Login Reward</h3>
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <div class="text-2xl font-black" id="dailyReward">+100</div>
                            <div class="text-sm opacity-80">coins waiting</div>
                        </div>
                        <i class="fas fa-gift text-3xl"></i>
                    </div>
                    <button class="w-full py-2 bg-white text-orange-600 rounded-lg font-semibold hover:bg-opacity-90 transition" onclick="claimDailyReward()">
                        Claim Reward
                    </button>
                </div>
            </div>

            <!-- Live Tournament Banner -->
            <div class="live-tournament rounded-2xl p-6 mb-8 flex items-center justify-between">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-red-500 rounded-full flex items-center justify-center mr-4">
                        <i class="fas fa-fire text-white"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-black text-white">Live Tournament: Word Master</h2>
                        <p class="text-red-200">Ends in 2:15:43 - 5,000 coin prize pool</p>
                    </div>
                </div>
                <button class="px-6 py-2 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600 transition">
                    Join Now
                </button>
            </div>

            <!-- Level Progression Banner -->
            <div class="glass-card rounded-2xl p-6 mb-8 border border-purple-500/30">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-black text-white mb-2">Unlimited Gaming Experience</h2>
                        <p class="text-slate-400">Play thousands of levels across all games. Progress never resets!</p>
                    </div>
                    <div class="level-badge px-4 py-2 rounded-full text-white font-bold">
                        Level <span id="currentLevelDisplay">1</span>
                    </div>
                </div>
                <div class="mt-4 bg-slate-700 rounded-full h-3">
                    <div id="levelProgress" class="bg-gradient-to-r from-purple-500 to-pink-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
                <div class="flex justify-between text-sm text-slate-400 mt-2">
                    <span>Level <span id="currentLevel">1</span></span>
                    <span>Next: <span id="nextLevel">2</span></span>
                </div>
            </div>

            <!-- Recently Played & Popular Games -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                <!-- Recently Played -->
                <div class="lg:col-span-2">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-400">
                            Recently Played
                        </h2>
                        <button class="text-slate-400 hover:text-white text-sm" onclick="viewAllRecentGames()">
                            View All
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="recentlyPlayed">
                        <!-- Recently played games will be loaded here -->
                    </div>
                </div>
                
                <!-- Popular Games -->
                <div>
                    <h2 class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400 mb-6">
                        Popular Games
                    </h2>
                    <div class="space-y-4" id="popularGames">
                        <!-- Popular games will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Game Categories & Filter -->
            <div class="mb-6">
                <div class="flex flex-wrap gap-2 mb-4">
                    <button class="px-4 py-2 rounded-full glass-card text-white hover:bg-slate-700 transition active" data-category="all">
                        All Games
                    </button>
                    <button class="px-4 py-2 rounded-full glass-card text-white hover:bg-slate-700 transition" data-category="puzzle">
                        Puzzle
                    </button>
                    <button class="px-4 py-2 rounded-full glass-card text-white hover:bg-slate-700 transition" data-category="strategy">
                        Strategy
                    </button>
                    <button class="px-4 py-2 rounded-full glass-card text-white hover:bg-slate-700 transition" data-category="trivia">
                        Trivia
                    </button>
                    <button class="px-4 py-2 rounded-full glass-card text-white hover:bg-slate-700 transition" data-category="action">
                        Action
                    </button>
                </div>
            </div>

            <!-- Featured Games -->
            <div class="mb-8">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400">
                        Featured Games
                    </h2>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="featuredGames">
                    <!-- Game cards will be loaded here -->
                </div>
            </div>

            <!-- Premium Games Section -->
            <div class="mb-8">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-orange-400">
                        <i class="fas fa-crown mr-2"></i>Premium Games
                    </h2>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="premiumGames">
                    <!-- Premium game cards will be loaded here -->
                </div>
            </div>

            <!-- New Games Section -->
            <div class="mb-8">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-blue-400">
                        <i class="fas fa-star mr-2"></i>New & Trending
                    </h2>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="newGames">
                    <!-- New game cards will be loaded here -->
                </div>
            </div>

            <!-- Leaderboard Section -->
            <div class="mb-8">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-blue-400">
                        <i class="fas fa-trophy mr-2"></i>Leaderboards
                    </h2>
                    <div class="flex space-x-2">
                        <button class="px-3 py-1 rounded-lg glass-card text-white text-sm" onclick="showLeaderboard('daily')">
                            Daily
                        </button>
                        <button class="px-3 py-1 rounded-lg glass-card text-white text-sm" onclick="showLeaderboard('weekly')">
                            Weekly
                        </button>
                        <button class="px-3 py-1 rounded-lg glass-card text-white text-sm active" onclick="showLeaderboard('alltime')">
                            All Time
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Top Players -->
                    <div class="glass-card rounded-2xl p-6">
                        <h3 class="text-xl font-bold text-white mb-4">Top Players</h3>
                        <div id="topPlayers">
                            <!-- Top players will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Your Ranking -->
                    <div class="glass-card rounded-2xl p-6">
                        <h3 class="text-xl font-bold text-white mb-4">Your Ranking</h3>
                        <div id="userRanking">
                            <!-- User ranking will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Multiplayer & Challenges -->
            <div class="mb-8">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-red-400 to-pink-400">
                        <i class="fas fa-users mr-2"></i>Multiplayer & Challenges
                    </h2>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Active Challenges -->
                    <div class="glass-card rounded-2xl p-6">
                        <h3 class="text-xl font-bold text-white mb-4">Active Challenges</h3>
                        <div id="activeChallenges">
                            <div class="text-center text-slate-400 py-8">
                                <i class="fas fa-trophy text-4xl mb-4 text-yellow-400"></i>
                                <p>No active challenges</p>
                                <p class="text-sm">Challenge friends to play games together!</p>
                            </div>
                        </div>
                        <button class="w-full mt-4 py-2 primary-gradient text-white rounded-lg font-semibold hover:scale-105 transition" onclick="showChallengeModal()">
                            Create Challenge
                        </button>
                    </div>
                    
                    <!-- Friends Online -->
                    <div class="glass-card rounded-2xl p-6">
                        <h3 class="text-xl font-bold text-white mb-4">Friends Online</h3>
                        <div id="friendsOnline">
                            <div class="text-center text-slate-400 py-8">
                                <i class="fas fa-users text-4xl mb-4 text-blue-400"></i>
                                <p>No friends online</p>
                                <p class="text-sm">Invite friends to join the fun!</p>
                            </div>
                        </div>
                        <button class="w-full mt-4 py-2 glass-card border border-slate-700 text-white rounded-lg font-semibold hover:border-blue-400 transition" onclick="showFriendsModal()">
                            Invite Friends
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Modals -->
    
    <!-- Chess Game Modal -->
    <div id="chessGameModal" class="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50 hidden">
        <div class="glass-card rounded-2xl p-6 max-w-2xl w-full fade-in">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h3 class="text-2xl font-black text-white">Quantum Chess</h3>
                    <p class="text-slate-400">Level <span id="chessLevel">1</span> - Unlimited progression</p>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-green-400 font-bold" id="chessStatus">White's Turn</span>
                    <button class="text-slate-400 hover:text-white" onclick="closeGameModal('chessGameModal')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="flex justify-center mb-6">
                <div class="chess-board" id="chessBoard">
                    <!-- Chess board will be generated here -->
                </div>
            </div>
            
            <div class="flex space-x-3">
                <button class="flex-1 px-4 py-2 glass-card border border-slate-700 rounded-xl text-slate-400 hover:border-blue-400 hover:text-blue-400 transition" onclick="closeGameModal('chessGameModal')">
                    Exit Game
                </button>
                <button class="flex-1 px-4 py-2 primary-gradient text-white rounded-xl font-semibold hover:scale-105 transition" onclick="nextChessLevel()">
                    Next Level
                </button>
            </div>
        </div>
    </div>

    <!-- Word Puzzle Modal -->
    <div id="wordPuzzleModal" class="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50 hidden">
        <div class="glass-card rounded-2xl p-6 max-w-2xl w-full fade-in">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h3 class="text-2xl font-black text-white">Word Master</h3>
                    <p class="text-slate-400">Level <span id="wordPuzzleLevel">1</span> - Unlimited words</p>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-green-400 font-bold" id="wordPuzzleStatus">Guess the 5-letter word!</span>
                    <button class="text-slate-400 hover:text-white" onclick="closeGameModal('wordPuzzleModal')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="mb-6 text-center">
                <div id="wordPuzzleGrid" class="word-puzzle-grid">
                    <!-- Word puzzle grid will be generated here -->
                </div>
                <div class="keyboard" id="wordKeyboard">
                    <!-- Keyboard will be generated here -->
                </div>
            </div>
            
            <div class="flex space-x-3">
                <button class="flex-1 px-4 py-2 glass-card border border-slate-700 rounded-xl text-slate-400 hover:border-blue-400 hover:text-blue-400 transition" onclick="closeGameModal('wordPuzzleModal')">
                    Exit Game
                </button>
                <button class="flex-1 px-4 py-2 primary-gradient text-white rounded-xl font-semibold hover:scale-105 transition" onclick="nextWordPuzzleLevel()">
                    Next Word
                </button>
            </div>
        </div>
    </div>

    <!-- Memory Game Modal -->
    <div id="memoryGameModal" class="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50 hidden">
        <div class="glass-card rounded-2xl p-6 max-w-2xl w-full fade-in">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h3 class="text-2xl font-black text-white">Memory Matrix</h3>
                    <p class="text-slate-400">Level <span id="memoryLevel">1</span> - Increasing difficulty</p>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-green-400 font-bold" id="memoryMoves">Moves: 0</span>
                    <button class="text-slate-400 hover:text-white" onclick="closeGameModal('memoryGameModal')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="mb-4 text-center" id="memoryGameGrid">
                <!-- Memory cards will be generated here -->
            </div>
            
            <div class="flex space-x-3">
                <button class="flex-1 px-4 py-2 glass-card border border-slate-700 rounded-xl text-slate-400 hover:border-blue-400 hover:text-blue-400 transition" onclick="closeGameModal('memoryGameModal')">
                    Exit Game
                </button>
                <button class="flex-1 px-4 py-2 primary-gradient text-white rounded-xl font-semibold hover:scale-105 transition" onclick="nextMemoryLevel()">
                    Next Level
                </button>
            </div>
        </div>
    </div>

    <!-- Quiz Game Modal -->
    <div id="quizGameModal" class="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50 hidden">
        <div class="glass-card rounded-2xl p-6 max-w-2xl w-full fade-in">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h3 class="text-2xl font-black text-white" id="quizGameTitle">Knowledge Challenge</h3>
                    <p class="text-slate-400">Level <span id="quizLevel">1</span> - Choose your category</p>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-green-400 font-bold" id="quizScore">Score: 0/0</span>
                    <button class="text-slate-400 hover:text-white" onclick="closeGameModal('quizGameModal')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="mb-6" id="quizGameContent">
                <!-- Quiz content will be loaded here -->
            </div>
            
            <div class="flex space-x-3">
                <button class="flex-1 px-4 py-2 glass-card border border-slate-700 rounded-xl text-slate-400 hover:border-blue-400 hover:text-blue-400 transition" onclick="closeGameModal('quizGameModal')">
                    Exit Game
                </button>
                <button class="flex-1 px-4 py-2 primary-gradient text-white rounded-xl font-semibold hover:scale-105 transition" id="nextQuizQuestion" onclick="loadNextQuizQuestion()">
                    Next Question
                </button>
            </div>
        </div>
    </div>

    <!-- Tic Tac Toe Modal -->
    <div id="ticTacToeModal" class="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50 hidden">
        <div class="glass-card rounded-2xl p-6 max-w-2xl w-full fade-in">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h3 class="text-2xl font-black text-white">Tic Tac Toe</h3>
                    <p class="text-slate-400">Play against the computer</p>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-green-400 font-bold" id="ticTacToeStatus">Your turn (X)</span>
                    <button class="text-slate-400 hover:text-white" onclick="closeGameModal('ticTacToeModal')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="flex justify-center mb-6">
                <div class="tic-tac-toe-board" id="ticTacToeBoard">
                    <!-- Tic Tac Toe board will be generated here -->
                </div>
            </div>
            
            <div class="flex space-x-3">
                <button class="flex-1 px-4 py-2 glass-card border border-slate-700 rounded-xl text-slate-400 hover:border-blue-400 hover:text-blue-400 transition" onclick="closeGameModal('ticTacToeModal')">
                    Exit Game
                </button>
                <button class="flex-1 px-4 py-2 primary-gradient text-white rounded-xl font-semibold hover:scale-105 transition" onclick="resetTicTacToe()">
                    New Game
                </button>
            </div>
        </div>
    </div>

    <!-- Sudoku Modal -->
    <div id="sudokuModal" class="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50 hidden">
        <div class="glass-card rounded-2xl p-6 max-w-2xl w-full fade-in">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h3 class="text-2xl font-black text-white">Sudoku</h3>
                    <p class="text-slate-400">Level <span id="sudokuLevel">1</span> - Fill the grid with numbers</p>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-green-400 font-bold" id="sudokuStatus">Select a cell</span>
                    <button class="text-slate-400 hover:text-white" onclick="closeGameModal('sudokuModal')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="flex flex-col items-center mb-6">
                <div class="sudoku-board" id="sudokuBoard">
                    <!-- Sudoku board will be generated here -->
                </div>
                <div class="mt-4 grid grid-cols-5 gap-2" id="sudokuControls">
                    <!-- Number controls will be generated here -->
                </div>
            </div>
            
            <div class="flex space-x-3">
                <button class="flex-1 px-4 py-2 glass-card border border-slate-700 rounded-xl text-slate-400 hover:border-blue-400 hover:text-blue-400 transition" onclick="closeGameModal('sudokuModal')">
                    Exit Game
                </button>
                <button class="flex-1 px-4 py-2 primary-gradient text-white rounded-xl font-semibold hover:scale-105 transition" onclick="nextSudokuLevel()">
                    Next Puzzle
                </button>
            </div>
        </div>
    </div>

    <!-- Quiz Category Selection Modal -->
    <div id="quizCategoryModal" class="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50 hidden">
        <div class="glass-card rounded-2xl p-6 max-w-md w-full fade-in">
            <div class="text-center mb-6">
                <div class="w-16 h-16 primary-gradient rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-brain text-white text-2xl"></i>
                </div>
                <h3 class="text-2xl font-black text-white mb-2">Choose Quiz Category</h3>
                <p class="text-slate-400">Select your preferred topic</p>
            </div>
            
            <div class="space-y-3 mb-6" id="quizCategories">
                <!-- Categories will be loaded here -->
            </div>
            
            <div class="flex space-x-3">
                <button class="flex-1 px-4 py-2 glass-card border border-slate-700 rounded-xl text-slate-400 hover:border-blue-400 hover:text-blue-400 transition" onclick="closeGameModal('quizCategoryModal')">
                    Cancel
                </button>
                <button class="flex-1 px-4 py-2 primary-gradient text-white rounded-xl font-semibold hover:scale-105 transition" onclick="startSelectedQuiz()">
                    Start Quiz
                </button>
            </div>
        </div>
    </div>

    <!-- Premium Subscription Modal -->
    <div id="premiumModal" class="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50 hidden">
        <div class="glass-card rounded-2xl p-6 max-w-2xl w-full fade-in">
            <div class="text-center mb-6">
                <div class="w-16 h-16 premium-gradient rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-crown text-white text-2xl"></i>
                </div>
                <h3 class="text-2xl font-black text-white mb-2">Upgrade to Kynecta Premium</h3>
                <p class="text-slate-400">Choose your preferred payment method</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Coins Payment -->
                <div class="payment-method glass-card p-6 rounded-xl cursor-pointer" onclick="selectPaymentMethod('coins')">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-coins text-yellow-400 text-2xl mr-3"></i>
                        <h4 class="text-lg font-bold text-white">Pay with Coins</h4>
                    </div>
                    <p class="text-slate-400 text-sm mb-4">Use your earned coins to unlock premium</p>
                    <div class="text-center">
                        <div class="text-2xl font-black text-yellow-400">5,000</div>
                        <div class="text-slate-400 text-sm">coins</div>
                    </div>
                    <div class="text-xs text-slate-500 mt-2">Your coins: <span id="userCoinBalance">0</span></div>
                </div>

                <!-- M-Pesa Payment -->
                <div class="payment-method glass-card p-6 rounded-xl cursor-pointer" onclick="selectPaymentMethod('mpesa')">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-mobile-alt text-green-400 text-2xl mr-3"></i>
                        <h4 class="text-lg font-bold text-white">M-Pesa</h4>
                    </div>
                    <p class="text-slate-400 text-sm mb-4">Instant activation via M-Pesa</p>
                    <div class="text-center">
                        <div class="text-2xl font-black text-green-400">KSh 99</div>
                        <div class="text-slate-400 text-sm">per month</div>
                    </div>
                    <div class="text-xs text-slate-500 mt-2">+254 XXX XXX XXX</div>
                </div>

                <!-- Bank Transfer -->
                <div class="payment-method glass-card p-6 rounded-xl cursor-pointer" onclick="selectPaymentMethod('bank')">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-university text-blue-400 text-2xl mr-3"></i>
                        <h4 class="text-lg font-bold text-white">Bank Transfer</h4>
                    </div>
                    <p class="text-slate-400 text-sm mb-4">Direct bank transfer option</p>
                    <div class="text-center">
                        <div class="text-2xl font-black text-blue-400">KSh 99</div>
                        <div class="text-slate-400 text-sm">per month</div>
                    </div>
                    <div class="text-xs text-slate-500 mt-2">Account: 1234567890</div>
                </div>

                <!-- Credit Card -->
                <div class="payment-method glass-card p-6 rounded-xl cursor-pointer" onclick="selectPaymentMethod('card')">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-credit-card text-purple-400 text-2xl mr-3"></i>
                        <h4 class="text-lg font-bold text-white">Credit Card</h4>
                    </div>
                    <p class="text-slate-400 text-sm mb-4">Secure card payment</p>
                    <div class="text-center">
                        <div class="text-2xl font-black text-purple-400">$0.99</div>
                        <div class="text-slate-400 text-sm">per month</div>
                    </div>
                    <div class="text-xs text-slate-500 mt-2">Visa, MasterCard, Amex</div>
                </div>
            </div>

            <div class="text-center mb-6">
                <div class="text-sm text-slate-400">
                    <i class="fas fa-shield-check text-green-400 mr-1"></i>
                    All payments are secure and encrypted
                </div>
            </div>
            
            <div class="flex space-x-3">
                <button class="flex-1 px-4 py-2 glass-card border border-slate-700 rounded-xl text-slate-400 hover:border-blue-400 hover:text-blue-400 transition" onclick="closePremiumModal()">
                    Maybe Later
                </button>
                <button class="flex-1 px-4 py-2 premium-gradient text-white rounded-xl font-semibold hover:scale-105 transition" id="subscribeButton" onclick="processPremiumPayment()">
                    Subscribe Now
                </button>
            </div>
        </div>
    </div>

    <!-- Payment Processing Modal -->
    <div id="paymentModal" class="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50 hidden">
        <div class="glass-card rounded-2xl p-6 max-w-md w-full fade-in text-center">
            <div class="w-16 h-16 primary-gradient rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-spinner fa-spin text-white text-2xl" id="paymentIcon"></i>
            </div>
            <h3 class="text-2xl font-black text-white mb-2" id="paymentTitle">Processing Payment</h3>
            <p class="text-slate-400 mb-6" id="paymentMessage">Please wait while we process your payment...</p>
            <div class="loading-spinner mx-auto mb-4"></div>
            <button class="w-full px-4 py-2 glass-card border border-slate-700 rounded-xl text-slate-400 hover:border-blue-400 hover:text-blue-400 transition hidden" id="paymentCloseButton" onclick="closePaymentModal()">
                Close
            </button>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDHHyGgsSV18BcXrGgzi4C8frzDAE1C1zo",
            authDomain: "uniconnect-ee95c.firebaseapp.com",
            projectId: "uniconnect-ee95c",
            storageBucket: "uniconnect-ee95c.firebasestorage.app",
            messagingSenderId: "1003264444309",
            appId: "1:1003264444309:web:9f0307516e44d21e97d89c"
        };

        // Initialize Firebase
        let auth, db, storage;
        try {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            storage = firebase.storage();
            
            // Clear any cached data
            localStorage.removeItem('userData');
            sessionStorage.clear();
            
            document.getElementById('firebaseStatus').textContent = 'Connected ';
            document.getElementById('firebaseStatus').style.color = '#10b981';
        } catch (error) {
            document.getElementById('firebaseStatus').textContent = 'Failed ';
            document.getElementById('firebaseStatus').style.color = '#ef4444';
            console.error("Firebase initialization error:", error);
        }

        // Current user and data
        let currentUser = null;
        let userData = null;

        // Game data - Updated with Kynecta branding and new games
        const gamesData = [
            {
                id: "memory",
                name: "Memory Matrix",
                description: "Test your memory with unlimited levels",
                category: "puzzle",
                players: "1",
                coins: 80,
                gradient: "game-gradient-1",
                icon: "fa-brain",
                image: "memory.jpg",
                featured: true,
                premium: false,
                unlimitedLevels: true,
                popularity: 85,
                rating: 4.5,
                new: false
            },
            {
                id: "quiz",
                name: "Knowledge Challenge",
                description: "Test your knowledge across multiple categories",
                category: "trivia",
                players: "1",
                coins: 120,
                gradient: "game-gradient-2",
                icon: "fa-brain",
                image: "quiz.jpg",
                featured: true,
                premium: false,
                unlimitedLevels: true,
                popularity: 92,
                rating: 4.7,
                new: false
            },
            {
                id: "chess",
                name: "Quantum Chess",
                description: "Strategic chess with unlimited progression",
                category: "strategy",
                players: "2",
                coins: 200,
                gradient: "game-gradient-3",
                icon: "fa-chess",
                image: "chess.jpg",
                featured: true,
                premium: true,
                unlimitedLevels: true,
                popularity: 78,
                rating: 4.8,
                new: false
            },
            {
                id: "wordpuzzle",
                name: "Word Master",
                description: "Unlimited word puzzles with increasing difficulty",
                category: "puzzle",
                players: "1",
                coins: 150,
                gradient: "game-gradient-4",
                icon: "fa-font",
                image: "wordpuzzle.jpg",
                featured: true,
                premium: true,
                unlimitedLevels: true,
                popularity: 88,
                rating: 4.6,
                new: false
            },
            {
                id: "sudoku",
                name: "Number Matrix",
                description: "Thousands of Sudoku puzzles",
                category: "puzzle",
                players: "1",
                coins: 180,
                gradient: "game-gradient-5",
                icon: "fa-th-large",
                image: "sudoku.jpg",
                featured: false,
                premium: true,
                unlimitedLevels: true,
                popularity: 75,
                rating: 4.4,
                new: false
            },
            {
                id: "tictactoe",
                name: "Tic Tac Toe",
                description: "Classic game with multiplayer support",
                category: "strategy",
                players: "2",
                coins: 50,
                gradient: "game-gradient-1",
                icon: "fa-times",
                image: "tictactoe.jpg",
                featured: false,
                premium: false,
                unlimitedLevels: true,
                popularity: 65,
                rating: 4.2,
                new: false
            },
            {
                id: "trivia",
                name: "Quick Trivia",
                description: "Fast-paced trivia with various topics",
                category: "trivia",
                players: "1-4",
                coins: 100,
                gradient: "game-gradient-2",
                icon: "fa-question-circle",
                image: "trivia.jpg",
                featured: false,
                premium: false,
                unlimitedLevels: true,
                popularity: 80,
                rating: 4.3,
                new: true
            },
            {
                id: "puzzle2048",
                name: "2048 Challenge",
                description: "Slide and combine numbers to reach 2048",
                category: "puzzle",
                players: "1",
                coins: 90,
                gradient: "game-gradient-3",
                icon: "fa-th",
                image: "2048.jpg",
                featured: false,
                premium: false,
                unlimitedLevels: true,
                popularity: 82,
                rating: 4.5,
                new: true
            },
            {
                id: "wordsearch",
                name: "Word Search Pro",
                description: "Find hidden words in a grid",
                category: "puzzle",
                players: "1",
                coins: 110,
                gradient: "game-gradient-4",
                icon: "fa-search",
                image: "wordsearch.jpg",
                featured: false,
                premium: false,
                unlimitedLevels: true,
                popularity: 70,
                rating: 4.2,
                new: true
            }
        ];

        // Quiz Categories
        const quizCategories = [
            {
                id: "technology",
                name: "Technology & Programming",
                icon: "fa-laptop-code",
                color: "text-blue-400",
                questions: [
                    {
                        question: "What does API stand for?",
                        options: [
                            "Application Programming Interface",
                            "Advanced Programming Interface", 
                            "Application Process Integration",
                            "Automated Programming Interface"
                        ],
                        correct: 0
                    },
                    {
                        question: "Which language is used for web styling?",
                        options: [
                            "JavaScript",
                            "Python",
                            "CSS",
                            "HTML"
                        ],
                        correct: 2
                    },
                    {
                        question: "What does HTML stand for?",
                        options: [
                            "Hyper Text Markup Language",
                            "High Tech Modern Language", 
                            "Hyper Transfer Markup Language",
                            "Home Tool Markup Language"
                        ],
                        correct: 0
                    }
                ]
            },
            {
                id: "science",
                name: "Science & Nature",
                icon: "fa-flask",
                color: "text-green-400",
                questions: [
                    {
                        question: "What is the chemical symbol for gold?",
                        options: [
                            "Go",
                            "Gd", 
                            "Au",
                            "Ag"
                        ],
                        correct: 2
                    },
                    {
                        question: "Which planet is known as the Red Planet?",
                        options: [
                            "Venus",
                            "Mars", 
                            "Jupiter",
                            "Saturn"
                        ],
                        correct: 1
                    },
                    {
                        question: "What is the largest mammal in the world?",
                        options: [
                            "Elephant",
                            "Blue Whale", 
                            "Giraffe",
                            "Polar Bear"
                        ],
                        correct: 1
                    }
                ]
            }
        ];

        // Game state variables (unchanged from original)
        let chessGame = {
            board: [],
            currentPlayer: 'white',
            selectedPiece: null,
            validMoves: [],
            currentLevel: 1
        };

        let wordPuzzle = {
            targetWord: '',
            currentGuess: '',
            guesses: [],
            maxGuesses: 6,
            gameOver: false,
            currentLevel: 1,
            wordList: [
                'APPLE', 'BRAIN', 'CHESS', 'DREAM', 'EARTH', 'FLAME', 'GRAPE', 'HOUSE',
                'IMAGE', 'JOKER', 'KNIFE', 'LIGHT', 'MAGIC', 'NIGHT', 'OCEAN', 'PIANO',
                'QUEEN', 'RIVER', 'SMILE', 'TIGER', 'UMBRA', 'VOICE', 'WATER', 'YACHT',
                'ZEBRA', 'ALPHA', 'BROWN', 'CLOUD', 'DANCE', 'EAGLE', 'FRUIT', 'GHOST'
            ]
        };

        let memoryGame = {
            cards: [],
            flippedCards: [],
            matchedPairs: 0,
            moves: 0,
            totalPairs: 8,
            currentLevel: 1
        };

        let quizGame = {
            questions: [],
            currentQuestion: 0,
            score: 0,
            totalQuestions: 5,
            currentLevel: 1,
            selectedCategory: null
        };

        let ticTacToe = {
            board: Array(9).fill(''),
            currentPlayer: 'X',
            gameOver: false,
            winner: null
        };

        let sudokuGame = {
            board: [],
            solution: [],
            selectedCell: null,
            currentLevel: 1,
            mistakes: 0
        };

        // Payment state
        let selectedPaymentMethod = null;

        // Level progression system
        const LEVEL_XP_REQUIREMENTS = {
            1: 100, 2: 250, 3: 500, 4: 1000, 5: 2000,
            6: 4000, 7: 8000, 8: 16000, 9: 32000, 10: 64000
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
            loadNewGames();
        });

        function initializeApp() {
            // Set up auth state listener
            auth.onAuthStateChanged(async (user) => {
                currentUser = user;
                
                if (user) {
                    document.getElementById('userStatus').textContent = user.email;
                    document.getElementById('userStatus').style.color = '#10b981';
                    await loadUserData(user.uid);
                } else {
                    document.getElementById('userStatus').textContent = 'Not signed in';
                    document.getElementById('userStatus').style.color = '#ef4444';
                    // Use demo data for guests
                    userData = { 
                        coins: 1000, 
                        level: 1, 
                        gamesPlayed: 0, 
                        displayName: "Guest", 
                        isPremium: false,
                        profilePicture: null,
                        gameProgress: {
                            chess: { level: 1, xp: 0 },
                            wordpuzzle: { level: 1, xp: 0 },
                            memory: { level: 1, xp: 0 },
                            quiz: { level: 1, xp: 0 },
                            tictactoe: { level: 1, xp: 0 },
                            sudoku: { level: 1, xp: 0 }
                        }
                    };
                    updateUI();
                    loadGames();
                }
            });
        }

        async function loadUserData(userId) {
            try {
                const userDoc = await db.collection('users').doc(userId).get();
                
                if (userDoc.exists) {
                    userData = userDoc.data();
                    updateUI();
                    loadGames();
                    loadLeaderboard();
                    loadRecentGames();
                    loadPopularGames();
                } else {
                    // Create new user document
                    userData = {
                        coins: 100,
                        level: 1,
                        gamesPlayed: 0,
                        totalCoinsEarned: 0,
                        displayName: currentUser.displayName || "Player",
                        email: currentUser.email,
                        isPremium: false,
                        profilePicture: currentUser.photoURL || "",
                        streak: 0,
                        lastLogin: new Date(),
                        achievements: [],
                        recentGames: [],
                        friends: [],
                        challenges: [],
                        gameProgress: {
                            chess: { level: 1, xp: 0 },
                            wordpuzzle: { level: 1, xp: 0 },
                            memory: { level: 1, xp: 0 },
                            quiz: { level: 1, xp: 0 },
                            tictactoe: { level: 1, xp: 0 },
                            sudoku: { level: 1, xp: 0 }
                        }
                    };
                    await db.collection('users').doc(userId).set(userData);
                    updateUI();
                    loadGames();
                }
            } catch (error) {
                console.error("Error loading user data:", error);
                userData = { 
                    coins: 500, 
                    level: 1, 
                    gamesPlayed: 0, 
                    displayName: "Guest", 
                    isPremium: false,
                    profilePicture: null,
                    gameProgress: {
                        chess: { level: 1, xp: 0 },
                        wordpuzzle: { level: 1, xp: 0 },
                        memory: { level: 1, xp: 0 },
                        quiz: { level: 1, xp: 0 },
                        tictactoe: { level: 1, xp: 0 },
                        sudoku: { level: 1, xp: 0 }
                    }
                };
                updateUI();
                loadGames();
            }
        }

        function updateUI() {
            if (userData) {
                document.getElementById('userCoins').textContent = userData.coins + ' coins';
                document.getElementById('coinsStatus').textContent = userData.coins;
                document.getElementById('userLevel').textContent = 'Level ' + userData.level;
                document.getElementById('levelStatus').textContent = userData.level;
                document.getElementById('currentLevelDisplay').textContent = userData.level;
                document.getElementById('currentLevel').textContent = userData.level;
                document.getElementById('nextLevel').textContent = userData.level + 1;
                document.getElementById('gamesPlayedCount').textContent = userData.gamesPlayed || 0;
                document.getElementById('totalCoinsEarned').textContent = userData.totalCoinsEarned || 0;
                document.getElementById('currentStreak').textContent = (userData.streak || 0) + ' days';
                document.getElementById('userCoinBalance').textContent = userData.coins.toLocaleString();
                
                // Update level progress
                const currentLevel = userData.level;
                const currentXP = userData.gameProgress ? Object.values(userData.gameProgress).reduce((total, game) => total + game.xp, 0) : 0;
                const xpForCurrentLevel = LEVEL_XP_REQUIREMENTS[currentLevel] || 100;
                const xpForNextLevel = LEVEL_XP_REQUIREMENTS[currentLevel + 1] || xpForCurrentLevel * 2;
                const progress = ((currentXP - xpForCurrentLevel) / (xpForNextLevel - xpForCurrentLevel)) * 100;
                
                document.getElementById('levelProgress').style.width = `${Math.max(0, Math.min(100, progress))}%`;
                
                // Update user avatar
                const avatar = document.getElementById('userAvatar');
                if (userData.profilePicture) {
                    avatar.src = userData.profilePicture;
                } else {
                    avatar.src = "https://ui-avatars.com/api/?name=" + encodeURIComponent(userData.displayName) + "&background=3b82f6&color=fff";
                }
            }
        }

        function loadGames() {
            const featuredContainer = document.getElementById('featuredGames');
            const premiumContainer = document.getElementById('premiumGames');
            
            featuredContainer.innerHTML = '';
            premiumContainer.innerHTML = '';
            
            gamesData.forEach(game => {
                const gameCard = createGameCard(game);
                
                if (game.featured) {
                    featuredContainer.appendChild(gameCard);
                }
                
                if (game.premium) {
                    premiumContainer.appendChild(gameCard);
                }
            });
        }

        function loadNewGames() {
            const newContainer = document.getElementById('newGames');
            newContainer.innerHTML = '';
            
            const newGames = gamesData.filter(game => game.new);
            
            newGames.forEach(game => {
                const gameCard = createGameCard(game);
                newContainer.appendChild(gameCard);
            });
        }

        function createGameCard(game) {
            const card = document.createElement('div');
            card.className = `game-card glass-card rounded-2xl overflow-hidden fade-in ${game.gradient}`;
            card.onclick = () => startGame(game.id);
            
            const isPremium = game.premium;
            const isUnlocked = !isPremium || (userData && userData.isPremium);
            const isNew = game.new;
            
            card.innerHTML = `
                <div class="relative">
                    <div class="game-image">
                        <i class="${game.icon}"></i>
                    </div>
                    ${isPremium ? '<div class="absolute top-3 right-3 premium-badge px-2 py-1 rounded-full text-xs font-bold text-white"><i class="fas fa-crown mr-1"></i>PREMIUM</div>' : ''}
                    ${isNew ? '<div class="absolute top-3 left-3 bg-green-500 px-2 py-1 rounded-full text-xs font-bold text-white"><i class="fas fa-star mr-1"></i>NEW</div>' : ''}
                    ${!isUnlocked ? '<div class="absolute inset-0 bg-black bg-opacity-70 flex items-center justify-center"><i class="fas fa-lock text-3xl text-white"></i></div>' : ''}
                </div>
                <div class="p-4">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-bold text-white text-lg">${game.name}</h3>
                        <div class="flex items-center text-sm text-white">
                            <i class="fas fa-star text-yellow-400 mr-1"></i>
                            <span>${game.rating}</span>
                        </div>
                    </div>
                    <p class="text-slate-300 text-sm mb-3">${game.description}</p>
                    <div class="flex justify-between items-center">
                        <div class="flex items-center text-sm text-slate-300">
                            <i class="fas fa-users mr-1"></i>
                            <span>${game.players}</span>
                            <i class="fas fa-coins ml-3 mr-1 text-yellow-400"></i>
                            <span>${game.coins}</span>
                        </div>
                        <div class="text-xs px-2 py-1 rounded-full bg-black bg-opacity-30 text-white">
                            ${game.category}
                        </div>
                    </div>
                </div>
            `;
            
            return card;
        }

        function loadRecentGames() {
            const container = document.getElementById('recentlyPlayed');
            container.innerHTML = '';
            
            if (userData && userData.recentGames && userData.recentGames.length > 0) {
                userData.recentGames.slice(0, 4).forEach(gameId => {
                    const game = gamesData.find(g => g.id === gameId);
                    if (game) {
                        const gameCard = createGameCard(game);
                        container.appendChild(gameCard);
                    }
                });
            } else {
                container.innerHTML = '<p class="text-slate-400">No recently played games</p>';
            }
        }

        function loadPopularGames() {
            const container = document.getElementById('popularGames');
            container.innerHTML = '';
            
            // Sort games by popularity and take top 3
            const popularGames = [...gamesData]
                .sort((a, b) => b.popularity - a.popularity)
                .slice(0, 3);
            
            popularGames.forEach(game => {
                const gameItem = document.createElement('div');
                gameItem.className = 'glass-card rounded-xl p-4 flex items-center space-x-4';
                gameItem.onclick = () => startGame(game.id);
                
                gameItem.innerHTML = `
                    <div class="w-12 h-12 ${game.gradient} rounded-lg flex items-center justify-center text-white">
                        <i class="${game.icon}"></i>
                    </div>
                    <div class="flex-1">
                        <h4 class="font-semibold text-white">${game.name}</h4>
                        <div class="flex items-center text-sm text-slate-400">
                            <i class="fas fa-users mr-1"></i>
                            <span>${game.popularity}% playing</span>
                        </div>
                    </div>
                    <div class="text-sm text-slate-400">
                        ${game.coins} <i class="fas fa-coins text-yellow-400 ml-1"></i>
                    </div>
                `;
                
                container.appendChild(gameItem);
            });
        }

        function loadLeaderboard() {
            // This would fetch real leaderboard data from Firestore
            const topPlayersContainer = document.getElementById('topPlayers');
            const userRankingContainer = document.getElementById('userRanking');
            
            // Mock data for demonstration
            const topPlayers = [
                { name: "ProGamer123", score: 15420, rank: 1 },
                { name: "GameMaster", score: 14250, rank: 2 },
                { name: "StrategyKing", score: 13890, rank: 3 },
                { name: "PuzzleSolver", score: 12560, rank: 4 },
                { name: "QuizWhiz", score: 11840, rank: 5 }
            ];
            
            topPlayersContainer.innerHTML = '';
            topPlayers.forEach(player => {
                const playerElement = document.createElement('div');
                playerElement.className = 'leaderboard-item';
                
                playerElement.innerHTML = `
                    <div class="leaderboard-rank rank-${player.rank}">${player.rank}</div>
                    <div class="flex-1">
                        <div class="font-medium text-white">${player.name}</div>
                        <div class="text-sm text-slate-400">${player.score.toLocaleString()} points</div>
                    </div>
                `;
                
                topPlayersContainer.appendChild(playerElement);
            });
            
            // User ranking
            if (userData) {
                userRankingContainer.innerHTML = `
                    <div class="leaderboard-item">
                        <div class="leaderboard-rank rank-other">7</div>
                        <div class="flex-1">
                            <div class="font-medium text-white">${userData.displayName}</div>
                            <div class="text-sm text-slate-400">${(userData.totalCoinsEarned || 0).toLocaleString()} points</div>
                        </div>
                    </div>
                `;
            } else {
                userRankingContainer.innerHTML = '<p class="text-slate-400">Sign in to see your ranking</p>';
            }
        }

        function setupEventListeners() {
            // Search functionality
            const searchInput = document.getElementById('gameSearch');
            searchInput.addEventListener('input', handleSearch);
            
            // Category filters
            document.querySelectorAll('[data-category]').forEach(button => {
                button.addEventListener('click', function() {
                    const category = this.getAttribute('data-category');
                    filterGamesByCategory(category);
                    
                    // Update active state
                    document.querySelectorAll('[data-category]').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    this.classList.add('active');
                });
            });
        }

        function handleSearch(e) {
            const query = e.target.value.toLowerCase();
            const resultsContainer = document.getElementById('searchResults');
            
            if (query.length < 2) {
                resultsContainer.classList.add('hidden');
                return;
            }
            
            const filteredGames = gamesData.filter(game => 
                game.name.toLowerCase().includes(query) || 
                game.category.toLowerCase().includes(query) ||
                game.description.toLowerCase().includes(query)
            );
            
            resultsContainer.innerHTML = '';
            
            if (filteredGames.length === 0) {
                resultsContainer.innerHTML = '<div class="search-result-item text-slate-400">No games found</div>';
            } else {
                filteredGames.forEach(game => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'search-result-item';
                    resultItem.innerHTML = `
                        <div class="font-medium text-white">${game.name}</div>
                        <div class="text-sm text-slate-400">${game.category}</div>
                    `;
                    resultItem.onclick = () => {
                        startGame(game.id);
                        resultsContainer.classList.add('hidden');
                        searchInput.value = '';
                    };
                    resultsContainer.appendChild(resultItem);
                });
            }
            
            resultsContainer.classList.remove('hidden');
        }

        function filterGamesByCategory(category) {
            const featuredContainer = document.getElementById('featuredGames');
            const premiumContainer = document.getElementById('premiumGames');
            const newContainer = document.getElementById('newGames');
            
            featuredContainer.innerHTML = '';
            premiumContainer.innerHTML = '';
            newContainer.innerHTML = '';
            
            const filteredGames = category === 'all' 
                ? gamesData 
                : gamesData.filter(game => game.category === category);
            
            filteredGames.forEach(game => {
                const gameCard = createGameCard(game);
                
                if (game.featured) {
                    featuredContainer.appendChild(gameCard);
                }
                
                if (game.premium) {
                    premiumContainer.appendChild(gameCard);
                }
                
                if (game.new) {
                    newContainer.appendChild(gameCard);
                }
            });
        }

        function startGame(gameId) {
            const game = gamesData.find(g => g.id === gameId);
            if (!game) return;
            
            // Check if game is premium and user doesn't have access
            if (game.premium && (!userData || !userData.isPremium)) {
                showPremiumModal();
                return;
            }
            
            // Load current level for the game
            const currentLevel = userData.gameProgress[gameId]?.level || 1;
            
            switch(gameId) {
                case 'chess':
                    chessGame.currentLevel = currentLevel;
                    startChessGame();
                    break;
                case 'wordpuzzle':
                    wordPuzzle.currentLevel = currentLevel;
                    startWordPuzzle();
                    break;
                case 'memory':
                    memoryGame.currentLevel = currentLevel;
                    startMemoryGame();
                    break;
                case 'quiz':
                    quizGame.currentLevel = currentLevel;
                    showQuizCategorySelection();
                    break;
                case 'tictactoe':
                    startTicTacToe();
                    break;
                case 'sudoku':
                    sudokuGame.currentLevel = currentLevel;
                    startSudoku();
                    break;
                case 'puzzle2048':
                case 'wordsearch':
                case 'trivia':
                    showToast('Game coming soon!', 'info');
                    break;
                default:
                    showToast('Game coming soon!', 'info');
            }
            
            // Update recent games
            if (userData && currentUser) {
                let recentGames = userData.recentGames || [];
                
                // Remove if already exists
                recentGames = recentGames.filter(id => id !== gameId);
                
                // Add to beginning
                recentGames.unshift(gameId);
                
                // Keep only last 10
                if (recentGames.length > 10) {
                    recentGames = recentGames.slice(0, 10);
                }
                
                // Update in Firestore
                if (currentUser) {
                    db.collection('users').doc(currentUser.uid).update({
                        recentGames: recentGames
                    });
                }
                
                userData.recentGames = recentGames;
                loadRecentGames();
            }
        }

        // ==================== CHESS GAME ====================
        function startChessGame() {
            openGameModal('chessGameModal');
            document.getElementById('chessLevel').textContent = chessGame.currentLevel;
            initializeChessBoard();
            renderChessBoard();
        }

        function initializeChessBoard() {
            chessGame.board = Array(8).fill().map(() => Array(8).fill(null));
            
            // Set up pawns
            for (let i = 0; i < 8; i++) {
                chessGame.board[1][i] = { type: 'pawn', color: 'black' };
                chessGame.board[6][i] = { type: 'pawn', color: 'white' };
            }
            
            // Set up other pieces
            const backRow = ['rook', 'knight', 'bishop', 'queen', 'king', 'bishop', 'knight', 'rook'];
            for (let i = 0; i < 8; i++) {
                chessGame.board[0][i] = { type: backRow[i], color: 'black' };
                chessGame.board[7][i] = { type: backRow[i], color: 'white' };
            }
            
            chessGame.currentPlayer = 'white';
            chessGame.selectedPiece = null;
            chessGame.validMoves = [];
            
            updateChessStatus();
        }

        function renderChessBoard() {
            const board = document.getElementById('chessBoard');
            board.innerHTML = '';
            
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const square = document.createElement('div');
                    const isWhite = (row + col) % 2 === 0;
                    square.className = `chess-square ${isWhite ? 'white' : 'black'}`;
                    
                    const piece = chessGame.board[row][col];
                    if (piece) {
                        square.innerHTML = getChessSymbol(piece);
                        square.style.cursor = 'pointer';
                    }
                    
                    if (chessGame.validMoves.some(move => move.row === row && move.col === col)) {
                        square.classList.add('valid-move');
                    }
                    
                    if (chessGame.selectedPiece && chessGame.selectedPiece.row === row && chessGame.selectedPiece.col === col) {
                        square.classList.add('selected');
                    }
                    
                    square.onclick = () => handleChessClick(row, col);
                    board.appendChild(square);
                }
            }
        }

        function getChessSymbol(piece) {
            const symbols = {
                'king': { white: '', black: '' },
                'queen': { white: '', black: '' },
                'rook': { white: '', black: '' },
                'bishop': { white: '', black: '' },
                'knight': { white: '', black: '' },
                'pawn': { white: '', black: '' }
            };
            return symbols[piece.type][piece.color];
        }

        function handleChessClick(row, col) {
            const piece = chessGame.board[row][col];
            
            if (chessGame.selectedPiece) {
                const selectedRow = chessGame.selectedPiece.row;
                const selectedCol = chessGame.selectedPiece.col;
                
                const isValidMove = chessGame.validMoves.some(move => move.row === row && move.col === col);
                
                if (isValidMove) {
                    chessGame.board[row][col] = chessGame.board[selectedRow][selectedCol];
                    chessGame.board[selectedRow][selectedCol] = null;
                    
                    chessGame.currentPlayer = chessGame.currentPlayer === 'white' ? 'black' : 'white';
                    updateChessStatus();
                    awardCoins(10);
                }
                
                chessGame.selectedPiece = null;
                chessGame.validMoves = [];
                renderChessBoard();
                return;
            }
            
            if (piece && piece.color === chessGame.currentPlayer) {
                chessGame.selectedPiece = { row, col };
                chessGame.validMoves = calculateValidMoves(row, col, piece);
                renderChessBoard();
            }
        }

        function calculateValidMoves(row, col, piece) {
            const moves = [];
            
            if (piece.type === 'pawn') {
                const direction = piece.color === 'white' ? -1 : 1;
                if (row + direction >= 0 && row + direction < 8 && !chessGame.board[row + direction][col]) {
                    moves.push({ row: row + direction, col });
                }
                if (col > 0 && chessGame.board[row + direction][col - 1] && chessGame.board[row + direction][col - 1].color !== piece.color) {
                    moves.push({ row: row + direction, col: col - 1 });
                }
                if (col < 7 && chessGame.board[row + direction][col + 1] && chessGame.board[row + direction][col + 1].color !== piece.color) {
                    moves.push({ row: row + direction, col: col + 1 });
                }
            }
            
            return moves;
        }

        function updateChessStatus() {
            document.getElementById('chessStatus').textContent = `${chessGame.currentPlayer.charAt(0).toUpperCase() + chessGame.currentPlayer.slice(1)}'s Turn`;
        }

        function nextChessLevel() {
            chessGame.currentLevel++;
            document.getElementById('chessLevel').textContent = chessGame.currentLevel;
            initializeChessBoard();
            renderChessBoard();
            showToast(`Advanced to Chess Level ${chessGame.currentLevel}!`, 'success');
            awardCoins(50);
        }

        // ==================== WORD PUZZLE GAME ====================
        function startWordPuzzle() {
            openGameModal('wordPuzzleModal');
            document.getElementById('wordPuzzleLevel').textContent = wordPuzzle.currentLevel;
            wordPuzzle.maxGuesses = Math.max(4, 7 - Math.floor(wordPuzzle.currentLevel / 10));
            initializeWordPuzzle();
            renderWordPuzzle();
        }

        function initializeWordPuzzle() {
            const startIndex = Math.min(wordPuzzle.currentLevel - 1, wordPuzzle.wordList.length - 1);
            const endIndex = Math.min(startIndex + 20, wordPuzzle.wordList.length);
            const levelWords = wordPuzzle.wordList.slice(startIndex, endIndex);
            
            wordPuzzle.targetWord = levelWords[Math.floor(Math.random() * levelWords.length)];
            wordPuzzle.currentGuess = '';
            wordPuzzle.guesses = [];
            wordPuzzle.gameOver = false;
            
            updateWordPuzzleStatus();
        }

        function renderWordPuzzle() {
            const grid = document.getElementById('wordPuzzleGrid');
            const keyboard = document.getElementById('wordKeyboard');
            
            grid.innerHTML = '';
            keyboard.innerHTML = '';
            
            for (let i = 0; i < wordPuzzle.maxGuesses; i++) {
                for (let j = 0; j < 5; j++) {
                    const cell = document.createElement('div');
                    cell.className = 'word-cell';
                    
                    if (wordPuzzle.guesses[i] && wordPuzzle.guesses[i][j]) {
                        cell.textContent = wordPuzzle.guesses[i][j];
                        cell.classList.add('filled');
                        
                        if (wordPuzzle.guesses[i][j] === wordPuzzle.targetWord[j]) {
                            cell.classList.add('correct');
                        } else if (wordPuzzle.targetWord.includes(wordPuzzle.guesses[i][j])) {
                            cell.classList.add('partial');
                        } else {
                            cell.classList.add('incorrect');
                        }
                    }
                    
                    grid.appendChild(cell);
                }
            }
            
            const keyboardLayout = 'QWERTYUIOPASDFGHJKLZXCVBNM';
            for (let char of keyboardLayout) {
                const key = document.createElement('button');
                key.className = 'key';
                key.textContent = char;
                key.onclick = () => handleKeyPress(char);
                keyboard.appendChild(key);
            }
            
            const enterKey = document.createElement('button');
            enterKey.className = 'key';
            enterKey.textContent = 'ENTER';
            enterKey.onclick = submitGuess;
            keyboard.appendChild(enterKey);
            
            const backspaceKey = document.createElement('button');
            backspaceKey.className = 'key';
            backspaceKey.innerHTML = '<i class="fas fa-backspace"></i>';
            backspaceKey.onclick = handleBackspace;
            keyboard.appendChild(backspaceKey);
        }

        function handleKeyPress(char) {
            if (wordPuzzle.gameOver) return;
            
            if (wordPuzzle.currentGuess.length < 5) {
                wordPuzzle.currentGuess += char;
                renderWordPuzzle();
            }
        }

        function handleBackspace() {
            if (wordPuzzle.gameOver) return;
            
            if (wordPuzzle.currentGuess.length > 0) {
                wordPuzzle.currentGuess = wordPuzzle.currentGuess.slice(0, -1);
                renderWordPuzzle();
            }
        }

        function submitGuess() {
            if (wordPuzzle.gameOver || wordPuzzle.currentGuess.length !== 5) return;
            
            wordPuzzle.guesses.push(wordPuzzle.currentGuess);
            
            if (wordPuzzle.currentGuess === wordPuzzle.targetWord) {
                wordPuzzle.gameOver = true;
                showToast('Congratulations! You guessed the word!', 'success');
                awardCoins(100);
            } else if (wordPuzzle.guesses.length >= wordPuzzle.maxGuesses) {
                wordPuzzle.gameOver = true;
                showToast(`Game Over! The word was: ${wordPuzzle.targetWord}`, 'info');
            }
            
            wordPuzzle.currentGuess = '';
            renderWordPuzzle();
            updateWordPuzzleStatus();
        }

        function updateWordPuzzleStatus() {
            if (wordPuzzle.gameOver) {
                if (wordPuzzle.guesses[wordPuzzle.guesses.length - 1] === wordPuzzle.targetWord) {
                    document.getElementById('wordPuzzleStatus').textContent = 'You won! ';
                } else {
                    document.getElementById('wordPuzzleStatus').textContent = `The word was: ${wordPuzzle.targetWord}`;
                }
            } else {
                document.getElementById('wordPuzzleStatus').textContent = `Guess ${wordPuzzle.guesses.length + 1}/${wordPuzzle.maxGuesses}`;
            }
        }

        function nextWordPuzzleLevel() {
            wordPuzzle.currentLevel++;
            document.getElementById('wordPuzzleLevel').textContent = wordPuzzle.currentLevel;
            initializeWordPuzzle();
            renderWordPuzzle();
            showToast(`Advanced to Word Puzzle Level ${wordPuzzle.currentLevel}!`, 'success');
            awardCoins(50);
        }

        // ==================== MEMORY GAME ====================
        function startMemoryGame() {
            openGameModal('memoryGameModal');
            document.getElementById('memoryLevel').textContent = memoryGame.currentLevel;
            memoryGame.totalPairs = Math.min(16, 8 + Math.floor(memoryGame.currentLevel / 3));
            resetMemoryGame();
            generateMemoryCards();
            renderMemoryCards();
        }

        function resetMemoryGame() {
            memoryGame.cards = [];
            memoryGame.flippedCards = [];
            memoryGame.matchedPairs = 0;
            memoryGame.moves = 0;
            updateMemoryMoves();
        }

        function generateMemoryCards() {
            const symbols = ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''];
            let cards = [];
            
            const levelSymbols = symbols.slice(0, memoryGame.totalPairs);
            levelSymbols.forEach(symbol => {
                cards.push({ symbol, matched: false });
                cards.push({ symbol, matched: false });
            });
            
            memoryGame.cards = cards.sort(() => Math.random() - 0.5);
        }

        function renderMemoryCards() {
            const grid = document.getElementById('memoryGameGrid');
            grid.innerHTML = '';
            const columns = Math.min(6, Math.ceil(Math.sqrt(memoryGame.totalPairs * 2)));
            grid.className = `grid grid-cols-${columns} gap-2 max-w-md mx-auto`;
            
            memoryGame.cards.forEach((card, index) => {
                const cardElement = document.createElement('div');
                cardElement.className = `memory-card ${card.matched ? 'matched' : ''}`;
                cardElement.innerHTML = card.matched || memoryGame.flippedCards.includes(index) ? 
                    card.symbol : '<i class="fas fa-question text-white"></i>';
                cardElement.onclick = () => flipMemoryCard(index);
                grid.appendChild(cardElement);
            });
        }

        function flipMemoryCard(index) {
            if (memoryGame.flippedCards.length >= 2 || 
                memoryGame.flippedCards.includes(index) || 
                memoryGame.cards[index].matched) {
                return;
            }
            
            memoryGame.flippedCards.push(index);
            memoryGame.moves++;
            updateMemoryMoves();
            
            renderMemoryCards();
            
            if (memoryGame.flippedCards.length === 2) {
                checkMemoryMatch();
            }
        }

        function checkMemoryMatch() {
            const [index1, index2] = memoryGame.flippedCards;
            const card1 = memoryGame.cards[index1];
            const card2 = memoryGame.cards[index2];
            
            if (card1.symbol === card2.symbol) {
                card1.matched = true;
                card2.matched = true;
                memoryGame.matchedPairs++;
                memoryGame.flippedCards = [];
                
                if (memoryGame.matchedPairs === memoryGame.totalPairs) {
                    setTimeout(() => {
                        showToast(`Congratulations! You won in ${memoryGame.moves} moves!`, 'success');
                        awardCoins(80);
                    }, 500);
                }
            } else {
                setTimeout(() => {
                    memoryGame.flippedCards = [];
                    renderMemoryCards();
                }, 1000);
            }
        }

        function updateMemoryMoves() {
            document.getElementById('memoryMoves').textContent = `Moves: ${memoryGame.moves}`;
        }

        function nextMemoryLevel() {
            memoryGame.currentLevel++;
            document.getElementById('memoryLevel').textContent = memoryGame.currentLevel;
            startMemoryGame();
            showToast(`Advanced to Memory Level ${memoryGame.currentLevel}!`, 'success');
            awardCoins(50);
        }

        // ==================== QUIZ GAME ====================
        function showQuizCategorySelection() {
            const categoriesContainer = document.getElementById('quizCategories');
            categoriesContainer.innerHTML = quizCategories.map(category => `
                <div class="quiz-option flex items-center p-4" onclick="selectQuizCategory('${category.id}')">
                    <i class="fas ${category.icon} ${category.color} text-xl mr-3"></i>
                    <span class="text-white font-medium">${category.name}</span>
                </div>
            `).join('');
            
            openGameModal('quizCategoryModal');
        }

        function selectQuizCategory(categoryId) {
            quizGame.selectedCategory = categoryId;
            const category = quizCategories.find(c => c.id === categoryId);
            
            document.querySelectorAll('.quiz-option').forEach(opt => {
                opt.classList.remove('correct');
            });
            
            event.currentTarget.classList.add('correct');
        }

        function startSelectedQuiz() {
            if (!quizGame.selectedCategory) {
                showToast('Please select a quiz category', 'error');
                return;
            }
            
            closeGameModal('quizCategoryModal');
            startQuizGame();
        }

        function startQuizGame() {
            openGameModal('quizGameModal');
            document.getElementById('quizLevel').textContent = quizGame.currentLevel;
            
            const category = quizCategories.find(c => c.id === quizGame.selectedCategory);
            if (category) {
                document.getElementById('quizGameTitle').textContent = category.name;
            }
            
            resetQuizGame();
            loadQuizQuestions();
        }

        function resetQuizGame() {
            quizGame.currentQuestion = 0;
            quizGame.score = 0;
            updateQuizScore();
        }

        function loadQuizQuestions() {
            const category = quizCategories.find(c => c.id === quizGame.selectedCategory);
            if (!category) return;

            if (quizGame.currentLevel > 5) {
                const allQuestions = quizCategories.flatMap(cat => cat.questions);
                quizGame.questions = allQuestions.sort(() => 0.5 - Math.random()).slice(0, quizGame.totalQuestions);
            } else {
                quizGame.questions = category.questions.slice(0, quizGame.totalQuestions);
            }
            
            loadNextQuizQuestion();
        }

        function loadNextQuizQuestion() {
            if (quizGame.currentQuestion >= quizGame.questions.length) {
                showQuizResults();
                return;
            }
            
            const question = quizGame.questions[quizGame.currentQuestion];
            const content = document.getElementById('quizGameContent');
            
            content.innerHTML = `
                <div class="glass-card rounded-xl p-6 mb-4">
                    <h4 class="text-xl font-semibold text-white mb-4">${question.question}</h4>
                    <div class="space-y-3" id="quizOptions">
                        ${question.options.map((option, index) => `
                            <div class="quiz-option" onclick="selectQuizAnswer(${index})">
                                ${option}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            document.getElementById('nextQuizQuestion').style.display = 'none';
        }

        function selectQuizAnswer(selectedIndex) {
            const question = quizGame.questions[quizGame.currentQuestion];
            const options = document.querySelectorAll('.quiz-option');
            
            options.forEach((option, index) => {
                if (index === question.correct) {
                    option.classList.add('correct');
                } else if (index === selectedIndex && index !== question.correct) {
                    option.classList.add('incorrect');
                }
                option.style.pointerEvents = 'none';
            });
            
            if (selectedIndex === question.correct) {
                quizGame.score++;
                updateQuizScore();
            }
            
            document.getElementById('nextQuizQuestion').style.display = 'block';
            quizGame.currentQuestion++;
        }

        function updateQuizScore() {
            document.getElementById('quizScore').textContent = `Score: ${quizGame.score}/${quizGame.currentQuestion}`;
        }

        function showQuizResults() {
            const content = document.getElementById('quizGameContent');
            content.innerHTML = `
                <div class="glass-card rounded-xl p-6 text-center">
                    <h4 class="text-2xl font-black text-white mb-4">Quiz Complete!</h4>
                    <div class="text-4xl font-black text-green-400 mb-4">${quizGame.score}/${quizGame.questions.length}</div>
                    <p class="text-slate-400 mb-4">You scored ${Math.round((quizGame.score / quizGame.questions.length) * 100)}%</p>
                    ${quizGame.score === quizGame.questions.length ? 
                        '<p class="text-yellow-400 font-semibold">Perfect score! Amazing job! </p>' :
                        quizGame.score >= quizGame.questions.length * 0.7 ?
                        '<p class="text-green-400 font-semibold">Great job! Well done! </p>' :
                        '<p class="text-blue-400 font-semibold">Good effort! Keep practicing! </p>'
                    }
                </div>
            `;
            
            document.getElementById('nextQuizQuestion').style.display = 'none';
            awardCoins(quizGame.score * 20);
        }

        // ==================== TIC TAC TOE GAME ====================
        function startTicTacToe() {
            openGameModal('ticTacToeModal');
            resetTicTacToe();
            renderTicTacToeBoard();
        }

        function resetTicTacToe() {
            ticTacToe.board = Array(9).fill('');
            ticTacToe.currentPlayer = 'X';
            ticTacToe.gameOver = false;
            ticTacToe.winner = null;
            updateTicTacToeStatus();
        }

        function renderTicTacToeBoard() {
            const board = document.getElementById('ticTacToeBoard');
            board.innerHTML = '';
            
            for (let i = 0; i < 9; i++) {
                const cell = document.createElement('div');
                cell.className = `tic-tac-toe-cell ${ticTacToe.board[i] ? ticTacToe.board[i].toLowerCase() : ''}`;
                cell.textContent = ticTacToe.board[i];
                cell.onclick = () => handleTicTacToeClick(i);
                board.appendChild(cell);
            }
        }

        function handleTicTacToeClick(index) {
            if (ticTacToe.gameOver || ticTacToe.board[index] !== '') return;
            
            ticTacToe.board[index] = ticTacToe.currentPlayer;
            renderTicTacToeBoard();
            
            if (checkTicTacToeWinner()) {
                ticTacToe.gameOver = true;
                ticTacToe.winner = ticTacToe.currentPlayer;
                showToast(`${ticTacToe.winner} wins!`, 'success');
                awardCoins(30);
                updateTicTacToeStatus();
                return;
            }
            
            if (ticTacToe.board.every(cell => cell !== '')) {
                ticTacToe.gameOver = true;
                showToast("It's a tie!", 'info');
                awardCoins(10);
                updateTicTacToeStatus();
                return;
            }
            
            ticTacToe.currentPlayer = ticTacToe.currentPlayer === 'X' ? 'O' : 'X';
            updateTicTacToeStatus();
            
            // Computer's turn
            if (ticTacToe.currentPlayer === 'O' && !ticTacToe.gameOver) {
                setTimeout(makeComputerMove, 500);
            }
        }

        function makeComputerMove() {
            const emptyCells = ticTacToe.board
                .map((cell, index) => cell === '' ? index : null)
                .filter(index => index !== null);
            
            if (emptyCells.length > 0) {
                const randomIndex = emptyCells[Math.floor(Math.random() * emptyCells.length)];
                ticTacToe.board[randomIndex] = 'O';
                renderTicTacToeBoard();
                
                if (checkTicTacToeWinner()) {
                    ticTacToe.gameOver = true;
                    ticTacToe.winner = 'O';
                    showToast("Computer wins!", 'info');
                    updateTicTacToeStatus();
                    return;
                }
                
                if (ticTacToe.board.every(cell => cell !== '')) {
                    ticTacToe.gameOver = true;
                    showToast("It's a tie!", 'info');
                    awardCoins(10);
                    updateTicTacToeStatus();
                    return;
                }
                
                ticTacToe.currentPlayer = 'X';
                updateTicTacToeStatus();
            }
        }

        function checkTicTacToeWinner() {
            const winPatterns = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8], // rows
                [0, 3, 6], [1, 4, 7], [2, 5, 8], // columns
                [0, 4, 8], [2, 4, 6] // diagonals
            ];
            
            return winPatterns.some(pattern => {
                const [a, b, c] = pattern;
                return ticTacToe.board[a] !== '' && 
                       ticTacToe.board[a] === ticTacToe.board[b] && 
                       ticTacToe.board[a] === ticTacToe.board[c];
            });
        }

        function updateTicTacToeStatus() {
            if (ticTacToe.gameOver) {
                document.getElementById('ticTacToeStatus').textContent = 
                    ticTacToe.winner ? `${ticTacToe.winner} wins!` : "It's a tie!";
            } else {
                document.getElementById('ticTacToeStatus').textContent = 
                    `Player ${ticTacToe.currentPlayer}'s turn`;
            }
        }

        // ==================== SUDOKU GAME ====================
        function startSudoku() {
            openGameModal('sudokuModal');
            document.getElementById('sudokuLevel').textContent = sudokuGame.currentLevel;
            generateSudoku();
            renderSudoku();
        }

        function generateSudoku() {
            // Generate a simple Sudoku puzzle (in a real app, this would be more complex)
            sudokuGame.board = [
                [5, 3, 0, 0, 7, 0, 0, 0, 0],
                [6, 0, 0, 1, 9, 5, 0, 0, 0],
                [0, 9, 8, 0, 0, 0, 0, 6, 0],
                [8, 0, 0, 0, 6, 0, 0, 0, 3],
                [4, 0, 0, 8, 0, 3, 0, 0, 1],
                [7, 0, 0, 0, 2, 0, 0, 0, 6],
                [0, 6, 0, 0, 0, 0, 2, 8, 0],
                [0, 0, 0, 4, 1, 9, 0, 0, 5],
                [0, 0, 0, 0, 8, 0, 0, 7, 9]
            ];
            
            sudokuGame.solution = JSON.parse(JSON.stringify(sudokuGame.board));
            // In a real app, we would have a complete solution
            sudokuGame.mistakes = 0;
            sudokuGame.selectedCell = null;
            
            updateSudokuStatus();
        }

        function renderSudoku() {
            const board = document.getElementById('sudokuBoard');
            const controls = document.getElementById('sudokuControls');
            
            board.innerHTML = '';
            controls.innerHTML = '';
            
            for (let row = 0; row < 9; row++) {
                for (let col = 0; col < 9; col++) {
                    const cell = document.createElement('div');
                    cell.className = `sudoku-cell ${sudokuGame.board[row][col] === 0 ? '' : 'prefilled'} ${sudokuGame.selectedCell && sudokuGame.selectedCell.row === row && sudokuGame.selectedCell.col === col ? 'selected' : ''}`;
                    cell.textContent = sudokuGame.board[row][col] === 0 ? '' : sudokuGame.board[row][col];
                    cell.onclick = () => selectSudokuCell(row, col);
                    board.appendChild(cell);
                }
            }
            
            for (let num = 1; num <= 9; num++) {
                const button = document.createElement('button');
                button.className = 'px-4 py-2 glass-card text-white rounded-lg font-semibold hover:scale-105 transition';
                button.textContent = num;
                button.onclick = () => fillSudokuCell(num);
                controls.appendChild(button);
            }
            
            const clearButton = document.createElement('button');
            clearButton.className = 'px-4 py-2 glass-card text-white rounded-lg font-semibold hover:scale-105 transition';
            clearButton.innerHTML = '<i class="fas fa-eraser"></i>';
            clearButton.onclick = clearSudokuCell;
            controls.appendChild(clearButton);
        }

        function selectSudokuCell(row, col) {
            if (sudokuGame.board[row][col] === 0) {
                sudokuGame.selectedCell = { row, col };
                renderSudoku();
                updateSudokuStatus();
            }
        }

        function fillSudokuCell(num) {
            if (!sudokuGame.selectedCell) {
                showToast('Please select a cell first', 'info');
                return;
            }
            
            const { row, col } = sudokuGame.selectedCell;
            
            // Check if the move is valid (simplified validation)
            if (isValidSudokuMove(row, col, num)) {
                sudokuGame.board[row][col] = num;
                
                if (checkSudokuComplete()) {
                    showToast('Congratulations! Puzzle completed!', 'success');
                    awardCoins(120);
                }
            } else {
                sudokuGame.mistakes++;
                showToast('Invalid move! Try again.', 'error');
            }
            
            renderSudoku();
            updateSudokuStatus();
        }

        function clearSudokuCell() {
            if (!sudokuGame.selectedCell) return;
            
            const { row, col } = sudokuGame.selectedCell;
            sudokuGame.board[row][col] = 0;
            renderSudoku();
        }

        function isValidSudokuMove(row, col, num) {
            // Simplified validation - in a real app, this would check row, column, and 3x3 box
            return true;
        }

        function checkSudokuComplete() {
            for (let row = 0; row < 9; row++) {
                for (let col = 0; col < 9; col++) {
                    if (sudokuGame.board[row][col] === 0) {
                        return false;
                    }
                }
            }
            return true;
        }

        function updateSudokuStatus() {
            if (checkSudokuComplete()) {
                document.getElementById('sudokuStatus').textContent = 'Puzzle completed!';
            } else if (sudokuGame.selectedCell) {
                document.getElementById('sudokuStatus').textContent = `Selected: Row ${sudokuGame.selectedCell.row + 1}, Col ${sudokuGame.selectedCell.col + 1}`;
            } else {
                document.getElementById('sudokuStatus').textContent = 'Select a cell to fill';
            }
        }

        function nextSudokuLevel() {
            sudokuGame.currentLevel++;
            document.getElementById('sudokuLevel').textContent = sudokuGame.currentLevel;
            startSudoku();
            showToast(`Advanced to Sudoku Level ${sudokuGame.currentLevel}!`, 'success');
            awardCoins(50);
        }

        // ==================== PAYMENT SYSTEM ====================
        function selectPaymentMethod(method) {
            selectedPaymentMethod = method;
            
            document.querySelectorAll('.payment-method').forEach(method => {
                method.classList.remove('selected');
            });
            
            event.currentTarget.classList.add('selected');
            
            const button = document.getElementById('subscribeButton');
            if (method === 'coins') {
                button.innerHTML = '<i class="fas fa-coins mr-2"></i>Pay with Coins (5,000)';
            } else {
                button.innerHTML = '<i class="fas fa-lock mr-2"></i>Subscribe Now';
            }
        }

        async function processPremiumPayment() {
            if (!selectedPaymentMethod) {
                showToast('Please select a payment method', 'error');
                return;
            }

            if (!currentUser) {
                showToast('Please sign in to purchase premium', 'error');
                return;
            }

            showPaymentModal('Processing your payment...', 'Please wait...');

            try {
                if (selectedPaymentMethod === 'coins') {
                    if (userData.coins < 5000) {
                        showPaymentResult('error', 'Insufficient Coins', 'You need 5,000 coins to unlock premium. Keep playing to earn more!');
                        return;
                    }

                    await db.collection('users').doc(currentUser.uid).update({
                        coins: firebase.firestore.FieldValue.increment(-5000),
                        isPremium: true,
                        premiumSince: firebase.firestore.FieldValue.serverTimestamp(),
                        premiumMethod: 'coins'
                    });

                    userData.coins -= 5000;
                    userData.isPremium = true;
                    showPaymentResult('success', 'Premium Unlocked!', 'You have successfully unlocked Kynecta Premium using coins!');
                    
                } else {
                    setTimeout(async () => {
                        await db.collection('users').doc(currentUser.uid).update({
                            isPremium: true,
                            premiumSince: firebase.firestore.FieldValue.serverTimestamp(),
                            premiumMethod: selectedPaymentMethod
                        });

                        userData.isPremium = true;
                        showPaymentResult('success', 'Payment Successful!', 'Welcome to Kynecta Premium!');
                    }, 3000);
                }

                loadGames();
                updateUI();

            } catch (error) {
                console.error("Payment processing error:", error);
                showPaymentResult('error', 'Payment Failed', 'There was an error processing your payment. Please try again.');
            }
        }

        function showPaymentModal(title, message) {
            document.getElementById('paymentTitle').textContent = title;
            document.getElementById('paymentMessage').textContent = message;
            document.getElementById('paymentIcon').className = 'fas fa-spinner fa-spin text-white text-2xl';
            document.getElementById('paymentCloseButton').classList.add('hidden');
            openGameModal('paymentModal');
        }

        function showPaymentResult(type, title, message) {
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
            const color = type === 'success' ? 'text-green-400' : 'text-red-400';
            
            document.getElementById('paymentTitle').textContent = title;
            document.getElementById('paymentMessage').textContent = message;
            document.getElementById('paymentIcon').className = `fas ${icon} ${color} text-2xl`;
            document.getElementById('paymentCloseButton').classList.remove('hidden');
        }

        function closePaymentModal() {
            closeGameModal('paymentModal');
            closePremiumModal();
        }

        // ==================== COMMON FUNCTIONS ====================
        function openGameModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function closeGameModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function showPremiumModal() {
            document.getElementById('premiumModal').classList.remove('hidden');
        }

        function closePremiumModal() {
            document.getElementById('premiumModal').classList.add('hidden');
            selectedPaymentMethod = null;
            
            document.querySelectorAll('.payment-method').forEach(method => {
                method.classList.remove('selected');
            });
        }

        async function awardCoins(amount) {
            if (!currentUser) {
                showToast(`You earned ${amount} coins! Sign in to save your progress.`, 'info');
                return;
            }

            try {
                const finalAmount = userData.isPremium ? amount * 2 : amount;
                const newCoins = userData.coins + finalAmount;
                
                await db.collection('users').doc(currentUser.uid).update({
                    coins: newCoins,
                    totalCoinsEarned: firebase.firestore.FieldValue.increment(finalAmount),
                    lastGamePlayed: firebase.firestore.FieldValue.serverTimestamp(),
                    gamesPlayed: firebase.firestore.FieldValue.increment(1)
                });
                
                userData.coins = newCoins;
                userData.totalCoinsEarned = (userData.totalCoinsEarned || 0) + finalAmount;
                userData.gamesPlayed += 1;
                
                updateUI();
                showToast(`+${finalAmount} coins awarded! ${userData.isPremium ? '(Premium bonus!)' : ''}`, 'success');
                
            } catch (error) {
                console.error("Error awarding coins:", error);
                showToast('Error saving coins to database', 'error');
            }
        }

        function claimDailyReward() {
            if (!currentUser) {
                showToast('Please sign in to claim daily rewards', 'error');
                return;
            }
            
            const today = new Date().toDateString();
            const lastClaim = userData.lastRewardClaim;
            
            if (lastClaim === today) {
                showToast('You have already claimed your daily reward today', 'info');
                return;
            }
            
            // Award coins
            const reward = 100;
            const newCoins = (userData.coins || 0) + reward;
            
            // Update streak
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const isConsecutive = lastClaim === yesterday.toDateString();
            const newStreak = isConsecutive ? (userData.streak || 0) + 1 : 1;
            
            // Update user data
            db.collection('users').doc(currentUser.uid).update({
                coins: newCoins,
                totalCoinsEarned: firebase.firestore.FieldValue.increment(reward),
                streak: newStreak,
                lastRewardClaim: today
            }).then(() => {
                userData.coins = newCoins;
                userData.totalCoinsEarned = (userData.totalCoinsEarned || 0) + reward;
                userData.streak = newStreak;
                userData.lastRewardClaim = today;
                
                updateUI();
                showToast(`Daily reward claimed! +${reward} coins`, 'success');
            }).catch(error => {
                console.error("Error claiming reward:", error);
                showToast('Error claiming reward', 'error');
            });
        }

        function suggestGames(mood) {
            let suggestedGames = [];
            
            switch(mood) {
                case 'relaxing':
                    suggestedGames = gamesData.filter(g => g.category === 'puzzle');
                    break;
                case 'energetic':
                    suggestedGames = gamesData.filter(g => g.category === 'action' || g.category === 'trivia');
                    break;
                case 'competitive':
                    suggestedGames = gamesData.filter(g => g.players.includes('2') || g.players.includes('4'));
                    break;
            }
            
            // Filter games to show only available ones (non-premium or user has premium)
            suggestedGames = suggestedGames.filter(game => 
                !game.premium || (userData && userData.isPremium)
            );
            
            if (suggestedGames.length > 0) {
                // In a real app, this would highlight or filter to these games
                showToast(`Showing ${suggestedGames.length} ${mood} games`, 'info');
                
                // For demo, just open the first suggested game
                if (suggestedGames.length > 0) {
                    startGame(suggestedGames[0].id);
                }
            } else {
                showToast(`No ${mood} games available`, 'info');
            }
        }

        function showLeaderboard(timeframe) {
            // In a real app, this would fetch and display the leaderboard for the selected timeframe
            showToast(`Showing ${timeframe} leaderboard`, 'info');
        }

        function toggleTheme() {
            const toggle = document.getElementById('themeToggle');
            toggle.classList.toggle('active');
            
            // In a real app, this would toggle between light and dark mode
            // For this demo, we'll just show a toast
            const isDark = toggle.classList.contains('active');
            showToast(`Switched to ${isDark ? 'dark' : 'light'} mode`, 'info');
        }

        function showToast(message, type) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} mr-2"></i>
                    ${message}
                </div>
            `;
            
            container.appendChild(toast);
            
            // Show toast
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // Hide after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    container.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // Additional functions for multiplayer, challenges, etc.
        function showChallengeModal() {
            showToast('Challenge modal would open here', 'info');
        }

        function showFriendsModal() {
            showToast('Friends modal would open here', 'info');
        }

        function viewAllRecentGames() {
            // In a real app, this would navigate to a page with all recent games
            showToast('Showing all recent games', 'info');
        }
    </script>
</body>
</html>